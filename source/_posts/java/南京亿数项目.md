---
title: 能源互联网营销设计方案及建设
category: JAVA
tag: 项目熟悉
abbrlink: 62511
date: 2024-04-01 09:10:00
---

# 研发人员能源互联网关注点
## 技术架构和系统设计： 
1. 开发人员需要理解和评估能源互联网营销系统的技术架构，包括后端服务器、数据库、前端界面等方面的设计。他们需要确保系统具有良好的可扩展性、性能和安全性。
2. 总体架构图
    - ![总体架构图](/img/能源互联网/营销2.0总体架构图.png)
3. 技术架构图第一版
    - ![技术架构图](/img/能源互联网/营销2.0技术架构图.png)
4. 技术架构图第二版
    - ![技术架构图](/img/能源互联网/营销2.0技术架构图_2.png)
5. 延展设计图
    - ![技术架构图](/img/能源互联网/营销2.0内部集成层面的延展设计图.png)
## 数据管理和分析： 
1. 能源互联网营销系统涉及大量数据的收集、存储和分析，开发人员需要关注数据管理的方案，包括数据的采集、清洗、存储和处理，以及数据分析和挖掘技术的应用。

## 用户体验和界面设计： 
1. 用户体验对于能源互联网营销系统至关重要。开发人员需要与设计团队合作，确保系统界面友好、易用，并能够满足用户的需求和期望。

## 安全性和隐私保护： 
1. 能源互联网营销涉及用户的个人和敏感信息，因此安全性和隐私保护是至关重要的。开发人员需要关注系统的安全设计，包括身份验证、数据加密、访问控制等方面的实施。

## 云计算和物联网技术： 
1. 能源互联网营销系统通常需要借助云计算和物联网技术实现设备之间的连接和数据交换。开发人员需要了解并熟练应用这些技术，确保系统的稳定性和可靠性。

## 集成和扩展性： 
1. 能源互联网营销系统通常需要与其他系统集成，例如能源管理系统、智能电表系统等。开发人员需要考虑系统的集成方案，并确保系统具有良好的扩展性，能够满足未来业务发展的需求。

## 持续优化和迭代： 
1. 能源互联网营销系统是一个持续发展的过程，开发人员需要通过持续优化和迭代来不断改进系统，以满足用户和业务的不断变化的需求。


# 数据库信息汇总

1. Oracle DB1
    - emss_pserv
        1. ocs_business_scenario: 全渠道场景表
        2. ocs_channel_archive: 渠道档案表
        3. ocs_channel_inter_rela: 渠道业务授权表
        4. ocs_interface_def: 接口定义表
        5. ocs_relat_map: 全渠道关系映射表
        6. ocs_system_config: 系统参数配置

    - emss_cmc
        1. mgt_org: 管理单位表
2. Oracle DB3
    - emss_pfc
        1. pay_chan: 收费渠道表
        2. coll_trans_rec: 代收记录表
        3. coll_trans_reco: 对账汇总表 (代收 + 托收)
        4. pd_order: 批扣订单表
        5. pd_acct: 批扣明细表
        6. charg_acct: 收费记录表
        7. pay_order: 支付订单表
        8. cash_chk_rec: 解款到账表 
        9. chan_auto_task_cfg: 代扣上限表 
3. Oracle DB4
    - emss_woc
        1. hldy_info: 假日信息表
4. MySQL 
    - quanqudao_data
        - fact: 事实表
            1. fact_debit: 代扣汇总表
            2. fact_debit_error: 代扣失败汇总表
            3. fact_deplicate_charge: 疑似重复缴费表
            4. fact_debit_wk: 代扣工单关联表
        ```sql
        CREATE TABLE `fact_debit_wk` (
        `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT '主键',
        `sta_date` date NOT NULL COMMENT '年月日',
        `mgt_org_code` varchar(20) DEFAULT NULL COMMENT '管理单位编码',
        `channel_code` varchar(20) DEFAULT NULL COMMENT '渠道编码',
        `busi_type` varchar(20) DEFAULT NULL COMMENT '业务类型',
        `mq_msg` text COMMENT '工单消息',
        `handle_time` datetime DEFAULT NULL COMMENT '工单时间',
        `accept_content` text COMMENT '工单内容',
        `create_time` datetime DEFAULT NULL COMMENT '创建时间',
        PRIMARY KEY (`id`,`sta_date`),
        KEY `indx_mgt` (`mgt_org_code`),
        KEY `indx_sta_date` (`sta_date`) USING BTREE,
        KEY `indx_channel` (`channel_code`)
        ) ENGINE=InnoDB AUTO_INCREMENT=69 DEFAULT CHARSET=utf8mb4
        PARTITION BY RANGE COLUMNS(sta_date) (
        PARTITION p202401 VALUES LESS THAN ('2024-02-01'),
        PARTITION p202402 VALUES LESS THAN ('2024-03-01'),
        PARTITION p202403 VALUES LESS THAN ('2024-04-01'),
        PARTITION p202404 VALUES LESS THAN ('2024-05-01'),
        PARTITION p202405 VALUES LESS THAN ('2024-06-01'),
        PARTITION p202406 VALUES LESS THAN ('2024-07-01'),
        PARTITION p202407 VALUES LESS THAN ('2024-08-01'),
        PARTITION p202408 VALUES LESS THAN ('2024-09-01'),
        PARTITION p202409 VALUES LESS THAN ('2024-10-01'),
        PARTITION p202410 VALUES LESS THAN ('2024-11-01'),
        PARTITION p202411 VALUES LESS THAN ('2024-12-01'),
        PARTITION p202412 VALUES LESS THAN ('2025-01-01'),
        PARTITION p202501 VALUES LESS THAN ('2025-02-01'),
        PARTITION p202502 VALUES LESS THAN ('2025-03-01'),
        PARTITION p202503 VALUES LESS THAN ('2025-04-01'),
        PARTITION p202504 VALUES LESS THAN ('2025-05-01'),
        PARTITION p202505 VALUES LESS THAN ('2025-06-01'),
        PARTITION p202506 VALUES LESS THAN ('2025-07-01'),
        PARTITION p202507 VALUES LESS THAN ('2025-08-01'),
        PARTITION p202508 VALUES LESS THAN ('2025-09-01'),
        PARTITION p202509 VALUES LESS THAN ('2025-10-01'),
        PARTITION p202510 VALUES LESS THAN ('2025-11-01'),
        PARTITION p202511 VALUES LESS THAN ('2025-12-01'),
        PARTITION p202512 VALUES LESS THAN ('2026-01-01')
        );
        ```
        - PS : 以上四个表皆采用分区方式: 
            1. PARTITION BY RANGE COLUMNS(sta_date):  这表示使用基于日期范围的分区方式，并且以 sta_date 列作为分区列。
            2. PARTITION: 这是每个分区的开始定义。每个分区都有一个唯一的名称。
            3. VALUES LESS THAN ('date_value'): 这是定义分区的范围条件。每个分区根据指定的列的值进行划分，当列的值小于指定的日期值时，数据就会被放入该分区
        - 分区方式一共有:
            - 范围分区（Range Partitioning）：根据列的范围值将数据分区。例如，根据日期范围将数据分为不同的分区。

            - 列表分区（List Partitioning）：根据列的离散值列表将数据分区。例如，根据地区列表将数据分为不同的分区。

            - 哈希分区（Hash Partitioning）：根据列值的哈希值将数据分区。哈希分区通常用于平均分配数据，避免某些分区数据量过大的情况。

            - 分区键分区（Partition Key Partitioning）：根据列值的某种特性进行分区，比如根据年份、月份等。

            - 范围-列表混合分区（Range-List Hybrid Partitioning）：结合了范围分区和列表分区的特性，先按范围进行分区，再在每个范围内根据列表进行二次分区。

            - 复合分区（Composite Partitioning）：使用多种分区方法的组合，例如先进行哈希分区，然后在每个哈希分区内再进行范围或列表分区。

            - 子分区（Subpartitioning）：在每个分区内再进行进一步的分区。可以与上述任何一种分区方式结合使用。
# 代扣全景监控接口文档
## 定时统计加工数据 Acct2DebitPer30MinJob 
- 涉及数据库表名
    - pd_acct  [批扣明细表]{.label} [Oracle DB3]{.label .primary}
    - pd_order [批扣订单表]{.label} [Oracle DB3]{.label .primary}
    - fact_debit [代扣汇总表]{.label} [MySQL]{.label .primary}
- 步骤
    1. 查询退款中的代扣渠道
    ```sql
    SELECT
        t.pd_order_id,
        t.chan_no 
    FROM
        EMSS_PFC.pd_order t 
    WHERE
        ddct_strt_date BETWEEN to_date (今天开始时间) 
        AND to_date (今天结束时间) 
        AND EXISTS (
        SELECT
            1 
        FROM
            EMSS_PFC.pd_acct a 
        WHERE
            a.in_trnst_ym >= 两个月前的日期 ( yyyyMM ) 
            AND a.pd_order_id = t.pd_order_id 
            AND a.fail_reason = 'F00001' 
        ) 
        AND ddct_mode = '03'
    ```
    2. 查询整合之后的debit信息

    ```sql
    select * from fact_debit where sta_date = (当前日期 yyyy-MM-dd)
    ```
    3. 批量更新退款中代扣包数
    ```sql
    <foreach collection="list" separator=";" item="fact">
        update fact_debit
        <set>
            <if test="fact.outgoingCnt != null">
                outgoing_cnt = #{fact.outgoingCnt},
            </if>
            <if test="fact.outgoingUsersCnt != null">
                outgoing_users_cnt = #{fact.outgoingUsersCnt},
            </if>
            <if test="fact.outgoingReturnCnt != null">
                outgoing_return_cnt = #{fact.outgoingReturnCnt},
            </if>
            <if test="fact.debitSuccessRate != null">
                debit_success_rate = #{fact.debitSuccessRate},
            </if>
            <if test="fact.returnCnt != null">
                return_cnt = #{fact.returnCnt},
            </if>
            <if test="fact.debitsAmountMonth != null">
                debits_amount_month = #{fact.debitsAmountMonth},
            </if>
            <if test="fact.debitsCntMonth != null">
                debits_cnt_month = #{fact.debitsCntMonth},
            </if>
            <if test="fact.updateTime != null">
                update_time = #{fact.updateTime}
            </if>
        </set>
        <where>
            <if test="fact.staDate != null">
                sta_date = #{fact.staDate}
            </if>
            <if test="fact.channelCode != null and fact.channelCode != ''">
                and channel_code = #{fact.channelCode}
            </if>
        </where>
    </foreach>
    ```

## debitChart
- 数据库:
    - fact_debit 代扣汇总表
- 路径： /member/debitMonitor/debitChart  
- HTTP请求方式：post
### 趋势图
- factDebitMapper.getTrendChart
    ```sql
        <if test="indexType != 'wkOrders95598Cnt' ">
            select
            <include refid="debitChart"/>
            f.sta_date
            from fact_debit f
            where
            f.sta_date between #{startDate} and #{endDate}
            group by f.sta_date
            order by f.sta_date
        </if>
    ```
    ```sql
        <if test="indexType == 'wkOrders95598Cnt' ">
            select
            count(*) as index_value,
            f.sta_date
            from fact_debit_wk f
            where
            f.sta_date between #{startDate} and #{endDate}
            group by f.sta_date
            order by f.sta_date
        </if>
    ```

## wkOrders95598Cnt
- factDebitWkMapper.queryGroupByOrg
    ```sql
        select
            mgt_org_code,
            count(*) as cnt
        FROM
            fact_debit_wk
        WHERE
            sta_date = #{staDate}
        <if test="mgtChannelCode != null and mgtChannelCode != ''">
            and channel_code = #{mgtChannelCode}
        </if>
        GROUP BY
            mgt_org_code
    ```
- factDebitWkMapper.queryGroupByChannel
    ```sql
        select
            channel_code,
            count(*) as cnt
        FROM
            fact_debit_wk
        WHERE
            sta_date = #{staDate}
        <if test="mgtOrgCode != null and mgtOrgCode != ''">
            and mgt_org_code = #{mgtOrgCode}
        </if>
        GROUP BY
            channel_code
    ```

## 翻译渠道名称 queryChannelTypeName

### 获得一级分类渠道map
- factDebitErrorService.getFirstLevelChannelMap
    ```sql
        select
            SUBSTR(archive.CHANNEL_NO,0,5) as channelNo,
            config.config_name as channelName
        from EMSS_PSERV.ocs_channel_archive archive
                    left join EMSS_PSERV.ocs_system_config config on config.config_value = archive.system_no
        where config.enable_flag = '01'
            and config.config_type = 'SystemNo'
            and config.data_type = '01'
        GROUP BY
            SUBSTR(archive.CHANNEL_NO,0,5),
            config.config_name
        ORDER BY SUBSTR(archive.CHANNEL_NO,0,5)
    ```

- 翻译组织名称 queryOrgName
- mgtOrgMapper.queryOrgName
    ```sql
        SELECT
            mgt_org_chn_abbr1 
        FROM
            emss_cmc.MGT_ORG 
        WHERE
            MGT_ORG_CODE = #{mgtOrgCode,jdbcType=VARCHAR} and dist_lv = '03' and mgt_org_type = 'corp'
    ```

- factDebitMapper.debitChartByOrg
    ```sql
        select
        <include refid="debitChart"/>
        f.mgt_org_code
        from fact_debit f
        where
        <if test="indexType == 'debitsCntMonth' ">
            f.sta_date between #{startDate} and #{endDate}
        </if>
        <if test="indexType != 'debitsCntMonth' ">
            f.sta_date = #{staDate}
        </if>
        group by f.mgt_org_code
        order by f.mgt_org_code
    ```

- factDebitMapper.debitChartByOrgToChannel
    
    ```sql
        select
        <include refid="debitChart"/>
        f.channel_code
        from fact_debit f
        where
        <if test="indexType == 'debitsCntMonth' ">
            f.sta_date between #{startDate} and #{endDate}
        </if>
        <if test="indexType != 'debitsCntMonth' ">
            f.sta_date = #{staDate}
        </if>
        and f.mgt_org_code = #{mgtOrgCode}
        group by f.channel_code
        order by f.channel_code
    ```
    ```sql
- factDebitMapper.debitChartByChannel
        select
        <include refid="debitChart"/>
        LEFT(f.channel_code,5) as channel_code
        from fact_debit f
        where
        <if test="indexType == 'debitsCntMonth' ">
            f.sta_date between #{startDate} and #{endDate}
        </if>
        <if test="indexType != 'debitsCntMonth' ">
            f.sta_date = #{staDate}
        </if>
        group by LEFT(f.channel_code,5)
        order by LEFT(f.channel_code,5)
    ```

- factDebitMapper.debitChartByChannelToOrg
    ```sql
        select
        <include refid="debitChart"/>
        f.mgt_org_code
        from fact_debit f
        where
        <if test="indexType == 'debitsCntMonth' ">
            f.sta_date between #{startDate} and #{endDate}
        </if>
        <if test="indexType != 'debitsCntMonth' ">
            f.sta_date = #{staDate}
        </if>
        and LEFT(f.channel_code,5) = #{mgtChannelCode}
        group by f.mgt_org_code
        order by f.mgt_org_code
    ```


## 代扣失败情况柱状图
- 数据库表：
    - fact_debit_error  代扣失败汇总表  MySQL表
- 路径： /member/debitMonitor/debitErrorColumn   
- HTTP请求方式：post

- factDebitErrorMapper.queryOrgError
    ```sql
        select
            mgt_org_code as mgtOrgCode,
            mgt_org_name as mgtOrgName,
            sum(cnt) as indexValue
        FROM fact_debit_error t
        WHERE
            sta_date = #{staDate}
        <if test="errorCode != null and errorCode != ''">
            and t.error_code = #{errorCode}
        </if>
        group by mgt_org_code,mgt_org_name
        order by mgtOrgName
    ```

    - factDebitErrorMapper.queryChannelErrorByOrg

### 代扣失败汇总表   RDS表
    ```sql
        select
        channel_code as channelCode,
        channel_name as channelName,
        sum(cnt) as indexValue
        FROM fact_debit_error t
        WHERE
        sta_date = #{staDate}
        <if test="errorCode != null and errorCode != ''">
            and t.error_code = #{errorCode}
        </if>
        <if test="mgtOrgCode != null and mgtOrgCode != ''">
            and t.mgt_org_code = #{mgtOrgCode}
        </if>
        <if test="errorCode != null and errorCode != ''">
            and t.error_code = #{errorCode}
        </if>
        group by channel_code,channel_name
        order by channel_name
    ```

- factDebitErrorMapper.queryChannelError
    ```sql
        select
        channel_type as channelCode,
        channel_type_name as channelName,
        sum(cnt) as indexValue
        FROM fact_debit_error t
        WHERE
        sta_date = #{staDate}
        <if test="errorCode != null and errorCode != ''">
            and t.error_code = #{errorCode}
        </if>
        <if test="mgtChannelCode != null and mgtChannelCode != ''">
            and t.channel_code = #{mgtChannelCode}
        </if>
        <if test="errorCode != null and errorCode != ''">
            and t.error_code = #{errorCode}
        </if>
        group by channel_type,channel_type_name
        order by channel_type_name
    ```

- factDebitErrorMapper.queryOrgErrorByChannel
    ```sql
        select
        mgt_org_code as mgtOrgCode,
        mgt_org_name as mgtOrgName,
        sum(cnt) as indexValue
        FROM fact_debit_error t
        WHERE
        sta_date = #{staDate}
        <if test="errorCode != null and errorCode != ''">
            and t.error_code = #{errorCode}
        </if>
        <if test="mgtChannelCode != null and mgtChannelCode != ''">
            and LEFT(t.channel_code,5) = #{mgtChannelCode}
        </if>
        <if test="errorCode != null and errorCode != ''">
            and t.error_code = #{errorCode}
        </if>
        group by mgt_org_code,mgt_org_name
        order by mgt_org_name
    ```

## 代扣失败情况雷达图
- 数据库表：
    - fact_debit_error  代扣失败汇总表  MySQL表
- 路径： /member/debitMonitor/debitErrorRadar   
- HTTP请求方式：post

- factDebitErrorMapper.queryGroup
    ```sql
    select
        error_code as errorCode,
        error_name as errorName,
        sum(cnt) as cnt
    FROM fact_debit_error
    WHERE
        sta_date = #{staDate}
    group by error_code,error_name
    order by error_code
    ```

## 代扣异常异常用户数-列表信息
- 数据库表：
    - fact_debit_error  代扣失败汇总表  MySQL表
- 路径： /member/debitMonitor/debitErrorUsersList   
- HTTP请求方式：post

- factDebitErrorMapper.queryList
    ```sql
        select
            channel_code,
            channel_name,
            error_code,
            error_name,
            sum(cnt) as cnt
        FROM fact_debit_error
        WHERE
            sta_date = #{staDate}
        group by channel_code,channel_name,error_code,error_name
        order by error_code,cnt,channel_code
    ```

代扣异常异常用户数-汇总
/member/debitMonitor/debitErrorUsersOverview

factDebitErrorMapper.queryGroup
        select
            error_code as errorCode,
            error_name as errorName,
            sum(cnt) as cnt
        FROM fact_debit_error
        WHERE
            sta_date = #{staDate}
        group by error_code,error_name
        order by error_code

------------------------------------------------------------------------

debitOverview
/member/debitMonitor/debitOverview

factDebitMapper.debitOverview
  select
        <include refid="debitOverview"/>
        from
        fact_debit
        where sta_date = #{staDate}
factDebitMapper.lastMonthAvg
        select config_value
        from pfc_system_config
        where kind = 'debitsAvgCntMonth'
          and code = '01'
          and is_valid = '1'
factDebitMapper.selectCntAndAmtByMonth
        select sum(debits_cnt_month ) debitsCntMonth
        from fact_debit
        where sta_date between #{startDate} and #{endDate}
factDebitWkMapper.queryCnt

        select
            count(*) as cnt
        FROM fact_debit_wk
        WHERE
            sta_date = #{staDate}
-----------------------------------------------
## 代扣工单-列表信息

- 数据库表：
    - fact_debit_error  代扣失败汇总表  MySQL表
- 路径： /member/debitMonitor/debitWkList   
- HTTP请求方式：post

- factDebitWkMapper.queryList

    ```sql
    SELECT
        * 
    FROM
        fact_debit_wk < WHERE > < IF test = "debitWk.busiType != null and debitWk.busiType != ''" > 
        AND busi_type = #{debitWk.busiType}
        </ IF > < IF test = "debitWk.mgtOrgCode != null and debitWk.mgtOrgCode != ''" > 
        AND mgt_org_code = #{debitWk.mgtOrgCode}
        </ IF > < IF test = "debitWk.staDate != null" > 
        AND sta_date = #{debitWk.staDate}
        </ IF > </ WHERE > 
    ORDER BY
        handle_time DESC
    ```
获得一级渠道分类结果集
factDebitErrorService.getFirstLevelChannelMap
获得地市部门
factDebitErrorService.getDistrictOrgs
------------------------------------------------------------------------
## 工单指标查询

- 数据库表：
    - fact_debit_wk  代扣工单关联表  MySQL
- 路径： /member/debitMonitor/debitWkSubIndex  
- HTTP请求方式：post


- factDebitWkMapper.querySubIndex
    ```sql
        select
            busi_type,
            count(*) as cnt
        FROM fact_debit_wk
        WHERE
            sta_date = #{staDate}
        group by busi_type
        order by busi_type
    ```


## 疑似重复缴费详情

- 数据库表：
    - fact_debit_wk  代扣工单关联表  MySQL
    - fact_duplicate_charge 
- 路径： /member/debitMonitor/duplicateChargeList 
- HTTP请求方式：post


- factDuplicateChargeMapper.selectByChannelCode
    ```sql
    select * from fact_duplicate_charge where sta_date = #{staDate} and debit_channel_no in
    <foreach collection="list" item="channelCode" separator="," open="(" close=")">
        #{channelCode}
    </foreach>
    ```

疑似重复缴费汇总
/member/debitMonitor/duplicateChargeOverview

factDuplicateChargeMapper.selectDuplicateChargeOverview

        SELECT debit_channel_no, debit_channel_name, COUNT(debit_channel_no) AS summaryCnt FROM fact_duplicate_charge
        WHERE sta_date = #{charger.staDate}
        GROUP BY debit_channel_no, debit_channel_name ORDER BY summaryCnt DESC, debit_channel_no DESC LIMIT 3

debitRangeConfigMapper.queryList
        select
        <include refid="Base_Column_List"/>
        FROM debit_range_config t
        WHERE 1=1
        <include refid="debit_range_config_condition"></include>

--------------------------------------------------------------------------

工单-列表查询
/member/debitMonitor/queryOrderPage




工单-工单类型
/member/debitMonitor/queryOrderType




工单-地市列表
/member/debitMonitor/queryOrgs




模拟发送MQ工单消息
/member/debitMonitor/testMqSendMsg
传递方式：get
factDebitWkMapper.querySubIndex
        select
            busi_type,
            count(*) as cnt
        FROM fact_debit_wk
        WHERE
            sta_date = #{staDate}
        group by busi_type
        order by busi_type
-------------------------------------------------------
## Order2DebitError30MinJob  
- 定时加工到 fact_debit_error 表，用于展示代扣失败，按天存储，周期性覆盖

-  queryFailReasonGroup 分组汇总代扣失败信息
```sql
SELECT
	ttt.chanNo,
	( SELECT chan_name FROM EMSS_PFC.PAY_CHAN pc WHERE pc.chan_no = ttt.chanNo ) AS chanName,
	ttt.mgtOrgCode,
	ttt.failReason,
	SUM( ttt.CNT ) AS CNT 
FROM
	(
	SELECT
		tt.chanNo,
		tt.mgtOrgCode,
	CASE
			
			WHEN tt.failReason NOT IN ( 'A1', 'B1', 'C1' ) THEN
			'E1' ELSE tt.failReason 
		END AS failReason,
		tt.CNT 
	FROM
		(
		SELECT
			a.CHAN_NO AS chanNo,
			a.MGT_ORG_CODE AS mgtOrgCode,
			SUBSTR( t.fail_reason, 1, 2 ) AS failReason,
			COUNT( t.cust_no ) AS CNT 
		FROM
			emss_pfc.pd_acct t,
			emss_pfc.pd_order a 
		WHERE
			ddct_strt_date BETWEEN to_date (今天开始时间, 'yyyy-MM-dd hh24:mi:ss' ) 
			AND to_date (今天结束时间, 'yyyy-MM-dd hh24:mi:ss' ) 
			AND a.ddct_mode = '03' 
			AND t.in_trnst_ym >= TO_CHAR ( ADD_MONTHS ( TO_DATE ( 3天前的开始时间 )), 'yyyyMM' ) 
			AND t.fail_reason != '000000' 
			AND t.PD_ORDER_ID = a.PD_ORDER_ID 
			AND CHAN_NO LIKE 'D%' 
		GROUP BY
			a.CHAN_NO,
			a.MGT_ORG_CODE,
			SUBSTR( t.fail_reason, 1, 2 ) 
		) tt 
	) ttt 
GROUP BY
	ttt.chanNo,
	ttt.mgtOrgCode,
	ttt.failReason
```
-  queryFirstLevelChannel   获得一级渠道分类结果集
```sql
SELECT
	SUBSTR( archive.CHANNEL_NO, 0, 5 ) AS channelNo,
	config.config_name AS channelName 
FROM
	EMSS_PSERV.ocs_channel_archive archive
	LEFT JOIN EMSS_PSERV.ocs_system_config config ON config.config_value = archive.system_no 
WHERE
	config.enable_flag = '01' 
	AND config.config_type = 'SystemNo' 

AND config.data_type = '01'
GROUP BY
	SUBSTR( archive.CHANNEL_NO, 0, 5 ),
	config.config_name 
ORDER BY
	SUBSTR(
		archive.CHANNEL_NO,0,5)
```

-  queryDistrictOrgs 获得地市部门
```sql
SELECT
	mgt_org_code AS mgtOrgCode,
	mgt_org_chn_abbr1 AS mgtOrgName 
FROM
	emss_cmc.mgt_org 
WHERE
	dist_lv = '03' 
	AND mgt_org_type = 'corp' 
	AND mgt_org_code LIKE '32%'
```
- 批量更新 fact_debit_error
- 批量新增 fact_debit_error
-  存储redis
- 每分钟定时整合代扣数据异常 fact_debit_error

---------------------------------------------------------

## Order2DebitErrorDayJob
- 按天定时加工到 fact_debit_error 表，用于展示多次代扣失败的汇总数据，按天存储，周期性覆盖


- getPfcSystemConfigByKey 根据ID获取收费业务全局配置
    ```sql
    select
    <include refid="Base_Column_List"/>
    FROM pfc_system_config t
    WHERE t.kind = #{kind} and t.code = #{code}
    ```

- 分组汇总代扣失败信息-多次扣款失败
```sql
SELECT
	cust.chanNo,
	( SELECT chan_name FROM EMSS_PFC.PAY_CHAN pc WHERE pc.chan_no = cust.chanNo ) AS chanName,
	cust.mgtOrgCode,
	count( cust.CUST_NO ) AS CNT 
FROM
	(
	SELECT
		t.CUST_NO,
		a.CHAN_NO AS chanNo,
		a.MGT_ORG_CODE AS mgtOrgCode,
		COUNT( t.cust_no ) AS CNT 
	FROM
		emss_pfc.pd_acct t,
		emss_pfc.pd_order a 
	WHERE
		ddct_strt_date BETWEEN to_date (当月一号, 'yyyy-MM-dd hh24:mi:ss' ) 
		AND to_date (今天结束时间, 'yyyy-MM-dd hh24:mi:ss' ) 
		AND a.ddct_mode = '03' 
		AND t.in_trnst_ym >= TO_CHAR (
			ADD_MONTHS (
				TO_DATE (向前推三天, 'yyyyMM' ) 
				AND t.fail_reason != '000000' 
				AND t.PD_ORDER_ID = a.PD_ORDER_ID 
				AND CHAN_NO LIKE 'D%' 
			GROUP BY
				t.CUST_NO,
				a.CHAN_NO,
				a.MGT_ORG_CODE 
			HAVING
				COUNT( t.cust_no ) >= #{order.failedCnt}
				
			) cust 
		GROUP BY
		cust.chanNo,
	cust.mgtOrgCode
```
    
- 获得一级分类渠道map
- 获得地市部门map
- 批量更新 fact_debit_error
- 批量新增 fact_debit_error
- 存储redis

----------------------------------------------

## Order2DebitPerOneMinJob

- selectList  按条件查询订单信息
```sql
SELECT
	* 
FROM
	EMSS_PFC.pd_order 
WHERE
	ddct_strt_date BETWEEN to_date (今天开始时间, 'yyyy-MM-dd hh24:mi:ss' ) 
	AND to_date (今天结束时间, 'yyyy-MM-dd hh24:mi:ss' ) 
	AND ddct_mode = '03'
```
-  入库
- factDebitMapper 批量更新   fact_debit
- factDebitMapper 批量新增   fact_debit

------------------------------------------------------

## SuspectedRepeatDkJob

-   查询重复交费  selectSuspectRepeatPay
```sql
SELECT DISTINCT
	t1.cust_no custNo,
	t1.shd_ddct_amt inTrnstAmt,
	ca.charg_amt chargAmt,
	t.chan_no debitChannelNo,
	( SELECT chan_name FROM emss_pfc.pay_chan n WHERE n.chan_no = t.chan_no ) debitChannelName,
	ca.chan_no chargeChannelCode,
	( SELECT chan_name FROM emss_pfc.pay_chan pc WHERE pc.chan_no = ca.chan_no AND rownum = 1 ) chargeChannelName,
	t.ddct_acmp_date ddctAcmpDate,
	ca.charg_date chargDate,
	t.fail_reason failReason 
FROM
	emss_pfc.pd_order t,
	emss_pfc.pd_acct t1,
	emss_pfc.charg_acct ca 
WHERE
	t.ddct_strt_date >= to_date (今天日期, 'yyyy-mm-dd' ) 
	AND t.ddct_strt_date < to_date (明天日期, 'yyyy-mm-dd' ) 
	AND t1.fail_reason IN ( 'F19999', 'F00001', 'F00000' ) 
	AND ca.charg_date & gt;= to_date (今天日期, 'yyyy-mm-dd' ) 
AND ca.charg_date & lt;
to_date (明天日期, 'yyyy-mm-dd' ) 
AND ca.charg_date & lt;
t.ddct_acmp_date 
AND t1.in_trnst_ym > (两个月前的日期, 'yyyyMM' ) 
AND ca.cust_no = t1.cust_no 
AND t1.shd_ddct_amt = ca.charg_amt 
AND t1.pd_order_id = t.pd_order_id 
AND ca.charg_ym = (今天日期, 'yyyyMM' ) 
AND t.ddct_mode = '03' 
AND ca.charg_type IN ('0101')
```


- 删除 fact_duplicate_charge 记录
    ```sql
    DELETE FROM
	fact_duplicate_charge 
    WHERE sta_date = #{charge.staDate}
    ```

- 疑似重复代扣数据插入成功，影响行数  insertBatch
    ```sql
    insert into fact_duplicate_charge (sta_date,cust_no,in_trnst_amt,charg_amt,debit_channel_no,debit_channel_name,charge_channel_code,charge_channel_name,ddct_acmp_date,charg_date,debit_gap,fail_reason,create_time)
    values
    <foreach collection="list" item="charge" separator=",">
        (#{charge.staDate},#{charge.custNo},#{charge.inTrnstAmt},#{charge.chargAmt},#{charge.debitChannelNo},#{charge.debitChannelName},
            #{charge.chargeChannelCode},#{charge.chargeChannelName},#{charge.ddctAcmpDate},#{charge.chargDate},#{charge.debitGap},#{charge.failReason},#{charge.createTime})
    </foreach>
    ```