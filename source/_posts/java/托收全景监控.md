---
title: 托收全景监控
category: JAVA
tag: 项目开发
abbrlink: 24593
date: 2024-04-07 11:10:00
---

# 托收全景监控

## 总览

- ![托收全景监控图第一版](/img/能源互联网/托收全景监控图第一版.png)

## 总体情况


## 托收投诉意见监控
### 总体预览图
- ![托收投诉意见监控](/img/能源互联网/托收投诉意见监控.png)




## 托收异常情况


## 托收时间监控
- ![托收时间监控](/img/能源互联网/托收时间监控.png)

### 分析阶段
- 全渠道收费渠道运维日报sql-v2.3

    1. 收费日报汇总分析
        - 提供的原始 sql 语句
        ```sql
        SELECT
            '今日0点到18点，全渠道收费渠道共产生交易' ||
        CASE
                WHEN count( 1 )> 10000 THEN
                to_char ( round( count( 1 )/ 10000, 2 ), 'FM999999990.00' )|| '万笔' ELSE count( 1 )|| '笔' 
            END || '、金额' ||
        CASE   
                WHEN sum( a.charg_amt )> 100000000 THEN
                to_char ( round( sum( a.charg_amt )/ 100000000, 2 ), 'FM999999990.00' )|| '亿元' 
                WHEN sum( a.charg_amt )> 10000 THEN
                to_char ( round( sum( a.charg_amt )/ 10000, 2 ), 'FM999999990.00' )|| '万元' ELSE sum( a.charg_amt )|| '元' 
            END || '。' AS "收费日报汇总" 
        FROM
            emss_pfc.charg_acct a 
        WHERE
            a.charg_ym = to_char ( sysdate, 'yyyyMM' ) 
            AND a.charg_date >= trunc ( sysdate ) 
            AND a.charg_date <= to_date ( to_char ( sysdate, 'yyyy-MM-dd' ) || ' 18:00:00', 'yyyy-MM-dd hh24:MI:ss' ) 
            AND a.cap_no LIKE 'D%';
        ```
        - 分析结果
            1. 涉及表名：emss_pfc.charg_acct

            2. 查询内容：该查询用于统计从今天零点到今天下午六点 (18:00) 之间，特定渠道产生的收费交易总量和总金额。具体来说，它计算了满足以下条件的收费记录：
                - charg_ym = to_char ( sysdate, 'yyyyMM' )：收费年月与当前日期年月相同
                - charg_date >= trunc ( sysdate )：收费日期大于等于今天的零点
                - charg_date <= to_date ( to_char ( sysdate, 'yyyy-MM-dd' ) || ' 18:00:00', 'yyyy-MM-dd hh24:MI:ss' )：收费日期小于等于今天的下午六点
                - cap_no LIKE 'D%'：渠道编号以 'D' 开头

            3. 使用的函数：
                - count(1)：用于统计符合条件的记录数量
                - sum(a.charg_amt)：用于计算符合条件的记录中收费金额的总和
                - to_char()：用于将数值转换为字符串，并指定格式
                - round()：用于对数值进行四舍五入取整
                - 查询结果：查询结果被取名为 "收费日报汇总"，它包括了两个部分：交易总量和总金额。交易总量根据数量的大小，可能会以 "万笔" - 或者 "笔" 作为单位显示；总金额根据金额的大小，可能会以 "亿元"、"万元" 或者 "元" 作为单位显示。

    2. 代扣运维数据分析
        - 提供的原始 sql 语句
        ```sql
        SELECT
            '代扣业务出盘' || count( t.pd_order_id )|| '个地市渠道，共' ||
        CASE            
                WHEN sum( t.ddct_t_num )> 10000 THEN
                to_char ( round( sum( t.ddct_t_num )/ 10000, 2 ), 'FM999999990.00' )|| '万笔' ELSE sum( t.ddct_t_num )|| '笔' 
            END || '电费、金额' ||
        CASE              
                WHEN sum( t.ddct_t_amt )> 100000000 THEN
                to_char ( round( sum( t.ddct_t_amt )/ 100000000, 2 ), 'FM999999990.00' )|| '亿元' 
                WHEN sum( t.ddct_t_amt )> 10000 THEN
                to_char ( round( sum( t.ddct_t_amt )/ 10000, 2 ), 'FM999999990.00' )|| '万元' ELSE sum( t.ddct_t_amt )|| '元' 
                END || '，回盘' || count(
                decode( t.ddct_stat, '02', '1', NULL ))|| '个地市渠道（锁定在途' || (
                count( t.pd_order_id )- count(
                decode( t.ddct_stat, '02', '1', NULL )))|| '个、退款中' || (
            SELECT
                count( 1 ) 
            FROM
                emss_pfc.pd_acct n 
            WHERE
                n.pd_order_id IN ( SELECT o.pd_order_id FROM emss_pfc.pd_order o WHERE o.ddct_strt_date >= trunc ( sysdate ) AND o.ddct_mode = '03' ) 
                AND n.fail_reason IN ( 'F00001' ))|| '笔），' || '代扣成功' ||(
            SELECT
            CASE
                    
                WHEN
                    count( 1 )> 10000 THEN
                        to_char ( round( count( 1 )/ 10000, 2 ), 'FM999999990.00' )|| '万笔' ELSE count( 1 )|| '笔' 
                        END || '、金额' ||
                CASE
                        
                        WHEN sum( n.charg_amt )> 100000000 THEN
                        to_char ( round( sum( n.charg_amt )/ 100000000, 2 ), 'FM999999990.00' )|| '亿元' 
                        WHEN sum( n.charg_amt )> 10000 THEN
                        to_char ( round( sum( n.charg_amt )/ 10000, 2 ), 'FM999999990.00' )|| '万元' ELSE sum( n.charg_amt )|| '元' 
                    END 
                    FROM
                        emss_pfc.charg_acct n 
                    WHERE
                        n.charg_ym = to_char ( sysdate, 'yyyyMM' ) 
                        AND n.charg_date >= trunc ( sysdate ) 
                        AND n.charg_date <= to_date ( to_char ( sysdate, 'yyyy-MM-dd' ) || ' 18:00:00', 'yyyy-MM-dd hh24:MI:ss' ) 
                        AND n.cap_no LIKE '%PLDK%' 
                        )|| '，成功率约' ||(
                    CASE
                            
                            WHEN round( 100 * sum( decode( t.ddct_stat, '02', t.actl_ddct_t_num, '0' )) / sum( t.ddct_t_num ), 2 )>= 1 THEN
                            to_char (
                                round( 100 * sum( decode( t.ddct_stat, '02', t.actl_ddct_t_num, '0' )) / sum( t.ddct_t_num ), 2 ),
                                'FM999999990.00' 
                                ) ELSE to_char (
                                round( 100 * sum( decode( t.ddct_stat, '02', t.actl_ddct_t_num, '0' )) / sum( t.ddct_t_num ), 2 ),
                                'FM999999990D99' 
                            ) 
                        END || '%。' 
                    ) AS "代扣运维日报" 
                FROM
                    emss_pfc.pd_order t 
                WHERE
                    t.ddct_strt_date >= trunc ( sysdate ) 
                    AND t.ddct_strt_date <= to_date ( to_char ( sysdate, 'yyyy-MM-dd' ) || ' 18:00:00', 'yyyy-MM-dd hh24:MI:ss' ) 
                    AND t.ddct_mode = '03' 
            GROUP BY
            t.ddct_mode;
        ```

    3. 代收运维数据
        ```sql
        WITH total AS (
            SELECT
                count( 1 ) AS all_count,
            CASE
                    
                    WHEN sum( a.charg_amt )> 100000000 THEN
                    to_char ( round( sum( a.charg_amt )/ 100000000, 2 ), 'FM999999990.00' )|| '亿元' 
                    WHEN sum( a.charg_amt )> 10000 THEN
                    to_char ( round( sum( a.charg_amt )/ 10000, 2 ), 'FM999999990.00' )|| '万元' ELSE sum( a.charg_amt )|| '元' 
                END AS sum_amt,
            CASE
                    
                    WHEN count( 1 )> 10000 THEN
                    to_char ( round( count( 1 )/ 10000, 2 ), 'FM999999990.00' )|| '万笔' ELSE count( 1 )|| '笔' 
                END AS sum_count 
            FROM
                emss_pfc.charg_acct a 
            WHERE
                a.charg_ym = to_char ( sysdate, 'yyyyMM' ) 
                AND a.charg_date >= trunc ( sysdate ) 
                AND a.charg_date <= to_date ( to_char ( sysdate, 'yyyy-MM-dd' ) || ' 18:00:00', 'yyyy-MM-dd hh24:MI:ss' ) 
                AND a.cap_no LIKE 'D%CZ%' 
            ),
            zfb AS (
            SELECT
                count( 1 ) AS zfb_count,
            CASE
                    
                    WHEN count( 1 )> 10000 THEN
                    to_char ( round( count( 1 )/ 10000, 2 ), 'FM999999990.00' )|| '万笔' ELSE count( 1 )|| '笔' 
                END || '、' AS zfb_sum 
            FROM
                emss_pfc.charg_acct a 
            WHERE
                a.charg_ym = to_char ( sysdate, 'yyyyMM' ) 
                AND a.charg_date >= trunc ( sysdate ) 
                AND a.charg_date <= to_date ( to_char ( sysdate, 'yyyy-MM-dd' ) || ' 18:00:00', 'yyyy-MM-dd hh24:MI:ss' ) 
                AND a.cap_no LIKE 'DZFB32%CZ%' 
            ),
            wxgd AS (
            SELECT
                count( 1 ) AS wxgd_count,
            CASE
                    
                    WHEN count( 1 )> 10000 THEN
                    to_char ( round( count( 1 )/ 10000, 2 ), 'FM999999990.00' )|| '万笔' ELSE count( 1 )|| '笔' 
                END || '、' AS wxgd_sum 
            FROM
                emss_pfc.charg_acct a 
            WHERE
                a.charg_ym = to_char ( sysdate, 'yyyyMM' ) 
                AND a.charg_date >= trunc ( sysdate ) 
                AND a.charg_date <= to_date ( to_char ( sysdate, 'yyyy-MM-dd' ) || ' 18:00:00', 'yyyy-MM-dd hh24:MI:ss' ) 
                AND a.cap_no LIKE 'DWX32%CZ%' 
            ),
            wxdeb AS (
            SELECT
                count( 1 ) AS wxdeb_count,
            CASE
                    
                    WHEN count( 1 )> 10000 THEN
                    to_char ( round( count( 1 )/ 10000, 2 ), 'FM999999990.00' )|| '万笔' ELSE count( 1 )|| '笔' 
                END || '、' AS wxdeb_sum 
            FROM
                emss_pfc.charg_acct a 
            WHERE
                a.charg_ym = to_char ( sysdate, 'yyyyMM' ) 
                AND a.charg_date >= trunc ( sysdate ) 
                AND a.charg_date <= to_date ( to_char ( sysdate, 'yyyy-MM-dd' ) || ' 18:00:00', 'yyyy-MM-dd hh24:MI:ss' ) 
                AND a.cap_no LIKE 'DDEB32%CZ%' 
            ) SELECT
            '代收业务销账成功' || t.sum_count || '、金额' || t.sum_amt || '，其中支付宝' || zfb.zfb_sum || '占比' || round( zfb.zfb_count / t.all_count * 100, 2 )|| '%，' || '微信(光大)' || wxgd.wxgd_sum || '占比' || round( wxgd.wxgd_count / t.all_count * 100, 2 )|| '%，' || '微信(电e宝)' || wxdeb.wxdeb_sum || '占比' || round( wxdeb.wxdeb_count / t.all_count * 100, 2 )|| '%。' AS "代收运维日报" 
        FROM
            total t
            CROSS JOIN zfb
            CROSS JOIN wxgd
            CROSS JOIN wxdeb;
        ```

### [托收]{.rainbow}运维数据
- 提供的原始 sql 语句
    ```sql
    SELECT
        '托收业务共发送' ||
    CASE              
            WHEN count( 1 ) > 10000 THEN
            to_char ( round( count( 1 ) / 10000, 2 ), 'FM999999990.00' ) || '万笔' ELSE count( 1 ) || '笔' 
        END || '、金额' ||
    CASE       
            WHEN sum( t.actl_ddct_t_amt ) > 100000000 THEN
            to_char ( round( sum( t.actl_ddct_t_amt ) / 100000000, 2 ), 'FM999999990.00' ) || '亿元' 
            WHEN sum( t.actl_ddct_t_amt ) > 10000 THEN
            to_char ( round( sum( t.actl_ddct_t_amt ) / 10000, 2 ), 'FM999999990.00' ) || '万元' ELSE sum( t.actl_ddct_t_amt ) || '元' 
        END || '，' AS "托收运维日报 - 发送、销账、在途" 
    FROM
        emss_pfc.pd_order t 
    WHERE
        t.ddct_strt_date >= trunc ( sysdate ) 
        AND t.ddct_strt_date <= to_date ( to_char ( sysdate, 'yyyy-MM-dd' ) || ' 18:00:00', 'yyyy-MM-dd hh24:MI:ss' ) 
        AND t.ddct_mode = '0204' 
    GROUP BY
        t.ddct_mode 
        
        UNION ALL

    SELECT
        '销账成功' ||
    CASE
            WHEN count( 1 ) > 10000 THEN
            to_char ( round( count( 1 ) / 10000, 2 ), 'FM999999990.00' ) || '万笔' ELSE count( 1 ) || '笔' 
        END || '、金额' ||
    CASE
            WHEN sum( a.charg_amt ) > 100000000 THEN
            to_char ( round( sum( a.charg_amt ) / 100000000, 2 ), 'FM999999990.00' ) || '亿元' 
            WHEN sum( a.charg_amt ) > 10000 THEN
            to_char ( round( sum( a.charg_amt ) / 10000, 2 ), 'FM999999990.00' ) || '万元' ELSE sum( a.charg_amt ) || '元' 
        END || '，' AS "托收运维日报 - 销账" 
    FROM
        emss_pfc.charg_acct a
        INNER JOIN emss_pfc.pay_chan b ON b.chan_no = a.chan_no 
    WHERE
        a.charg_ym = to_char ( sysdate, 'yyyyMM' ) 
        AND a.charg_date >= trunc ( sysdate ) 
        AND a.charg_date <= to_date ( to_char ( sysdate, 'yyyy-MM-dd' ) || ' 18:00:00', 'yyyy-MM-dd hh24:MI:ss' ) 
        AND a.cap_no LIKE b.chan_no || 'DZTS%' 
        
        UNION ALL

    SELECT
        '锁定在途' || count( 1 ) || '笔。' AS "托收运维日报 - 锁定在途" 
    FROM
        emss_pfc.pd_order a
        INNER JOIN emss_pfc.pay_chan b ON b.chan_no = a.chan_no 
    WHERE
        a.ddct_stat = '01' 
        AND a.ddct_mode = '0204' 
        AND a.ddct_strt_date >= trunc ( sysdate ) 
        AND a.ddct_strt_date <= to_date ( to_char ( sysdate, 'yyyy-MM-dd' ) || ' 18:00:00', 'yyyy-MM-dd hh24:MI:ss' );
    ```
- 分析结果
    - 涉及表名：
        1. emss_pfc.pd_order：批扣订单表，包含了代扣业务的订单信息。 [oracle DB3]{.label}
        ```sql
        CREATE TABLE `pd_order` (
        `pd_order_id` bigint(20) NOT NULL COMMENT '委托扣款单标识是指委托扣款单的唯一标识',
        `ddct_exp_categ` varchar(8) DEFAULT NULL COMMENT '扣款费用类别是指委托扣款的费用类别，引用国家电网公司营销管理代码类集：扣款费用类别，枚举值，如后付费、分次划拨、费控等',
        `ddct_mode` varchar(8) DEFAULT NULL COMMENT '扣款方式是指委托扣款的方式，引用国家电网公司营销管理代码类集：扣款方式，枚举值，如普通托收、电子托收、代扣',
        `chan_no` varchar(32) DEFAULT NULL COMMENT '渠道编号是指渠道对象的唯一编码，此处指委托扣款单关联的渠道',
        `ddct_t_num` bigint(20) DEFAULT NULL COMMENT '扣款总笔数是指委托扣款的总笔数',
        `ddct_t_amt` decimal(18,2) DEFAULT NULL COMMENT '扣款总额是指委托扣款的总金额',
        `ddct_stat` varchar(8) DEFAULT NULL COMMENT '扣款状态是指委托扣款的扣款状态，引用国家电网公司营销管理代码类集：扣款状态，枚举值，如在途、成功、失败',
        `actl_ddct_t_num` bigint(20) DEFAULT NULL COMMENT '实际扣款户数是指实际扣款的总户数',
        `actl_ddct_t_amt` decimal(18,2) DEFAULT NULL COMMENT '实际扣款总额是指实际扣款的总金额',
        `ddct_init` varchar(32) DEFAULT NULL COMMENT '扣款发起人是指委托扣款的发起人员',
        `ddct_strt_date` datetime DEFAULT NULL COMMENT '扣款发起日期是指委托扣款的发起日期',
        `ddct_acmp_date` datetime DEFAULT NULL COMMENT '扣款完成日期是指委托扣款的完成日期',
        `ddct_batch_no` varchar(48) DEFAULT NULL COMMENT '扣款批次号是指委托扣款的批次号',
        `mgt_org_code` varchar(16) DEFAULT NULL COMMENT '管理单位编码是指管理单位的唯一编码，此处是指委托扣款单的管理单位编码',
        `chan_cls` varchar(32) DEFAULT NULL COMMENT '渠道分类是指委托扣款的渠道分类，如工商银行、农业银行等',
        `cap_no` varchar(32) DEFAULT NULL COMMENT '资金编号是指解款记录的唯一编码',
        `agrt_no` varchar(32) DEFAULT NULL COMMENT '协议编号是指委托扣款协议的编号',
        `bank_acct` varchar(32) DEFAULT NULL COMMENT '银行账号是指客户开设的银行账号',
        `fail_reason` varchar(256) DEFAULT NULL COMMENT '失败原因指委托扣款的失败原因',
        `file_name` varchar(512) DEFAULT NULL COMMENT '文件名是指代扣出盘文件的名称',
        `file_id` varchar(64) DEFAULT NULL COMMENT '文档服务器文件唯一标识',
        `ntce_no` varchar(64) DEFAULT NULL COMMENT '记录通知的进账单编号信息，用于资金勾对',
        `pay_main_type` varchar(8) DEFAULT NULL COMMENT '支付账户的支付主体类型，如：财政客户、普通客户。',
        PRIMARY KEY (`pd_order_id`),
        KEY `IDX_PDORDER_CPNO` (`cap_no`),
        KEY `IDX_PDORDER_DDCTBATCHNO` (`ddct_batch_no`),
        KEY `IDX_PD_ORDER_DDCT_STRT_DATE` (`ddct_strt_date`),
        KEY `IDX_PD_ORDER_MGT_ORG_CODE` (`mgt_org_code`)
        ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='委托扣款单是指企业依据委托扣款协议，根据扣款策略，将委托扣款数据发送至委托扣款单位，由委托扣款单位从用户账户中扣划资金并通知企业完成销账的申请单；委托扣款单实体包含扣款费用类别、扣款方式、扣款总笔数、扣款总额、扣款状态、实际扣款笔数、实际扣款总额等属性；由委托扣款出盘业务产生；主要用于记录委托扣款的情况';
        ```
        2. emss_pfc.charg_acct：收费记录表 用于记录交费台账信息 [oracle DB3]{.label}
        ```sql
        CREATE TABLE `charg_acct` (
        `charg_acct_id` bigint(20) NOT NULL COMMENT '交费台账标识是指交费台账的唯一标识',
        `cash_chk_rec_id` bigint(20) DEFAULT NULL COMMENT '解款记录标识是指解款记录的唯一标识',
        `srv_kind` varchar(8) DEFAULT NULL COMMENT '服务种类是指充值卡所属的服务种类，引用国家电网公司营销管理代码类集：服务种类，枚举值，如电类、水类、气类、热类、电动汽车、综合能源',
        `cust_no` varchar(16) DEFAULT NULL COMMENT '客户编号是指客户的唯一编码',
        `charg_ym` varchar(6) DEFAULT NULL COMMENT '收费年月是指该笔交费记录产生时所在的年月，格式为YYYYMM',
        `charg_date` datetime DEFAULT NULL COMMENT '收费日期是指该笔交费记录的收费日期，格式为YYYY/MM/DD HH24:MI:SS',
        `charg_type` varchar(8) DEFAULT NULL COMMENT '收费类型是指该笔交费记录的收费类型，引用国家电网公司营销管理代码类集：收费类型，枚举值，如收费、收电费、收业务费、坏账核销、冲正、冲正电费、冲正业务费、退费、退电费、退业务费、退预收费、内部往来、预收冲抵、退费转预收、电费转预收、预收互转',
        `charg_amt` decimal(18,2) DEFAULT NULL COMMENT '收费金额是指该笔交费记录的收费金额',
        `charg_stf` varchar(32) DEFAULT NULL COMMENT '收费人员指该笔交费记录的收费人员',
        `this_lvling_amt` decimal(18,2) DEFAULT NULL COMMENT '本次调尾是指该笔交费记录的本次调尾',
        `last_lvling_amt` decimal(18,2) DEFAULT NULL COMMENT '上次调尾指该笔交费记录的上次调尾',
        `charg_dept` varchar(16) DEFAULT NULL COMMENT '收费部门是指该笔交费记录的收费部门',
        `charg_org` varchar(16) DEFAULT NULL COMMENT '收费单位是指该笔交费记录的收费单位',
        `pay_mode` varchar(8) DEFAULT NULL COMMENT '支付方式是指该笔交费记录的支付方式，引用国家电网公司营销管理代码类集：支付方式，枚举值，如现金、转账支票、本票、银行承兑汇票、商业承兑汇票、POS机刷卡、微信支付、支付宝支付、电e宝支付、充值卡充值、到账单、进账单、常用能源卡、临时能源卡、网银支付、快捷支付',
        `pay_chan` varchar(8) DEFAULT NULL COMMENT '交费渠道是指该笔交费记录的交费渠道，引用国家电网公司营销管理代码类集：交费渠道，枚举值，如电力机构、电力网点交费、移动作业终端交费、自助终端交费、网上国网交费、社会网点交费、能源卡',
        `pay_order_no` varchar(32) DEFAULT NULL COMMENT '支付单编号是指支付单的唯一编码，支付单编号规则：8位年月日+2位省（市）码+18位流水',
        `cap_no` varchar(64) DEFAULT NULL COMMENT '资金编号是解款记录的唯一编码',
        `branch_code` varchar(32) DEFAULT NULL COMMENT '网点代码是指该笔交费记录交费网点的代码',
        `trans_run_acct_no` varchar(32) DEFAULT NULL COMMENT '交易流水号是指该笔交费记录的流水号',
        `acct_no` varchar(16) DEFAULT NULL COMMENT '记账编号是指明细记账凭证的唯一编码，触发会计事务制作会计分录时，用于获取费用金额，记账编号生成规则为8位年月日+10位流水号',
        `acct_ym` varchar(6) DEFAULT NULL COMMENT '记账年月是指该笔交费记录所在的记帐年月',
        `charg_daily_setl_rec_id` bigint(20) DEFAULT NULL COMMENT '收费日结记录标识是指收费日结记录的唯一标识',
        `rela_id` bigint(20) DEFAULT NULL COMMENT '关联标识是指发生冲正、预收互转等业务时记录关联的交费台账标识',
        `remark` varchar(256) DEFAULT NULL COMMENT '备注是指该笔交费记录需要备注的内容',
        `mgt_org_code` varchar(16) DEFAULT NULL COMMENT '管理单位编码是指管理单位的唯一编码，此处是指交费台账所属的管理单位编码',
        `pay_order_id` bigint(20) DEFAULT NULL COMMENT '支付单标识是指支付单的唯一标识',
        `setl_acct_id` bigint(20) DEFAULT NULL COMMENT '合同账户标识是指合同账户的唯一标识',
        `prtr_no` varchar(16) DEFAULT NULL COMMENT '伙伴编号是指业务伙伴的唯一编码',
        `this_bal` decimal(18,2) DEFAULT NULL COMMENT '本次结余是指该笔交费台账发生后对应合同账户的账户余额',
        `last_bal` decimal(18,2) DEFAULT NULL COMMENT '上次结余是指指该笔交费台账发生前对应合同账户的账户余额',
        `chan_no` varchar(32) DEFAULT NULL COMMENT '渠道编号是指渠道实体的唯一编码，此处是指交费台账关联的渠道编号',
        `batch_pay_rec_id` bigint(20) DEFAULT NULL COMMENT '批量交费记录标识是指批量交费记录的唯一标识',
        `mgt_org_prft_center` varchar(16) DEFAULT NULL COMMENT '管理单位利润中心',
        `charg_situ_stat_id` bigint(20) DEFAULT NULL COMMENT '收费情况统计标识是指收费情况统计的唯一编码',
        `coll_amt_org_prft_center` varchar(16) DEFAULT NULL COMMENT '收款单位利润中心',
        `mgt_chan_org` varchar(16) DEFAULT NULL COMMENT '渠道供电单位是指管理单位的唯一编码，此处是指交费渠道所属的管理单位编码',
        `chan_cls_code` varchar(32) DEFAULT NULL COMMENT '渠道分类编码用于记录渠道所属的机构单元，如工商银行、招商银行、电E宝、支付宝等',
        `coll_branch_code` varchar(32) DEFAULT NULL COMMENT '代收网点编码是指渠道网点的唯一编码',
        `acct_date` datetime DEFAULT NULL COMMENT '记账日期指该笔交费记录记账的日期',
        `inv_flag` varchar(8) DEFAULT NULL COMMENT '发票开具标志是指交费台账发票开具的标志，引用国家电网公司营销管理代码类集：发票开具标志，枚举值，如未开具、已开具、已冲红、已作废',
        PRIMARY KEY (`charg_acct_id`),
        KEY `IDX_CHARGACCT_ACCTNO` (`acct_no`) COMMENT '账户编号索引',
        KEY `IDX_CHARGACCT_CAPNO` (`cap_no`) COMMENT '资金编号索引',
        KEY `IDX_CHARGACCT_CASHCHKRECID` (`cash_chk_rec_id`) COMMENT '解款记录索引',
        KEY `IDX_CHARGACCT_CHARGDAILYSETLRECID` (`charg_daily_setl_rec_id`) COMMENT '收费日结记录索引',
        KEY `IDX_CHARGACCT_CUSTNO` (`cust_no`) COMMENT '客户编号索引',
        KEY `IDX_CHARGACCT_PAYORDERID` (`pay_order_id`) COMMENT '支付单标识索引',
        KEY `IDX_CHARGACCT_PAYORDERNO` (`pay_order_no`) COMMENT '支付单编号索引',
        KEY `IDX_CHARGACCT_PRTRNO` (`prtr_no`) COMMENT '伙伴编号索引',
        KEY `IDX_CHARGACCT_SETLACCTID` (`setl_acct_id`) COMMENT '合同账户标识索引',
        KEY `IDX_CHARGACCT_TRANSRUNACCTNO` (`trans_run_acct_no`) COMMENT '交易流水号索引',
        KEY `IDX_CHARG_ACCT_CHARG_ORG` (`charg_org`) COMMENT '收费单位索引'
        ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='实体描述：交费台账是指收取客户费用、内部转帐的流水账，收费、票据退票、预收结转、退款、转预收等；实体包含的内容：交费台账标识、解款记录标识、服务种类、客户编号、收费年月、收费日期、收费类型、收费金额、收费人员、本次调尾、上次调尾、收费部门、收费单位、支付方式、交费渠道、支付单编号、资金编号、网点、交易流水号、记账编号、记账年月、收费日结记录标识、关联标识、备注、管理单位编码等；通过收费、退款等业务产生；用于记录交费流水';
        ```
    - 这段 SQL 查询生成了一个包含三个部分的日报，用于统计托收业务的情况。让我们逐步解释它：
        1. 第一个 SELECT 语句计算并展示了托收业务发送的情况：

        它选择了一条字符串 '托收业务共发送'。
        然后，通过 CASE 表达式计算了发送的总笔数和总金额，并根据情况添加了单位（笔或元）。
        这个 SELECT 语句从表 pd_order 中检索数据，并按照指定的条件进行筛选。
        筛选条件包括：
        ddct_strt_date >= trunc(sysdate)：托收发送日期大于等于今天的日期（不包括时间部分）。
        ddct_strt_date <= to_date(to_char(sysdate, 'yyyy-MM-dd') || ' 18:00:00', 'yyyy-MM-dd hh24:MI:ss')：托收发送日期小于等于今天的日期，并且时间部分为18:00:00。
        ddct_mode = '0204'：扣款方式为 '0204'，表示[托收]{.rainbow}方式。
        结果按照 ddct_mode 分组，因为这个查询中有一个 GROUP BY 子句。

        2. 第二个 SELECT 语句计算并展示了销账成功的情况：
        它选择了一条字符串 '销账成功'。
        然后，通过 CASE 表达式计算了销账成功的总笔数和总金额，并根据情况添加了单位（笔或元）。
        这个 SELECT 语句从表 charg_acct 中检索数据，并按照指定的条件进行筛选。
        筛选条件包括：
        charg_ym = to_char(sysdate, 'yyyyMM')：收费年月等于当前年月。
        charg_date >= trunc(sysdate)：收费日期大于等于今天的日期（不包括时间部分）。
        charg_date <= to_date(to_char(sysdate, 'yyyy-MM-dd') || ' 18:00:00', 'yyyy-MM-dd hh24:MI:ss')：收费日期小于等于今天的日期，并且时间部分为18:00:00。
        cap_no LIKE b.chan_no || 'DZTS%'：资金编号类似于渠道编号加上 'DZTS%' 的模式。
        这个查询也按照 ddct_mode 分组，与第一个 SELECT 语句相同。

        3. 第三个 SELECT 语句计算并展示了锁定在途的情况：
        它选择了一条字符串 '锁定在途'。
        然后，它计算了在途锁定的笔数，并将其作为一条完整的字符串返回。
        这个 SELECT 语句从表 pd_order 中检索数据，并按照指定的条件进行筛选。
        筛选条件与第一个 SELECT 语句中的条件类似，都是基于扣款开始日期，扣款状态和扣款方式。

        4. 关键字 UNION ALL 用于将这三个查询的结果合并成一个结果集。 UNION ALL 会把所有符合条件的行都包括在内，不进行任何去重操作。

### 交易对账运维数据（昨天[代收]{.blue}[托收]{.rainbow}的今天对账业务）

```sql
WITH dz_data AS (
    SELECT
        t.dz_reco,
        count( t.cap_no ) AS dz_ywqd,
        sum( t.dz_amt ) AS dz_amt 
    FROM
        (
        SELECT
            a.cap_no AS cap_no,
            count( a.charg_acct_id ) AS dz_count,
            sum( a.charg_amt ) AS dz_amt,
            ( SELECT n.chan_name FROM emss_pfc.pay_chan n WHERE n.chan_no = a.chan_no ) AS chan_name,
            nvl ( b.reco_rslt_desc, '尚未对账' ) AS dz_reco 
        FROM
            emss_pfc.charg_acct a
            LEFT JOIN emss_pfc.coll_trans_reco b ON b.cap_no = a.cap_no 
        WHERE
            a.charg_ym >= to_char ( sysdate - 1, 'yyyyMM' ) 
            AND a.charg_date >= trunc ( sysdate - 1 ) 
            AND a.charg_date <= to_date ( to_char ( sysdate - 1, 'yyyy-MM-dd' ) || '23:59:59', 'yyyy-MM-dd hh24:MI:ss' ) 
            AND ( a.cap_no LIKE 'D%CZ%' OR a.cap_no LIKE 'D%DZTS%' ) 
            AND a.cap_no NOT LIKE 'D%' || to_char ( sysdate, 'yyyyMMdd' ) || '%' 
        GROUP BY
            a.chan_no,
            a.cap_no,
        nvl ( b.reco_rslt_desc, '尚未对账' )) t 
    GROUP BY
        t.dz_reco 
    ),
    dz_total AS (
    SELECT
        sum( dz_ywqd ) AS total_count,
    CASE
            
            WHEN sum( dz_amt ) > 100000000 THEN
            to_char ( round( sum( dz_amt ) / 100000000, 2 ), 'FM999999990.00' ) || '亿元' 
            WHEN sum( dz_amt ) > 10000 THEN
            to_char ( round( sum( dz_amt ) / 10000, 2 ), 'FM999999990.00' ) || '万元' ELSE sum( dz_amt ) || '元' 
        END AS dz_lx_amt,-- 对账合计金额
        sum( CASE WHEN instr( dz_reco, '对账成功' ) > 0 THEN dz_ywqd ELSE 0 END ) AS dz_succ_count,
        sum( CASE WHEN instr( dz_reco, '单边账' ) > 0 THEN dz_ywqd ELSE 0 END ) AS dz_dbz_count,
        sum( CASE WHEN dz_reco = '尚未对账' THEN dz_ywqd ELSE 0 END ) AS dz_swdz_count 
    FROM
        dz_data 
    ) SELECT
CASE
        
    WHEN
        total_count = dz_succ_count THEN
            '对账业务共 ' || total_count || ' 个地市渠道，全部对账成功。' ELSE '对账业务共 ' || total_count || ' 个地市渠道，' || '今日对账成功' || dz_succ_count || '个，单边账' || dz_dbz_count || '个，尚未对账' || dz_swdz_count || '个，对账异常' || ( total_count - dz_succ_count - dz_dbz_count - dz_swdz_count ) || '个。' 
            END AS "交易对账运维数据" 
FROM
    dz_total;
```

### 昨天今天[托收]{.rainbow}锁定在途监控
- 提供的原始 sql 语句
    ```sql
    select decode(b.affil_plat, '01', '全渠道平台', '业务连接平台') 所属平台,
        decode(a.ddct_mode, '03', '代扣锁定', '托收锁定')     收费类型,
        (select n.chan_name || a.chan_no
            from emss_pfc.pay_chan n
            where n.chan_no = a.chan_no)                 渠道编码,
        sum(ddct_t_num)                               总笔数,
        sum(ddct_t_amt)                               总金额,
        to_char(a.ddct_strt_date, 'yyyy-MM-dd')       托收发送日期
    from emss_pfc.pd_order a
            inner join emss_pfc.pay_chan b on b.chan_no = a.chan_no
    where a.ddct_stat = '01'
    and a.ddct_mode = '0204'
    and a.ddct_strt_date >= trunc(sysdate - 1)
    group by b.affil_plat, a.ddct_mode, a.chan_no, to_char(a.ddct_strt_date, 'yyyy-MM-dd')
    order by to_char(a.ddct_strt_date, 'yyyy-MM-dd'), b.affil_plat, a.chan_no;
    ```

- 分析结果
    - 涉及表名：
        1. emss_pfc.pd_order：批扣订单表，包含了代扣业务的订单信息。[oracle DB3]{.label}
        ```sql
        CREATE TABLE `pd_order` (
        `pd_order_id` bigint(20) NOT NULL COMMENT '委托扣款单标识是指委托扣款单的唯一标识',
        `ddct_exp_categ` varchar(8) DEFAULT NULL COMMENT '扣款费用类别是指委托扣款的费用类别，引用国家电网公司营销管理代码类集：扣款费用类别，枚举值，如后付费、分次划拨、费控等',
        `ddct_mode` varchar(8) DEFAULT NULL COMMENT '扣款方式是指委托扣款的方式，引用国家电网公司营销管理代码类集：扣款方式，枚举值，如普通托收、电子托收、代扣',
        `chan_no` varchar(32) DEFAULT NULL COMMENT '渠道编号是指渠道对象的唯一编码，此处指委托扣款单关联的渠道',
        `ddct_t_num` bigint(20) DEFAULT NULL COMMENT '扣款总笔数是指委托扣款的总笔数',
        `ddct_t_amt` decimal(18,2) DEFAULT NULL COMMENT '扣款总额是指委托扣款的总金额',
        `ddct_stat` varchar(8) DEFAULT NULL COMMENT '扣款状态是指委托扣款的扣款状态，引用国家电网公司营销管理代码类集：扣款状态，枚举值，如在途、成功、失败',
        `actl_ddct_t_num` bigint(20) DEFAULT NULL COMMENT '实际扣款户数是指实际扣款的总户数',
        `actl_ddct_t_amt` decimal(18,2) DEFAULT NULL COMMENT '实际扣款总额是指实际扣款的总金额',
        `ddct_init` varchar(32) DEFAULT NULL COMMENT '扣款发起人是指委托扣款的发起人员',
        `ddct_strt_date` datetime DEFAULT NULL COMMENT '扣款发起日期是指委托扣款的发起日期',
        `ddct_acmp_date` datetime DEFAULT NULL COMMENT '扣款完成日期是指委托扣款的完成日期',
        `ddct_batch_no` varchar(48) DEFAULT NULL COMMENT '扣款批次号是指委托扣款的批次号',
        `mgt_org_code` varchar(16) DEFAULT NULL COMMENT '管理单位编码是指管理单位的唯一编码，此处是指委托扣款单的管理单位编码',
        `chan_cls` varchar(32) DEFAULT NULL COMMENT '渠道分类是指委托扣款的渠道分类，如工商银行、农业银行等',
        `cap_no` varchar(32) DEFAULT NULL COMMENT '资金编号是指解款记录的唯一编码',
        `agrt_no` varchar(32) DEFAULT NULL COMMENT '协议编号是指委托扣款协议的编号',
        `bank_acct` varchar(32) DEFAULT NULL COMMENT '银行账号是指客户开设的银行账号',
        `fail_reason` varchar(256) DEFAULT NULL COMMENT '失败原因指委托扣款的失败原因',
        `file_name` varchar(512) DEFAULT NULL COMMENT '文件名是指代扣出盘文件的名称',
        `file_id` varchar(64) DEFAULT NULL COMMENT '文档服务器文件唯一标识',
        `ntce_no` varchar(64) DEFAULT NULL COMMENT '记录通知的进账单编号信息，用于资金勾对',
        `pay_main_type` varchar(8) DEFAULT NULL COMMENT '支付账户的支付主体类型，如：财政客户、普通客户。',
        PRIMARY KEY (`pd_order_id`),
        KEY `IDX_PDORDER_CPNO` (`cap_no`),
        KEY `IDX_PDORDER_DDCTBATCHNO` (`ddct_batch_no`),
        KEY `IDX_PD_ORDER_DDCT_STRT_DATE` (`ddct_strt_date`),
        KEY `IDX_PD_ORDER_MGT_ORG_CODE` (`mgt_org_code`)
        ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='委托扣款单是指企业依据委托扣款协议，根据扣款策略，将委托扣款数据发送至委托扣款单位，由委托扣款单位从用户账户中扣划资金并通知企业完成销账的申请单；委托扣款单实体包含扣款费用类别、扣款方式、扣款总笔数、扣款总额、扣款状态、实际扣款笔数、实际扣款总额等属性；由委托扣款出盘业务产生；主要用于记录委托扣款的情况';
        ```
        
        2. emss_pfc.pay_chan：收费渠道表，包含了支付渠道的相关信息。[oracle DB3]{.label}
        ```sql
        CREATE TABLE `pay_chan` (
        `pay_chan_id` bigint(20) NOT NULL COMMENT '交费渠道标识',
        `chan_no` varchar(32) DEFAULT NULL COMMENT '渠道编码，唯一',
        `chan_name` varchar(256) DEFAULT NULL COMMENT '渠道名称',
        `chan_abbr` varchar(256) DEFAULT NULL COMMENT '渠道简称',
        `charg_stf` varchar(32) DEFAULT NULL COMMENT '收费人员',
        `pay_bank_acct` varchar(32) DEFAULT NULL COMMENT '付款方银行账户',
        `pay_bank_acct_no` varchar(32) DEFAULT NULL COMMENT '付款方银行账号',
        `chan_contact` varchar(256) DEFAULT NULL COMMENT '渠道联系人',
        `contact_tel` varchar(32) DEFAULT NULL COMMENT '联系人电话',
        `enc_mode` varchar(32) DEFAULT NULL COMMENT '加密方式',
        `enc_key` varchar(128) DEFAULT NULL COMMENT '密钥',
        `trnsm_agrt` varchar(256) DEFAULT NULL COMMENT '传输协议',
        `reco_cyc` varchar(32) DEFAULT NULL COMMENT '对账周期',
        `reco_time_sec` varchar(32) DEFAULT NULL COMMENT '对账时间段',
        `master_ip` varchar(32) DEFAULT NULL COMMENT '主IP',
        `slave_ip` varchar(32) DEFAULT NULL COMMENT '从IP',
        `prft_center` varchar(16) DEFAULT NULL COMMENT '利润中心',
        `cash_chk_bank_id` bigint(20) DEFAULT NULL COMMENT '解款银行标识',
        `coll_amt_org` varchar(16) DEFAULT NULL COMMENT '收款单位',
        `refund_sprt_flag` varchar(8) DEFAULT NULL COMMENT '退费支持标志',
        `send_sign_flag` varchar(8) DEFAULT NULL COMMENT '发送签约标志',
        `wk_beg_time` varchar(8) DEFAULT NULL COMMENT '渠道工作日开始时间',
        `wk_end_time` varchar(8) DEFAULT NULL COMMENT '渠道工作日结束时间',
        `hldy_flag` varchar(8) DEFAULT NULL COMMENT '执行节假日标志 01是 02否',
        `auto_hndl_flag` varchar(8) DEFAULT NULL COMMENT '单边账自动处理标志，02:是,01:否',
        `chan_cls_code` varchar(32) DEFAULT NULL COMMENT '渠道分类编码，如银行名称等',
        `affil_plat` varchar(8) DEFAULT NULL COMMENT '所属平台标志：00直收平台，01全渠道平台',
        `bus_type` varchar(8) DEFAULT NULL COMMENT '业务类型',
        `auto_coll_flag` varchar(8) DEFAULT NULL COMMENT '自动托收标志：是否开启自动托收业务',
        `auto_bd_flag` varchar(8) DEFAULT NULL COMMENT '自动批扣标志：是否开启自动批扣业务',
        PRIMARY KEY (`pay_chan_id`),
        KEY `IDX_PAY_CHAN_CNO` (`chan_no`)
        ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='交费渠道信息表，包含各个交费渠道的具体信息';
        ```
    - SELECT 语句：

        1. 使用 decode() 函数对 b.affil_plat 进行条件判断，如果其值为 '01'，则显示为 '全渠道平台'，否则显示为 '业务连接平台'。
        2. 使用 decode() 函数对 a.ddct_mode 进行条件判断，如果其值为 '03'，则显示为 '代扣锁定'，否则显示为 '托收锁定'。
        3. 使用子查询从 pay_chan 表中获取 chan_name 字段，并将其与 pd_order 表中的 chan_no 字段进行连接，作为 渠道编码 列的值。
        4. 使用 sum() 函数对 ddct_t_num 和 ddct_t_amt 字段进行汇总，得到总笔数和总金额。
        5. 使用 to_char() 函数将 ddct_strt_date 字段格式化为 'yyyy-MM-dd' 格式，作为 托收发送日期 列的值。
    - FROM 语句：

        1. 从 emss_pfc.pd_order 表和 emss_pfc.pay_chan 表中获取数据。
        2. 使用 INNER JOIN 将两个表连接起来，连接条件是 pay_chan 表中的 chan_no 字段与 pd_order 表中的 chan_no 字段相匹配。
    - WHERE 语句：
        设定条件筛选规则：
        1. ddct_stat = '01'：扣款状态为 '01'，即在途状态。
        2. ddct_mode = '0204'：扣款方式为 '0204'。
        3. ddct_strt_date >= trunc(sysdate - 1)：扣款发起日期大于等于前一天的日期。
    - GROUP BY 语句：

        1. 对 b.affil_plat、a.ddct_mode、a.chan_no 和 to_char(a.ddct_strt_date, 'yyyy-MM-dd') 进行分组，以进行汇总统计。
    - ORDER BY 语句：

        - 按照 托收发送日期、所属平台 和 渠道编号 进行排序，以便结果更易读。
        - 这段 SQL 查询语句的目的是获取前一天扣款方式为 '0204'（即某种特定方式）且扣款状态为在途的数据，并按照所属平台、收费类型、渠道编码和托收发送日期进行汇总和排序。


### 渠道总体耗时
- 预览图
    - ![托收全景监控渠道总体耗时](/img/能源互联网/托收全景监控渠道总体耗时.png)
- 提供渠道总体耗时 SQL 语句
    - WITH子句（公共表表达式）
    ```sql
    --渠道总体耗时
    WITH TMP AS
    (
        SELECT 
            (SELECT C.CHAN_NAME FROM PAY_CHAN C WHERE C.CHAN_NO = O.CHAN_NO) 渠道名称,
            (SELECT SUBSTR(C.CHAN_NAME, 0, INSTR(C.CHAN_NAME, '（') - 1) FROM PAY_CHAN C WHERE C.CHAN_NO = O.CHAN_NO) 省渠道名称,
            CHAN_NO,
            O.PD_ORDER_ID,
            O.ACTL_DDCT_T_AMT,
            (CASE
                WHEN O.DDCT_STAT = '01' THEN (SYSDATE - O.DDCT_STRT_DATE) * 24 * 60
                ELSE (O.DDCT_ACMP_DATE - O.DDCT_STRT_DATE) * 24 * 60
            END) DBHS
        FROM 
            PD_ORDER O
        WHERE 
            O.DDCT_MODE = '0204'
            AND DDCT_STRT_DATE >= TRUNC(SYSDATE)
            AND DDCT_STRT_DATE < TRUNC(SYSDATE + 1)
            AND DDCT_EXP_CATEG = '02' -- 01 后付费 02 分次划拨
            AND O.DDCT_STAT <> '00'
    )
    SELECT 
        省渠道名称, ROUND(AVG(DBHS), 2) 渠道总体耗时
    FROM 
        TMP
    GROUP BY 
        省渠道名称
    ORDER BY 
        AVG(DBHS) DESC;

    ```
    - 分析结果
        1. 这部分是一个公共表表达式（WITH子句），命名为TMP。它从PD_ORDER表中选择数据，并进行筛选和计算。

            - 渠道名称列通过子查询从PAY_CHAN表中获取，根据订单的CHAN_NO字段匹配。(通过渠道编号匹配)
            - 省渠道名称列也通过子查询从PAY_CHAN表中获取，但使用了SUBSTR和INSTR函数来截取括号前的内容。示例:(渠道名称（省份）-> 渠道名称)
            - CHAN_NO、PD_ORDER_ID、ACTL_DDCT_T_AMT列直接从PD_ORDER表中选择。
            - DBHS列使用CASE表达式根据订单的DDCT_STAT字段计算订单的耗时。
                - 当 DDCT_STAT = '01'，计算从[订单发起]{.blue}到[当前时间]{.red}的时间间隔（单位是天），然后乘以 24 * 60 将时间间隔转换为分钟。
                - 否则计算从[订单开始]{.blue}到[完成的时间]{.red}间隔（单位是天），然后乘以 24 * 60 将时间间隔转换为分钟。
            - [扣款方式是指委托扣款的方式]{.rainbow}DDCT_MODE等于'0204' 
            - [扣款发起日期]{.rainbow}DDCT_STRT_DATE大于等于当天的零点 
            - [扣款完成日期]{.rainbow}DDCT_STRT_DATE小于明天的零点 
            - [扣款费用类别是指委托扣款的费用类别]{.rainbow}DDCT_EXP_CATEG等于'02'（分次划拨）
            - [扣款状态是指委托扣款的扣款状态]{.rainbow}DDCT_STAT不等于'00'（表示扣款状态不为'00'）
    - 主查询
        ```sql
        SELECT 
            省渠道名称, ROUND(AVG(DBHS), 2) 渠道总体耗时
        FROM 
            TMP
        GROUP BY 
            省渠道名称
        ORDER BY 
            AVG(DBHS) DESC;

        ```
        - 这部分是主查询，从上面的公共表TMP中选择数据。
        - 使用ROUND函数对平均耗时进行四舍五入，保留两位小数。
        - 使用GROUP BY子句对省渠道名称进行分组。
        - 最后使用ORDER BY子句对平均耗时进行降序排列。
        - 总体而言，该SQL语句的目的是从PD_ORDER表中选择符合特定条件的数据，并与PAY_CHAN表进行关联，然后计算每个省份的渠道的平均耗时。




