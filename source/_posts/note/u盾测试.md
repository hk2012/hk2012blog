---
title: U盾测试
category: C
tag: 项目开发
abbrlink: 57959
date: 2024-04-25 09:05:00
---

# 前端网址
- http://103.21.119.84:17000/message/messagev2.html



# 情况异常 
## 第一种情况 (可以复现)
1. 采集指纹一 （食指）
2. 采集指纹二  (中指)
3. 删除指纹
    - ![u盾测试情况一](/img/能源互联网/U盾/u盾测试情况一.png)
4. 认证指纹 (食指)  -> 成功
5. 认证指纹 (中指)  -> 成功
7. 刷新页面后 再次点击删除 
    - ![u盾测试一刷新后](/img/能源互联网/U盾/u盾测试一刷新后.png)
8. 最后删除成功

- 总结： 在页面不刷新的情况下，删除一次和删除多次情况是一样的，都是可以匹配上的
- 原因:  在页面刷新后，

## 第二种情况
1. 采集指纹一 （食指）
2. 采集指纹二  (中指)
3. 采集指纹二  (无名指)
4. 采集指纹二  (小指)
5. 四个手指的指纹都可以匹配上

## 第三种情况
1. 在认证步骤连续点击两次认证情况，会发生 [下发]{.blue}与[认证]{.red}错乱.
2. 在认证超时之后，指纹后录入情况，会发生 [下发]{.blue}与[认证]{.red}错乱.

# 交互方式

1. 连接U盾
    - 测试u盾连接情况
2. 采集SN
    - 获取安全U盾编号
3. 采集身份证号
    - 待开发 
4. 采集指纹
    - 录入指纹一 和 指纹二 ，并存入U盾模组
5. 删除指纹
    - 将之前存储在模组中的指纹信息给删除 （[全部清空]{.red}）
6. 安全认证 (比对)
    1. 下发 FP_UP 指令 （指录入当前指纹）
    2. 对比 （将当前指纹，与之前存入模组间的指纹匹配）
    3. 删除当前指纹信息
7. 删除身份证号
    - 待开发
8. 获取指纹信息
    - 当前指纹如果匹配失败，可以根据 index 获取当前指纹信息
    ```json
    如果只录入一条指纹情况，错误指纹 index 如下
    verify finger info one index: 116
    如果录入两条指纹情况，错误指纹 index 如下
    verify finger info more index: 100
    ```

# 指令

- 侦测到指纹指令
    - CMD_FP_DETECT
    - 0x50
- 指纹采集指令-仅要求比对结果
    - CMD_FP_CHECH
    - 0x50
- 指纹采集指令-指纹信息传输指令，从host传输到指纹终端用于比对
    - CMD_FP_TRANS
    - 0x50
- 指纹采集指令-根据指纹索引号，获取0x50 0x17下发的指纹信息
    - CMD_FP_GET
    - 0x50
- 指纹采集指令-采集指纹信息注册到指纹模组
    - CMD_FP_REG
    - 0x50
- 指纹采集指令-删除指纹指令
    - CMD_FP_DEL
    - 0x50
- 获取指纹模组序列ID指令
    - CMD_FPRS_CHIPID
    - 0x50
- 设置指纹模组序列ID指令
    - CMD_FPWS_CHIPID
    - 0x50
- 设置/读取SN
    - CMD_CONFIG_CMD
- 删除保存的身份证信息
    - CMD_DEL_ID
- 保存身份证信息
    - CMD_ADD_ID
- 读取保存的身份证信息
    - CMD_RDSA_ID
- 设置标识信息
    - CMD_ADD_FLAG
- 读取标识标识
    - CMD_RD_FLAG
- 蜂鸣器操作
    - CMD_BUZZER



0x7c
0x7d
0x7E
0x7F
0x80
0x81
0x51


0x10 （0x01||0x00）
0x11 （0x01||0x00） 
0x17 （0x01||0x00） 0xXX 0xXX (两个字节指纹信息长度) 0xXX 0xXX 0xXX ... 指纹信息
0x18 （0x01||0x00）0xII 0xII(指纹索引) 0xXX 0xXX（两字节信息长度）0xXX 0xXX 0xXX ... 指纹信息
0x12 （0x01||0x00）0xII 0xII(指纹索引)  0xXX 0xXX（两字节信息长度）0xXX 0xXX 0xXX ... 指纹信息
0x13 （0x01||0x00） 0xXX 0xXX 0xYY 0xYY
0x14 （0x01||0x00）（16个字节）
0x15 （0x01||0x00）（16个字节）

SUBCMD+LEN+DATA
0（1字节数据，值为0，表示清除设备中保存的数据）
18字节身份证号
0x7F 0xXX 0xXX ...（18位身份证号码）
0x80 (0x01||0x00) 0xXX 0xXX ...（16位信息标识）
0x81 0xXX 0xXX ...（16位信息标识）
1-长响1声，用于操作成功情况下；2-连续短响2声，用于出现错误情况下；


指纹模组发送给上位机表示指纹模组侦测到指纹，上位机发送给指纹模组表示上位查询指纹信息 0x00-无 0x01-有
"上位机发送到指纹模组表示需要进行用户指纹或身份证认证，指令：0x11;
指纹模组发送给上位机表示认证结果：0x00-失败 0x01-成功
指令：0x11 0x01||0x00 (成功||失败) 
认证完成后，需要上位机发送删除指纹指令，清除指纹模组中缓存的指纹信息,指纹索引是0x00 0x64至0x01 0xF4，删除指纹指令：0x13"
"上位机发送到指纹模组表示传输指纹信息，指令：0x17 0xXX 0xXX (两个字节指纹信息长度) 0xXX 0xXX 0xXX ... 指纹信息
指纹模组发送给上位机表示指纹传输结果 (0x00-失败 0x01-成功) 
指令：0x17 0x01||0x00 (成功||失败) (0xII 0xXII)(上传成功后，终端保存指纹信息，并返回保存两个指纹信息的索引号)"
"上位机发送到指纹模组表示获取0x50 0x17指令上送至终端的指纹信息，指令：0x18 0xII 0xII 两位指纹索引
指纹模组发送给上位机表示获取指纹信息结果与指纹信息 (0x00-失败 0x01-成功) 
指令：0x18 0x01||0x00 (成功||失败) 0xII 0xII(指纹索引) 0xXX 0xXX (两个字节指纹信息长度) 0xXX 0xXX 0xXX ... 指纹信息
指纹数据长度一般是1008个字节，预留2024个字节"
"上位机发送到指纹模组表示采集指纹信息，指令：0x12 （0x00||0xAA） 注：0x00:表示终端不需要保存指纹信息；0xAA：表示终端需要保存指纹信息
指纹模组发送给上位机表示采集指纹信息结果与指纹信息 (0x00-失败 0x01-成功) 
指令：0x12 0x01||0x00 (成功||失败) 0xII 0xII(指纹索引) 0xXX 0xXX (两个字节指纹信息长度) 0xXX 0xXX 0xXX ... 指纹信息
注：当终端不需要指纹信息时，指纹索引为0x00 0x00
指纹数据长度一般是1008个字节，预留2024个字节"
"上位机发送给指纹模组表示需要删除指纹：指令：0x13 0xXX 0xXX 0xYY 0xYY
0xXX 0xXX：两字节删除指纹开始索引;
0xYY 0xYY：两字节删除指纹结束索引;
删除相同指纹时，0xXX 0xXX： == 0xYY 0xYY
指纹模组发送给上位机表示删除指纹结果；指令：0x13 0x01||0x00 (成功||失败)"

设置时，直接16个；

SUBCMD：0-读取SN，1-设置SN；LEN：SN数据的长度；DATA：SN的内容；
删除保存的身份证信息

"上位机发送到设备表示读取设备中保存的身份证号信息，指令：0x7F
设备发送给上位机表示读取结果
指令：0x7F  0xXX 0xXX ...（18位身份证号码）如果设备中没有保存身份证信息，则身份证号码是18个0xFF"
"上位机发送到设备表示设置标识信息，指令：0x80 0xXX 0xXX ...（16位信息标识）
设备发送给上位机表示设置结果
指令：0x80  0x01||0x00    注：0x01-成功 0x00-失败"
"上位机发送到设备表示读取标识信息，指令：0x81
设备发送给上位机表示读取结果
指令：0x81 0xXX 0xXX ...（16位信息标识）    注：失败-16个0xFF"







