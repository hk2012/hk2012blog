<!-- build time:Wed May 08 2024 20:37:27 GMT+0800 (中国标准时间) --><!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#FFF"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png"><link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="google-site-verification" content="true"><meta name="msvalidate.01" content="true"><meta name="yandex-verification" content="true"><meta name="baidu-site-verification" content="true"><link rel="alternate" type="application/rss+xml" title="流年印记" href="https://hk2012.github.io/rss.xml"><link rel="alternate" type="application/atom+xml" title="流年印记" href="https://hk2012.github.io/atom.xml"><link rel="alternate" type="application/json" title="流年印记" href="https://hk2012.github.io/feed.json"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="/css/app.css?v=0.2.5"><meta name="keywords" content="熟悉项目"><link rel="canonical" href="https://hk2012.github.io/2024/04/10/other/u%E7%9B%BE/"><title>U盾项目代码熟悉 - C | HongKuan = 流年印记 = 总结过去 领悟现在 洞悉未来</title><script src="https://fastly.jsdelivr.net/gh/stevenjoezhang/live2d-widget@latest/autoload.js"></script><meta name="generator" content="Hexo 5.4.2"></head><body itemscope itemtype="http://schema.org/WebPage"><div id="loading"><div class="cat"><div class="body"></div><div class="head"><div class="face"></div></div><div class="foot"><div class="tummy-end"></div><div class="bottom"></div><div class="legs left"></div><div class="legs right"></div></div><div class="paw"><div class="hands left"></div><div class="hands right"></div></div></div></div><div id="container"><header id="header" itemscope itemtype="http://schema.org/WPHeader"><div class="inner"><div id="brand"><div class="pjax"><h1 itemprop="name headline">U盾项目代码熟悉</h1><div class="meta"><span class="item" title="创建时间：2024-04-10 19:09:00"><span class="icon"><i class="ic i-calendar"></i> </span><span class="text">发表于</span> <time itemprop="dateCreated datePublished" datetime="2024-04-10T19:09:00+08:00">2024-04-10</time> </span><span class="item" title="本文字数"><span class="icon"><i class="ic i-pen"></i> </span><span class="text">本文字数</span> <span>89k</span> <span class="text">字</span> </span><span class="item" title="阅读时长"><span class="icon"><i class="ic i-clock"></i> </span><span class="text">阅读时长</span> <span>1:21</span></span></div></div></div><nav id="nav"><div class="inner"><div class="toggle"><div class="lines" aria-label="切换导航栏"><span class="line"></span> <span class="line"></span> <span class="line"></span></div></div><ul class="menu"><li class="item title"><a href="/" rel="start">HongKuan</a></li></ul><ul class="right"><li class="item theme"><i class="ic i-sun"></i></li><li class="item search"><i class="ic i-search"></i></li></ul></div></nav></div><div id="imgs" class="pjax"><ul><li class="item" data-background-image="https://www.loliapi.com/acg/?508207"></li><li class="item" data-background-image="https://www.loliapi.com/acg/?547133"></li><li class="item" data-background-image="https://www.loliapi.com/acg/?593572"></li><li class="item" data-background-image="https://www.loliapi.com/acg/?349393"></li><li class="item" data-background-image="https://www.loliapi.com/acg/?273756"></li><li class="item" data-background-image="https://www.loliapi.com/acg/?262075"></li></ul></div></header><div id="waves"><svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"/></defs><g class="parallax"><use xlink:href="#gentle-wave" x="48" y="0"/><use xlink:href="#gentle-wave" x="48" y="3"/><use xlink:href="#gentle-wave" x="48" y="5"/><use xlink:href="#gentle-wave" x="48" y="7"/></g></svg></div><main><div class="inner"><div id="main" class="pjax"><div class="article wrap"><div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList"><i class="ic i-home"></i> <span><a href="/">首页</a></span><i class="ic i-angle-right"></i> <span class="current" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/C/" itemprop="item" rel="index" title="分类于 C"><span itemprop="name">C</span></a><meta itemprop="position" content="1"></span></div><article itemscope itemtype="http://schema.org/Article" class="post block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://hk2012.github.io/2024/04/10/other/u%E7%9B%BE/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jpg"><meta itemprop="name" content="洪宽"><meta itemprop="description" content="总结过去 领悟现在 洞悉未来, 数学 & 软件工程"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="流年印记"></span><div class="body md" itemprop="articleBody"><h1 id="代码分析"><a class="anchor" href="#代码分析">#</a> 代码分析</h1><h2 id="natchost-v1"><a class="anchor" href="#natchost-v1">#</a> natchost-v1</h2><h3 id="原始代码"><a class="anchor" href="#原始代码">#</a> 原始代码</h3><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"stdafx.h"</span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"windows.h"</span></span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h></span></span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;io.h></span></span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;string.h></span></span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;json/json.h></span></span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MAX_LEN</span> <span class="token expression"><span class="token number">4096</span></span></span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token keyword">typedef</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">(</span>WINAPI <span class="token operator">*</span>CONNECTPROC<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token keyword">typedef</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">(</span>WINAPI <span class="token operator">*</span>COLLSNPROC<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token keyword">typedef</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">(</span>WINAPI <span class="token operator">*</span>COLLIDPROC<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token keyword">typedef</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">(</span>WINAPI <span class="token operator">*</span>COLLFPRPROC<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token keyword">typedef</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">(</span>WINAPI <span class="token operator">*</span>DELFPPROC<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token keyword">typedef</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">(</span>WINAPI <span class="token operator">*</span>VERIFYPROC<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token comment">// 从标准输入输出接收数据</span></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token keyword">char</span> g_input<span class="token punctuation">[</span><span class="token number">4096</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre></pre></td></tr><tr><td data-num="28"></td><td><pre><span class="token comment">// 写日志函数</span></pre></td></tr><tr><td data-num="29"></td><td><pre><span class="token keyword">int</span> <span class="token function">write_log_file</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre></pre></td></tr><tr><td data-num="31"></td><td><pre><span class="token comment">// 读取标准输入的数据</span></pre></td></tr><tr><td data-num="32"></td><td><pre><span class="token keyword">char</span> <span class="token operator">*</span><span class="token function">get_input</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre></pre></td></tr><tr><td data-num="34"></td><td><pre><span class="token comment">// 输出</span></pre></td></tr><tr><td data-num="35"></td><td><pre><span class="token keyword">int</span> <span class="token function">out_write</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre></pre></td></tr><tr><td data-num="37"></td><td><pre><span class="token comment">// 处理结束符</span></pre></td></tr><tr><td data-num="38"></td><td><pre><span class="token keyword">int</span> <span class="token function">handle_EOF</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>dest<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>src<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre></pre></td></tr><tr><td data-num="40"></td><td><pre><span class="token comment">// 拼接数组</span></pre></td></tr><tr><td data-num="41"></td><td><pre><span class="token keyword">int</span> <span class="token function">arr_cat</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>dest<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> from<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>src<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre></pre></td></tr><tr><td data-num="43"></td><td><pre>string <span class="token function">replaceChar</span><span class="token punctuation">(</span>string src<span class="token punctuation">,</span> string sub<span class="token punctuation">,</span> string dest<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="44"></td><td><pre></pre></td></tr><tr><td data-num="45"></td><td><pre>HINSTANCE WLinst<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="46"></td><td><pre></pre></td></tr><tr><td data-num="47"></td><td><pre><span class="token comment">// 返回 0 为成功，其他值是失败</span></pre></td></tr><tr><td data-num="48"></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>    <span class="token keyword">int</span> result<span class="token punctuation">;</span> <span class="token comment">// 设置数据流模式结果</span></pre></td></tr><tr><td data-num="50"></td><td><pre>    <span class="token keyword">char</span> reclog<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"recieve command: "</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="51"></td><td><pre>    <span class="token keyword">char</span> commlog<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"parsed command: "</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="52"></td><td><pre>    <span class="token keyword">char</span> castlog<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"cast command: "</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="53"></td><td><pre>    <span class="token keyword">char</span> connlog<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"usbkey connect response: "</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="54"></td><td><pre>    <span class="token keyword">char</span> snlog<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"usbkey sn response: "</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="55"></td><td><pre>    <span class="token keyword">char</span> idlog<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"usbkey id number response: "</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="56"></td><td><pre>    <span class="token keyword">char</span> fplog<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"usbkey fingerprint response: "</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="57"></td><td><pre>    <span class="token keyword">char</span> dellog<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"usbkey delete fingerprint response: "</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="58"></td><td><pre>    <span class="token keyword">char</span> verifylog<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"usbkey verify response: "</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="59"></td><td><pre>    <span class="token keyword">char</span> inlen <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 接收字符串长度</span></pre></td></tr><tr><td data-num="60"></td><td><pre></pre></td></tr><tr><td data-num="61"></td><td><pre>    <span class="token comment">//char message [] = "&#123;\"text\": \"hello chrome extension\"&#125;"; // 例子</span></pre></td></tr><tr><td data-num="62"></td><td><pre>    <span class="token comment">//char message[] = "&#123;\"command\": \"collFingerprint\", \"res\": &#123;\"code\":\"0\",\"content\":\"collect fingerprint failure!\"&#125;&#125;";</span></pre></td></tr><tr><td data-num="63"></td><td><pre></pre></td></tr><tr><td data-num="64"></td><td><pre></pre></td></tr><tr><td data-num="65"></td><td><pre>    <span class="token comment">// 设置数据流模式模式为二进制流</span></pre></td></tr><tr><td data-num="66"></td><td><pre>    result <span class="token operator">=</span> <span class="token function">_setmode</span><span class="token punctuation">(</span><span class="token function">_fileno</span><span class="token punctuation">(</span><span class="token constant">stdin</span><span class="token punctuation">)</span><span class="token punctuation">,</span> _O_BINARY<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="67"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="68"></td><td><pre>        <span class="token function">out_write</span><span class="token punctuation">(</span><span class="token string">"Cannot set mode\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="69"></td><td><pre></pre></td></tr><tr><td data-num="70"></td><td><pre>    WLinst <span class="token operator">=</span> <span class="token function">LoadLibrary</span><span class="token punctuation">(</span><span class="token string">"natcud.dll"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="71"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>WLinst <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="72"></td><td><pre>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="73"></td><td><pre></pre></td></tr><tr><td data-num="74"></td><td><pre>    CONNECTPROC ffconnect <span class="token operator">=</span> <span class="token punctuation">(</span>CONNECTPROC<span class="token punctuation">)</span> <span class="token function">GetProcAddress</span><span class="token punctuation">(</span>WLinst<span class="token punctuation">,</span> <span class="token string">"ffconnect"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="75"></td><td><pre>    COLLSNPROC collsn <span class="token operator">=</span> <span class="token punctuation">(</span>COLLSNPROC<span class="token punctuation">)</span> <span class="token function">GetProcAddress</span><span class="token punctuation">(</span>WLinst<span class="token punctuation">,</span> <span class="token string">"collTerminalSN"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="76"></td><td><pre>    COLLIDPROC collid <span class="token operator">=</span> <span class="token punctuation">(</span>COLLIDPROC<span class="token punctuation">)</span> <span class="token function">GetProcAddress</span><span class="token punctuation">(</span>WLinst<span class="token punctuation">,</span> <span class="token string">"collIdNumber"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="77"></td><td><pre>    COLLFPRPROC collfp <span class="token operator">=</span> <span class="token punctuation">(</span>COLLFPRPROC<span class="token punctuation">)</span> <span class="token function">GetProcAddress</span><span class="token punctuation">(</span>WLinst<span class="token punctuation">,</span> <span class="token string">"collFingerPrint"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="78"></td><td><pre>    DELFPPROC delfp <span class="token operator">=</span> <span class="token punctuation">(</span>DELFPPROC<span class="token punctuation">)</span> <span class="token function">GetProcAddress</span><span class="token punctuation">(</span>WLinst<span class="token punctuation">,</span> <span class="token string">"deleteFingerprints"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="79"></td><td><pre>    VERIFYPROC verify <span class="token operator">=</span> <span class="token punctuation">(</span>VERIFYPROC<span class="token punctuation">)</span> <span class="token function">GetProcAddress</span><span class="token punctuation">(</span>WLinst<span class="token punctuation">,</span> <span class="token string">"verify"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="80"></td><td><pre></pre></td></tr><tr><td data-num="81"></td><td><pre></pre></td></tr><tr><td data-num="82"></td><td><pre>    <span class="token keyword">char</span> <span class="token operator">*</span>tmpcomm <span class="token operator">=</span> <span class="token function">get_input</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="83"></td><td><pre>    <span class="token function">strcat</span><span class="token punctuation">(</span>reclog<span class="token punctuation">,</span> tmpcomm<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="84"></td><td><pre>    <span class="token function">write_log_file</span><span class="token punctuation">(</span>reclog<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="85"></td><td><pre></pre></td></tr><tr><td data-num="86"></td><td><pre>    std<span class="token double-colon punctuation">::</span>string <span class="token function">command</span><span class="token punctuation">(</span>tmpcomm<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="87"></td><td><pre>    <span class="token function">strcat</span><span class="token punctuation">(</span>castlog<span class="token punctuation">,</span> command<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="88"></td><td><pre>    <span class="token function">write_log_file</span><span class="token punctuation">(</span>castlog<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="89"></td><td><pre></pre></td></tr><tr><td data-num="90"></td><td><pre></pre></td></tr><tr><td data-num="91"></td><td><pre>    <span class="token comment">//std::string command = "&#123;\"command\":\"collTerminalSN\"&#125;";</span></pre></td></tr><tr><td data-num="92"></td><td><pre><span class="token comment">//	std::string command = "&#123;\"command\": \"collTerminalSN\"&#125;";</span></pre></td></tr><tr><td data-num="93"></td><td><pre>    <span class="token comment">//std::string command = "&#123;\"command\": \"collIdNumber\",\"req\": &#123;\"serial\": \"32016225\",\"idNumber\": \"411481199110128450\"&#125;&#125;";</span></pre></td></tr><tr><td data-num="94"></td><td><pre>    <span class="token comment">//std::string command = "&#123;\"command\": \"collFingerprint\",\"req\": &#123;\"serial\": \"32016225\"&#125;&#125;";</span></pre></td></tr><tr><td data-num="95"></td><td><pre>    <span class="token comment">//std::string command = "&#123;\"command\": \"collFingerprint\",\"req\": &#123;\"serial\": \"32016225\",\"fingerNo\": \"\"&#125;&#125;";</span></pre></td></tr><tr><td data-num="96"></td><td><pre>    <span class="token comment">//std::string command = "&#123;\"command\": \"deleteFingerprints\",\"req\": &#123;\"serial\": \"32016225\"&#125;&#125;";</span></pre></td></tr><tr><td data-num="97"></td><td><pre>    <span class="token comment">// 指令判断处理 ..........................</span></pre></td></tr><tr><td data-num="98"></td><td><pre>    <span class="token comment">//std::string command = "&#123;\"command\": \"verify\",\"req\": &#123;\"serial\": \"30077052\"&#125;&#125;";</span></pre></td></tr><tr><td data-num="99"></td><td><pre></pre></td></tr><tr><td data-num="100"></td><td><pre>    <span class="token comment">//std::string command = "&#123;\"cmd\": \"f\",\"req\": &#123;\"s\": \"30077052\",\"f\": 1&#125;&#125;";</span></pre></td></tr><tr><td data-num="101"></td><td><pre></pre></td></tr><tr><td data-num="102"></td><td><pre>    Json<span class="token double-colon punctuation">::</span>Value jData<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="103"></td><td><pre>    Json<span class="token double-colon punctuation">::</span>Reader reader<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="104"></td><td><pre>    reader<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>command<span class="token punctuation">,</span> jData<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="105"></td><td><pre>    string comname <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> jData<span class="token punctuation">[</span><span class="token string">"cmd"</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">asString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="106"></td><td><pre>    <span class="token function">strcat</span><span class="token punctuation">(</span>commlog<span class="token punctuation">,</span> comname<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="107"></td><td><pre>    <span class="token function">write_log_file</span><span class="token punctuation">(</span>comname<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="108"></td><td><pre></pre></td></tr><tr><td data-num="109"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">stricmp</span><span class="token punctuation">(</span>comname<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"connect"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="110"></td><td><pre></pre></td></tr><tr><td data-num="111"></td><td><pre>        <span class="token keyword">char</span> <span class="token operator">*</span>rdata <span class="token operator">=</span> <span class="token function">ffconnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="112"></td><td><pre>        <span class="token comment">// 写日志</span></pre></td></tr><tr><td data-num="113"></td><td><pre>        <span class="token function">strcat</span><span class="token punctuation">(</span>connlog<span class="token punctuation">,</span> rdata<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="114"></td><td><pre>        <span class="token function">write_log_file</span><span class="token punctuation">(</span>connlog<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="115"></td><td><pre></pre></td></tr><tr><td data-num="116"></td><td><pre>        Json<span class="token double-colon punctuation">::</span>Value root<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="117"></td><td><pre>        Json<span class="token double-colon punctuation">::</span>Value res<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="118"></td><td><pre>        root<span class="token punctuation">[</span><span class="token string">"cmd"</span><span class="token punctuation">]</span> <span class="token operator">=</span> comname<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="119"></td><td><pre>        root<span class="token punctuation">[</span><span class="token string">"res"</span><span class="token punctuation">]</span> <span class="token operator">=</span> rdata<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="120"></td><td><pre>        root<span class="token punctuation">.</span><span class="token function">toStyledString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="121"></td><td><pre>        std<span class="token double-colon punctuation">::</span>string rtnOut <span class="token operator">=</span> root<span class="token punctuation">.</span><span class="token function">toStyledString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="122"></td><td><pre>        string rtn <span class="token operator">=</span> <span class="token function">replaceChar</span><span class="token punctuation">(</span>rtnOut<span class="token punctuation">,</span> <span class="token string">"\\n"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="123"></td><td><pre>        rtn <span class="token operator">=</span> <span class="token function">replaceChar</span><span class="token punctuation">(</span>rtn<span class="token punctuation">,</span> <span class="token string">"\n"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="124"></td><td><pre>        <span class="token function">out_write</span><span class="token punctuation">(</span>rtn<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="125"></td><td><pre></pre></td></tr><tr><td data-num="126"></td><td><pre>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">stricmp</span><span class="token punctuation">(</span>comname<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"sn"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="127"></td><td><pre>        <span class="token keyword">char</span> <span class="token operator">*</span>rdata <span class="token operator">=</span> <span class="token function">collsn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="128"></td><td><pre>        <span class="token comment">// 写日志</span></pre></td></tr><tr><td data-num="129"></td><td><pre>        <span class="token function">strcat</span><span class="token punctuation">(</span>snlog<span class="token punctuation">,</span> rdata<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="130"></td><td><pre>        <span class="token function">write_log_file</span><span class="token punctuation">(</span>snlog<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="131"></td><td><pre>        Json<span class="token double-colon punctuation">::</span>Value root<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="132"></td><td><pre>        Json<span class="token double-colon punctuation">::</span>Value res<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="133"></td><td><pre>        root<span class="token punctuation">[</span><span class="token string">"cmd"</span><span class="token punctuation">]</span> <span class="token operator">=</span> comname<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="134"></td><td><pre>        root<span class="token punctuation">[</span><span class="token string">"res"</span><span class="token punctuation">]</span> <span class="token operator">=</span> rdata<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="135"></td><td><pre>        root<span class="token punctuation">.</span><span class="token function">toStyledString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="136"></td><td><pre>        std<span class="token double-colon punctuation">::</span>string rtnOut <span class="token operator">=</span> root<span class="token punctuation">.</span><span class="token function">toStyledString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="137"></td><td><pre>        string rtn <span class="token operator">=</span> <span class="token function">replaceChar</span><span class="token punctuation">(</span>rtnOut<span class="token punctuation">,</span> <span class="token string">"\\n"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="138"></td><td><pre>        rtn <span class="token operator">=</span> <span class="token function">replaceChar</span><span class="token punctuation">(</span>rtn<span class="token punctuation">,</span> <span class="token string">"\n"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="139"></td><td><pre>        <span class="token function">out_write</span><span class="token punctuation">(</span>rtn<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="140"></td><td><pre></pre></td></tr><tr><td data-num="141"></td><td><pre>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">stricmp</span><span class="token punctuation">(</span>comname<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"i"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="142"></td><td><pre></pre></td></tr><tr><td data-num="143"></td><td><pre><span class="token comment">// 读取 json 子结构</span></pre></td></tr><tr><td data-num="144"></td><td><pre>        Json<span class="token double-colon punctuation">::</span>Value reqData <span class="token operator">=</span> jData<span class="token punctuation">[</span><span class="token string">"req"</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="145"></td><td><pre><span class="token comment">//		string req=jData["command"].asString().c_str();</span></pre></td></tr><tr><td data-num="146"></td><td><pre>        string req <span class="token operator">=</span> reqData<span class="token punctuation">.</span><span class="token function">toStyledString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 转换成字符串</span></pre></td></tr><tr><td data-num="147"></td><td><pre>        <span class="token keyword">char</span> <span class="token operator">*</span>rdata <span class="token operator">=</span> <span class="token function">collid</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> req<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="148"></td><td><pre>        <span class="token comment">// 写日志</span></pre></td></tr><tr><td data-num="149"></td><td><pre>        <span class="token function">strcat</span><span class="token punctuation">(</span>idlog<span class="token punctuation">,</span> rdata<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="150"></td><td><pre>        <span class="token function">write_log_file</span><span class="token punctuation">(</span>idlog<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="151"></td><td><pre></pre></td></tr><tr><td data-num="152"></td><td><pre>        Json<span class="token double-colon punctuation">::</span>Value root<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="153"></td><td><pre>        Json<span class="token double-colon punctuation">::</span>Value res<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="154"></td><td><pre>        root<span class="token punctuation">[</span><span class="token string">"cmd"</span><span class="token punctuation">]</span> <span class="token operator">=</span> comname<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="155"></td><td><pre>        root<span class="token punctuation">[</span><span class="token string">"res"</span><span class="token punctuation">]</span> <span class="token operator">=</span> rdata<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="156"></td><td><pre>        root<span class="token punctuation">.</span><span class="token function">toStyledString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="157"></td><td><pre>        std<span class="token double-colon punctuation">::</span>string rtnOut <span class="token operator">=</span> root<span class="token punctuation">.</span><span class="token function">toStyledString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="158"></td><td><pre>        string rtn <span class="token operator">=</span> <span class="token function">replaceChar</span><span class="token punctuation">(</span>rtnOut<span class="token punctuation">,</span> <span class="token string">"\\n"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="159"></td><td><pre>        rtn <span class="token operator">=</span> <span class="token function">replaceChar</span><span class="token punctuation">(</span>rtn<span class="token punctuation">,</span> <span class="token string">"\n"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="160"></td><td><pre>        <span class="token function">out_write</span><span class="token punctuation">(</span>rtn<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="161"></td><td><pre></pre></td></tr><tr><td data-num="162"></td><td><pre>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">stricmp</span><span class="token punctuation">(</span>comname<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"f"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="163"></td><td><pre>        Json<span class="token double-colon punctuation">::</span>Value reqData <span class="token operator">=</span> jData<span class="token punctuation">[</span><span class="token string">"req"</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="164"></td><td><pre>        string req <span class="token operator">=</span> reqData<span class="token punctuation">.</span><span class="token function">toStyledString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 转换成字符串</span></pre></td></tr><tr><td data-num="165"></td><td><pre>        <span class="token comment">//char * req=(char *).asString().c_str();</span></pre></td></tr><tr><td data-num="166"></td><td><pre>        <span class="token keyword">char</span> <span class="token operator">*</span>rdata <span class="token operator">=</span> <span class="token function">collfp</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> req<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="167"></td><td><pre>        <span class="token comment">// 写日志</span></pre></td></tr><tr><td data-num="168"></td><td><pre>        <span class="token function">strcat</span><span class="token punctuation">(</span>fplog<span class="token punctuation">,</span> rdata<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="169"></td><td><pre>        <span class="token function">write_log_file</span><span class="token punctuation">(</span>fplog<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="170"></td><td><pre></pre></td></tr><tr><td data-num="171"></td><td><pre>        Json<span class="token double-colon punctuation">::</span>Value root<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="172"></td><td><pre>        Json<span class="token double-colon punctuation">::</span>Value res<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="173"></td><td><pre>        root<span class="token punctuation">[</span><span class="token string">"cmd"</span><span class="token punctuation">]</span> <span class="token operator">=</span> comname<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="174"></td><td><pre>        root<span class="token punctuation">[</span><span class="token string">"res"</span><span class="token punctuation">]</span> <span class="token operator">=</span> rdata<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="175"></td><td><pre>        <span class="token comment">//	root.toStyledString();</span></pre></td></tr><tr><td data-num="176"></td><td><pre>        std<span class="token double-colon punctuation">::</span>string rtnOut <span class="token operator">=</span> root<span class="token punctuation">.</span><span class="token function">toStyledString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="177"></td><td><pre>        string rtn <span class="token operator">=</span> <span class="token function">replaceChar</span><span class="token punctuation">(</span>rtnOut<span class="token punctuation">,</span> <span class="token string">"\\n"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="178"></td><td><pre>        rtn <span class="token operator">=</span> <span class="token function">replaceChar</span><span class="token punctuation">(</span>rtn<span class="token punctuation">,</span> <span class="token string">"\n"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="179"></td><td><pre>        <span class="token function">out_write</span><span class="token punctuation">(</span>rtn<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="180"></td><td><pre></pre></td></tr><tr><td data-num="181"></td><td><pre>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">stricmp</span><span class="token punctuation">(</span>comname<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"verify"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="182"></td><td><pre>        Json<span class="token double-colon punctuation">::</span>Value reqData <span class="token operator">=</span> jData<span class="token punctuation">[</span><span class="token string">"req"</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="183"></td><td><pre>        string req <span class="token operator">=</span> reqData<span class="token punctuation">.</span><span class="token function">toStyledString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 转换成字符串</span></pre></td></tr><tr><td data-num="184"></td><td><pre>        <span class="token comment">// char * req=(char *)jData["req"].asString().c_str();</span></pre></td></tr><tr><td data-num="185"></td><td><pre>        <span class="token keyword">char</span> <span class="token operator">*</span>rdata <span class="token operator">=</span> <span class="token function">verify</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> req<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="186"></td><td><pre></pre></td></tr><tr><td data-num="187"></td><td><pre>        Json<span class="token double-colon punctuation">::</span>Value rtnData <span class="token operator">=</span> rdata<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="188"></td><td><pre>        string _rtnData <span class="token operator">=</span> rtnData<span class="token punctuation">.</span><span class="token function">toStyledString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="189"></td><td><pre></pre></td></tr><tr><td data-num="190"></td><td><pre>        <span class="token comment">// 写日志</span></pre></td></tr><tr><td data-num="191"></td><td><pre>        <span class="token function">strcat</span><span class="token punctuation">(</span>verifylog<span class="token punctuation">,</span> rdata<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="192"></td><td><pre>        <span class="token function">write_log_file</span><span class="token punctuation">(</span>verifylog<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="193"></td><td><pre></pre></td></tr><tr><td data-num="194"></td><td><pre>        Json<span class="token double-colon punctuation">::</span>Value root<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="195"></td><td><pre>        Json<span class="token double-colon punctuation">::</span>Value res<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="196"></td><td><pre>        root<span class="token punctuation">[</span><span class="token string">"cmd"</span><span class="token punctuation">]</span> <span class="token operator">=</span> comname<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="197"></td><td><pre>        root<span class="token punctuation">[</span><span class="token string">"res"</span><span class="token punctuation">]</span> <span class="token operator">=</span> rdata<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="198"></td><td><pre>        root<span class="token punctuation">.</span><span class="token function">toStyledString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="199"></td><td><pre>        std<span class="token double-colon punctuation">::</span>string rtnOut <span class="token operator">=</span> root<span class="token punctuation">.</span><span class="token function">toStyledString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="200"></td><td><pre>        string rtn <span class="token operator">=</span> <span class="token function">replaceChar</span><span class="token punctuation">(</span>rtnOut<span class="token punctuation">,</span> <span class="token string">"\\n"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="201"></td><td><pre>        rtn <span class="token operator">=</span> <span class="token function">replaceChar</span><span class="token punctuation">(</span>rtn<span class="token punctuation">,</span> <span class="token string">"\n"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="202"></td><td><pre>        <span class="token function">out_write</span><span class="token punctuation">(</span>rtn<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="203"></td><td><pre></pre></td></tr><tr><td data-num="204"></td><td><pre>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">stricmp</span><span class="token punctuation">(</span>comname<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"delf"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="205"></td><td><pre>        Json<span class="token double-colon punctuation">::</span>Value reqData <span class="token operator">=</span> jData<span class="token punctuation">[</span><span class="token string">"req"</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="206"></td><td><pre>        string req <span class="token operator">=</span> reqData<span class="token punctuation">.</span><span class="token function">toStyledString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 转换成字符串</span></pre></td></tr><tr><td data-num="207"></td><td><pre>        <span class="token comment">// char * req=(char *)jData["req"].asString().c_str();</span></pre></td></tr><tr><td data-num="208"></td><td><pre>        <span class="token keyword">char</span> <span class="token operator">*</span>rdata <span class="token operator">=</span> <span class="token function">delfp</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> req<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="209"></td><td><pre>        <span class="token comment">// 写日志</span></pre></td></tr><tr><td data-num="210"></td><td><pre>        <span class="token function">strcat</span><span class="token punctuation">(</span>dellog<span class="token punctuation">,</span> rdata<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="211"></td><td><pre>        <span class="token function">write_log_file</span><span class="token punctuation">(</span>dellog<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="212"></td><td><pre></pre></td></tr><tr><td data-num="213"></td><td><pre>        Json<span class="token double-colon punctuation">::</span>Value root<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="214"></td><td><pre>        Json<span class="token double-colon punctuation">::</span>Value res<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="215"></td><td><pre>        root<span class="token punctuation">[</span><span class="token string">"cmd"</span><span class="token punctuation">]</span> <span class="token operator">=</span> comname<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="216"></td><td><pre>        root<span class="token punctuation">[</span><span class="token string">"res"</span><span class="token punctuation">]</span> <span class="token operator">=</span> rdata<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="217"></td><td><pre>        root<span class="token punctuation">.</span><span class="token function">toStyledString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="218"></td><td><pre>        std<span class="token double-colon punctuation">::</span>string rtnOut <span class="token operator">=</span> root<span class="token punctuation">.</span><span class="token function">toStyledString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="219"></td><td><pre>        string rtn <span class="token operator">=</span> <span class="token function">replaceChar</span><span class="token punctuation">(</span>rtnOut<span class="token punctuation">,</span> <span class="token string">"\\n"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="220"></td><td><pre>        rtn <span class="token operator">=</span> <span class="token function">replaceChar</span><span class="token punctuation">(</span>rtn<span class="token punctuation">,</span> <span class="token string">"\n"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="221"></td><td><pre>        <span class="token function">out_write</span><span class="token punctuation">(</span>rtn<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="222"></td><td><pre>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="223"></td><td><pre>        <span class="token keyword">char</span> msg<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"command failure, exit"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="224"></td><td><pre>        <span class="token function">write_log_file</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="225"></td><td><pre>        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="226"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="227"></td><td><pre>    <span class="token function">out_write</span><span class="token punctuation">(</span><span class="token string">"exit program"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="228"></td><td><pre>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="229"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="230"></td><td><pre></pre></td></tr><tr><td data-num="231"></td><td><pre><span class="token comment">// 读取标准输入的数据</span></pre></td></tr><tr><td data-num="232"></td><td><pre><span class="token keyword">char</span> <span class="token operator">*</span><span class="token function">get_input</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="233"></td><td><pre>    <span class="token keyword">int</span> len <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 从接收字符串中前 4 个字节读取的数据长度</span></pre></td></tr><tr><td data-num="234"></td><td><pre>    <span class="token keyword">char</span> log<span class="token punctuation">[</span>MAX_LEN<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 日志</span></pre></td></tr><tr><td data-num="235"></td><td><pre>    <span class="token keyword">char</span> log_len<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 日值输出读取字符串的长度，临时值。</span></pre></td></tr><tr><td data-num="236"></td><td><pre>    <span class="token keyword">int</span> i<span class="token punctuation">;</span> <span class="token comment">// 循环初始值</span></pre></td></tr><tr><td data-num="237"></td><td><pre>    <span class="token keyword">int</span> l<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="238"></td><td><pre>    <span class="token comment">// 读取数据流长度</span></pre></td></tr><tr><td data-num="239"></td><td><pre>    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">4</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="240"></td><td><pre>        <span class="token comment">//l = char2hex(getchar());</span></pre></td></tr><tr><td data-num="241"></td><td><pre>        l <span class="token operator">=</span> <span class="token function">getchar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="242"></td><td><pre>        len <span class="token operator">+=</span> l <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span>i <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="243"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="244"></td><td><pre>    <span class="token comment">// 失败返回</span></pre></td></tr><tr><td data-num="245"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>len <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="246"></td><td><pre>        <span class="token function">write_log_file</span><span class="token punctuation">(</span><span class="token string">"read error,len is 0"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="247"></td><td><pre>        <span class="token function">out_write</span><span class="token punctuation">(</span><span class="token string">"read error,len is 0"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="248"></td><td><pre>        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="249"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="250"></td><td><pre></pre></td></tr><tr><td data-num="251"></td><td><pre>    <span class="token function">strcpy</span><span class="token punctuation">(</span>log<span class="token punctuation">,</span> <span class="token string">"read len is "</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="252"></td><td><pre>    <span class="token function">sprintf</span><span class="token punctuation">(</span>log_len<span class="token punctuation">,</span> <span class="token string">"%ld"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="253"></td><td><pre>    <span class="token function">strcat</span><span class="token punctuation">(</span>log<span class="token punctuation">,</span> log_len<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="254"></td><td><pre>    <span class="token function">write_log_file</span><span class="token punctuation">(</span>log<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="255"></td><td><pre>    <span class="token comment">// 读取数据流内容</span></pre></td></tr><tr><td data-num="256"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">fgets</span><span class="token punctuation">(</span>g_input<span class="token punctuation">,</span> len <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token constant">stdin</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="257"></td><td><pre>        <span class="token function">write_log_file</span><span class="token punctuation">(</span>g_input<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="258"></td><td><pre>        <span class="token keyword">return</span> g_input<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="259"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="260"></td><td><pre>    <span class="token function">write_log_file</span><span class="token punctuation">(</span><span class="token string">"read content error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="261"></td><td><pre>    <span class="token function">out_write</span><span class="token punctuation">(</span><span class="token string">"read content error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="262"></td><td><pre>    <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="263"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="264"></td><td><pre></pre></td></tr><tr><td data-num="265"></td><td><pre><span class="token comment">// 输出</span></pre></td></tr><tr><td data-num="266"></td><td><pre><span class="token keyword">int</span> <span class="token function">out_write</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>message<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="267"></td><td><pre>    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> len<span class="token punctuation">;</span> <span class="token comment">// 将要输出的字符串的长度</span></pre></td></tr><tr><td data-num="268"></td><td><pre>    <span class="token keyword">char</span> protocol_len<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 按照交互协调协议转换后，协议中的输出字符串长度</span></pre></td></tr><tr><td data-num="269"></td><td><pre>    <span class="token keyword">char</span> out_all<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 输出的所有字符串</span></pre></td></tr><tr><td data-num="270"></td><td><pre>    <span class="token keyword">char</span> log_len<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 日志中输出的字符串长度</span></pre></td></tr><tr><td data-num="271"></td><td><pre>    <span class="token keyword">char</span> log<span class="token punctuation">[</span>MAX_LEN<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 日志内容</span></pre></td></tr><tr><td data-num="272"></td><td><pre>    <span class="token keyword">int</span> i<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="273"></td><td><pre></pre></td></tr><tr><td data-num="274"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>message <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="275"></td><td><pre>        <span class="token comment">// 输出消息为空</span></pre></td></tr><tr><td data-num="276"></td><td><pre>        <span class="token function">write_log_file</span><span class="token punctuation">(</span><span class="token string">"out_write NULL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="277"></td><td><pre>        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="278"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="279"></td><td><pre>    <span class="token function">write_log_file</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="280"></td><td><pre>    len <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="281"></td><td><pre><span class="token comment">//    printf("%zu",len);</span></pre></td></tr><tr><td data-num="282"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>len <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="283"></td><td><pre>        <span class="token comment">// 长度为空</span></pre></td></tr><tr><td data-num="284"></td><td><pre>        <span class="token function">write_log_file</span><span class="token punctuation">(</span><span class="token string">"out_write len is 0"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="285"></td><td><pre>        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="286"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="287"></td><td><pre></pre></td></tr><tr><td data-num="288"></td><td><pre>    <span class="token function">strcpy</span><span class="token punctuation">(</span>log<span class="token punctuation">,</span> <span class="token string">"out_write content len is "</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="289"></td><td><pre>    <span class="token function">sprintf</span><span class="token punctuation">(</span>log_len<span class="token punctuation">,</span> <span class="token string">"%ld"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="290"></td><td><pre>    <span class="token function">strcat</span><span class="token punctuation">(</span>log<span class="token punctuation">,</span> log_len<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="291"></td><td><pre>    <span class="token function">write_log_file</span><span class="token punctuation">(</span>log<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="292"></td><td><pre><span class="token comment">/*</span></pre></td></tr><tr><td data-num="293"></td><td><pre>    for(i = 0; i &lt; 4; i++)&#123;</pre></td></tr><tr><td data-num="294"></td><td><pre>        protocol_len[i] = (char)((len >> (i * 8)) &amp; 0xFF);</pre></td></tr><tr><td data-num="295"></td><td><pre>    &#125;</pre></td></tr><tr><td data-num="296"></td><td><pre>    strcpy(out_all,protocol_len);</pre></td></tr><tr><td data-num="297"></td><td><pre>    arr_cat(out_all,4,message, len);</pre></td></tr><tr><td data-num="298"></td><td><pre>    fwrite(out_all, sizeof(char),  4+len,  stdout);</pre></td></tr><tr><td data-num="299"></td><td><pre>*/</pre></td></tr><tr><td data-num="300"></td><td><pre></pre></td></tr><tr><td data-num="301"></td><td><pre>    <span class="token comment">// We need to send the 4 bytes of length information</span></pre></td></tr><tr><td data-num="302"></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%c%c%c%c"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>len <span class="token operator">&amp;</span> <span class="token number">0xff</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="303"></td><td><pre>           <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>len <span class="token operator">>></span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="304"></td><td><pre>           <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>len <span class="token operator">>></span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="305"></td><td><pre>           <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>len <span class="token operator">>></span> <span class="token number">24</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="306"></td><td><pre>    <span class="token comment">// Now we can output our message</span></pre></td></tr><tr><td data-num="307"></td><td><pre>    <span class="token function">fwrite</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span><span class="token punctuation">,</span> len<span class="token punctuation">,</span> <span class="token constant">stdout</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="308"></td><td><pre>    <span class="token comment">//printf("%s", message);</span></pre></td></tr><tr><td data-num="309"></td><td><pre>    <span class="token function">fflush</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="310"></td><td><pre>    <span class="token function">write_log_file</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="311"></td><td><pre>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="312"></td><td><pre>    <span class="token comment">// 刷新输出缓冲区，以确保消息立即被发送</span></pre></td></tr><tr><td data-num="313"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="314"></td><td><pre></pre></td></tr><tr><td data-num="315"></td><td><pre><span class="token keyword">int</span> <span class="token function">write_log_file</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>str<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="316"></td><td><pre>    FILE <span class="token operator">*</span>file <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span><span class="token string">"data.txt"</span><span class="token punctuation">,</span> <span class="token string">"a+"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="317"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>file <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="318"></td><td><pre>        <span class="token comment">// exit(1);</span></pre></td></tr><tr><td data-num="319"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="320"></td><td><pre>    <span class="token comment">//if(file.isope</span></pre></td></tr><tr><td data-num="321"></td><td><pre>    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> len <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="322"></td><td><pre>    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> wlen <span class="token operator">=</span> <span class="token function">fwrite</span><span class="token punctuation">(</span>str<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span><span class="token punctuation">,</span> len<span class="token punctuation">,</span> file<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="323"></td><td><pre>    <span class="token function">fputc</span><span class="token punctuation">(</span><span class="token char">'\n'</span><span class="token punctuation">,</span> file<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="324"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>len <span class="token operator">!=</span> wlen<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="325"></td><td><pre>        <span class="token comment">//exit(1);</span></pre></td></tr><tr><td data-num="326"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="327"></td><td><pre></pre></td></tr><tr><td data-num="328"></td><td><pre>    <span class="token function">fclose</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="329"></td><td><pre>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="330"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="331"></td><td><pre></pre></td></tr><tr><td data-num="332"></td><td><pre><span class="token comment">// 拼接数组</span></pre></td></tr><tr><td data-num="333"></td><td><pre><span class="token keyword">int</span> <span class="token function">arr_cat</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>dest<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> from<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>src<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> len<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="334"></td><td><pre>    <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="335"></td><td><pre>    dest <span class="token operator">=</span> dest <span class="token operator">+</span> from<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="336"></td><td><pre>    <span class="token keyword">while</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;</span> len<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="337"></td><td><pre>        <span class="token operator">*</span>dest <span class="token operator">=</span> <span class="token operator">*</span>src<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="338"></td><td><pre>        dest<span class="token operator">++</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="339"></td><td><pre>        src<span class="token operator">++</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="340"></td><td><pre>        i<span class="token operator">++</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="341"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="342"></td><td><pre>    <span class="token keyword">return</span> i<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="343"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="344"></td><td><pre></pre></td></tr><tr><td data-num="345"></td><td><pre>string <span class="token function">replaceChar</span><span class="token punctuation">(</span>string src<span class="token punctuation">,</span> string sub<span class="token punctuation">,</span> string dest<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="346"></td><td><pre>    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="347"></td><td><pre>        <span class="token keyword">unsigned</span> <span class="token keyword">int</span> len <span class="token operator">=</span> src<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="348"></td><td><pre>        <span class="token keyword">int</span> idx <span class="token operator">=</span> src<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>sub<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="349"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>idx <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="350"></td><td><pre>            <span class="token keyword">return</span> src<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="351"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="352"></td><td><pre>        <span class="token keyword">unsigned</span> <span class="token keyword">int</span> slen <span class="token operator">=</span> sub<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="353"></td><td><pre>        src <span class="token operator">=</span> src<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>idx<span class="token punctuation">,</span> slen<span class="token punctuation">,</span> dest<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="354"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="355"></td><td><pre>    <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="356"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="357"></td><td><pre></pre></td></tr><tr><td data-num="358"></td><td><pre><span class="token keyword">int</span> <span class="token function">handle_EOF</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>dest<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>src<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="359"></td><td><pre>    <span class="token keyword">char</span> arr<span class="token punctuation">[</span>MAX_LEN<span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="360"></td><td><pre>    <span class="token keyword">int</span> idx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="361"></td><td><pre>    <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="362"></td><td><pre>    <span class="token keyword">while</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;</span> MAX_LEN<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="363"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span>src <span class="token operator">!=</span> <span class="token char">'\0'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="364"></td><td><pre>            arr<span class="token punctuation">[</span>idx<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">*</span>src<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="365"></td><td><pre>            idx<span class="token operator">++</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="366"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="367"></td><td><pre>        src<span class="token operator">++</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="368"></td><td><pre>        i<span class="token operator">++</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="369"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="370"></td><td><pre>    arr<span class="token punctuation">[</span>idx <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">'\0'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="371"></td><td><pre>    dest <span class="token operator">=</span> arr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="372"></td><td><pre>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="373"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><ul><li>这段代码看起来是一个用于与 USB key 进行通信的程序。我来解释一下每个方法的作用和整体的功能：</li></ul><ol><li>get_input (): 这个函数负责从标准输入读取数据。它首先读取前四个字节以确定接收到的数据的长度，然后根据长度读取实际的数据内容。</li><li>out_write (const char *message): 这个函数用于向标准输出写入数据。它将输入的消息长度转换为四个字节的格式，并将消息内容输出到标准输出流中。</li><li>write_log_file (const char *str): 这个函数用于将字符串写入日志文件 &quot;data.txt&quot; 中。它打开一个文件句柄，将字符串写入文件中，并在每个字符串后添加换行符。</li><li>arr_cat (char *dest, unsigned int from, const char *src, unsigned int len): 这个函数用于将源数组的内容连接到目标数组的末尾。它接受目标数组的指针、起始位置、源数组的指针以及源数组的长度作为参数，并将源数组的内容复制到目标数组的末尾。</li><li>replaceChar (string src, string sub, string dest): 这个函数用于在字符串中替换子字符串。它接受源字符串、要替换的子字符串以及替换后的字符串作为参数，并在源字符串中将所有匹配的子字符串替换为指定的字符串。</li><li>handle_EOF (char *dest, char *src): 这个函数似乎有些问题，因为它试图将源数组的内容复制到目标数组中。然而，它使用了一个局部数组 arr，并将其指针赋给了目标数组，这意味着在函数返回后，arr 将超出作用域并丢失其内容。因此，这个函数可能无法正确工作。</li></ol><ul><li>整体来说，这段代码是一个基于命令的 USB key 通信程序。它从标准输入读取命令，解析命令并调用相应的函数与 USB key 进行通信，然后将通信结果写入标准输出，并将相关信息记录在日志文件中。</li></ul><h3 id="整理后的代码"><a class="anchor" href="#整理后的代码">#</a> 整理后的代码</h3><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"stdafx.h"</span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"windows.h"</span></span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h></span></span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;io.h></span></span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;json/json.h></span></span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MAX_LEN</span> <span class="token expression"><span class="token number">4096</span></span></span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token keyword">typedef</span> <span class="token keyword">char</span><span class="token operator">*</span> <span class="token punctuation">(</span>WINAPI<span class="token operator">*</span> CONNECTPROC<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token keyword">typedef</span> <span class="token keyword">char</span><span class="token operator">*</span> <span class="token punctuation">(</span>WINAPI<span class="token operator">*</span> COLLSNPROC<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token keyword">typedef</span> <span class="token keyword">char</span><span class="token operator">*</span> <span class="token punctuation">(</span>WINAPI<span class="token operator">*</span> COLLIDPROC<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token keyword">typedef</span> <span class="token keyword">char</span><span class="token operator">*</span> <span class="token punctuation">(</span>WINAPI<span class="token operator">*</span> COLLFPRPROC<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token keyword">typedef</span> <span class="token keyword">char</span><span class="token operator">*</span> <span class="token punctuation">(</span>WINAPI<span class="token operator">*</span> DELFPPROC<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token keyword">typedef</span> <span class="token keyword">char</span><span class="token operator">*</span> <span class="token punctuation">(</span>WINAPI<span class="token operator">*</span> VERIFYPROC<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token comment">// Function prototypes</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token keyword">char</span><span class="token operator">*</span> <span class="token function">get_input</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token keyword">int</span> <span class="token function">out_write</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token keyword">int</span> <span class="token function">write_log_file</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> str<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token keyword">int</span> <span class="token function">arr_cat</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span> dest<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> from<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> src<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>string <span class="token function">replaceChar</span><span class="token punctuation">(</span>string src<span class="token punctuation">,</span> string sub<span class="token punctuation">,</span> string dest<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token keyword">int</span> <span class="token function">handle_EOF</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span> dest<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> src<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token comment">// Global variables</span></pre></td></tr><tr><td data-num="28"></td><td><pre><span class="token keyword">char</span> g_input<span class="token punctuation">[</span>MAX_LEN<span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>HINSTANCE WLinst<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre></pre></td></tr><tr><td data-num="31"></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>    <span class="token comment">// Variables for logging</span></pre></td></tr><tr><td data-num="33"></td><td><pre>    <span class="token keyword">char</span> reclog<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"Received command: "</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>    <span class="token keyword">char</span> commlog<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"Parsed command: "</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>    <span class="token keyword">char</span> castlog<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"Casted command: "</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>    <span class="token keyword">char</span> connlog<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"USB key connect response: "</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>    <span class="token keyword">char</span> snlog<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"USB key SN response: "</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>    <span class="token keyword">char</span> idlog<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"USB key ID number response: "</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>    <span class="token keyword">char</span> fplog<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"USB key fingerprint response: "</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>    <span class="token keyword">char</span> dellog<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"USB key delete fingerprint response: "</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>    <span class="token keyword">char</span> verifylog<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"USB key verify response: "</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre></pre></td></tr><tr><td data-num="43"></td><td><pre>    <span class="token comment">// Set input/output mode to binary</span></pre></td></tr><tr><td data-num="44"></td><td><pre>    <span class="token keyword">int</span> result <span class="token operator">=</span> <span class="token function">_setmode</span><span class="token punctuation">(</span><span class="token function">_fileno</span><span class="token punctuation">(</span><span class="token constant">stdin</span><span class="token punctuation">)</span><span class="token punctuation">,</span> _O_BINARY<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="46"></td><td><pre>        <span class="token function">out_write</span><span class="token punctuation">(</span><span class="token string">"Cannot set mode\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="47"></td><td><pre></pre></td></tr><tr><td data-num="48"></td><td><pre>    <span class="token comment">// Load library</span></pre></td></tr><tr><td data-num="49"></td><td><pre>    WLinst <span class="token operator">=</span> <span class="token function">LoadLibrary</span><span class="token punctuation">(</span><span class="token string">"natcud.dll"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="50"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>WLinst <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="51"></td><td><pre>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="52"></td><td><pre></pre></td></tr><tr><td data-num="53"></td><td><pre>    <span class="token comment">// Function pointers</span></pre></td></tr><tr><td data-num="54"></td><td><pre>    CONNECTPROC ffconnect <span class="token operator">=</span> <span class="token punctuation">(</span>CONNECTPROC<span class="token punctuation">)</span><span class="token function">GetProcAddress</span><span class="token punctuation">(</span>WLinst<span class="token punctuation">,</span> <span class="token string">"ffconnect"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="55"></td><td><pre>    COLLSNPROC collsn <span class="token operator">=</span> <span class="token punctuation">(</span>COLLSNPROC<span class="token punctuation">)</span><span class="token function">GetProcAddress</span><span class="token punctuation">(</span>WLinst<span class="token punctuation">,</span> <span class="token string">"collTerminalSN"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="56"></td><td><pre>    COLLIDPROC collid <span class="token operator">=</span> <span class="token punctuation">(</span>COLLIDPROC<span class="token punctuation">)</span><span class="token function">GetProcAddress</span><span class="token punctuation">(</span>WLinst<span class="token punctuation">,</span> <span class="token string">"collIdNumber"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="57"></td><td><pre>    COLLFPRPROC collfp <span class="token operator">=</span> <span class="token punctuation">(</span>COLLFPRPROC<span class="token punctuation">)</span><span class="token function">GetProcAddress</span><span class="token punctuation">(</span>WLinst<span class="token punctuation">,</span> <span class="token string">"collFingerPrint"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="58"></td><td><pre>    DELFPPROC delfp <span class="token operator">=</span> <span class="token punctuation">(</span>DELFPPROC<span class="token punctuation">)</span><span class="token function">GetProcAddress</span><span class="token punctuation">(</span>WLinst<span class="token punctuation">,</span> <span class="token string">"deleteFingerprints"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="59"></td><td><pre>    VERIFYPROC verify <span class="token operator">=</span> <span class="token punctuation">(</span>VERIFYPROC<span class="token punctuation">)</span><span class="token function">GetProcAddress</span><span class="token punctuation">(</span>WLinst<span class="token punctuation">,</span> <span class="token string">"verify"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="60"></td><td><pre></pre></td></tr><tr><td data-num="61"></td><td><pre>    <span class="token comment">// Get input</span></pre></td></tr><tr><td data-num="62"></td><td><pre>    <span class="token keyword">char</span><span class="token operator">*</span> tmpcomm <span class="token operator">=</span> <span class="token function">get_input</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="63"></td><td><pre>    <span class="token function">strcat</span><span class="token punctuation">(</span>reclog<span class="token punctuation">,</span> tmpcomm<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="64"></td><td><pre>    <span class="token function">write_log_file</span><span class="token punctuation">(</span>reclog<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="65"></td><td><pre></pre></td></tr><tr><td data-num="66"></td><td><pre>    <span class="token comment">// Parse command</span></pre></td></tr><tr><td data-num="67"></td><td><pre>    std<span class="token double-colon punctuation">::</span>string <span class="token function">command</span><span class="token punctuation">(</span>tmpcomm<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="68"></td><td><pre>    <span class="token function">strcat</span><span class="token punctuation">(</span>castlog<span class="token punctuation">,</span> command<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="69"></td><td><pre>    <span class="token function">write_log_file</span><span class="token punctuation">(</span>castlog<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="70"></td><td><pre></pre></td></tr><tr><td data-num="71"></td><td><pre>    <span class="token comment">// Parse JSON command</span></pre></td></tr><tr><td data-num="72"></td><td><pre>    Json<span class="token double-colon punctuation">::</span>Value jData<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="73"></td><td><pre>    Json<span class="token double-colon punctuation">::</span>Reader reader<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="74"></td><td><pre>    reader<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>command<span class="token punctuation">,</span> jData<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="75"></td><td><pre>    string comname <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>jData<span class="token punctuation">[</span><span class="token string">"cmd"</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">asString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="76"></td><td><pre>    <span class="token function">strcat</span><span class="token punctuation">(</span>commlog<span class="token punctuation">,</span> comname<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="77"></td><td><pre>    <span class="token function">write_log_file</span><span class="token punctuation">(</span>comname<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="78"></td><td><pre></pre></td></tr><tr><td data-num="79"></td><td><pre>    <span class="token comment">// Execute command based on its type</span></pre></td></tr><tr><td data-num="80"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">stricmp</span><span class="token punctuation">(</span>comname<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"connect"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="81"></td><td><pre>        <span class="token keyword">char</span><span class="token operator">*</span> rdata <span class="token operator">=</span> <span class="token function">ffconnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="82"></td><td><pre>        <span class="token function">strcat</span><span class="token punctuation">(</span>connlog<span class="token punctuation">,</span> rdata<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="83"></td><td><pre>        <span class="token function">write_log_file</span><span class="token punctuation">(</span>connlog<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="84"></td><td><pre>        Json<span class="token double-colon punctuation">::</span>Value root<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="85"></td><td><pre>        root<span class="token punctuation">[</span><span class="token string">"cmd"</span><span class="token punctuation">]</span> <span class="token operator">=</span> comname<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="86"></td><td><pre>        root<span class="token punctuation">[</span><span class="token string">"res"</span><span class="token punctuation">]</span> <span class="token operator">=</span> rdata<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="87"></td><td><pre>        std<span class="token double-colon punctuation">::</span>string rtnOut <span class="token operator">=</span> root<span class="token punctuation">.</span><span class="token function">toStyledString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="88"></td><td><pre>        string rtn <span class="token operator">=</span> <span class="token function">replaceChar</span><span class="token punctuation">(</span>rtnOut<span class="token punctuation">,</span> <span class="token string">"\\n"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="89"></td><td><pre>        rtn <span class="token operator">=</span> <span class="token function">replaceChar</span><span class="token punctuation">(</span>rtn<span class="token punctuation">,</span> <span class="token string">"\n"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="90"></td><td><pre>        <span class="token function">out_write</span><span class="token punctuation">(</span>rtn<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="91"></td><td><pre>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">stricmp</span><span class="token punctuation">(</span>comname<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"sn"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="92"></td><td><pre>        <span class="token keyword">char</span><span class="token operator">*</span> rdata <span class="token operator">=</span> <span class="token function">collsn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="93"></td><td><pre>        <span class="token function">strcat</span><span class="token punctuation">(</span>snlog<span class="token punctuation">,</span> rdata<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="94"></td><td><pre>        <span class="token function">write_log_file</span><span class="token punctuation">(</span>snlog<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="95"></td><td><pre>        Json<span class="token double-colon punctuation">::</span>Value root<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="96"></td><td><pre>        root<span class="token punctuation">[</span><span class="token string">"cmd"</span><span class="token punctuation">]</span> <span class="token operator">=</span> comname<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="97"></td><td><pre>        root<span class="token punctuation">[</span><span class="token string">"res"</span><span class="token punctuation">]</span> <span class="token operator">=</span> rdata<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="98"></td><td><pre>        std<span class="token double-colon punctuation">::</span>string rtnOut <span class="token operator">=</span> root<span class="token punctuation">.</span><span class="token function">toStyledString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="99"></td><td><pre>        string rtn <span class="token operator">=</span> <span class="token function">replaceChar</span><span class="token punctuation">(</span>rtnOut<span class="token punctuation">,</span> <span class="token string">"\\n"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="100"></td><td><pre>        rtn <span class="token operator">=</span> <span class="token function">replaceChar</span><span class="token punctuation">(</span>rtn<span class="token punctuation">,</span> <span class="token string">"\n"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="101"></td><td><pre>        <span class="token function">out_write</span><span class="token punctuation">(</span>rtn<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="102"></td><td><pre>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">stricmp</span><span class="token punctuation">(</span>comname<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"i"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="103"></td><td><pre>        Json<span class="token double-colon punctuation">::</span>Value reqData <span class="token operator">=</span> jData<span class="token punctuation">[</span><span class="token string">"req"</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="104"></td><td><pre>        string req <span class="token operator">=</span> reqData<span class="token punctuation">.</span><span class="token function">toStyledString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="105"></td><td><pre>        <span class="token keyword">char</span><span class="token operator">*</span> rdata <span class="token operator">=</span> <span class="token function">collid</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>req<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="106"></td><td><pre>        <span class="token function">strcat</span><span class="token punctuation">(</span>idlog<span class="token punctuation">,</span> rdata<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="107"></td><td><pre>        <span class="token function">write_log_file</span><span class="token punctuation">(</span>idlog<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="108"></td><td><pre>        Json<span class="token double-colon punctuation">::</span>Value root<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="109"></td><td><pre>        root<span class="token punctuation">[</span><span class="token string">"cmd"</span><span class="token punctuation">]</span> <span class="token operator">=</span> comname<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="110"></td><td><pre>        root<span class="token punctuation">[</span><span class="token string">"res"</span><span class="token punctuation">]</span> <span class="token operator">=</span> rdata<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="111"></td><td><pre>        std<span class="token double-colon punctuation">::</span>string rtnOut <span class="token operator">=</span> root<span class="token punctuation">.</span><span class="token function">toStyledString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="112"></td><td><pre>        string rtn <span class="token operator">=</span> <span class="token function">replaceChar</span><span class="token punctuation">(</span>rtnOut<span class="token punctuation">,</span> <span class="token string">"\\n"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="113"></td><td><pre>        rtn <span class="token operator">=</span> <span class="token function">replaceChar</span><span class="token punctuation">(</span>rtn<span class="token punctuation">,</span> <span class="token string">"\n"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="114"></td><td><pre>        <span class="token function">out_write</span><span class="token punctuation">(</span>rtn<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="115"></td><td><pre>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">stricmp</span><span class="token punctuation">(</span>comname<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"f"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="116"></td><td><pre>        Json<span class="token double-colon punctuation">::</span>Value reqData <span class="token operator">=</span> jData<span class="token punctuation">[</span><span class="token string">"req"</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="117"></td><td><pre>        string req <span class="token operator">=</span> reqData<span class="token punctuation">.</span><span class="token function">toStyledString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="118"></td><td><pre>        <span class="token keyword">char</span><span class="token operator">*</span> rdata <span class="token operator">=</span> <span class="token function">collfp</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>req<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="119"></td><td><pre>        <span class="token function">strcat</span><span class="token punctuation">(</span>fplog<span class="token punctuation">,</span> rdata<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="120"></td><td><pre>        <span class="token function">write_log_file</span><span class="token punctuation">(</span>fplog<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="121"></td><td><pre>        Json<span class="token double-colon punctuation">::</span>Value root<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="122"></td><td><pre>        root<span class="token punctuation">[</span><span class="token string">"cmd"</span><span class="token punctuation">]</span> <span class="token operator">=</span> comname<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="123"></td><td><pre>        root<span class="token punctuation">[</span><span class="token string">"res"</span><span class="token punctuation">]</span> <span class="token operator">=</span> rdata<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="124"></td><td><pre>        std<span class="token double-colon punctuation">::</span>string rtnOut <span class="token operator">=</span> root<span class="token punctuation">.</span><span class="token function">toStyledString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="125"></td><td><pre>        string rtn <span class="token operator">=</span> <span class="token function">replaceChar</span><span class="token punctuation">(</span>rtnOut<span class="token punctuation">,</span> <span class="token string">"\\n"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="126"></td><td><pre>        rtn <span class="token operator">=</span> <span class="token function">replaceChar</span><span class="token punctuation">(</span>rtn<span class="token punctuation">,</span> <span class="token string">"\n"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="127"></td><td><pre>        <span class="token function">out_write</span><span class="token punctuation">(</span>rtn<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="128"></td><td><pre>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">stricmp</span><span class="token punctuation">(</span>comname<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"verify"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="129"></td><td><pre>        Json<span class="token double-colon punctuation">::</span>Value reqData <span class="token operator">=</span> jData<span class="token punctuation">[</span><span class="token string">"req"</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="130"></td><td><pre>        string req <span class="token operator">=</span> reqData<span class="token punctuation">.</span><span class="token function">toStyledString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="131"></td><td><pre>        <span class="token keyword">char</span><span class="token operator">*</span> rdata <span class="token operator">=</span> <span class="token function">verify</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>req<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="132"></td><td><pre>        <span class="token function">strcat</span><span class="token punctuation">(</span>verifylog<span class="token punctuation">,</span> rdata<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="133"></td><td><pre>        <span class="token function">write_log_file</span><span class="token punctuation">(</span>verifylog<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="134"></td><td><pre>        Json<span class="token double-colon punctuation">::</span>Value root<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="135"></td><td><pre>        root<span class="token punctuation">[</span><span class="token string">"cmd"</span><span class="token punctuation">]</span> <span class="token operator">=</span> comname<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="136"></td><td><pre>        root<span class="token punctuation">[</span><span class="token string">"res"</span><span class="token punctuation">]</span> <span class="token operator">=</span> rdata<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="137"></td><td><pre>        std<span class="token double-colon punctuation">::</span>string rtnOut <span class="token operator">=</span> root<span class="token punctuation">.</span><span class="token function">toStyledString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="138"></td><td><pre>        string rtn <span class="token operator">=</span> <span class="token function">replaceChar</span><span class="token punctuation">(</span>rtnOut<span class="token punctuation">,</span> <span class="token string">"\\n"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="139"></td><td><pre>        rtn <span class="token operator">=</span> <span class="token function">replaceChar</span><span class="token punctuation">(</span>rtn<span class="token punctuation">,</span> <span class="token string">"\n"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="140"></td><td><pre>        <span class="token function">out_write</span><span class="token punctuation">(</span>rtn<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="141"></td><td><pre>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">stricmp</span><span class="token punctuation">(</span>comname<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"delf"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="142"></td><td><pre>        Json<span class="token double-colon punctuation">::</span>Value reqData <span class="token operator">=</span> jData<span class="token punctuation">[</span><span class="token string">"req"</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="143"></td><td><pre>        string req <span class="token operator">=</span> reqData<span class="token punctuation">.</span><span class="token function">toStyledString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="144"></td><td><pre>        <span class="token keyword">char</span><span class="token operator">*</span> rdata <span class="token operator">=</span> <span class="token function">delfp</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>req<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="145"></td><td><pre>        <span class="token function">strcat</span><span class="token punctuation">(</span>dellog<span class="token punctuation">,</span> rdata<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="146"></td><td><pre>        <span class="token function">write_log_file</span><span class="token punctuation">(</span>dellog<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="147"></td><td><pre>        Json<span class="token double-colon punctuation">::</span>Value root<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="148"></td><td><pre>        root<span class="token punctuation">[</span><span class="token string">"cmd"</span><span class="token punctuation">]</span> <span class="token operator">=</span> comname<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="149"></td><td><pre>        root<span class="token punctuation">[</span><span class="token string">"res"</span><span class="token punctuation">]</span> <span class="token operator">=</span> rdata<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="150"></td><td><pre>        std<span class="token double-colon punctuation">::</span>string rtnOut <span class="token operator">=</span> root<span class="token punctuation">.</span><span class="token function">toStyledString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="151"></td><td><pre>        string rtn <span class="token operator">=</span> <span class="token function">replaceChar</span><span class="token punctuation">(</span>rtnOut<span class="token punctuation">,</span> <span class="token string">"\\n"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="152"></td><td><pre>        rtn <span class="token operator">=</span> <span class="token function">replaceChar</span><span class="token punctuation">(</span>rtn<span class="token punctuation">,</span> <span class="token string">"\n"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="153"></td><td><pre>        <span class="token function">out_write</span><span class="token punctuation">(</span>rtn<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="154"></td><td><pre>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="155"></td><td><pre>        <span class="token keyword">char</span> msg<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"Command failure, exiting"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="156"></td><td><pre>        <span class="token function">write_log_file</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="157"></td><td><pre>        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="158"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="159"></td><td><pre></pre></td></tr><tr><td data-num="160"></td><td><pre>    <span class="token function">out_write</span><span class="token punctuation">(</span><span class="token string">"Exit program"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="161"></td><td><pre>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="162"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="163"></td><td><pre></pre></td></tr><tr><td data-num="164"></td><td><pre><span class="token keyword">char</span><span class="token operator">*</span> <span class="token function">get_input</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="165"></td><td><pre>    <span class="token keyword">int</span> len <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="166"></td><td><pre>    <span class="token keyword">char</span> log<span class="token punctuation">[</span>MAX_LEN<span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="167"></td><td><pre>    <span class="token keyword">char</span> log_len<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="168"></td><td><pre>    <span class="token keyword">int</span> i<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="169"></td><td><pre>    <span class="token keyword">int</span> l<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="170"></td><td><pre>    <span class="token comment">// Read data stream length</span></pre></td></tr><tr><td data-num="171"></td><td><pre>    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">4</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="172"></td><td><pre>        l <span class="token operator">=</span> <span class="token function">getchar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="173"></td><td><pre>        len <span class="token operator">+=</span> l <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span>i <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="174"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="175"></td><td><pre>    <span class="token comment">// Fail if length is 0</span></pre></td></tr><tr><td data-num="176"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>len <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="177"></td><td><pre>        <span class="token function">write_log_file</span><span class="token punctuation">(</span><span class="token string">"Read error, length is 0"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="178"></td><td><pre>        <span class="token function">out_write</span><span class="token punctuation">(</span><span class="token string">"Read error, length is 0"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="179"></td><td><pre>        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="180"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="181"></td><td><pre>    <span class="token function">strcpy</span><span class="token punctuation">(</span>log<span class="token punctuation">,</span> <span class="token string">"Read length is "</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="182"></td><td><pre>    <span class="token function">sprintf</span><span class="token punctuation">(</span>log_len<span class="token punctuation">,</span> <span class="token string">"%ld"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="183"></td><td><pre>    <span class="token function">strcat</span><span class="token punctuation">(</span>log<span class="token punctuation">,</span> log_len<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="184"></td><td><pre>    <span class="token function">write_log_file</span><span class="token punctuation">(</span>log<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="185"></td><td><pre>    <span class="token comment">// Read data stream content</span></pre></td></tr><tr><td data-num="186"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">fgets</span><span class="token punctuation">(</span>g_input<span class="token punctuation">,</span> len <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token constant">stdin</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="187"></td><td><pre>        <span class="token function">write_log_file</span><span class="token punctuation">(</span>g_input<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="188"></td><td><pre>        <span class="token keyword">return</span> g_input<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="189"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="190"></td><td><pre>    <span class="token function">write_log_file</span><span class="token punctuation">(</span><span class="token string">"Read content error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="191"></td><td><pre>    <span class="token function">out_write</span><span class="token punctuation">(</span><span class="token string">"Read content error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="192"></td><td><pre>    <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="193"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="194"></td><td><pre></pre></td></tr><tr><td data-num="195"></td><td><pre><span class="token keyword">int</span> <span class="token function">out_write</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> message<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="196"></td><td><pre>    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> len<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="197"></td><td><pre>    <span class="token keyword">char</span> protocol_len<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="198"></td><td><pre>    <span class="token keyword">char</span> out_all<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="199"></td><td><pre>    <span class="token keyword">char</span> log_len<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="200"></td><td><pre>    <span class="token keyword">char</span> log<span class="token punctuation">[</span>MAX_LEN<span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="201"></td><td><pre>    <span class="token keyword">int</span> i<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="202"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>message <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="203"></td><td><pre>        <span class="token function">write_log_file</span><span class="token punctuation">(</span><span class="token string">"out_write NULL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="204"></td><td><pre>        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="205"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="206"></td><td><pre>    <span class="token function">write_log_file</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="207"></td><td><pre>    len <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="208"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>len <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="209"></td><td><pre>        <span class="token function">write_log_file</span><span class="token punctuation">(</span><span class="token string">"out_write length is 0"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="210"></td><td><pre>        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="211"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="212"></td><td><pre>    <span class="token function">strcpy</span><span class="token punctuation">(</span>log<span class="token punctuation">,</span> <span class="token string">"out_write content length is "</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="213"></td><td><pre>    <span class="token function">sprintf</span><span class="token punctuation">(</span>log_len<span class="token punctuation">,</span> <span class="token string">"%ld"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="214"></td><td><pre>    <span class="token function">strcat</span><span class="token punctuation">(</span>log<span class="token punctuation">,</span> log_len<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="215"></td><td><pre>    <span class="token function">write_log_file</span><span class="token punctuation">(</span>log<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="216"></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%c%c%c%c"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span><span class="token punctuation">(</span>len <span class="token operator">&amp;</span> <span class="token number">0xff</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="217"></td><td><pre>        <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>len <span class="token operator">>></span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="218"></td><td><pre>        <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>len <span class="token operator">>></span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="219"></td><td><pre>        <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>len <span class="token operator">>></span> <span class="token number">24</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="220"></td><td><pre>    <span class="token function">fwrite</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span><span class="token punctuation">,</span> len<span class="token punctuation">,</span> <span class="token constant">stdout</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="221"></td><td><pre>    <span class="token function">fflush</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="222"></td><td><pre>    <span class="token function">write_log_file</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="223"></td><td><pre>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="224"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="225"></td><td><pre></pre></td></tr><tr><td data-num="226"></td><td><pre><span class="token keyword">int</span> <span class="token function">write_log_file</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> str<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="227"></td><td><pre>    FILE<span class="token operator">*</span> file <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span><span class="token string">"data.txt"</span><span class="token punctuation">,</span> <span class="token string">"a+"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="228"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>file <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="229"></td><td><pre>        <span class="token comment">// exit(1);</span></pre></td></tr><tr><td data-num="230"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="231"></td><td><pre>    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> len <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="232"></td><td><pre>    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> wlen <span class="token operator">=</span> <span class="token function">fwrite</span><span class="token punctuation">(</span>str<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span><span class="token punctuation">,</span> len<span class="token punctuation">,</span> file<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="233"></td><td><pre>    <span class="token function">fputc</span><span class="token punctuation">(</span><span class="token char">'\n'</span><span class="token punctuation">,</span> file<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="234"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>len <span class="token operator">!=</span> wlen<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="235"></td><td><pre>        <span class="token comment">//exit(1);</span></pre></td></tr><tr><td data-num="236"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="237"></td><td><pre>    <span class="token function">fclose</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="238"></td><td><pre>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="239"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="240"></td><td><pre></pre></td></tr><tr><td data-num="241"></td><td><pre><span class="token keyword">int</span> <span class="token function">arr_cat</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span> dest<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> from<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> src<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> len<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="242"></td><td><pre>    <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="243"></td><td><pre>    dest <span class="token operator">=</span> dest <span class="token operator">+</span> from<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="244"></td><td><pre>    <span class="token keyword">while</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;</span> len<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="245"></td><td><pre>        <span class="token operator">*</span>dest <span class="token operator">=</span> <span class="token operator">*</span>src<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="246"></td><td><pre>        dest<span class="token operator">++</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="247"></td><td><pre>        src<span class="token operator">++</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="248"></td><td><pre>        i<span class="token operator">++</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="249"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="250"></td><td><pre>    <span class="token keyword">return</span> i<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="251"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="252"></td><td><pre></pre></td></tr><tr><td data-num="253"></td><td><pre>string <span class="token function">replaceChar</span><span class="token punctuation">(</span>string src<span class="token punctuation">,</span> string sub<span class="token punctuation">,</span> string dest<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="254"></td><td><pre>    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="255"></td><td><pre>        <span class="token keyword">unsigned</span> <span class="token keyword">int</span> len <span class="token operator">=</span> src<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="256"></td><td><pre>        <span class="token keyword">int</span> idx <span class="token operator">=</span> src<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>sub<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="257"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>idx <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="258"></td><td><pre>            <span class="token keyword">return</span> src<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="259"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="260"></td><td><pre>        <span class="token keyword">unsigned</span> <span class="token keyword">int</span> slen <span class="token operator">=</span> sub<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="261"></td><td><pre>        src <span class="token operator">=</span> src<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>idx<span class="token punctuation">,</span> slen<span class="token punctuation">,</span> dest<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="262"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="263"></td><td><pre>    <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="264"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="265"></td><td><pre></pre></td></tr><tr><td data-num="266"></td><td><pre><span class="token keyword">int</span> <span class="token function">handle_EOF</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span> dest<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> src<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="267"></td><td><pre>    <span class="token keyword">char</span> arr<span class="token punctuation">[</span>MAX_LEN<span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="268"></td><td><pre>    <span class="token keyword">int</span> idx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="269"></td><td><pre>    <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="270"></td><td><pre>    <span class="token keyword">while</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;</span> MAX_LEN<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="271"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span>src <span class="token operator">!=</span> <span class="token char">'\0'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="272"></td><td><pre>            arr<span class="token punctuation">[</span>idx<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">*</span>src<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="273"></td><td><pre>            idx<span class="token operator">++</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="274"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="275"></td><td><pre>        src<span class="token operator">++</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="276"></td><td><pre>        i<span class="token operator">++</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="277"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="278"></td><td><pre>    arr<span class="token punctuation">[</span>idx <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">'\0'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="279"></td><td><pre>    dest <span class="token operator">=</span> arr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="280"></td><td><pre>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="281"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><ul><li>这段代码是一个与 USB key 进行通信的程序，主要负责从标准输入接收命令，解析命令并调用相应的函数与 USB key 进行交互，然后将结果输出到标准输出并记录日志。以下是每个方法的作用以及可能的优化点：</li></ul><ol><li>get_input (): 该方法用于从标准输入读取数据。它首先读取前四个字节以确定接收到的数据的长度，然后根据长度读取实际的数据内容。优化点：目前没有看到明显的优化点，但可以考虑增加错误处理机制，以应对无效输入或读取错误。</li><li>out_write (const char* message): 该方法用于向标准输出写入数据。它将输入的消息长度转换为四个字节的格式，并将消息内容输出到标准输出流中。优化点：可以考虑使用更有效率的方式将消息长度转换为四个字节的格式，例如使用位运算代替 sprintf。</li><li>write_log_file (const char* str): 该方法用于将字符串写入日志文件 &quot;data.txt&quot; 中。它打开一个文件句柄，将字符串写入文件中，并在每个字符串后添加换行符。优化点：可以考虑批量写入日志，而不是每次写入都打开和关闭文件句柄，以提高效率。</li><li>arr_cat (char* dest, unsigned int from, const char* src, unsigned int len): 该方法用于将源数组的内容连接到目标数组的末尾。它接受目标数组的指针、起始位置、源数组的指针以及源数组的长度作为参数，并将源数组的内容复制到目标数组的末尾。优化点：目前没有明显的优化点，因为这个函数的作用比较简单，已经比较高效。</li><li>replaceChar (string src, string sub, string dest): 该方法用于在字符串中替换子字符串。它接受源字符串、要替换的子字符串以及替换后的字符串作为参数，并在源字符串中将所有匹配的子字符串替换为指定的字符串。优化点：目前没有明显的优化点，但可以考虑使用更高效的字符串替换算法，例如 Boyer-Moore 算法。</li><li>handle_EOF (char* dest, char* src): 这个方法似乎有问题，因为它试图将源数组的内容复制到目标数组中。然而，它使用了一个局部数组 arr，并将其指针赋给了目标数组，这意味着在函数返回后，arr 将超出作用域并丢失其内容。因此，这个方法需要重写以正确工作。</li></ol><ul><li>至于优化的建议，主要集中在文件操作、内存管理和字符串处理等方面。可以通过减少文件操作次数、使用更有效的内存分配和释放方式以及优化字符串处理算法来提高程序的性能和健壮性。</li></ul><h4 id="精简之后的代码"><a class="anchor" href="#精简之后的代码">#</a> 精简之后的代码</h4><ul><li>这个版本将日志记录的部分移除，只保留了与 USB key 通信相关的功能。</li></ul><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"stdafx.h"</span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"windows.h"</span></span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h></span></span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;io.h></span></span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;json/json.h></span></span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MAX_LEN</span> <span class="token expression"><span class="token number">4096</span></span></span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token keyword">typedef</span> <span class="token keyword">char</span><span class="token operator">*</span> <span class="token punctuation">(</span>WINAPI<span class="token operator">*</span> CONNECTPROC<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token keyword">typedef</span> <span class="token keyword">char</span><span class="token operator">*</span> <span class="token punctuation">(</span>WINAPI<span class="token operator">*</span> COLLSNPROC<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token keyword">typedef</span> <span class="token keyword">char</span><span class="token operator">*</span> <span class="token punctuation">(</span>WINAPI<span class="token operator">*</span> COLLIDPROC<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token keyword">typedef</span> <span class="token keyword">char</span><span class="token operator">*</span> <span class="token punctuation">(</span>WINAPI<span class="token operator">*</span> COLLFPRPROC<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token keyword">typedef</span> <span class="token keyword">char</span><span class="token operator">*</span> <span class="token punctuation">(</span>WINAPI<span class="token operator">*</span> DELFPPROC<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token keyword">typedef</span> <span class="token keyword">char</span><span class="token operator">*</span> <span class="token punctuation">(</span>WINAPI<span class="token operator">*</span> VERIFYPROC<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token keyword">char</span> g_input<span class="token punctuation">[</span>MAX_LEN<span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>HINSTANCE WLinst<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token keyword">char</span><span class="token operator">*</span> <span class="token function">get_input</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token keyword">int</span> <span class="token function">out_write</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token keyword">int</span> <span class="token function">arr_cat</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span> dest<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> from<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> src<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>string <span class="token function">replaceChar</span><span class="token punctuation">(</span>string src<span class="token punctuation">,</span> string sub<span class="token punctuation">,</span> string dest<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token keyword">int</span> <span class="token function">handle_EOF</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span> dest<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> src<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token keyword">int</span> result <span class="token operator">=</span> <span class="token function">_setmode</span><span class="token punctuation">(</span><span class="token function">_fileno</span><span class="token punctuation">(</span><span class="token constant">stdin</span><span class="token punctuation">)</span><span class="token punctuation">,</span> _O_BINARY<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="30"></td><td><pre>        <span class="token function">out_write</span><span class="token punctuation">(</span><span class="token string">"Cannot set mode\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre></pre></td></tr><tr><td data-num="32"></td><td><pre>    WLinst <span class="token operator">=</span> <span class="token function">LoadLibrary</span><span class="token punctuation">(</span><span class="token string">"natcud.dll"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>WLinst <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="34"></td><td><pre>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre></pre></td></tr><tr><td data-num="36"></td><td><pre>    CONNECTPROC ffconnect <span class="token operator">=</span> <span class="token punctuation">(</span>CONNECTPROC<span class="token punctuation">)</span><span class="token function">GetProcAddress</span><span class="token punctuation">(</span>WLinst<span class="token punctuation">,</span> <span class="token string">"ffconnect"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>    COLLSNPROC collsn <span class="token operator">=</span> <span class="token punctuation">(</span>COLLSNPROC<span class="token punctuation">)</span><span class="token function">GetProcAddress</span><span class="token punctuation">(</span>WLinst<span class="token punctuation">,</span> <span class="token string">"collTerminalSN"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>    COLLIDPROC collid <span class="token operator">=</span> <span class="token punctuation">(</span>COLLIDPROC<span class="token punctuation">)</span><span class="token function">GetProcAddress</span><span class="token punctuation">(</span>WLinst<span class="token punctuation">,</span> <span class="token string">"collIdNumber"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>    COLLFPRPROC collfp <span class="token operator">=</span> <span class="token punctuation">(</span>COLLFPRPROC<span class="token punctuation">)</span><span class="token function">GetProcAddress</span><span class="token punctuation">(</span>WLinst<span class="token punctuation">,</span> <span class="token string">"collFingerPrint"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>    DELFPPROC delfp <span class="token operator">=</span> <span class="token punctuation">(</span>DELFPPROC<span class="token punctuation">)</span><span class="token function">GetProcAddress</span><span class="token punctuation">(</span>WLinst<span class="token punctuation">,</span> <span class="token string">"deleteFingerprints"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>    VERIFYPROC verify <span class="token operator">=</span> <span class="token punctuation">(</span>VERIFYPROC<span class="token punctuation">)</span><span class="token function">GetProcAddress</span><span class="token punctuation">(</span>WLinst<span class="token punctuation">,</span> <span class="token string">"verify"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre></pre></td></tr><tr><td data-num="43"></td><td><pre>    <span class="token keyword">char</span><span class="token operator">*</span> tmpcomm <span class="token operator">=</span> <span class="token function">get_input</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="44"></td><td><pre></pre></td></tr><tr><td data-num="45"></td><td><pre>    Json<span class="token double-colon punctuation">::</span>Value jData<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>    Json<span class="token double-colon punctuation">::</span>Reader reader<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>    reader<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>tmpcomm<span class="token punctuation">,</span> jData<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>    string comname <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>jData<span class="token punctuation">[</span><span class="token string">"cmd"</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">asString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="49"></td><td><pre></pre></td></tr><tr><td data-num="50"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">stricmp</span><span class="token punctuation">(</span>comname<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"connect"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="51"></td><td><pre>        <span class="token keyword">char</span><span class="token operator">*</span> rdata <span class="token operator">=</span> <span class="token function">ffconnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="52"></td><td><pre>        <span class="token function">out_write</span><span class="token punctuation">(</span>rdata<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="53"></td><td><pre>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">stricmp</span><span class="token punctuation">(</span>comname<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"sn"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="54"></td><td><pre>        <span class="token keyword">char</span><span class="token operator">*</span> rdata <span class="token operator">=</span> <span class="token function">collsn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="55"></td><td><pre>        <span class="token function">out_write</span><span class="token punctuation">(</span>rdata<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="56"></td><td><pre>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">stricmp</span><span class="token punctuation">(</span>comname<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"i"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="57"></td><td><pre>        Json<span class="token double-colon punctuation">::</span>Value reqData <span class="token operator">=</span> jData<span class="token punctuation">[</span><span class="token string">"req"</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="58"></td><td><pre>        string req <span class="token operator">=</span> reqData<span class="token punctuation">.</span><span class="token function">toStyledString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="59"></td><td><pre>        <span class="token keyword">char</span><span class="token operator">*</span> rdata <span class="token operator">=</span> <span class="token function">collid</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>req<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="60"></td><td><pre>        <span class="token function">out_write</span><span class="token punctuation">(</span>rdata<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="61"></td><td><pre>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">stricmp</span><span class="token punctuation">(</span>comname<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"f"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="62"></td><td><pre>        Json<span class="token double-colon punctuation">::</span>Value reqData <span class="token operator">=</span> jData<span class="token punctuation">[</span><span class="token string">"req"</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="63"></td><td><pre>        string req <span class="token operator">=</span> reqData<span class="token punctuation">.</span><span class="token function">toStyledString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="64"></td><td><pre>        <span class="token keyword">char</span><span class="token operator">*</span> rdata <span class="token operator">=</span> <span class="token function">collfp</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>req<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="65"></td><td><pre>        <span class="token function">out_write</span><span class="token punctuation">(</span>rdata<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="66"></td><td><pre>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">stricmp</span><span class="token punctuation">(</span>comname<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"verify"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="67"></td><td><pre>        Json<span class="token double-colon punctuation">::</span>Value reqData <span class="token operator">=</span> jData<span class="token punctuation">[</span><span class="token string">"req"</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="68"></td><td><pre>        string req <span class="token operator">=</span> reqData<span class="token punctuation">.</span><span class="token function">toStyledString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="69"></td><td><pre>        <span class="token keyword">char</span><span class="token operator">*</span> rdata <span class="token operator">=</span> <span class="token function">verify</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>req<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="70"></td><td><pre>        <span class="token function">out_write</span><span class="token punctuation">(</span>rdata<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="71"></td><td><pre>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">stricmp</span><span class="token punctuation">(</span>comname<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"delf"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="72"></td><td><pre>        Json<span class="token double-colon punctuation">::</span>Value reqData <span class="token operator">=</span> jData<span class="token punctuation">[</span><span class="token string">"req"</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="73"></td><td><pre>        string req <span class="token operator">=</span> reqData<span class="token punctuation">.</span><span class="token function">toStyledString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="74"></td><td><pre>        <span class="token keyword">char</span><span class="token operator">*</span> rdata <span class="token operator">=</span> <span class="token function">delfp</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>req<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="75"></td><td><pre>        <span class="token function">out_write</span><span class="token punctuation">(</span>rdata<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="76"></td><td><pre>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="77"></td><td><pre>        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="78"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="79"></td><td><pre></pre></td></tr><tr><td data-num="80"></td><td><pre>    <span class="token function">out_write</span><span class="token punctuation">(</span><span class="token string">"Exit program"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="81"></td><td><pre>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="82"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="83"></td><td><pre></pre></td></tr><tr><td data-num="84"></td><td><pre><span class="token keyword">char</span><span class="token operator">*</span> <span class="token function">get_input</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="85"></td><td><pre>    <span class="token keyword">int</span> len <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="86"></td><td><pre>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">4</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="87"></td><td><pre>        <span class="token keyword">int</span> l <span class="token operator">=</span> <span class="token function">getchar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="88"></td><td><pre>        len <span class="token operator">+=</span> l <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span>i <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="89"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="90"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>len <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="91"></td><td><pre>        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="92"></td><td><pre></pre></td></tr><tr><td data-num="93"></td><td><pre>    <span class="token function">fgets</span><span class="token punctuation">(</span>g_input<span class="token punctuation">,</span> len <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token constant">stdin</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="94"></td><td><pre>    <span class="token keyword">return</span> g_input<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="95"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="96"></td><td><pre></pre></td></tr><tr><td data-num="97"></td><td><pre><span class="token keyword">int</span> <span class="token function">out_write</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> message<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="98"></td><td><pre>    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> len <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="99"></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%c%c%c%c"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span><span class="token punctuation">(</span>len <span class="token operator">&amp;</span> <span class="token number">0xff</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="100"></td><td><pre>        <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>len <span class="token operator">>></span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="101"></td><td><pre>        <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>len <span class="token operator">>></span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="102"></td><td><pre>        <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>len <span class="token operator">>></span> <span class="token number">24</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="103"></td><td><pre>    <span class="token function">fwrite</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span><span class="token punctuation">,</span> len<span class="token punctuation">,</span> <span class="token constant">stdout</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="104"></td><td><pre>    <span class="token function">fflush</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="105"></td><td><pre>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="106"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="107"></td><td><pre></pre></td></tr><tr><td data-num="108"></td><td><pre><span class="token keyword">int</span> <span class="token function">arr_cat</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span> dest<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> from<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> src<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> len<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="109"></td><td><pre>    <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="110"></td><td><pre>    dest <span class="token operator">=</span> dest <span class="token operator">+</span> from<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="111"></td><td><pre>    <span class="token keyword">while</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;</span> len<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="112"></td><td><pre>        <span class="token operator">*</span>dest <span class="token operator">=</span> <span class="token operator">*</span>src<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="113"></td><td><pre>        dest<span class="token operator">++</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="114"></td><td><pre>        src<span class="token operator">++</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="115"></td><td><pre>        i<span class="token operator">++</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="116"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="117"></td><td><pre>    <span class="token keyword">return</span> i<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="118"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="119"></td><td><pre></pre></td></tr><tr><td data-num="120"></td><td><pre>string <span class="token function">replaceChar</span><span class="token punctuation">(</span>string src<span class="token punctuation">,</span> string sub<span class="token punctuation">,</span> string dest<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="121"></td><td><pre>    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="122"></td><td><pre>        <span class="token keyword">unsigned</span> <span class="token keyword">int</span> len <span class="token operator">=</span> src<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="123"></td><td><pre>        <span class="token keyword">int</span> idx <span class="token operator">=</span> src<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>sub<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="124"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>idx <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="125"></td><td><pre>            <span class="token keyword">return</span> src<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="126"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="127"></td><td><pre>        <span class="token keyword">unsigned</span> <span class="token keyword">int</span> slen <span class="token operator">=</span> sub<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="128"></td><td><pre>        src <span class="token operator">=</span> src<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>idx<span class="token punctuation">,</span> slen<span class="token punctuation">,</span> dest<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="129"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="130"></td><td><pre>    <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="131"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="132"></td><td><pre></pre></td></tr><tr><td data-num="133"></td><td><pre><span class="token keyword">int</span> <span class="token function">handle_EOF</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span> dest<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> src<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="134"></td><td><pre>    <span class="token keyword">char</span> arr<span class="token punctuation">[</span>MAX_LEN<span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="135"></td><td><pre>    <span class="token keyword">int</span> idx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="136"></td><td><pre>    <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="137"></td><td><pre>    <span class="token keyword">while</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;</span> MAX_LEN<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="138"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span>src <span class="token operator">!=</span> <span class="token char">'\0'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="139"></td><td><pre>            arr<span class="token punctuation">[</span>idx<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">*</span>src<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="140"></td><td><pre>            idx<span class="token operator">++</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="141"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="142"></td><td><pre>        src<span class="token operator">++</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="143"></td><td><pre>        i<span class="token operator">++</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="144"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="145"></td><td><pre>    arr<span class="token punctuation">[</span>idx <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">'\0'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="146"></td><td><pre>    dest <span class="token operator">=</span> arr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="147"></td><td><pre>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="148"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><ul><li>这段代码是一个简单的与外部库进行交互的程序，它通过标准输入接收命令，解析命令后调用外部库的相应函数，并将结果输出到标准输出。以下是每个方法的作用以及可能的优化点：</li></ul><ol><li>get_input (): 该方法用于从标准输入读取数据。它首先读取前四个字节以确定接收到的数据的长度，然后根据长度读取实际的数据内容。优化点：可以增加错误处理机制，以应对无效输入或读取错误。</li><li>out_write (const char* message): 该方法用于向标准输出写入数据。它将输入的消息长度转换为四个字节的格式，并将消息内容输出到标准输出流中。优化点：可以考虑使用更有效率的方式将消息长度转换为四个字节的格式，例如使用位运算代替 sprintf。</li><li>arr_cat (char* dest, unsigned int from, const char* src, unsigned int len): 该方法用于将源数组的内容连接到目标数组的末尾。优化点：目前没有明显的优化点，因为这个函数的作用比较简单，已经比较高效。</li><li>replaceChar (string src, string sub, string dest): 该方法用于在字符串中替换子字符串。优化点：目前没有明显的优化点，但可以考虑使用更高效的字符串替换算法，例如 Boyer-Moore 算法。</li><li>handle_EOF (char* dest, char* src): 该方法似乎有问题，因为它试图将源数组的内容复制到目标数组中。然而，它使用了一个局部数组 arr，并将其指针赋给了目标数组，这意味着在函数返回后，arr 将超出作用域并丢失其内容。因此，这个方法需要重写以正确工作。</li></ol><ul><li>针对这段代码的改进方向：</li></ul><ol><li>错误处理：增加对输入数据的错误处理，例如长度为零或无效数据。</li><li>内存管理：检查所有的内存分配和释放，确保没有内存泄漏或悬空指针。</li><li>效率优化：尽可能减少文件操作次数，例如批量写入日志文件，以及优化字符串处理算法的性能。</li><li>代码清晰度：提高代码的可读性和可维护性，例如使用更有意义的变量名和添加注释来解释代码的功能和逻辑。</li></ol><ul><li>对于一个新手来说，可以逐步改进代码，首先着重处理错误情况，然后关注内存管理和效率优化，最后提高代码的可读性和清晰度。通过逐步改进，新手可以更好地理解代码，并逐渐掌握更高级的优化技巧和编程实践。</li></ul><h4 id="提高代码清晰度"><a class="anchor" href="#提高代码清晰度">#</a> 提高代码清晰度</h4><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"stdafx.h"</span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"windows.h"</span></span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h></span></span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;io.h></span></span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;json/json.h></span></span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MAX_INPUT_LEN</span> <span class="token expression"><span class="token number">4096</span></span></span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token comment">// Function pointers for external library functions</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token keyword">typedef</span> <span class="token keyword">char</span><span class="token operator">*</span> <span class="token punctuation">(</span>WINAPI<span class="token operator">*</span> CONNECTPROC<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token keyword">typedef</span> <span class="token keyword">char</span><span class="token operator">*</span> <span class="token punctuation">(</span>WINAPI<span class="token operator">*</span> COLLSNPROC<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token keyword">typedef</span> <span class="token keyword">char</span><span class="token operator">*</span> <span class="token punctuation">(</span>WINAPI<span class="token operator">*</span> COLLIDPROC<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token keyword">typedef</span> <span class="token keyword">char</span><span class="token operator">*</span> <span class="token punctuation">(</span>WINAPI<span class="token operator">*</span> COLLFPRPROC<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token keyword">typedef</span> <span class="token keyword">char</span><span class="token operator">*</span> <span class="token punctuation">(</span>WINAPI<span class="token operator">*</span> DELFPPROC<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token keyword">typedef</span> <span class="token keyword">char</span><span class="token operator">*</span> <span class="token punctuation">(</span>WINAPI<span class="token operator">*</span> VERIFYPROC<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token comment">// Global variables</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token keyword">char</span> g_input<span class="token punctuation">[</span>MAX_INPUT_LEN<span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>HINSTANCE libraryInstance<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token comment">// Function prototypes</span></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token keyword">char</span><span class="token operator">*</span> <span class="token function">getInput</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token keyword">int</span> <span class="token function">writeToOutput</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token comment">// Set input mode to binary</span></pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token keyword">int</span> result <span class="token operator">=</span> <span class="token function">_setmode</span><span class="token punctuation">(</span><span class="token function">_fileno</span><span class="token punctuation">(</span><span class="token constant">stdin</span><span class="token punctuation">)</span><span class="token punctuation">,</span> _O_BINARY<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="31"></td><td><pre>        <span class="token function">writeToOutput</span><span class="token punctuation">(</span><span class="token string">"Cannot set input mode\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre></pre></td></tr><tr><td data-num="33"></td><td><pre>    <span class="token comment">// Load library</span></pre></td></tr><tr><td data-num="34"></td><td><pre>    libraryInstance <span class="token operator">=</span> <span class="token function">LoadLibrary</span><span class="token punctuation">(</span><span class="token string">"natcud.dll"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>libraryInstance <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="36"></td><td><pre>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="37"></td><td><pre></pre></td></tr><tr><td data-num="38"></td><td><pre>    <span class="token comment">// Function pointers for library functions</span></pre></td></tr><tr><td data-num="39"></td><td><pre>    CONNECTPROC connectFunction <span class="token operator">=</span> <span class="token punctuation">(</span>CONNECTPROC<span class="token punctuation">)</span><span class="token function">GetProcAddress</span><span class="token punctuation">(</span>libraryInstance<span class="token punctuation">,</span> <span class="token string">"ffconnect"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>    COLLSNPROC collsnFunction <span class="token operator">=</span> <span class="token punctuation">(</span>COLLSNPROC<span class="token punctuation">)</span><span class="token function">GetProcAddress</span><span class="token punctuation">(</span>libraryInstance<span class="token punctuation">,</span> <span class="token string">"collTerminalSN"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>    COLLIDPROC collidFunction <span class="token operator">=</span> <span class="token punctuation">(</span>COLLIDPROC<span class="token punctuation">)</span><span class="token function">GetProcAddress</span><span class="token punctuation">(</span>libraryInstance<span class="token punctuation">,</span> <span class="token string">"collIdNumber"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>    COLLFPRPROC collfpFunction <span class="token operator">=</span> <span class="token punctuation">(</span>COLLFPRPROC<span class="token punctuation">)</span><span class="token function">GetProcAddress</span><span class="token punctuation">(</span>libraryInstance<span class="token punctuation">,</span> <span class="token string">"collFingerPrint"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>    DELFPPROC delfpFunction <span class="token operator">=</span> <span class="token punctuation">(</span>DELFPPROC<span class="token punctuation">)</span><span class="token function">GetProcAddress</span><span class="token punctuation">(</span>libraryInstance<span class="token punctuation">,</span> <span class="token string">"deleteFingerprints"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>    VERIFYPROC verifyFunction <span class="token operator">=</span> <span class="token punctuation">(</span>VERIFYPROC<span class="token punctuation">)</span><span class="token function">GetProcAddress</span><span class="token punctuation">(</span>libraryInstance<span class="token punctuation">,</span> <span class="token string">"verify"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="45"></td><td><pre></pre></td></tr><tr><td data-num="46"></td><td><pre>    <span class="token comment">// Get input from stdin</span></pre></td></tr><tr><td data-num="47"></td><td><pre>    <span class="token keyword">char</span><span class="token operator">*</span> receivedInput <span class="token operator">=</span> <span class="token function">getInput</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="48"></td><td><pre></pre></td></tr><tr><td data-num="49"></td><td><pre>    <span class="token comment">// Parse JSON input</span></pre></td></tr><tr><td data-num="50"></td><td><pre>    Json<span class="token double-colon punctuation">::</span>Value jsonData<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="51"></td><td><pre>    Json<span class="token double-colon punctuation">::</span>Reader jsonReader<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="52"></td><td><pre>    jsonReader<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>receivedInput<span class="token punctuation">,</span> jsonData<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="53"></td><td><pre>    string commandName <span class="token operator">=</span> jsonData<span class="token punctuation">[</span><span class="token string">"cmd"</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">asString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="54"></td><td><pre></pre></td></tr><tr><td data-num="55"></td><td><pre>    <span class="token comment">// Execute command based on its type</span></pre></td></tr><tr><td data-num="56"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">stricmp</span><span class="token punctuation">(</span>commandName<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"connect"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="57"></td><td><pre>        <span class="token keyword">char</span><span class="token operator">*</span> responseData <span class="token operator">=</span> <span class="token function">connectFunction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="58"></td><td><pre>        <span class="token function">writeToOutput</span><span class="token punctuation">(</span>responseData<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="59"></td><td><pre>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">stricmp</span><span class="token punctuation">(</span>commandName<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"sn"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="60"></td><td><pre>        <span class="token keyword">char</span><span class="token operator">*</span> responseData <span class="token operator">=</span> <span class="token function">collsnFunction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="61"></td><td><pre>        <span class="token function">writeToOutput</span><span class="token punctuation">(</span>responseData<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="62"></td><td><pre>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">stricmp</span><span class="token punctuation">(</span>commandName<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"i"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="63"></td><td><pre>        Json<span class="token double-colon punctuation">::</span>Value requestData <span class="token operator">=</span> jsonData<span class="token punctuation">[</span><span class="token string">"req"</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="64"></td><td><pre>        string request <span class="token operator">=</span> requestData<span class="token punctuation">.</span><span class="token function">toStyledString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="65"></td><td><pre>        <span class="token keyword">char</span><span class="token operator">*</span> responseData <span class="token operator">=</span> <span class="token function">collidFunction</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>request<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="66"></td><td><pre>        <span class="token function">writeToOutput</span><span class="token punctuation">(</span>responseData<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="67"></td><td><pre>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">stricmp</span><span class="token punctuation">(</span>commandName<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"f"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="68"></td><td><pre>        Json<span class="token double-colon punctuation">::</span>Value requestData <span class="token operator">=</span> jsonData<span class="token punctuation">[</span><span class="token string">"req"</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="69"></td><td><pre>        string request <span class="token operator">=</span> requestData<span class="token punctuation">.</span><span class="token function">toStyledString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="70"></td><td><pre>        <span class="token keyword">char</span><span class="token operator">*</span> responseData <span class="token operator">=</span> <span class="token function">collfpFunction</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>request<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="71"></td><td><pre>        <span class="token function">writeToOutput</span><span class="token punctuation">(</span>responseData<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="72"></td><td><pre>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">stricmp</span><span class="token punctuation">(</span>commandName<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"verify"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="73"></td><td><pre>        Json<span class="token double-colon punctuation">::</span>Value requestData <span class="token operator">=</span> jsonData<span class="token punctuation">[</span><span class="token string">"req"</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="74"></td><td><pre>        string request <span class="token operator">=</span> requestData<span class="token punctuation">.</span><span class="token function">toStyledString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="75"></td><td><pre>        <span class="token keyword">char</span><span class="token operator">*</span> responseData <span class="token operator">=</span> <span class="token function">verifyFunction</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>request<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="76"></td><td><pre>        <span class="token function">writeToOutput</span><span class="token punctuation">(</span>responseData<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="77"></td><td><pre>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">stricmp</span><span class="token punctuation">(</span>commandName<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"delf"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="78"></td><td><pre>        Json<span class="token double-colon punctuation">::</span>Value requestData <span class="token operator">=</span> jsonData<span class="token punctuation">[</span><span class="token string">"req"</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="79"></td><td><pre>        string request <span class="token operator">=</span> requestData<span class="token punctuation">.</span><span class="token function">toStyledString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="80"></td><td><pre>        <span class="token keyword">char</span><span class="token operator">*</span> responseData <span class="token operator">=</span> <span class="token function">delfpFunction</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>request<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="81"></td><td><pre>        <span class="token function">writeToOutput</span><span class="token punctuation">(</span>responseData<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="82"></td><td><pre>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="83"></td><td><pre>        <span class="token comment">// Unknown command</span></pre></td></tr><tr><td data-num="84"></td><td><pre>        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="85"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="86"></td><td><pre></pre></td></tr><tr><td data-num="87"></td><td><pre>    <span class="token comment">// Inform about program exit</span></pre></td></tr><tr><td data-num="88"></td><td><pre>    <span class="token function">writeToOutput</span><span class="token punctuation">(</span><span class="token string">"Exit program"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="89"></td><td><pre>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="90"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="91"></td><td><pre></pre></td></tr><tr><td data-num="92"></td><td><pre><span class="token comment">// Read input from stdin</span></pre></td></tr><tr><td data-num="93"></td><td><pre><span class="token keyword">char</span><span class="token operator">*</span> <span class="token function">getInput</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="94"></td><td><pre>    <span class="token keyword">int</span> inputLength <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="95"></td><td><pre>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">4</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="96"></td><td><pre>        <span class="token keyword">int</span> byte <span class="token operator">=</span> <span class="token function">getchar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="97"></td><td><pre>        inputLength <span class="token operator">+=</span> byte <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span>i <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="98"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="99"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>inputLength <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="100"></td><td><pre>        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="101"></td><td><pre></pre></td></tr><tr><td data-num="102"></td><td><pre>    <span class="token function">fgets</span><span class="token punctuation">(</span>g_input<span class="token punctuation">,</span> inputLength <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token constant">stdin</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="103"></td><td><pre>    <span class="token keyword">return</span> g_input<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="104"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="105"></td><td><pre></pre></td></tr><tr><td data-num="106"></td><td><pre><span class="token comment">// Write output to stdout</span></pre></td></tr><tr><td data-num="107"></td><td><pre><span class="token keyword">int</span> <span class="token function">writeToOutput</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> message<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="108"></td><td><pre>    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> messageLength <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="109"></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%c%c%c%c"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span><span class="token punctuation">(</span>messageLength <span class="token operator">&amp;</span> <span class="token number">0xff</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="110"></td><td><pre>        <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>messageLength <span class="token operator">>></span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="111"></td><td><pre>        <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>messageLength <span class="token operator">>></span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="112"></td><td><pre>        <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>messageLength <span class="token operator">>></span> <span class="token number">24</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="113"></td><td><pre>    <span class="token function">fwrite</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span><span class="token punctuation">,</span> messageLength<span class="token punctuation">,</span> <span class="token constant">stdout</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="114"></td><td><pre>    <span class="token function">fflush</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="115"></td><td><pre>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="116"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h2 id="demo1"><a class="anchor" href="#demo1">#</a> demo1</h2><h3 id="原始代码-2"><a class="anchor" href="#原始代码-2">#</a> 原始代码</h3><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// demo1.cpp : Defines the initialization routines for the DLL.</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"stdafx.h"</span></span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"demo1.h"</span></span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;json/json.h></span></span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment">// YSIDObjBB.cpp : Implementation of CYSIDObjBB</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"afxinet.h"</span></span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"usb_thread.h"</span></span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"TCPClient_FT.h"</span></span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"global.h"</span></span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"ZBase64.h"</span></span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"GSSocket.h"</span></span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token keyword">bool</span> bExit<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token keyword">char</span> DataB<span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>Json<span class="token double-colon punctuation">::</span>Value root<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>std<span class="token double-colon punctuation">::</span>string rtnOut<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre></pre></td></tr><tr><td data-num="21"></td><td><pre>CString SERVERIPARRAY<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//ip 组</span></pre></td></tr><tr><td data-num="22"></td><td><pre>CString SERVERIP <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span><span class="token comment">// 实际连上的 IP</span></pre></td></tr><tr><td data-num="23"></td><td><pre>UINT SERVERCOUNT <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token keyword">char</span> mip<span class="token punctuation">[</span><span class="token number">30</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token keyword">char</span> sID<span class="token punctuation">[</span><span class="token number">30</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token comment">//CString SERVERIP ;</span></pre></td></tr><tr><td data-num="28"></td><td><pre><span class="token keyword">char</span> CODEHEAD<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token char">'0'</span><span class="token punctuation">,</span> <span class="token char">'1'</span><span class="token punctuation">,</span> <span class="token char">'T'</span><span class="token punctuation">,</span> <span class="token char">'Y'</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>CWinThread <span class="token operator">*</span>usbread_thread<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>CWinThread <span class="token operator">*</span>checkThread<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre></pre></td></tr><tr><td data-num="32"></td><td><pre><span class="token keyword">unsigned</span> <span class="token keyword">int</span> DelayTime<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>UINT nEndCode<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>HINSTANCE WLinst<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre><span class="token keyword">typedef</span> <span class="token keyword">int</span><span class="token punctuation">(</span>WINAPI</pre></td></tr><tr><td data-num="36"></td><td><pre><span class="token operator">*</span>GETBMPPROC<span class="token punctuation">)</span><span class="token punctuation">(</span></pre></td></tr><tr><td data-num="37"></td><td><pre>LPCSTR a<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="38"></td><td><pre><span class="token keyword">int</span> b</pre></td></tr><tr><td data-num="39"></td><td><pre><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>GETBMPPROC AAAGetBmp<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="41"></td><td><pre><span class="token keyword">int</span> bEncrypt<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre><span class="token keyword">extern</span> <span class="token keyword">char</span> namebuf<span class="token punctuation">[</span><span class="token number">30</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="43"></td><td><pre><span class="token keyword">extern</span> UINT ClientPort<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="44"></td><td><pre></pre></td></tr><tr><td data-num="45"></td><td><pre><span class="token keyword">char</span> AreaCode<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token number">0xa3</span><span class="token punctuation">,</span> <span class="token number">0xb2</span><span class="token punctuation">,</span> <span class="token number">0xc1</span><span class="token punctuation">,</span> <span class="token number">0xd5</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x06</span><span class="token punctuation">,</span> <span class="token number">0x05</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="46"></td><td><pre><span class="token keyword">char</span> AreaCodeZ<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span><span class="token number">0xa1</span><span class="token punctuation">,</span> <span class="token number">0xb2</span><span class="token punctuation">,</span> <span class="token number">0xc3</span><span class="token punctuation">,</span> <span class="token number">0xd5</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x06</span><span class="token punctuation">,</span> <span class="token number">0x05</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="47"></td><td><pre>                       <span class="token punctuation">&#123;</span><span class="token number">0xa1</span><span class="token punctuation">,</span> <span class="token number">0xb2</span><span class="token punctuation">,</span> <span class="token number">0xc3</span><span class="token punctuation">,</span> <span class="token number">0xd5</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x01</span><span class="token punctuation">,</span> <span class="token number">0x06</span><span class="token punctuation">,</span> <span class="token number">0x05</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="48"></td><td><pre>                       <span class="token punctuation">&#123;</span><span class="token number">0xa1</span><span class="token punctuation">,</span> <span class="token number">0xb2</span><span class="token punctuation">,</span> <span class="token number">0xc3</span><span class="token punctuation">,</span> <span class="token number">0xd5</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x02</span><span class="token punctuation">,</span> <span class="token number">0x06</span><span class="token punctuation">,</span> <span class="token number">0x05</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="49"></td><td><pre>                       <span class="token punctuation">&#123;</span><span class="token number">0xa1</span><span class="token punctuation">,</span> <span class="token number">0xb2</span><span class="token punctuation">,</span> <span class="token number">0xc3</span><span class="token punctuation">,</span> <span class="token number">0xd5</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x03</span><span class="token punctuation">,</span> <span class="token number">0x06</span><span class="token punctuation">,</span> <span class="token number">0x05</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="50"></td><td><pre>                       <span class="token punctuation">&#123;</span><span class="token number">0xa1</span><span class="token punctuation">,</span> <span class="token number">0xb2</span><span class="token punctuation">,</span> <span class="token number">0xc3</span><span class="token punctuation">,</span> <span class="token number">0xd5</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x04</span><span class="token punctuation">,</span> <span class="token number">0x06</span><span class="token punctuation">,</span> <span class="token number">0x05</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="51"></td><td><pre>                       <span class="token punctuation">&#123;</span><span class="token number">0xa3</span><span class="token punctuation">,</span> <span class="token number">0xb2</span><span class="token punctuation">,</span> <span class="token number">0xc1</span><span class="token punctuation">,</span> <span class="token number">0xd5</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x06</span><span class="token punctuation">,</span> <span class="token number">0x05</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="52"></td><td><pre>                       <span class="token punctuation">&#123;</span><span class="token number">0xa3</span><span class="token punctuation">,</span> <span class="token number">0xb2</span><span class="token punctuation">,</span> <span class="token number">0xc1</span><span class="token punctuation">,</span> <span class="token number">0xd5</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x06</span><span class="token punctuation">,</span> <span class="token number">0x05</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="53"></td><td><pre>                       <span class="token punctuation">&#123;</span><span class="token number">0xa3</span><span class="token punctuation">,</span> <span class="token number">0xb2</span><span class="token punctuation">,</span> <span class="token number">0xc1</span><span class="token punctuation">,</span> <span class="token number">0xd5</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x06</span><span class="token punctuation">,</span> <span class="token number">0x05</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="54"></td><td><pre>                       <span class="token punctuation">&#123;</span><span class="token number">0xa3</span><span class="token punctuation">,</span> <span class="token number">0xb2</span><span class="token punctuation">,</span> <span class="token number">0xc1</span><span class="token punctuation">,</span> <span class="token number">0xd5</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x06</span><span class="token punctuation">,</span> <span class="token number">0x05</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="55"></td><td><pre>                       <span class="token punctuation">&#123;</span><span class="token number">0xa3</span><span class="token punctuation">,</span> <span class="token number">0xb2</span><span class="token punctuation">,</span> <span class="token number">0xc1</span><span class="token punctuation">,</span> <span class="token number">0xd5</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x06</span><span class="token punctuation">,</span> <span class="token number">0x05</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="56"></td><td><pre>                       <span class="token punctuation">&#123;</span><span class="token number">0xa3</span><span class="token punctuation">,</span> <span class="token number">0xb2</span><span class="token punctuation">,</span> <span class="token number">0xc1</span><span class="token punctuation">,</span> <span class="token number">0xd5</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x06</span><span class="token punctuation">,</span> <span class="token number">0x05</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="57"></td><td><pre>                       <span class="token punctuation">&#123;</span><span class="token number">0xa3</span><span class="token punctuation">,</span> <span class="token number">0xb2</span><span class="token punctuation">,</span> <span class="token number">0xc1</span><span class="token punctuation">,</span> <span class="token number">0xd5</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x06</span><span class="token punctuation">,</span> <span class="token number">0x05</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="58"></td><td><pre>                       <span class="token punctuation">&#123;</span><span class="token number">0xa3</span><span class="token punctuation">,</span> <span class="token number">0xb2</span><span class="token punctuation">,</span> <span class="token number">0xc1</span><span class="token punctuation">,</span> <span class="token number">0xd5</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x06</span><span class="token punctuation">,</span> <span class="token number">0x05</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="59"></td><td><pre>                       <span class="token punctuation">&#123;</span><span class="token number">0xa3</span><span class="token punctuation">,</span> <span class="token number">0xb2</span><span class="token punctuation">,</span> <span class="token number">0xc1</span><span class="token punctuation">,</span> <span class="token number">0xd5</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x06</span><span class="token punctuation">,</span> <span class="token number">0x05</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="60"></td><td><pre>                       <span class="token punctuation">&#123;</span><span class="token number">0xa3</span><span class="token punctuation">,</span> <span class="token number">0xb2</span><span class="token punctuation">,</span> <span class="token number">0xc1</span><span class="token punctuation">,</span> <span class="token number">0xd5</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x06</span><span class="token punctuation">,</span> <span class="token number">0x05</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="61"></td><td><pre>                       <span class="token punctuation">&#123;</span><span class="token number">0xa3</span><span class="token punctuation">,</span> <span class="token number">0xb2</span><span class="token punctuation">,</span> <span class="token number">0xc1</span><span class="token punctuation">,</span> <span class="token number">0xd5</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x06</span><span class="token punctuation">,</span> <span class="token number">0x05</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="62"></td><td><pre>                       <span class="token punctuation">&#123;</span><span class="token number">0xa3</span><span class="token punctuation">,</span> <span class="token number">0xb2</span><span class="token punctuation">,</span> <span class="token number">0xc1</span><span class="token punctuation">,</span> <span class="token number">0xd5</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x06</span><span class="token punctuation">,</span> <span class="token number">0x05</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="63"></td><td><pre>                       <span class="token punctuation">&#123;</span><span class="token number">0xa3</span><span class="token punctuation">,</span> <span class="token number">0xb2</span><span class="token punctuation">,</span> <span class="token number">0xc1</span><span class="token punctuation">,</span> <span class="token number">0xd5</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x06</span><span class="token punctuation">,</span> <span class="token number">0x05</span><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="64"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="65"></td><td><pre></pre></td></tr><tr><td data-num="66"></td><td><pre><span class="token keyword">char</span> ID<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token number">0x01</span><span class="token punctuation">,</span> <span class="token number">0x02</span><span class="token punctuation">,</span> <span class="token number">0x03</span><span class="token punctuation">,</span> <span class="token number">0x05</span><span class="token punctuation">,</span> <span class="token number">0x06</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x01</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="67"></td><td><pre><span class="token comment">//	char Key[8]=&#123;0x2E,0x16,09,0xc0,0x79,0x3f,0x5f,0x00&#125;;</span></pre></td></tr><tr><td data-num="68"></td><td><pre><span class="token keyword">unsigned</span> <span class="token keyword">int</span> key1<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x2E1609C7</span><span class="token punctuation">,</span> <span class="token number">0x793F5F08</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="69"></td><td><pre><span class="token keyword">unsigned</span> <span class="token keyword">int</span> key2<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0xB83D9A75</span><span class="token punctuation">,</span> <span class="token number">0x53A8C40B</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="70"></td><td><pre><span class="token keyword">unsigned</span> <span class="token keyword">int</span> keys<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0xE76AB896</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x530C8D24</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="71"></td><td><pre><span class="token comment">//char minzu[58][10];</span></pre></td></tr><tr><td data-num="72"></td><td><pre><span class="token keyword">char</span> minzu<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">11</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">"未定义"</span><span class="token punctuation">,</span> <span class="token string">"汉"</span><span class="token punctuation">,</span> <span class="token string">"蒙古"</span><span class="token punctuation">,</span> <span class="token string">"回"</span><span class="token punctuation">,</span> <span class="token string">"藏"</span><span class="token punctuation">,</span> <span class="token string">"维吾尔"</span><span class="token punctuation">,</span> <span class="token string">"苗"</span><span class="token punctuation">,</span> <span class="token string">"彝"</span><span class="token punctuation">,</span> <span class="token string">"壮"</span><span class="token punctuation">,</span> <span class="token string">"布依"</span><span class="token punctuation">,</span> <span class="token string">"朝鲜"</span><span class="token punctuation">,</span> <span class="token string">"满"</span><span class="token punctuation">,</span> <span class="token string">"侗"</span><span class="token punctuation">,</span> <span class="token string">"瑶"</span><span class="token punctuation">,</span> <span class="token string">"白"</span><span class="token punctuation">,</span> <span class="token string">"土家"</span><span class="token punctuation">,</span> <span class="token string">"哈尼"</span><span class="token punctuation">,</span> <span class="token string">"哈萨克"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="73"></td><td><pre>                    <span class="token string">"傣"</span><span class="token punctuation">,</span> <span class="token string">"黎"</span><span class="token punctuation">,</span> <span class="token string">"傈僳"</span><span class="token punctuation">,</span> <span class="token string">"佤"</span><span class="token punctuation">,</span> <span class="token string">"畲"</span><span class="token punctuation">,</span> <span class="token string">"高山"</span><span class="token punctuation">,</span> <span class="token string">"拉祜"</span><span class="token punctuation">,</span> <span class="token string">"水"</span><span class="token punctuation">,</span> <span class="token string">"东乡"</span><span class="token punctuation">,</span> <span class="token string">"纳西"</span><span class="token punctuation">,</span> <span class="token string">"景颇"</span><span class="token punctuation">,</span> <span class="token string">"柯尔克孜"</span><span class="token punctuation">,</span> <span class="token string">"土"</span><span class="token punctuation">,</span> <span class="token string">"达斡尔"</span><span class="token punctuation">,</span> <span class="token string">"仫佬"</span><span class="token punctuation">,</span> <span class="token string">"羌"</span><span class="token punctuation">,</span> <span class="token string">"布朗"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="74"></td><td><pre>                    <span class="token string">"撒拉"</span><span class="token punctuation">,</span> <span class="token string">"毛南"</span><span class="token punctuation">,</span> <span class="token string">"仡佬"</span><span class="token punctuation">,</span> <span class="token string">"锡伯"</span><span class="token punctuation">,</span> <span class="token string">"阿昌"</span><span class="token punctuation">,</span> <span class="token string">"普米"</span><span class="token punctuation">,</span> <span class="token string">"塔吉克"</span><span class="token punctuation">,</span> <span class="token string">"怒"</span><span class="token punctuation">,</span> <span class="token string">"乌孜别克"</span><span class="token punctuation">,</span> <span class="token string">"俄罗斯"</span><span class="token punctuation">,</span> <span class="token string">"鄂温克"</span><span class="token punctuation">,</span> <span class="token string">"德昂"</span><span class="token punctuation">,</span> <span class="token string">"保安"</span><span class="token punctuation">,</span> <span class="token string">"裕固"</span><span class="token punctuation">,</span> <span class="token string">"京"</span><span class="token punctuation">,</span> <span class="token string">"塔塔尔"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="75"></td><td><pre>                    <span class="token string">"独龙"</span><span class="token punctuation">,</span> <span class="token string">"鄂伦春"</span><span class="token punctuation">,</span> <span class="token string">"赫哲"</span><span class="token punctuation">,</span> <span class="token string">"门巴"</span><span class="token punctuation">,</span> <span class="token string">"珞巴"</span><span class="token punctuation">,</span> <span class="token string">"基诺"</span><span class="token punctuation">,</span> <span class="token string">"其它"</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="76"></td><td><pre></pre></td></tr><tr><td data-num="77"></td><td><pre><span class="token keyword">char</span> gender<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">"未知"</span><span class="token punctuation">,</span> <span class="token string">"男"</span><span class="token punctuation">,</span> <span class="token string">"女"</span><span class="token punctuation">,</span> <span class="token string">"未说明"</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="78"></td><td><pre></pre></td></tr><tr><td data-num="79"></td><td><pre><span class="token keyword">int</span> <span class="token function">TestConnect</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>ip<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="80"></td><td><pre>    WSADATA wsd<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="81"></td><td><pre>    SOCKET cClient<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="82"></td><td><pre>    <span class="token keyword">int</span> ret<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="83"></td><td><pre>    <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> server<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="84"></td><td><pre>    hostent <span class="token operator">*</span>host <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="85"></td><td><pre></pre></td></tr><tr><td data-num="86"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">WSAStartup</span><span class="token punctuation">(</span><span class="token function">MAKEWORD</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>wsd<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="87"></td><td><pre>    cClient <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> IPPROTO_TCP<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="88"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>cClient <span class="token operator">==</span> INVALID_SOCKET<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="89"></td><td><pre>    <span class="token comment">//set Recv and Send time out</span></pre></td></tr><tr><td data-num="90"></td><td><pre>    DWORD TimeOut <span class="token operator">=</span> <span class="token number">6000</span><span class="token punctuation">;</span> <span class="token comment">// 设置发送超时 6 秒</span></pre></td></tr><tr><td data-num="91"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token double-colon punctuation">::</span><span class="token function">setsockopt</span><span class="token punctuation">(</span>cClient<span class="token punctuation">,</span> SOL_SOCKET<span class="token punctuation">,</span> SO_SNDTIMEO<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>TimeOut<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>TimeOut<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> SOCKET_ERROR<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="92"></td><td><pre>        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="93"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="94"></td><td><pre>    TimeOut <span class="token operator">=</span> <span class="token number">6000</span><span class="token punctuation">;</span><span class="token comment">// 设置接收超时 6 秒</span></pre></td></tr><tr><td data-num="95"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token double-colon punctuation">::</span><span class="token function">setsockopt</span><span class="token punctuation">(</span>cClient<span class="token punctuation">,</span> SOL_SOCKET<span class="token punctuation">,</span> SO_RCVTIMEO<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>TimeOut<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>TimeOut<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> SOCKET_ERROR<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="96"></td><td><pre>        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="97"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="98"></td><td><pre>    <span class="token comment">// 设置非阻塞方式连接</span></pre></td></tr><tr><td data-num="99"></td><td><pre>    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> ul <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="100"></td><td><pre>    ret <span class="token operator">=</span> <span class="token function">ioctlsocket</span><span class="token punctuation">(</span>cClient<span class="token punctuation">,</span> FIONBIO<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>ul<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="101"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">==</span> SOCKET_ERROR<span class="token punctuation">)</span><span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="102"></td><td><pre></pre></td></tr><tr><td data-num="103"></td><td><pre>    <span class="token comment">// 连接</span></pre></td></tr><tr><td data-num="104"></td><td><pre>    server<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="105"></td><td><pre>    server<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span><span class="token number">9007</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="106"></td><td><pre>    server<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr <span class="token operator">=</span> <span class="token function">inet_addr</span><span class="token punctuation">(</span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="107"></td><td><pre>    <span class="token comment">//	    client.sin_addr.s_addr=inet_addr("192.168.1.106");</span></pre></td></tr><tr><td data-num="108"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr <span class="token operator">==</span> INADDR_NONE<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="109"></td><td><pre></pre></td></tr><tr><td data-num="110"></td><td><pre>    <span class="token function">connect</span><span class="token punctuation">(</span>cClient<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>server<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>server<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 立即返回</span></pre></td></tr><tr><td data-num="111"></td><td><pre></pre></td></tr><tr><td data-num="112"></td><td><pre></pre></td></tr><tr><td data-num="113"></td><td><pre>    <span class="token keyword">struct</span> <span class="token class-name">timeval</span> timeout<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="114"></td><td><pre>    fd_set r<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="115"></td><td><pre></pre></td></tr><tr><td data-num="116"></td><td><pre>    <span class="token function">FD_ZERO</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="117"></td><td><pre>    <span class="token function">FD_SET</span><span class="token punctuation">(</span>cClient<span class="token punctuation">,</span> <span class="token operator">&amp;</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="118"></td><td><pre>    timeout<span class="token punctuation">.</span>tv_sec <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// 连接超时 15 秒</span></pre></td></tr><tr><td data-num="119"></td><td><pre>    timeout<span class="token punctuation">.</span>tv_usec <span class="token operator">=</span> <span class="token number">200000</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="120"></td><td><pre>    ret <span class="token operator">=</span> <span class="token function">select</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>r<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>timeout<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="121"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="122"></td><td><pre>        <span class="token double-colon punctuation">::</span><span class="token function">closesocket</span><span class="token punctuation">(</span>cClient<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="123"></td><td><pre></pre></td></tr><tr><td data-num="124"></td><td><pre>        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="125"></td><td><pre>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="126"></td><td><pre>        <span class="token double-colon punctuation">::</span><span class="token function">closesocket</span><span class="token punctuation">(</span>cClient<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="127"></td><td><pre></pre></td></tr><tr><td data-num="128"></td><td><pre>        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="129"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="130"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="131"></td><td><pre></pre></td></tr><tr><td data-num="132"></td><td><pre></pre></td></tr><tr><td data-num="133"></td><td><pre><span class="token keyword">void</span> <span class="token function">CleanFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="134"></td><td><pre>    CString strFileTitle<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="135"></td><td><pre></pre></td></tr><tr><td data-num="136"></td><td><pre>    CFileFind finder<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="137"></td><td><pre>    <span class="token keyword">char</span> curpath<span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="138"></td><td><pre></pre></td></tr><tr><td data-num="139"></td><td><pre>    <span class="token function">GetModuleFileName</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> curpath<span class="token punctuation">,</span> MAX_PATH<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="140"></td><td><pre>    <span class="token punctuation">(</span><span class="token function">_tcsrchr</span><span class="token punctuation">(</span>curpath<span class="token punctuation">,</span> <span class="token function">_T</span><span class="token punctuation">(</span><span class="token char">'\\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//</span></pre></td></tr><tr><td data-num="141"></td><td><pre></pre></td></tr><tr><td data-num="142"></td><td><pre>    BOOL bWorking <span class="token operator">=</span> finder<span class="token punctuation">.</span><span class="token function">FindFile</span><span class="token punctuation">(</span><span class="token string">"P*.bmp"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="143"></td><td><pre>    <span class="token keyword">while</span> <span class="token punctuation">(</span>bWorking<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="144"></td><td><pre></pre></td></tr><tr><td data-num="145"></td><td><pre>        bWorking <span class="token operator">=</span> finder<span class="token punctuation">.</span><span class="token function">FindNextFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="146"></td><td><pre>        strFileTitle <span class="token operator">=</span> finder<span class="token punctuation">.</span><span class="token function">GetFileName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="147"></td><td><pre></pre></td></tr><tr><td data-num="148"></td><td><pre>        <span class="token class-name">CFile</span><span class="token double-colon punctuation">::</span><span class="token function">Remove</span><span class="token punctuation">(</span><span class="token punctuation">(</span>LPCSTR<span class="token punctuation">)</span> strFileTitle<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="149"></td><td><pre></pre></td></tr><tr><td data-num="150"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="151"></td><td><pre>    bWorking <span class="token operator">=</span> finder<span class="token punctuation">.</span><span class="token function">FindFile</span><span class="token punctuation">(</span><span class="token string">"P*.txt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="152"></td><td><pre>    <span class="token keyword">while</span> <span class="token punctuation">(</span>bWorking<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="153"></td><td><pre></pre></td></tr><tr><td data-num="154"></td><td><pre>        bWorking <span class="token operator">=</span> finder<span class="token punctuation">.</span><span class="token function">FindNextFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="155"></td><td><pre>        strFileTitle <span class="token operator">=</span> finder<span class="token punctuation">.</span><span class="token function">GetFileName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="156"></td><td><pre></pre></td></tr><tr><td data-num="157"></td><td><pre>        <span class="token class-name">CFile</span><span class="token double-colon punctuation">::</span><span class="token function">Remove</span><span class="token punctuation">(</span><span class="token punctuation">(</span>LPCSTR<span class="token punctuation">)</span> strFileTitle<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="158"></td><td><pre></pre></td></tr><tr><td data-num="159"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="160"></td><td><pre></pre></td></tr><tr><td data-num="161"></td><td><pre>    bWorking <span class="token operator">=</span> finder<span class="token punctuation">.</span><span class="token function">FindFile</span><span class="token punctuation">(</span><span class="token string">"wz.txt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="162"></td><td><pre>    <span class="token keyword">while</span> <span class="token punctuation">(</span>bWorking<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="163"></td><td><pre></pre></td></tr><tr><td data-num="164"></td><td><pre>        bWorking <span class="token operator">=</span> finder<span class="token punctuation">.</span><span class="token function">FindNextFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="165"></td><td><pre>        strFileTitle <span class="token operator">=</span> finder<span class="token punctuation">.</span><span class="token function">GetFileName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="166"></td><td><pre></pre></td></tr><tr><td data-num="167"></td><td><pre>        <span class="token class-name">CFile</span><span class="token double-colon punctuation">::</span><span class="token function">Remove</span><span class="token punctuation">(</span><span class="token punctuation">(</span>LPCSTR<span class="token punctuation">)</span> strFileTitle<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="168"></td><td><pre></pre></td></tr><tr><td data-num="169"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="170"></td><td><pre></pre></td></tr><tr><td data-num="171"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="172"></td><td><pre></pre></td></tr><tr><td data-num="173"></td><td><pre></pre></td></tr><tr><td data-num="174"></td><td><pre><span class="token keyword">int</span> <span class="token function">GetCheck</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="175"></td><td><pre>    <span class="token function">srand</span><span class="token punctuation">(</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="176"></td><td><pre>    <span class="token keyword">int</span> check <span class="token operator">=</span> <span class="token function">rand</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">0xFFFF</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="177"></td><td><pre></pre></td></tr><tr><td data-num="178"></td><td><pre>    <span class="token keyword">return</span> check<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="179"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="180"></td><td><pre></pre></td></tr><tr><td data-num="181"></td><td><pre><span class="token function">WritePrivateProfileInt</span><span class="token punctuation">(</span>   LPCTSTR</pre></td></tr><tr><td data-num="182"></td><td><pre>lpAppName<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="183"></td><td><pre>LPCTSTR lpKeyName<span class="token punctuation">,</span> INT</pre></td></tr><tr><td data-num="184"></td><td><pre>Value<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="185"></td><td><pre>LPCTSTR lpFileName</pre></td></tr><tr><td data-num="186"></td><td><pre><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="187"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="188"></td><td><pre>TCHAR ValBuf<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="189"></td><td><pre><span class="token function">sprintf</span><span class="token punctuation">(</span>ValBuf<span class="token punctuation">,</span> <span class="token function">TEXT</span><span class="token punctuation">(</span><span class="token string">"%i"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Value</pre></td></tr><tr><td data-num="190"></td><td><pre><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="191"></td><td><pre><span class="token keyword">return</span><span class="token punctuation">(</span></pre></td></tr><tr><td data-num="192"></td><td><pre><span class="token function">WritePrivateProfileString</span><span class="token punctuation">(</span>   lpAppName<span class="token punctuation">,</span> lpKeyName<span class="token punctuation">,</span> ValBuf<span class="token punctuation">,</span> lpFileName</pre></td></tr><tr><td data-num="193"></td><td><pre><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="194"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="195"></td><td><pre></pre></td></tr><tr><td data-num="196"></td><td><pre></pre></td></tr><tr><td data-num="197"></td><td><pre>CString <span class="token function">EncodeImage</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>jpgname<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// 对图片进行 Base64 编码</span></pre></td></tr><tr><td data-num="198"></td><td><pre>    ZBase64 zBase<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="199"></td><td><pre>    <span class="token comment">// 图片编码</span></pre></td></tr><tr><td data-num="200"></td><td><pre>    CFile cbfBmp<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="201"></td><td><pre>    cbfBmp<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span>jpgname<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="202"></td><td><pre>    <span class="token keyword">int</span> iBmpSize <span class="token operator">=</span> cbfBmp<span class="token punctuation">.</span><span class="token function">GetLength</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="203"></td><td><pre></pre></td></tr><tr><td data-num="204"></td><td><pre>    HGLOBAL hMemBmp <span class="token operator">=</span> <span class="token function">GlobalAlloc</span><span class="token punctuation">(</span>GMEM_FIXED<span class="token punctuation">,</span> iBmpSize<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="205"></td><td><pre></pre></td></tr><tr><td data-num="206"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>hMemBmp <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token string">""</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="207"></td><td><pre>    IStream <span class="token operator">*</span>pStmBmp <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="208"></td><td><pre></pre></td></tr><tr><td data-num="209"></td><td><pre>    <span class="token function">CreateStreamOnHGlobal</span><span class="token punctuation">(</span>hMemBmp<span class="token punctuation">,</span> FALSE<span class="token punctuation">,</span> <span class="token operator">&amp;</span>pStmBmp<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="210"></td><td><pre></pre></td></tr><tr><td data-num="211"></td><td><pre>    BYTE <span class="token operator">*</span>pbyBmp <span class="token operator">=</span> <span class="token punctuation">(</span>BYTE <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token function">GlobalLock</span><span class="token punctuation">(</span>hMemBmp<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="212"></td><td><pre>    cbfBmp<span class="token punctuation">.</span><span class="token function">SeekToBegin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="213"></td><td><pre>    cbfBmp<span class="token punctuation">.</span><span class="token function">Read</span><span class="token punctuation">(</span>pbyBmp<span class="token punctuation">,</span> iBmpSize<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="214"></td><td><pre></pre></td></tr><tr><td data-num="215"></td><td><pre>    string strTmpResult <span class="token operator">=</span> zBase<span class="token punctuation">.</span><span class="token function">Encode</span><span class="token punctuation">(</span>pbyBmp<span class="token punctuation">,</span> iBmpSize<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="216"></td><td><pre></pre></td></tr><tr><td data-num="217"></td><td><pre>    CString result<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="218"></td><td><pre>    result <span class="token operator">=</span> strTmpResult<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="219"></td><td><pre>    <span class="token keyword">return</span> result<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="220"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="221"></td><td><pre></pre></td></tr><tr><td data-num="222"></td><td><pre></pre></td></tr><tr><td data-num="223"></td><td><pre><span class="token keyword">char</span> <span class="token operator">*</span>__stdcall <span class="token function">ReadCard</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="224"></td><td><pre>    <span class="token function">AFX_MANAGE_STATE</span><span class="token punctuation">(</span><span class="token function">AfxGetStaticModuleState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="225"></td><td><pre></pre></td></tr><tr><td data-num="226"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">_AFXDLL</span></span></pre></td></tr><tr><td data-num="227"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">_AFX_SOCK_THREAD_STATE</span> <span class="token expression">AFX_MODULE_THREAD_STATE</span></span></pre></td></tr><tr><td data-num="228"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">_afxSockThreadState</span> <span class="token expression"><span class="token function">AfxGetModuleThreadState</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="229"></td><td><pre></pre></td></tr><tr><td data-num="230"></td><td><pre>    _AFX_SOCK_THREAD_STATE <span class="token operator">*</span>pState <span class="token operator">=</span> _afxSockThreadState<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="231"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>pState<span class="token operator">-></span>m_pmapSocketHandle <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="232"></td><td><pre>        pState<span class="token operator">-></span>m_pmapSocketHandle <span class="token operator">=</span> <span class="token keyword">new</span> CMapPtrToPtr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="233"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>pState<span class="token operator">-></span>m_pmapDeadSockets <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="234"></td><td><pre>        pState<span class="token operator">-></span>m_pmapDeadSockets <span class="token operator">=</span> <span class="token keyword">new</span> CMapPtrToPtr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="235"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>pState<span class="token operator">-></span>m_plistSocketNotifications <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="236"></td><td><pre>        pState<span class="token operator">-></span>m_plistSocketNotifications <span class="token operator">=</span> <span class="token keyword">new</span> CPtrList<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="237"></td><td><pre></pre></td></tr><tr><td data-num="238"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span></pre></td></tr><tr><td data-num="239"></td><td><pre>    <span class="token keyword">char</span> <span class="token operator">*</span>retString<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="240"></td><td><pre></pre></td></tr><tr><td data-num="241"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ReadThreadFindHID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="242"></td><td><pre></pre></td></tr><tr><td data-num="243"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="244"></td><td><pre>    retString <span class="token operator">=</span> <span class="token string">"net failure"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="245"></td><td><pre></pre></td></tr><tr><td data-num="246"></td><td><pre>    <span class="token keyword">return</span> retString<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="247"></td><td><pre></pre></td></tr><tr><td data-num="248"></td><td><pre></pre></td></tr><tr><td data-num="249"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="250"></td><td><pre></pre></td></tr><tr><td data-num="251"></td><td><pre><span class="token keyword">char</span> <span class="token operator">*</span>__stdcall <span class="token function">ffconnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="252"></td><td><pre>    <span class="token function">AFX_MANAGE_STATE</span><span class="token punctuation">(</span><span class="token function">AfxGetStaticModuleState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="253"></td><td><pre></pre></td></tr><tr><td data-num="254"></td><td><pre>    <span class="token keyword">char</span> <span class="token operator">*</span>retString<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="255"></td><td><pre></pre></td></tr><tr><td data-num="256"></td><td><pre></pre></td></tr><tr><td data-num="257"></td><td><pre>    CString strResult<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="258"></td><td><pre></pre></td></tr><tr><td data-num="259"></td><td><pre></pre></td></tr><tr><td data-num="260"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ReadThreadFindHID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="261"></td><td><pre>        root<span class="token punctuation">[</span><span class="token string">"code"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"1"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="262"></td><td><pre>        root<span class="token punctuation">[</span><span class="token string">"content"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"conect device success"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="263"></td><td><pre>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="264"></td><td><pre>        root<span class="token punctuation">[</span><span class="token string">"code"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"0"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="265"></td><td><pre>        root<span class="token punctuation">[</span><span class="token string">"content"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"connect device failure"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="266"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="267"></td><td><pre>    root<span class="token punctuation">.</span><span class="token function">toStyledString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="268"></td><td><pre>    rtnOut <span class="token operator">=</span> root<span class="token punctuation">.</span><span class="token function">toStyledString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="269"></td><td><pre></pre></td></tr><tr><td data-num="270"></td><td><pre>    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> rtnOut<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="271"></td><td><pre></pre></td></tr><tr><td data-num="272"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="273"></td><td><pre></pre></td></tr><tr><td data-num="274"></td><td><pre></pre></td></tr><tr><td data-num="275"></td><td><pre><span class="token keyword">char</span> <span class="token operator">*</span>__stdcall <span class="token function">collTerminalSN</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="276"></td><td><pre>    <span class="token function">write_log_file</span><span class="token punctuation">(</span><span class="token string">"collTerminalSN 1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="277"></td><td><pre>    <span class="token function">AFX_MANAGE_STATE</span><span class="token punctuation">(</span><span class="token function">AfxGetStaticModuleState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="278"></td><td><pre></pre></td></tr><tr><td data-num="279"></td><td><pre>    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> code_data<span class="token punctuation">[</span><span class="token number">60</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="280"></td><td><pre>    <span class="token function">memset</span><span class="token punctuation">(</span>code_data<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="281"></td><td><pre></pre></td></tr><tr><td data-num="282"></td><td><pre>    <span class="token function">write_log_file</span><span class="token punctuation">(</span><span class="token string">"collTerminalSN 2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="283"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ReadThreadFindHID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="284"></td><td><pre>        <span class="token function">write_log_file</span><span class="token punctuation">(</span><span class="token string">"collTerminalSN 3"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="285"></td><td><pre>        <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>Data <span class="token operator">=</span> <span class="token function">GET_SN</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="286"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>Data <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="287"></td><td><pre>            root<span class="token punctuation">[</span><span class="token string">"code"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"0"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="288"></td><td><pre>            root<span class="token punctuation">[</span><span class="token string">"content"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"get SN failure"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="289"></td><td><pre>            <span class="token comment">//root[""] =</span></pre></td></tr><tr><td data-num="290"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="291"></td><td><pre>            <span class="token function">write_log_file</span><span class="token punctuation">(</span><span class="token string">"collTerminalSN 4"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="292"></td><td><pre>            <span class="token function">memcpy</span><span class="token punctuation">(</span>code_data<span class="token punctuation">,</span> Data<span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="293"></td><td><pre></pre></td></tr><tr><td data-num="294"></td><td><pre>            root<span class="token punctuation">[</span><span class="token string">"code"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"1"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="295"></td><td><pre>            <span class="token keyword">char</span> sn<span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="296"></td><td><pre>            <span class="token function">memset</span><span class="token punctuation">(</span>sn<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="297"></td><td><pre>            <span class="token function">memcpy</span><span class="token punctuation">(</span>sn<span class="token punctuation">,</span> code_data <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="298"></td><td><pre>            root<span class="token punctuation">[</span><span class="token string">"content"</span><span class="token punctuation">]</span> <span class="token operator">=</span> sn<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="299"></td><td><pre></pre></td></tr><tr><td data-num="300"></td><td><pre>            <span class="token function">write_log_file</span><span class="token punctuation">(</span><span class="token string">"collTerminalSN 5"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="301"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="302"></td><td><pre>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="303"></td><td><pre>        root<span class="token punctuation">[</span><span class="token string">"code"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"0"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="304"></td><td><pre>        root<span class="token punctuation">[</span><span class="token string">"content"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"connect device failure"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="305"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="306"></td><td><pre>    <span class="token function">write_log_file</span><span class="token punctuation">(</span><span class="token string">"collTerminalSN 6"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="307"></td><td><pre>    root<span class="token punctuation">.</span><span class="token function">toStyledString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="308"></td><td><pre>    rtnOut <span class="token operator">=</span> root<span class="token punctuation">.</span><span class="token function">toStyledString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="309"></td><td><pre>    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> rtnOut<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="310"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="311"></td><td><pre></pre></td></tr><tr><td data-num="312"></td><td><pre><span class="token keyword">char</span> <span class="token operator">*</span>__stdcall <span class="token function">collIdNumber</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>inData<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="313"></td><td><pre>    <span class="token function">AFX_MANAGE_STATE</span><span class="token punctuation">(</span><span class="token function">AfxGetStaticModuleState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="314"></td><td><pre>    Json<span class="token double-colon punctuation">::</span>Value jData<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="315"></td><td><pre>    Json<span class="token double-colon punctuation">::</span>Reader reader<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="316"></td><td><pre>    string sinData <span class="token operator">=</span> inData<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="317"></td><td><pre>    reader<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>sinData<span class="token punctuation">,</span> jData<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="318"></td><td><pre>    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> code_data<span class="token punctuation">[</span><span class="token number">60</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="319"></td><td><pre>    <span class="token function">memset</span><span class="token punctuation">(</span>code_data<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="320"></td><td><pre></pre></td></tr><tr><td data-num="321"></td><td><pre>    string inID <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> jData<span class="token punctuation">[</span><span class="token string">"i"</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">asString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="322"></td><td><pre>    string inSN <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> jData<span class="token punctuation">[</span><span class="token string">"s"</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">asString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="323"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ReadThreadFindHID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="324"></td><td><pre>        <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>Data <span class="token operator">=</span> <span class="token function">GET_SN</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="325"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>Data <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="326"></td><td><pre>            root<span class="token punctuation">[</span><span class="token string">"code"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"2"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="327"></td><td><pre>            root<span class="token punctuation">[</span><span class="token string">"content"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"get SN failure"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="328"></td><td><pre>            root<span class="token punctuation">.</span><span class="token function">toStyledString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="329"></td><td><pre>            rtnOut <span class="token operator">=</span> root<span class="token punctuation">.</span><span class="token function">toStyledString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="330"></td><td><pre>            <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> rtnOut<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="331"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="332"></td><td><pre>            <span class="token function">memcpy</span><span class="token punctuation">(</span>code_data<span class="token punctuation">,</span> Data<span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="333"></td><td><pre>            <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">strncmp</span><span class="token punctuation">(</span>inSN<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> code_data <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="334"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="335"></td><td><pre>                root<span class="token punctuation">[</span><span class="token string">"code"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"3"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="336"></td><td><pre>                root<span class="token punctuation">[</span><span class="token string">"content"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"SN not match"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="337"></td><td><pre>                root<span class="token punctuation">.</span><span class="token function">toStyledString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="338"></td><td><pre>                rtnOut <span class="token operator">=</span> root<span class="token punctuation">.</span><span class="token function">toStyledString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="339"></td><td><pre>                <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> rtnOut<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="340"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="341"></td><td><pre></pre></td></tr><tr><td data-num="342"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="343"></td><td><pre></pre></td></tr><tr><td data-num="344"></td><td><pre>        Data <span class="token operator">=</span> <span class="token function">DEL_ID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="345"></td><td><pre></pre></td></tr><tr><td data-num="346"></td><td><pre>        Data <span class="token operator">=</span> <span class="token function">ADD_ID</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> inID<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="347"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>Data <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="348"></td><td><pre>            root<span class="token punctuation">[</span><span class="token string">"code"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"0"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="349"></td><td><pre>            root<span class="token punctuation">[</span><span class="token string">"content"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"collect id number failure"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="350"></td><td><pre>            root<span class="token punctuation">.</span><span class="token function">toStyledString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="351"></td><td><pre>            rtnOut <span class="token operator">=</span> root<span class="token punctuation">.</span><span class="token function">toStyledString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="352"></td><td><pre>            <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> rtnOut<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="353"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="354"></td><td><pre>            <span class="token function">memcpy</span><span class="token punctuation">(</span>code_data<span class="token punctuation">,</span> Data<span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="355"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span>code_data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0x00</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="356"></td><td><pre>                root<span class="token punctuation">[</span><span class="token string">"code"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"0"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="357"></td><td><pre>                root<span class="token punctuation">[</span><span class="token string">"content"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"collect id number failure!"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="358"></td><td><pre>                root<span class="token punctuation">.</span><span class="token function">toStyledString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="359"></td><td><pre>                rtnOut <span class="token operator">=</span> root<span class="token punctuation">.</span><span class="token function">toStyledString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="360"></td><td><pre>                <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> rtnOut<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="361"></td><td><pre>            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="362"></td><td><pre>                root<span class="token punctuation">[</span><span class="token string">"code"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"1"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="363"></td><td><pre></pre></td></tr><tr><td data-num="364"></td><td><pre>                inSN<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"|"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="365"></td><td><pre>                inSN<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>inID<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="366"></td><td><pre>                root<span class="token punctuation">[</span><span class="token string">"content"</span><span class="token punctuation">]</span> <span class="token operator">=</span> inSN<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="367"></td><td><pre></pre></td></tr><tr><td data-num="368"></td><td><pre>                root<span class="token punctuation">.</span><span class="token function">toStyledString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="369"></td><td><pre>                rtnOut <span class="token operator">=</span> root<span class="token punctuation">.</span><span class="token function">toStyledString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="370"></td><td><pre>                <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> rtnOut<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="371"></td><td><pre></pre></td></tr><tr><td data-num="372"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="373"></td><td><pre></pre></td></tr><tr><td data-num="374"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="375"></td><td><pre>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="376"></td><td><pre>        root<span class="token punctuation">[</span><span class="token string">"code"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="377"></td><td><pre>        root<span class="token punctuation">[</span><span class="token string">"content"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"connect device failure"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="378"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="379"></td><td><pre>    root<span class="token punctuation">.</span><span class="token function">toStyledString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="380"></td><td><pre>    rtnOut <span class="token operator">=</span> root<span class="token punctuation">.</span><span class="token function">toStyledString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="381"></td><td><pre>    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> rtnOut<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="382"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="383"></td><td><pre></pre></td></tr><tr><td data-num="384"></td><td><pre><span class="token keyword">char</span> <span class="token operator">*</span>__stdcall <span class="token function">collFingerPrint</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>inData<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="385"></td><td><pre>    <span class="token function">write_log_file</span><span class="token punctuation">(</span><span class="token string">"collFingerPrint 0"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 写日志</span></pre></td></tr><tr><td data-num="386"></td><td><pre>    <span class="token function">AFX_MANAGE_STATE</span><span class="token punctuation">(</span><span class="token function">AfxGetStaticModuleState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="387"></td><td><pre>    Json<span class="token double-colon punctuation">::</span>Value jData<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="388"></td><td><pre>    Json<span class="token double-colon punctuation">::</span>Reader reader<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="389"></td><td><pre>    string sinData <span class="token operator">=</span> inData<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="390"></td><td><pre>    reader<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>sinData<span class="token punctuation">,</span> jData<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="391"></td><td><pre>    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> code_data<span class="token punctuation">[</span><span class="token number">60</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="392"></td><td><pre>    <span class="token function">memset</span><span class="token punctuation">(</span>code_data<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="393"></td><td><pre>    <span class="token keyword">int</span> index <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="394"></td><td><pre>    <span class="token function">write_log_file</span><span class="token punctuation">(</span><span class="token string">"collFingerPrint 1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 写日志</span></pre></td></tr><tr><td data-num="395"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>jData<span class="token punctuation">[</span><span class="token string">"f"</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">isNull</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="396"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>jData<span class="token punctuation">[</span><span class="token string">"f"</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">isString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="397"></td><td><pre>            string strindex <span class="token operator">=</span> jData<span class="token punctuation">[</span><span class="token string">"f"</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">asString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="398"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>strindex<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="399"></td><td><pre>                index <span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> strindex<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="400"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="401"></td><td><pre></pre></td></tr><tr><td data-num="402"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="403"></td><td><pre>            index <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> jData<span class="token punctuation">[</span><span class="token string">"f"</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">asInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="404"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="405"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="406"></td><td><pre>    <span class="token function">write_log_file</span><span class="token punctuation">(</span><span class="token string">"collFingerPrint 2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="407"></td><td><pre>    string inSN <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> jData<span class="token punctuation">[</span><span class="token string">"s"</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">asString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="408"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ReadThreadFindHID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="409"></td><td><pre>        <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>Data <span class="token operator">=</span> <span class="token function">GET_SN</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="410"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>Data <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="411"></td><td><pre>            root<span class="token punctuation">[</span><span class="token string">"code"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"2"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="412"></td><td><pre>            root<span class="token punctuation">[</span><span class="token string">"content"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"get SN failure"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="413"></td><td><pre>            root<span class="token punctuation">.</span><span class="token function">toStyledString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="414"></td><td><pre>            rtnOut <span class="token operator">=</span> root<span class="token punctuation">.</span><span class="token function">toStyledString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="415"></td><td><pre>            <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> rtnOut<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="416"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="417"></td><td><pre>            <span class="token function">memcpy</span><span class="token punctuation">(</span>code_data<span class="token punctuation">,</span> Data<span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="418"></td><td><pre>            <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">strncmp</span><span class="token punctuation">(</span>inSN<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> code_data <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="419"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="420"></td><td><pre>                root<span class="token punctuation">[</span><span class="token string">"code"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"3"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="421"></td><td><pre>                root<span class="token punctuation">[</span><span class="token string">"content"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"SN not match"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="422"></td><td><pre>                root<span class="token punctuation">.</span><span class="token function">toStyledString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="423"></td><td><pre>                rtnOut <span class="token operator">=</span> root<span class="token punctuation">.</span><span class="token function">toStyledString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="424"></td><td><pre>                <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> rtnOut<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="425"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="426"></td><td><pre></pre></td></tr><tr><td data-num="427"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="428"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="429"></td><td><pre>            <span class="token function">write_log_file</span><span class="token punctuation">(</span><span class="token string">"collFingerPrint 3 del"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="430"></td><td><pre>            Data <span class="token operator">=</span> <span class="token function">FP_DEL</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> index<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="431"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="432"></td><td><pre>            index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="433"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="434"></td><td><pre></pre></td></tr><tr><td data-num="435"></td><td><pre>        Data <span class="token operator">=</span> <span class="token function">FP_REG</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="436"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>Data <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="437"></td><td><pre>            root<span class="token punctuation">[</span><span class="token string">"code"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"0"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="438"></td><td><pre>            root<span class="token punctuation">[</span><span class="token string">"content"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"collect fingerprint failure"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="439"></td><td><pre>            root<span class="token punctuation">.</span><span class="token function">toStyledString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="440"></td><td><pre>            rtnOut <span class="token operator">=</span> root<span class="token punctuation">.</span><span class="token function">toStyledString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="441"></td><td><pre>            <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> rtnOut<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="442"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="443"></td><td><pre>            <span class="token function">memcpy</span><span class="token punctuation">(</span>code_data<span class="token punctuation">,</span> Data<span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="444"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span>code_data<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0x00</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="445"></td><td><pre>                root<span class="token punctuation">[</span><span class="token string">"code"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"0"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="446"></td><td><pre>                root<span class="token punctuation">[</span><span class="token string">"content"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"collect fingerprint failure!"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="447"></td><td><pre>                root<span class="token punctuation">.</span><span class="token function">toStyledString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="448"></td><td><pre>                rtnOut <span class="token operator">=</span> root<span class="token punctuation">.</span><span class="token function">toStyledString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="449"></td><td><pre>                <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> rtnOut<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="450"></td><td><pre>            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="451"></td><td><pre>                root<span class="token punctuation">[</span><span class="token string">"code"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"1"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="452"></td><td><pre>                index <span class="token operator">=</span> code_data<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token number">256</span> <span class="token operator">+</span> code_data<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="453"></td><td><pre>                <span class="token keyword">char</span> idx<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="454"></td><td><pre>                <span class="token function">itoa</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> idx<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="455"></td><td><pre>                inSN<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"|"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="456"></td><td><pre>                inSN<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="457"></td><td><pre>                root<span class="token punctuation">[</span><span class="token string">"content"</span><span class="token punctuation">]</span> <span class="token operator">=</span> inSN<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="458"></td><td><pre></pre></td></tr><tr><td data-num="459"></td><td><pre>                root<span class="token punctuation">.</span><span class="token function">toStyledString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="460"></td><td><pre>                rtnOut <span class="token operator">=</span> root<span class="token punctuation">.</span><span class="token function">toStyledString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="461"></td><td><pre>                <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> rtnOut<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="462"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="463"></td><td><pre></pre></td></tr><tr><td data-num="464"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="465"></td><td><pre>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="466"></td><td><pre>        root<span class="token punctuation">[</span><span class="token string">"code"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="467"></td><td><pre>        root<span class="token punctuation">[</span><span class="token string">"content"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"connect device failure"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="468"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="469"></td><td><pre>    root<span class="token punctuation">.</span><span class="token function">toStyledString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="470"></td><td><pre>    rtnOut <span class="token operator">=</span> root<span class="token punctuation">.</span><span class="token function">toStyledString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="471"></td><td><pre>    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> rtnOut<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="472"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="473"></td><td><pre></pre></td></tr><tr><td data-num="474"></td><td><pre><span class="token keyword">char</span> <span class="token operator">*</span>__stdcall <span class="token function">deleteFingerprints</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>inData<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="475"></td><td><pre>    <span class="token function">AFX_MANAGE_STATE</span><span class="token punctuation">(</span><span class="token function">AfxGetStaticModuleState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="476"></td><td><pre>    Json<span class="token double-colon punctuation">::</span>Value jData<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="477"></td><td><pre>    Json<span class="token double-colon punctuation">::</span>Reader reader<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="478"></td><td><pre>    string sinData <span class="token operator">=</span> inData<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="479"></td><td><pre>    reader<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>sinData<span class="token punctuation">,</span> jData<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="480"></td><td><pre>    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> code_data<span class="token punctuation">[</span><span class="token number">60</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="481"></td><td><pre>    <span class="token function">memset</span><span class="token punctuation">(</span>code_data<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="482"></td><td><pre></pre></td></tr><tr><td data-num="483"></td><td><pre>    string inSN <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> jData<span class="token punctuation">[</span><span class="token string">"s"</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">asString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="484"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ReadThreadFindHID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="485"></td><td><pre>        <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>Data <span class="token operator">=</span> <span class="token function">GET_SN</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="486"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>Data <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="487"></td><td><pre>            root<span class="token punctuation">[</span><span class="token string">"code"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"2"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="488"></td><td><pre>            root<span class="token punctuation">[</span><span class="token string">"content"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"get SN failure"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="489"></td><td><pre>            root<span class="token punctuation">.</span><span class="token function">toStyledString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="490"></td><td><pre>            rtnOut <span class="token operator">=</span> root<span class="token punctuation">.</span><span class="token function">toStyledString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="491"></td><td><pre>            <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> rtnOut<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="492"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="493"></td><td><pre>            <span class="token function">memcpy</span><span class="token punctuation">(</span>code_data<span class="token punctuation">,</span> Data<span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="494"></td><td><pre>            <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">strncmp</span><span class="token punctuation">(</span>inSN<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> code_data <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="495"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="496"></td><td><pre>                root<span class="token punctuation">[</span><span class="token string">"code"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"3"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="497"></td><td><pre>                root<span class="token punctuation">[</span><span class="token string">"content"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"SN not match"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="498"></td><td><pre>                root<span class="token punctuation">.</span><span class="token function">toStyledString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="499"></td><td><pre>                rtnOut <span class="token operator">=</span> root<span class="token punctuation">.</span><span class="token function">toStyledString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="500"></td><td><pre>                <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> rtnOut<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="501"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="502"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="503"></td><td><pre></pre></td></tr><tr><td data-num="504"></td><td><pre>        Data <span class="token operator">=</span> <span class="token function">FP_DEL</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="505"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>Data <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="506"></td><td><pre>            root<span class="token punctuation">[</span><span class="token string">"code"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"0"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="507"></td><td><pre>            root<span class="token punctuation">[</span><span class="token string">"content"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"delete fingerprint failure"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="508"></td><td><pre>            root<span class="token punctuation">.</span><span class="token function">toStyledString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="509"></td><td><pre>            rtnOut <span class="token operator">=</span> root<span class="token punctuation">.</span><span class="token function">toStyledString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="510"></td><td><pre>            <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> rtnOut<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="511"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="512"></td><td><pre></pre></td></tr><tr><td data-num="513"></td><td><pre>            root<span class="token punctuation">[</span><span class="token string">"code"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"1"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="514"></td><td><pre>            <span class="token comment">//root["content"] = inSN;</span></pre></td></tr><tr><td data-num="515"></td><td><pre></pre></td></tr><tr><td data-num="516"></td><td><pre>            root<span class="token punctuation">.</span><span class="token function">toStyledString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="517"></td><td><pre>            rtnOut <span class="token operator">=</span> root<span class="token punctuation">.</span><span class="token function">toStyledString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="518"></td><td><pre>            <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> rtnOut<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="519"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="520"></td><td><pre>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="521"></td><td><pre>        root<span class="token punctuation">[</span><span class="token string">"code"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="522"></td><td><pre>        root<span class="token punctuation">[</span><span class="token string">"content"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"connect device failure"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="523"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="524"></td><td><pre>    root<span class="token punctuation">.</span><span class="token function">toStyledString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="525"></td><td><pre>    rtnOut <span class="token operator">=</span> root<span class="token punctuation">.</span><span class="token function">toStyledString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="526"></td><td><pre>    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> rtnOut<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="527"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="528"></td><td><pre></pre></td></tr><tr><td data-num="529"></td><td><pre></pre></td></tr><tr><td data-num="530"></td><td><pre><span class="token keyword">char</span> <span class="token operator">*</span>__stdcall <span class="token function">verify</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>inData<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="531"></td><td><pre>    <span class="token function">AFX_MANAGE_STATE</span><span class="token punctuation">(</span><span class="token function">AfxGetStaticModuleState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="532"></td><td><pre>    Json<span class="token double-colon punctuation">::</span>Value jData<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="533"></td><td><pre>    Json<span class="token double-colon punctuation">::</span>Reader reader<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="534"></td><td><pre>    string sinData <span class="token operator">=</span> inData<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="535"></td><td><pre>    reader<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>sinData<span class="token punctuation">,</span> jData<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="536"></td><td><pre>    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> code_data<span class="token punctuation">[</span><span class="token number">60</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="537"></td><td><pre>    <span class="token function">memset</span><span class="token punctuation">(</span>code_data<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="538"></td><td><pre>    <span class="token comment">//Json::Value root;</span></pre></td></tr><tr><td data-num="539"></td><td><pre>    <span class="token keyword">int</span> index<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="540"></td><td><pre></pre></td></tr><tr><td data-num="541"></td><td><pre>    string inSN <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> jData<span class="token punctuation">[</span><span class="token string">"s"</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">asString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="542"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ReadThreadFindHID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="543"></td><td><pre>        <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>Data <span class="token operator">=</span> <span class="token function">GET_SN</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="544"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>Data <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="545"></td><td><pre>            root<span class="token punctuation">[</span><span class="token string">"code"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"2"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="546"></td><td><pre>            root<span class="token punctuation">[</span><span class="token string">"content"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"get SN failure"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="547"></td><td><pre>            root<span class="token punctuation">.</span><span class="token function">toStyledString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="548"></td><td><pre>            rtnOut <span class="token operator">=</span> root<span class="token punctuation">.</span><span class="token function">toStyledString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="549"></td><td><pre>            <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> rtnOut<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="550"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="551"></td><td><pre>            <span class="token function">memcpy</span><span class="token punctuation">(</span>code_data<span class="token punctuation">,</span> Data<span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="552"></td><td><pre>            <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">strncmp</span><span class="token punctuation">(</span>inSN<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> code_data <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="553"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="554"></td><td><pre>                root<span class="token punctuation">[</span><span class="token string">"code"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"3"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="555"></td><td><pre>                root<span class="token punctuation">[</span><span class="token string">"content"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"SN not match"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="556"></td><td><pre>                root<span class="token punctuation">.</span><span class="token function">toStyledString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="557"></td><td><pre>                rtnOut <span class="token operator">=</span> root<span class="token punctuation">.</span><span class="token function">toStyledString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="558"></td><td><pre>                <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> rtnOut<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="559"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="560"></td><td><pre></pre></td></tr><tr><td data-num="561"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="562"></td><td><pre></pre></td></tr><tr><td data-num="563"></td><td><pre>        Data <span class="token operator">=</span> <span class="token function">FP_CHECH</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="564"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>Data <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="565"></td><td><pre>            root<span class="token punctuation">[</span><span class="token string">"code"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"0"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="566"></td><td><pre>            root<span class="token punctuation">[</span><span class="token string">"content"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"verify failure"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="567"></td><td><pre>            root<span class="token punctuation">.</span><span class="token function">toStyledString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="568"></td><td><pre>            rtnOut <span class="token operator">=</span> root<span class="token punctuation">.</span><span class="token function">toStyledString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="569"></td><td><pre>            <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> rtnOut<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="570"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="571"></td><td><pre>            <span class="token function">memcpy</span><span class="token punctuation">(</span>code_data<span class="token punctuation">,</span> Data<span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="572"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>code_data<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0x50</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>code_data<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0x11</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>code_data<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0x01</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 指紋成功</span></pre></td></tr><tr><td data-num="573"></td><td><pre>            <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="574"></td><td><pre>                root<span class="token punctuation">[</span><span class="token string">"code"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"6"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="575"></td><td><pre></pre></td></tr><tr><td data-num="576"></td><td><pre>                <span class="token keyword">char</span> <span class="token operator">*</span>tmpdata <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> code_data <span class="token operator">+</span> <span class="token number">6</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="577"></td><td><pre>                <span class="token keyword">char</span> tmp_code_data<span class="token punctuation">[</span><span class="token number">19</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="578"></td><td><pre>                <span class="token function">memset</span><span class="token punctuation">(</span>tmp_code_data<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">19</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="579"></td><td><pre>                <span class="token function">memcpy</span><span class="token punctuation">(</span>tmp_code_data<span class="token punctuation">,</span> tmpdata<span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="580"></td><td><pre></pre></td></tr><tr><td data-num="581"></td><td><pre>                index <span class="token operator">=</span> code_data<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token number">256</span> <span class="token operator">+</span> code_data<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="582"></td><td><pre>                <span class="token keyword">char</span> idx<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="583"></td><td><pre>                <span class="token function">itoa</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> idx<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="584"></td><td><pre></pre></td></tr><tr><td data-num="585"></td><td><pre>                inSN<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"|"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="586"></td><td><pre>                inSN<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="587"></td><td><pre></pre></td></tr><tr><td data-num="588"></td><td><pre>                root<span class="token punctuation">[</span><span class="token string">"content"</span><span class="token punctuation">]</span> <span class="token operator">=</span> inSN<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="589"></td><td><pre></pre></td></tr><tr><td data-num="590"></td><td><pre>                root<span class="token punctuation">.</span><span class="token function">toStyledString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="591"></td><td><pre>                rtnOut <span class="token operator">=</span> root<span class="token punctuation">.</span><span class="token function">toStyledString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="592"></td><td><pre>                <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> rtnOut<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="593"></td><td><pre>            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>code_data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0x16</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>code_data<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0x02</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>code_data<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0x01</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">// 身分証成功</span></pre></td></tr><tr><td data-num="594"></td><td><pre>            <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="595"></td><td><pre>                root<span class="token punctuation">[</span><span class="token string">"code"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"5"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="596"></td><td><pre>                <span class="token keyword">char</span> <span class="token operator">*</span>tmpdata <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> code_data <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="597"></td><td><pre>                <span class="token keyword">char</span> tmp_code_data<span class="token punctuation">[</span><span class="token number">19</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="598"></td><td><pre>                <span class="token function">memset</span><span class="token punctuation">(</span>tmp_code_data<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">19</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="599"></td><td><pre>                <span class="token function">memcpy</span><span class="token punctuation">(</span>tmp_code_data<span class="token punctuation">,</span> tmpdata<span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="600"></td><td><pre></pre></td></tr><tr><td data-num="601"></td><td><pre>                inSN<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"|"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="602"></td><td><pre>                inSN<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>tmp_code_data<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="603"></td><td><pre>                root<span class="token punctuation">[</span><span class="token string">"content"</span><span class="token punctuation">]</span> <span class="token operator">=</span> inSN<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="604"></td><td><pre></pre></td></tr><tr><td data-num="605"></td><td><pre>                root<span class="token punctuation">.</span><span class="token function">toStyledString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="606"></td><td><pre>                rtnOut <span class="token operator">=</span> root<span class="token punctuation">.</span><span class="token function">toStyledString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="607"></td><td><pre>                <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> rtnOut<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="608"></td><td><pre></pre></td></tr><tr><td data-num="609"></td><td><pre>            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span><span class="token comment">// 失敗</span></pre></td></tr><tr><td data-num="610"></td><td><pre>            <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="611"></td><td><pre>                root<span class="token punctuation">[</span><span class="token string">"code"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"0"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="612"></td><td><pre>                root<span class="token punctuation">[</span><span class="token string">"content"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"verify failure!"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="613"></td><td><pre>                root<span class="token punctuation">.</span><span class="token function">toStyledString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="614"></td><td><pre>                rtnOut <span class="token operator">=</span> root<span class="token punctuation">.</span><span class="token function">toStyledString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="615"></td><td><pre>                <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> rtnOut<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="616"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="617"></td><td><pre></pre></td></tr><tr><td data-num="618"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="619"></td><td><pre>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="620"></td><td><pre>        root<span class="token punctuation">[</span><span class="token string">"code"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="621"></td><td><pre>        root<span class="token punctuation">[</span><span class="token string">"content"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"connect device failure"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="622"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="623"></td><td><pre>    root<span class="token punctuation">.</span><span class="token function">toStyledString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="624"></td><td><pre>    rtnOut <span class="token operator">=</span> root<span class="token punctuation">.</span><span class="token function">toStyledString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="625"></td><td><pre>    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> rtnOut<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="626"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="627"></td><td><pre></pre></td></tr><tr><td data-num="628"></td><td><pre></pre></td></tr><tr><td data-num="629"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">_DEBUG</span></span></pre></td></tr><tr><td data-num="630"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">new</span> <span class="token expression">DEBUG_NEW</span></span></pre></td></tr><tr><td data-num="631"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">undef</span> <span class="token expression">THIS_FILE</span></span></pre></td></tr><tr><td data-num="632"></td><td><pre><span class="token keyword">static</span> <span class="token keyword">char</span> THIS_FILE<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token constant">__FILE__</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="633"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span></pre></td></tr><tr><td data-num="634"></td><td><pre></pre></td></tr><tr><td data-num="635"></td><td><pre><span class="token function">BEGIN_MESSAGE_MAP</span><span class="token punctuation">(</span>CDemo1App<span class="token punctuation">,</span> CWinApp</pre></td></tr><tr><td data-num="636"></td><td><pre><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="637"></td><td><pre></pre></td></tr><tr><td data-num="638"></td><td><pre><span class="token function">END_MESSAGE_MAP</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="639"></td><td><pre></pre></td></tr><tr><td data-num="640"></td><td><pre></pre></td></tr><tr><td data-num="641"></td><td><pre><span class="token class-name">CDemo1App</span><span class="token double-colon punctuation">::</span><span class="token function">CDemo1App</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="642"></td><td><pre></pre></td></tr><tr><td data-num="643"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="644"></td><td><pre></pre></td></tr><tr><td data-num="645"></td><td><pre>CDemo1App theApp<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="646"></td><td><pre></pre></td></tr><tr><td data-num="647"></td><td><pre></pre></td></tr><tr><td data-num="648"></td><td><pre>BOOL <span class="token class-name">CDemo1App</span><span class="token double-colon punctuation">::</span><span class="token function">InitInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="649"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">AfxSocketInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="650"></td><td><pre>        <span class="token function">AfxMessageBox</span><span class="token punctuation">(</span>IDP_SOCKETS_INIT_FAILED<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="651"></td><td><pre>        <span class="token keyword">return</span> FALSE<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="652"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="653"></td><td><pre></pre></td></tr><tr><td data-num="654"></td><td><pre>    <span class="token keyword">return</span> TRUE<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="655"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id="代码结构"><a class="anchor" href="#代码结构">#</a> 代码结构</h3><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// TestConnect: 测试连接到指定 IP 地址的特定端口。</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">int</span> <span class="token function">TestConnect</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>ip<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token comment">//... 实现代码 ...</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment">// CleanFile: 删除当前目录中特定类型的文件。</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">void</span> <span class="token function">CleanFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token comment">//... 实现代码 ...</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token comment">// GetCheck: 生成一个随机检查值。</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token keyword">int</span> <span class="token function">GetCheck</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token comment">//... 实现代码 ...</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token comment">// WritePrivateProfileInt: 将整数值写入 INI 文件。</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token function">WritePrivateProfileInt</span><span class="token punctuation">(</span>LPCTSTR lpAppName<span class="token punctuation">,</span> LPCTSTR lpKeyName<span class="token punctuation">,</span> INT Value<span class="token punctuation">,</span> LPCTSTR lpFileName<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token comment">//... 实现代码 ...</span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="20"></td><td><pre></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token comment">// EncodeImage: 将图像文件编码为 Base64 格式。</span></pre></td></tr><tr><td data-num="22"></td><td><pre>CString <span class="token function">EncodeImage</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>jpgname<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token comment">//... 实现代码 ...</span></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="25"></td><td><pre></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token comment">// ReadCard: 占位符函数，当前不执行任何操作。</span></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token keyword">char</span> <span class="token operator">*</span>__stdcall <span class="token function">ReadCard</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token comment">//... 实现代码 ...</span></pre></td></tr><tr><td data-num="29"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="30"></td><td><pre></pre></td></tr><tr><td data-num="31"></td><td><pre><span class="token comment">//ffconnect: 占位符函数，当前不执行任何操作。</span></pre></td></tr><tr><td data-num="32"></td><td><pre><span class="token keyword">char</span> <span class="token operator">*</span>__stdcall <span class="token function">ffconnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>    <span class="token comment">//... 实现代码 ...</span></pre></td></tr><tr><td data-num="34"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="35"></td><td><pre></pre></td></tr><tr><td data-num="36"></td><td><pre><span class="token comment">//collTerminalSN: 收集终端设备的序列号。</span></pre></td></tr><tr><td data-num="37"></td><td><pre><span class="token keyword">char</span> <span class="token operator">*</span>__stdcall <span class="token function">collTerminalSN</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>    <span class="token comment">//... 实现代码 ...</span></pre></td></tr><tr><td data-num="39"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="40"></td><td><pre></pre></td></tr><tr><td data-num="41"></td><td><pre><span class="token comment">//collIdNumber: 收集与终端设备关联的身份证号码。</span></pre></td></tr><tr><td data-num="42"></td><td><pre><span class="token keyword">char</span> <span class="token operator">*</span>__stdcall <span class="token function">collIdNumber</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>inData<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>    <span class="token comment">//... 实现代码 ...</span></pre></td></tr><tr><td data-num="44"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="45"></td><td><pre></pre></td></tr><tr><td data-num="46"></td><td><pre><span class="token comment">//collFingerPrint: 收集与终端设备关联的指纹。</span></pre></td></tr><tr><td data-num="47"></td><td><pre><span class="token keyword">char</span> <span class="token operator">*</span>__stdcall <span class="token function">collFingerPrint</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>inData<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>    <span class="token comment">//... 实现代码 ...</span></pre></td></tr><tr><td data-num="49"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="50"></td><td><pre></pre></td></tr><tr><td data-num="51"></td><td><pre><span class="token comment">//deleteFingerprints: 从终端设备中删除存储的指纹。</span></pre></td></tr><tr><td data-num="52"></td><td><pre><span class="token keyword">char</span> <span class="token operator">*</span>__stdcall <span class="token function">deleteFingerprints</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>inData<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="53"></td><td><pre>    <span class="token comment">//... 实现代码 ...</span></pre></td></tr><tr><td data-num="54"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="55"></td><td><pre></pre></td></tr><tr><td data-num="56"></td><td><pre><span class="token comment">//verify: 使用终端设备验证指纹或身份证号码。</span></pre></td></tr><tr><td data-num="57"></td><td><pre><span class="token keyword">char</span> <span class="token operator">*</span>__stdcall <span class="token function">verify</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>inData<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="58"></td><td><pre>    <span class="token comment">//... 实现代码 ...</span></pre></td></tr><tr><td data-num="59"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="60"></td><td><pre></pre></td></tr><tr><td data-num="61"></td><td><pre><span class="token comment">// 应用程序的初始化。</span></pre></td></tr><tr><td data-num="62"></td><td><pre>BOOL <span class="token class-name">CDemo1App</span><span class="token double-colon punctuation">::</span><span class="token function">InitInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="63"></td><td><pre>    <span class="token comment">// 初始化 Winsock。</span></pre></td></tr><tr><td data-num="64"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">AfxSocketInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="65"></td><td><pre>        <span class="token function">AfxMessageBox</span><span class="token punctuation">(</span>IDP_SOCKETS_INIT_FAILED<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="66"></td><td><pre>        <span class="token keyword">return</span> FALSE<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="67"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="68"></td><td><pre></pre></td></tr><tr><td data-num="69"></td><td><pre>    <span class="token keyword">return</span> TRUE<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="70"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h4 id="testconnect"><a class="anchor" href="#testconnect">#</a> TestConnect</h4><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/*</span></pre></td></tr><tr><td data-num="2"></td><td><pre> * 这个函数的作用是测试连接到指定 IP 地址的特定端口是否成功</pre></td></tr><tr><td data-num="3"></td><td><pre> * 如果连接成功则返回 1，否则返回 0</pre></td></tr><tr><td data-num="4"></td><td><pre> */</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">int</span> <span class="token function">TestConnect</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>ip<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token comment">// 初始化 Winsock</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    WSADATA wsd<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">WSAStartup</span><span class="token punctuation">(</span><span class="token function">MAKEWORD</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>wsd<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token comment">// 创建套接字</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    SOCKET cClient<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    cClient <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> IPPROTO_TCP<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>cClient <span class="token operator">==</span> INVALID_SOCKET<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token comment">// 设置发送和接收超时时间为 6 秒</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    DWORD TimeOut <span class="token operator">=</span> <span class="token number">6000</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token double-colon punctuation">::</span><span class="token function">setsockopt</span><span class="token punctuation">(</span>cClient<span class="token punctuation">,</span> SOL_SOCKET<span class="token punctuation">,</span> SO_SNDTIMEO<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>TimeOut<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>TimeOut<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> SOCKET_ERROR<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    TimeOut <span class="token operator">=</span> <span class="token number">6000</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token double-colon punctuation">::</span><span class="token function">setsockopt</span><span class="token punctuation">(</span>cClient<span class="token punctuation">,</span> SOL_SOCKET<span class="token punctuation">,</span> SO_RCVTIMEO<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>TimeOut<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>TimeOut<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> SOCKET_ERROR<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="24"></td><td><pre></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token comment">// 设置非阻塞方式连接</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> ul <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">ioctlsocket</span><span class="token punctuation">(</span>cClient<span class="token punctuation">,</span> FIONBIO<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>ul<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">==</span> SOCKET_ERROR<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token comment">// 连接到指定 IP 地址和端口</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> server<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>    server<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>    server<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span><span class="token number">9007</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>    server<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr <span class="token operator">=</span> <span class="token function">inet_addr</span><span class="token punctuation">(</span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr <span class="token operator">==</span> INADDR_NONE<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>    <span class="token function">connect</span><span class="token punctuation">(</span>cClient<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>server<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>server<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 立即返回</span></pre></td></tr><tr><td data-num="37"></td><td><pre></pre></td></tr><tr><td data-num="38"></td><td><pre>    <span class="token comment">// 使用 select 函数检测连接是否建立</span></pre></td></tr><tr><td data-num="39"></td><td><pre>    <span class="token keyword">struct</span> <span class="token class-name">timeval</span> timeout<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>    fd_set r<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>    <span class="token function">FD_ZERO</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>    <span class="token function">FD_SET</span><span class="token punctuation">(</span>cClient<span class="token punctuation">,</span> <span class="token operator">&amp;</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>    timeout<span class="token punctuation">.</span>tv_sec <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// 连接超时 1 秒</span></pre></td></tr><tr><td data-num="44"></td><td><pre>    timeout<span class="token punctuation">.</span>tv_usec <span class="token operator">=</span> <span class="token number">200000</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>    ret <span class="token operator">=</span> <span class="token function">select</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>r<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>timeout<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>        <span class="token double-colon punctuation">::</span><span class="token function">closesocket</span><span class="token punctuation">(</span>cClient<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 关闭套接字</span></pre></td></tr><tr><td data-num="48"></td><td><pre>        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 连接失败</span></pre></td></tr><tr><td data-num="49"></td><td><pre>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="50"></td><td><pre>        <span class="token double-colon punctuation">::</span><span class="token function">closesocket</span><span class="token punctuation">(</span>cClient<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 关闭套接字</span></pre></td></tr><tr><td data-num="51"></td><td><pre>        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// 连接成功</span></pre></td></tr><tr><td data-num="52"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="53"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h4 id="cleanfile"><a class="anchor" href="#cleanfile">#</a> CleanFile</h4><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="2"></td><td><pre> * 函数的作用是清理指定目录下的特定文件</pre></td></tr><tr><td data-num="3"></td><td><pre> * 该函数用于删除指定目录下以 "P*.bmp"、"P*.txt" 和 "wz.txt" 格式命名的文件</pre></td></tr><tr><td data-num="4"></td><td><pre> */</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">void</span> <span class="token function">CleanFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    CString strFileTitle<span class="token punctuation">;</span> <span class="token comment">// 用于存储文件名的字符串</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre>    CFileFind finder<span class="token punctuation">;</span> <span class="token comment">// 文件查找器对象</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token keyword">char</span> curpath<span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 存储当前执行文件路径的字符数组</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token comment">// 获取当前执行文件的路径</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token function">GetModuleFileName</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> curpath<span class="token punctuation">,</span> MAX_PATH<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token punctuation">(</span><span class="token function">_tcsrchr</span><span class="token punctuation">(</span>curpath<span class="token punctuation">,</span> <span class="token function">_T</span><span class="token punctuation">(</span><span class="token char">'\\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 将路径最后的文件名部分截断</span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token comment">// 查找并删除所有以 "P*.bmp" 格式命名的文件</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    BOOL bWorking <span class="token operator">=</span> finder<span class="token punctuation">.</span><span class="token function">FindFile</span><span class="token punctuation">(</span><span class="token string">"P*.bmp"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token keyword">while</span> <span class="token punctuation">(</span>bWorking<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        bWorking <span class="token operator">=</span> finder<span class="token punctuation">.</span><span class="token function">FindNextFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 继续查找下一个匹配的文件</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        strFileTitle <span class="token operator">=</span> finder<span class="token punctuation">.</span><span class="token function">GetFileName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取文件名</span></pre></td></tr><tr><td data-num="20"></td><td><pre>        <span class="token class-name">CFile</span><span class="token double-colon punctuation">::</span><span class="token function">Remove</span><span class="token punctuation">(</span><span class="token punctuation">(</span>LPCSTR<span class="token punctuation">)</span> strFileTitle<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 删除文件</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="22"></td><td><pre></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token comment">// 查找并删除所有以 "P*.txt" 格式命名的文件</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    bWorking <span class="token operator">=</span> finder<span class="token punctuation">.</span><span class="token function">FindFile</span><span class="token punctuation">(</span><span class="token string">"P*.txt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token keyword">while</span> <span class="token punctuation">(</span>bWorking<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>        bWorking <span class="token operator">=</span> finder<span class="token punctuation">.</span><span class="token function">FindNextFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 继续查找下一个匹配的文件</span></pre></td></tr><tr><td data-num="27"></td><td><pre>        strFileTitle <span class="token operator">=</span> finder<span class="token punctuation">.</span><span class="token function">GetFileName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取文件名</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        <span class="token class-name">CFile</span><span class="token double-colon punctuation">::</span><span class="token function">Remove</span><span class="token punctuation">(</span><span class="token punctuation">(</span>LPCSTR<span class="token punctuation">)</span> strFileTitle<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 删除文件</span></pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="30"></td><td><pre></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token comment">// 查找并删除所有名为 "wz.txt" 的文件</span></pre></td></tr><tr><td data-num="32"></td><td><pre>    bWorking <span class="token operator">=</span> finder<span class="token punctuation">.</span><span class="token function">FindFile</span><span class="token punctuation">(</span><span class="token string">"wz.txt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>    <span class="token keyword">while</span> <span class="token punctuation">(</span>bWorking<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>        bWorking <span class="token operator">=</span> finder<span class="token punctuation">.</span><span class="token function">FindNextFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 继续查找下一个匹配的文件</span></pre></td></tr><tr><td data-num="35"></td><td><pre>        strFileTitle <span class="token operator">=</span> finder<span class="token punctuation">.</span><span class="token function">GetFileName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取文件名</span></pre></td></tr><tr><td data-num="36"></td><td><pre>        <span class="token class-name">CFile</span><span class="token double-colon punctuation">::</span><span class="token function">Remove</span><span class="token punctuation">(</span><span class="token punctuation">(</span>LPCSTR<span class="token punctuation">)</span> strFileTitle<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 删除文件</span></pre></td></tr><tr><td data-num="37"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="38"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h4 id="getcheck"><a class="anchor" href="#getcheck">#</a> GetCheck</h4><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="2"></td><td><pre> * 这个函数的作用是生成一个用于校验的随机数</pre></td></tr><tr><td data-num="3"></td><td><pre> * 该函数利用当前时间作为随机数的种子，通过调用 rand () 函数生成一个随机数，并将其乘以 0xFFFF 以增加其随机性，最后返回生成的随机数作为校验值</pre></td></tr><tr><td data-num="4"></td><td><pre> * @return</pre></td></tr><tr><td data-num="5"></td><td><pre> */</pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">int</span> <span class="token function">GetCheck</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token function">srand</span><span class="token punctuation">(</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 使用当前时间作为随机数种子，以确保每次生成的随机数都不同</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token keyword">int</span> check <span class="token operator">=</span> <span class="token function">rand</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">0xFFFF</span><span class="token punctuation">;</span> <span class="token comment">// 生成一个随机数，并乘以 0xFFFF（十六进制中最大的两字节值），以增加随机性</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token keyword">return</span> check<span class="token punctuation">;</span> <span class="token comment">// 返回生成的随机数作为校验值</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h4 id="writeprivateprofileint"><a class="anchor" href="#writeprivateprofileint">#</a> WritePrivateProfileInt</h4><figure class="highlight cpp"><figcaption data-lang="C++"><span>WritePrivateProfileInt</span></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="2"></td><td><pre> * 这段代码定义了一个名为 WritePrivateProfileInt 的函数，用于向 INI 文件中写入整数值</pre></td></tr><tr><td data-num="3"></td><td><pre> * 这个函数的参数包括要写入的 INI 文件的节名 (lpAppName)、键名 (lpKeyName)，以及要写入的整数值 (Value)。函数将整数值转换为字符串格式，</pre></td></tr><tr><td data-num="4"></td><td><pre> * 并通过 WritePrivateProfileString 函数写入指定的 INI 文件中的相应部分</pre></td></tr><tr><td data-num="5"></td><td><pre> */</pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token function">WritePrivateProfileInt</span><span class="token punctuation">(</span>LPCTSTR lpAppName<span class="token punctuation">,</span> LPCTSTR lpKeyName<span class="token punctuation">,</span> INT Value<span class="token punctuation">,</span> LPCTSTR lpFileName<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>TCHAR ValBuf<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 用于存储整数值的字符缓冲区，大小为 16 字节</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token function">sprintf</span><span class="token punctuation">(</span>ValBuf<span class="token punctuation">,</span> <span class="token function">TEXT</span><span class="token punctuation">(</span><span class="token string">"%i"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Value<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 将整数值转换为字符串格式，存储在 ValBuf 中</span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token comment">// 调用 WritePrivateProfileString 函数写入 INI 文件，并返回其结果</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token keyword">return</span> <span class="token function">WritePrivateProfileString</span><span class="token punctuation">(</span>lpAppName<span class="token punctuation">,</span> lpKeyName<span class="token punctuation">,</span> ValBuf<span class="token punctuation">,</span> lpFileName<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h4 id="encodeimage"><a class="anchor" href="#encodeimage">#</a> EncodeImage</h4><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="2"></td><td><pre> * 这个函数是用来对图片进行 Base64 编码的</pre></td></tr><tr><td data-num="3"></td><td><pre> * 该函数的作用是接受一个图片文件的路径，然后对该图片进行 Base64 编码，并返回编码后的字符串。</pre></td></tr><tr><td data-num="4"></td><td><pre> * @param jpgname</pre></td></tr><tr><td data-num="5"></td><td><pre> * @return</pre></td></tr><tr><td data-num="6"></td><td><pre> */</pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre>CString <span class="token function">EncodeImage</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>jpgname<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// 对图片进行 Base64 编码的函数</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    ZBase64 zBase<span class="token punctuation">;</span> <span class="token comment">// 创建一个 ZBase64 对象，用于 Base64 编码</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token comment">// 打开图片文件</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    CFile cbfBmp<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    cbfBmp<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span>jpgname<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token comment">// 获取图片文件大小</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token keyword">int</span> iBmpSize <span class="token operator">=</span> cbfBmp<span class="token punctuation">.</span><span class="token function">GetLength</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token comment">// 分配内存</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    HGLOBAL hMemBmp <span class="token operator">=</span> <span class="token function">GlobalAlloc</span><span class="token punctuation">(</span>GMEM_FIXED<span class="token punctuation">,</span> iBmpSize<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token comment">// 如果内存分配失败，返回空字符串</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>hMemBmp <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token string">""</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token comment">// 创建内存流对象</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    IStream <span class="token operator">*</span>pStmBmp <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token function">CreateStreamOnHGlobal</span><span class="token punctuation">(</span>hMemBmp<span class="token punctuation">,</span> FALSE<span class="token punctuation">,</span> <span class="token operator">&amp;</span>pStmBmp<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token comment">// 锁定内存并读取图片数据</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    BYTE <span class="token operator">*</span>pbyBmp <span class="token operator">=</span> <span class="token punctuation">(</span>BYTE <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token function">GlobalLock</span><span class="token punctuation">(</span>hMemBmp<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    cbfBmp<span class="token punctuation">.</span><span class="token function">SeekToBegin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    cbfBmp<span class="token punctuation">.</span><span class="token function">Read</span><span class="token punctuation">(</span>pbyBmp<span class="token punctuation">,</span> iBmpSize<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre></pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token comment">// 使用 ZBase64 对象对图片数据进行 Base64 编码</span></pre></td></tr><tr><td data-num="30"></td><td><pre>    string strTmpResult <span class="token operator">=</span> zBase<span class="token punctuation">.</span><span class="token function">Encode</span><span class="token punctuation">(</span>pbyBmp<span class="token punctuation">,</span> iBmpSize<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre></pre></td></tr><tr><td data-num="32"></td><td><pre>    <span class="token comment">// 将 Base64 编码后的字符串转换为 CString 类型并返回</span></pre></td></tr><tr><td data-num="33"></td><td><pre>    CString result<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>    result <span class="token operator">=</span> strTmpResult<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>    <span class="token keyword">return</span> result<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h4 id="readcard"><a class="anchor" href="#readcard">#</a> ReadCard</h4><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="2"></td><td><pre> * 这段代码似乎是用于读取身份证信息的，但是其中缺少了具体的读取身份证信息的逻辑</pre></td></tr><tr><td data-num="3"></td><td><pre> * 这段代码中，ReadCard 函数似乎是用于读取身份证信息的，但其中的具体逻辑在 ReadThreadFindHID 函数内部实现。在当前的代码中，</pre></td></tr><tr><td data-num="4"></td><td><pre> * 没有提供 ReadThreadFindHID 函数的实现，因此无法准确判断 ReadCard 函数的功能</pre></td></tr><tr><td data-num="5"></td><td><pre> * @return</pre></td></tr><tr><td data-num="6"></td><td><pre> */</pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">char</span> <span class="token operator">*</span>__stdcall <span class="token function">ReadCard</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token function">AFX_MANAGE_STATE</span><span class="token punctuation">(</span><span class="token function">AfxGetStaticModuleState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 管理 MFC 模块状态</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">_AFXDLL</span></span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">_AFX_SOCK_THREAD_STATE</span> <span class="token expression">AFX_MODULE_THREAD_STATE</span></span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">_afxSockThreadState</span> <span class="token expression"><span class="token function">AfxGetModuleThreadState</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre>    _AFX_SOCK_THREAD_STATE <span class="token operator">*</span>pState <span class="token operator">=</span> _afxSockThreadState<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token comment">// 检查线程状态，如果为空，则初始化一些 Socket 相关的数据结构</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>pState<span class="token operator">-></span>m_pmapSocketHandle <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        pState<span class="token operator">-></span>m_pmapSocketHandle <span class="token operator">=</span> <span class="token keyword">new</span> CMapPtrToPtr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>pState<span class="token operator">-></span>m_pmapDeadSockets <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        pState<span class="token operator">-></span>m_pmapDeadSockets <span class="token operator">=</span> <span class="token keyword">new</span> CMapPtrToPtr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>pState<span class="token operator">-></span>m_plistSocketNotifications <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="21"></td><td><pre>        pState<span class="token operator">-></span>m_plistSocketNotifications <span class="token operator">=</span> <span class="token keyword">new</span> CPtrList<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span></pre></td></tr><tr><td data-num="24"></td><td><pre></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token keyword">char</span> <span class="token operator">*</span>retString<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token comment">// 检查是否找到了读取身份证信息的线程</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ReadThreadFindHID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>        <span class="token comment">// 如果找到了读取身份证信息的线程，则进行相关操作</span></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="31"></td><td><pre></pre></td></tr><tr><td data-num="32"></td><td><pre>    <span class="token comment">// 如果未找到读取身份证信息的线程，则返回 "net failure" 字符串</span></pre></td></tr><tr><td data-num="33"></td><td><pre>    retString <span class="token operator">=</span> <span class="token string">"net failure"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre></pre></td></tr><tr><td data-num="35"></td><td><pre>    <span class="token keyword">return</span> retString<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h4 id="ffconnect"><a class="anchor" href="#ffconnect">#</a> ffconnect</h4><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="2"></td><td><pre> * 这段代码似乎是一个用于连接设备的函数，同时返回一个包含连接状态信息的 JSON 字符串</pre></td></tr><tr><td data-num="3"></td><td><pre> * 在这个函数中，ReadThreadFindHID () 函数似乎用于检查是否成功找到了读取设备信息的线程。如果找到了，</pre></td></tr><tr><td data-num="4"></td><td><pre> * 函数会返回一个包含成功连接信息的 JSON 字符串；如果未找到，函数会返回一个包含连接失败信息的 JSON 字符串。</pre></td></tr><tr><td data-num="5"></td><td><pre> * @return</pre></td></tr><tr><td data-num="6"></td><td><pre> */</pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">char</span> <span class="token operator">*</span>__stdcall <span class="token function">ffconnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token function">AFX_MANAGE_STATE</span><span class="token punctuation">(</span><span class="token function">AfxGetStaticModuleState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 管理 MFC 模块状态</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token keyword">char</span> <span class="token operator">*</span>retString<span class="token punctuation">;</span> <span class="token comment">// 返回的字符串指针</span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre>    CString strResult<span class="token punctuation">;</span> <span class="token comment">// 存储连接状态信息的字符串</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ReadThreadFindHID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token comment">// 如果找到了读取身份证信息的线程，则表示连接设备成功</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        root<span class="token punctuation">[</span><span class="token string">"code"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"1"</span><span class="token punctuation">;</span> <span class="token comment">// 设定状态码为 1，表示成功</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        root<span class="token punctuation">[</span><span class="token string">"content"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"conect device success"</span><span class="token punctuation">;</span> <span class="token comment">// 设置内容为连接设备成功</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        <span class="token comment">// 如果未找到读取身份证信息的线程，则表示连接设备失败</span></pre></td></tr><tr><td data-num="20"></td><td><pre>        root<span class="token punctuation">[</span><span class="token string">"code"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"0"</span><span class="token punctuation">;</span> <span class="token comment">// 设定状态码为 0，表示失败</span></pre></td></tr><tr><td data-num="21"></td><td><pre>        root<span class="token punctuation">[</span><span class="token string">"content"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"connect device failure"</span><span class="token punctuation">;</span> <span class="token comment">// 设置内容为连接设备失败</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="23"></td><td><pre></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token comment">// 将 JSON 对象转换为格式化的字符串</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    root<span class="token punctuation">.</span><span class="token function">toStyledString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    rtnOut <span class="token operator">=</span> root<span class="token punctuation">.</span><span class="token function">toStyledString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> rtnOut<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 返回连接状态信息的字符串指针</span></pre></td></tr><tr><td data-num="29"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h4 id="collterminalsn"><a class="anchor" href="#collterminalsn">#</a> collTerminalSN</h4><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="2"></td><td><pre> * 这段代码是一个用于收集终端序列号的函数。它似乎会尝试从设备中读取序列号，并返回一个包含序列号信息的 JSON 字符串</pre></td></tr><tr><td data-num="3"></td><td><pre> * 在这个函数中，首先尝试找到读取设备信息的线程。如果成功找到，就尝试从设备中读取序列号数据，并根据读取结果返回相应的 JSON 字符串</pre></td></tr><tr><td data-num="4"></td><td><pre> * @return</pre></td></tr><tr><td data-num="5"></td><td><pre> */</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">char</span> <span class="token operator">*</span>__stdcall <span class="token function">collTerminalSN</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token function">write_log_file</span><span class="token punctuation">(</span><span class="token string">"collTerminalSN 1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 记录日志：开始收集终端序列号</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token function">AFX_MANAGE_STATE</span><span class="token punctuation">(</span><span class="token function">AfxGetStaticModuleState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 管理 MFC 模块状态</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> code_data<span class="token punctuation">[</span><span class="token number">60</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 存储序列号数据的缓冲区</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token function">memset</span><span class="token punctuation">(</span>code_data<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 将缓冲区清零</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token function">write_log_file</span><span class="token punctuation">(</span><span class="token string">"collTerminalSN 2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 记录日志：准备读取序列号</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ReadThreadFindHID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 如果成功找到读取设备信息的线程</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token function">write_log_file</span><span class="token punctuation">(</span><span class="token string">"collTerminalSN 3"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 记录日志：找到读取设备信息的线程</span></pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>Data <span class="token operator">=</span> <span class="token function">GET_SN</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取序列号数据</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>Data <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>            <span class="token comment">// 如果未成功获取序列号数据</span></pre></td></tr><tr><td data-num="20"></td><td><pre>            root<span class="token punctuation">[</span><span class="token string">"code"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"0"</span><span class="token punctuation">;</span> <span class="token comment">// 设定状态码为 0，表示失败</span></pre></td></tr><tr><td data-num="21"></td><td><pre>            root<span class="token punctuation">[</span><span class="token string">"content"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"get SN failure"</span><span class="token punctuation">;</span> <span class="token comment">// 设置内容为获取序列号失败</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>            <span class="token function">write_log_file</span><span class="token punctuation">(</span><span class="token string">"collTerminalSN 4"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 记录日志：成功获取序列号数据</span></pre></td></tr><tr><td data-num="24"></td><td><pre></pre></td></tr><tr><td data-num="25"></td><td><pre>            <span class="token comment">// 将获取的序列号数据拷贝到缓冲区中</span></pre></td></tr><tr><td data-num="26"></td><td><pre>            <span class="token function">memcpy</span><span class="token punctuation">(</span>code_data<span class="token punctuation">,</span> Data<span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre></pre></td></tr><tr><td data-num="28"></td><td><pre>            root<span class="token punctuation">[</span><span class="token string">"code"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"1"</span><span class="token punctuation">;</span> <span class="token comment">// 设定状态码为 1，表示成功</span></pre></td></tr><tr><td data-num="29"></td><td><pre>            <span class="token keyword">char</span> sn<span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 存储序列号的数组</span></pre></td></tr><tr><td data-num="30"></td><td><pre>            <span class="token function">memset</span><span class="token punctuation">(</span>sn<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 清零序列号数组</span></pre></td></tr><tr><td data-num="31"></td><td><pre>            <span class="token function">memcpy</span><span class="token punctuation">(</span>sn<span class="token punctuation">,</span> code_data <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 从序列号数据中提取序列号信息</span></pre></td></tr><tr><td data-num="32"></td><td><pre>            root<span class="token punctuation">[</span><span class="token string">"content"</span><span class="token punctuation">]</span> <span class="token operator">=</span> sn<span class="token punctuation">;</span> <span class="token comment">// 将序列号信息设置为内容</span></pre></td></tr><tr><td data-num="33"></td><td><pre></pre></td></tr><tr><td data-num="34"></td><td><pre>            <span class="token function">write_log_file</span><span class="token punctuation">(</span><span class="token string">"collTerminalSN 5"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 记录日志：序列号处理完成</span></pre></td></tr><tr><td data-num="35"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>        <span class="token comment">// 如果未找到读取设备信息的线程</span></pre></td></tr><tr><td data-num="38"></td><td><pre>        root<span class="token punctuation">[</span><span class="token string">"code"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"0"</span><span class="token punctuation">;</span> <span class="token comment">// 设定状态码为 0，表示失败</span></pre></td></tr><tr><td data-num="39"></td><td><pre>        root<span class="token punctuation">[</span><span class="token string">"content"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"connect device failure"</span><span class="token punctuation">;</span> <span class="token comment">// 设置内容为连接设备失败</span></pre></td></tr><tr><td data-num="40"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>    <span class="token function">write_log_file</span><span class="token punctuation">(</span><span class="token string">"collTerminalSN 6"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 记录日志：序列号收集完成</span></pre></td></tr><tr><td data-num="42"></td><td><pre></pre></td></tr><tr><td data-num="43"></td><td><pre>    root<span class="token punctuation">.</span><span class="token function">toStyledString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 将 JSON 对象转换为格式化的字符串</span></pre></td></tr><tr><td data-num="44"></td><td><pre>    rtnOut <span class="token operator">=</span> root<span class="token punctuation">.</span><span class="token function">toStyledString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 将格式化的字符串赋值给返回值</span></pre></td></tr><tr><td data-num="45"></td><td><pre></pre></td></tr><tr><td data-num="46"></td><td><pre>    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> rtnOut<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 返回序列号信息的字符串指针</span></pre></td></tr><tr><td data-num="47"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h4 id="collidnumber"><a class="anchor" href="#collidnumber">#</a> collIdNumber</h4><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="2"></td><td><pre> * 这是一个用于收集身份证号码的函数。它接收一个 JSON 字符串作为输入，解析其中的身份证号码和设备序列号，并尝试将身份证号码写入设备中</pre></td></tr><tr><td data-num="3"></td><td><pre> * 这个函数首先从输入的 JSON 字符串中解析身份证号码和设备序列号。然后它尝试从设备中获取序列号数据，并与输入的设备序列号进行匹配。</pre></td></tr><tr><td data-num="4"></td><td><pre> * 如果匹配成功，它会尝试将身份证号码写入设备中。最后，它会根据操作的结果返回相应的 JSON 字符串</pre></td></tr><tr><td data-num="5"></td><td><pre> * @param inData</pre></td></tr><tr><td data-num="6"></td><td><pre> * @return</pre></td></tr><tr><td data-num="7"></td><td><pre> */</pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">char</span> <span class="token operator">*</span>__stdcall <span class="token function">collIdNumber</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>inData<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token function">AFX_MANAGE_STATE</span><span class="token punctuation">(</span><span class="token function">AfxGetStaticModuleState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 管理 MFC 模块状态</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token comment">// 解析输入的 JSON 数据</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    Json<span class="token double-colon punctuation">::</span>Value jData<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    Json<span class="token double-colon punctuation">::</span>Reader reader<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    string sinData <span class="token operator">=</span> inData<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    reader<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>sinData<span class="token punctuation">,</span> jData<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> code_data<span class="token punctuation">[</span><span class="token number">60</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 存储设备数据的缓冲区</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token function">memset</span><span class="token punctuation">(</span>code_data<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 将缓冲区清零</span></pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token comment">// 从 JSON 中获取身份证号码和设备序列号</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    string inID <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> jData<span class="token punctuation">[</span><span class="token string">"i"</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">asString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 身份证号码</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    string inSN <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> jData<span class="token punctuation">[</span><span class="token string">"s"</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">asString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 设备序列号</span></pre></td></tr><tr><td data-num="23"></td><td><pre></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token comment">// 如果成功找到读取设备信息的线程</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ReadThreadFindHID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>        <span class="token comment">// 尝试从设备中获取序列号数据</span></pre></td></tr><tr><td data-num="27"></td><td><pre>        <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>Data <span class="token operator">=</span> <span class="token function">GET_SN</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>Data <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>            <span class="token comment">// 如果未成功获取序列号数据，则返回错误信息</span></pre></td></tr><tr><td data-num="30"></td><td><pre>            root<span class="token punctuation">[</span><span class="token string">"code"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"2"</span><span class="token punctuation">;</span> <span class="token comment">// 设置状态码为 2，表示获取序列号失败</span></pre></td></tr><tr><td data-num="31"></td><td><pre>            root<span class="token punctuation">[</span><span class="token string">"content"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"get SN failure"</span><span class="token punctuation">;</span> <span class="token comment">// 设置内容为获取序列号失败</span></pre></td></tr><tr><td data-num="32"></td><td><pre>            root<span class="token punctuation">.</span><span class="token function">toStyledString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>            rtnOut <span class="token operator">=</span> root<span class="token punctuation">.</span><span class="token function">toStyledString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>            <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> rtnOut<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 返回错误信息的字符串指针</span></pre></td></tr><tr><td data-num="35"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>            <span class="token comment">// 如果成功获取序列号数据，则检查序列号是否匹配</span></pre></td></tr><tr><td data-num="37"></td><td><pre>            <span class="token function">memcpy</span><span class="token punctuation">(</span>code_data<span class="token punctuation">,</span> Data<span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>            <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">strncmp</span><span class="token punctuation">(</span>inSN<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> code_data <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>                <span class="token comment">// 如果序列号不匹配，则返回错误信息</span></pre></td></tr><tr><td data-num="41"></td><td><pre>                root<span class="token punctuation">[</span><span class="token string">"code"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"3"</span><span class="token punctuation">;</span> <span class="token comment">// 设置状态码为 3，表示序列号不匹配</span></pre></td></tr><tr><td data-num="42"></td><td><pre>                root<span class="token punctuation">[</span><span class="token string">"content"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"SN not match"</span><span class="token punctuation">;</span> <span class="token comment">// 设置内容为序列号不匹配</span></pre></td></tr><tr><td data-num="43"></td><td><pre>                root<span class="token punctuation">.</span><span class="token function">toStyledString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>                rtnOut <span class="token operator">=</span> root<span class="token punctuation">.</span><span class="token function">toStyledString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>                <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> rtnOut<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 返回错误信息的字符串指针</span></pre></td></tr><tr><td data-num="46"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="48"></td><td><pre></pre></td></tr><tr><td data-num="49"></td><td><pre>        <span class="token comment">// 从设备中删除原有的身份证号码，并尝试写入新的身份证号码</span></pre></td></tr><tr><td data-num="50"></td><td><pre>        Data <span class="token operator">=</span> <span class="token function">DEL_ID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="51"></td><td><pre>        Data <span class="token operator">=</span> <span class="token function">ADD_ID</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> inID<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="52"></td><td><pre></pre></td></tr><tr><td data-num="53"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>Data <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="54"></td><td><pre>            <span class="token comment">// 如果写入身份证号码失败，则返回错误信息</span></pre></td></tr><tr><td data-num="55"></td><td><pre>            root<span class="token punctuation">[</span><span class="token string">"code"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"0"</span><span class="token punctuation">;</span> <span class="token comment">// 设置状态码为 0，表示写入失败</span></pre></td></tr><tr><td data-num="56"></td><td><pre>            root<span class="token punctuation">[</span><span class="token string">"content"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"collect id number failure"</span><span class="token punctuation">;</span> <span class="token comment">// 设置内容为写入身份证号码失败</span></pre></td></tr><tr><td data-num="57"></td><td><pre>            root<span class="token punctuation">.</span><span class="token function">toStyledString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="58"></td><td><pre>            rtnOut <span class="token operator">=</span> root<span class="token punctuation">.</span><span class="token function">toStyledString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="59"></td><td><pre>            <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> rtnOut<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 返回错误信息的字符串指针</span></pre></td></tr><tr><td data-num="60"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="61"></td><td><pre>            <span class="token comment">// 如果写入身份证号码成功，则返回成功信息及新的身份证号码</span></pre></td></tr><tr><td data-num="62"></td><td><pre>            <span class="token function">memcpy</span><span class="token punctuation">(</span>code_data<span class="token punctuation">,</span> Data<span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="63"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span>code_data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0x00</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="64"></td><td><pre>                root<span class="token punctuation">[</span><span class="token string">"code"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"0"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="65"></td><td><pre>                root<span class="token punctuation">[</span><span class="token string">"content"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"collect id number failure!"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="66"></td><td><pre>                root<span class="token punctuation">.</span><span class="token function">toStyledString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="67"></td><td><pre>                rtnOut <span class="token operator">=</span> root<span class="token punctuation">.</span><span class="token function">toStyledString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="68"></td><td><pre>                <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> rtnOut<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="69"></td><td><pre>            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="70"></td><td><pre>                root<span class="token punctuation">[</span><span class="token string">"code"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"1"</span><span class="token punctuation">;</span> <span class="token comment">// 设置状态码为 1，表示写入成功</span></pre></td></tr><tr><td data-num="71"></td><td><pre>                <span class="token comment">// 将新的身份证号码和设备序列号拼接成字符串</span></pre></td></tr><tr><td data-num="72"></td><td><pre>                inSN<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"|"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="73"></td><td><pre>                inSN<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>inID<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="74"></td><td><pre>                root<span class="token punctuation">[</span><span class="token string">"content"</span><span class="token punctuation">]</span> <span class="token operator">=</span> inSN<span class="token punctuation">;</span> <span class="token comment">// 设置内容为拼接后的字符串</span></pre></td></tr><tr><td data-num="75"></td><td><pre></pre></td></tr><tr><td data-num="76"></td><td><pre>                root<span class="token punctuation">.</span><span class="token function">toStyledString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="77"></td><td><pre>                rtnOut <span class="token operator">=</span> root<span class="token punctuation">.</span><span class="token function">toStyledString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="78"></td><td><pre>                <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> rtnOut<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 返回成功信息的字符串指针</span></pre></td></tr><tr><td data-num="79"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="80"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="81"></td><td><pre>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="82"></td><td><pre>        <span class="token comment">// 如果未找到读取设备信息的线程，则返回连接设备失败的错误信息</span></pre></td></tr><tr><td data-num="83"></td><td><pre>        root<span class="token punctuation">[</span><span class="token string">"code"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="84"></td><td><pre>        root<span class="token punctuation">[</span><span class="token string">"content"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"connect device failure"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="85"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="86"></td><td><pre>    root<span class="token punctuation">.</span><span class="token function">toStyledString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="87"></td><td><pre>    rtnOut <span class="token operator">=</span> root<span class="token punctuation">.</span><span class="token function">toStyledString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="88"></td><td><pre>    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> rtnOut<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 返回错误信息的字符串指针</span></pre></td></tr><tr><td data-num="89"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h4 id="collfingerprint"><a class="anchor" href="#collfingerprint">#</a> collFingerPrint</h4><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="2"></td><td><pre> * 这段代码是一个用于收集指纹数据的函数</pre></td></tr><tr><td data-num="3"></td><td><pre> * 这个函数的作用是收集指纹数据，并返回操作结果</pre></td></tr><tr><td data-num="4"></td><td><pre> * @param inData</pre></td></tr><tr><td data-num="5"></td><td><pre> * @return</pre></td></tr><tr><td data-num="6"></td><td><pre> */</pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">char</span> <span class="token operator">*</span>__stdcall <span class="token function">collFingerPrint</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>inData<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token function">write_log_file</span><span class="token punctuation">(</span><span class="token string">"collFingerPrint 0"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 写入日志，表示函数开始执行</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token function">AFX_MANAGE_STATE</span><span class="token punctuation">(</span><span class="token function">AfxGetStaticModuleState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 管理 MFC 模块状态</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token comment">// 解析输入的 JSON 数据</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    Json<span class="token double-colon punctuation">::</span>Value jData<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    Json<span class="token double-colon punctuation">::</span>Reader reader<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    string sinData <span class="token operator">=</span> inData<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    reader<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>sinData<span class="token punctuation">,</span> jData<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> code_data<span class="token punctuation">[</span><span class="token number">60</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 存储设备数据的缓冲区</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token function">memset</span><span class="token punctuation">(</span>code_data<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 将缓冲区清零</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token keyword">int</span> index <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// 指纹索引，默认为 - 1</span></pre></td></tr><tr><td data-num="20"></td><td><pre></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token function">write_log_file</span><span class="token punctuation">(</span><span class="token string">"collFingerPrint 1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 写入日志，表示进入函数的第一步</span></pre></td></tr><tr><td data-num="22"></td><td><pre></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token comment">// 从输入的 JSON 中获取指纹索引</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>jData<span class="token punctuation">[</span><span class="token string">"f"</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">isNull</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 如果 JSON 中包含 "f" 字段</span></pre></td></tr><tr><td data-num="25"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>jData<span class="token punctuation">[</span><span class="token string">"f"</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">isString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 如果 "f" 字段的值是字符串类型</span></pre></td></tr><tr><td data-num="26"></td><td><pre>            string strindex <span class="token operator">=</span> jData<span class="token punctuation">[</span><span class="token string">"f"</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">asString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 将 "f" 字段的值转换为字符串</span></pre></td></tr><tr><td data-num="27"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>strindex<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>                index <span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> strindex<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 将字符串转换为整数作为指纹索引</span></pre></td></tr><tr><td data-num="29"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 如果 "f" 字段的值不是字符串类型</span></pre></td></tr><tr><td data-num="31"></td><td><pre>            index <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> jData<span class="token punctuation">[</span><span class="token string">"f"</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">asInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 直接获取整数作为指纹索引</span></pre></td></tr><tr><td data-num="32"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="34"></td><td><pre></pre></td></tr><tr><td data-num="35"></td><td><pre>    <span class="token function">write_log_file</span><span class="token punctuation">(</span><span class="token string">"collFingerPrint 2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 写入日志，表示进入函数的第二步</span></pre></td></tr><tr><td data-num="36"></td><td><pre></pre></td></tr><tr><td data-num="37"></td><td><pre>    string inSN <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> jData<span class="token punctuation">[</span><span class="token string">"s"</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">asString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取设备序列号</span></pre></td></tr><tr><td data-num="38"></td><td><pre></pre></td></tr><tr><td data-num="39"></td><td><pre>    <span class="token comment">// 如果成功找到读取设备信息的线程</span></pre></td></tr><tr><td data-num="40"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ReadThreadFindHID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>        <span class="token comment">// 尝试从设备中获取序列号数据</span></pre></td></tr><tr><td data-num="42"></td><td><pre>        <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>Data <span class="token operator">=</span> <span class="token function">GET_SN</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>Data <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>            <span class="token comment">// 如果未成功获取序列号数据，则返回错误信息</span></pre></td></tr><tr><td data-num="45"></td><td><pre>            root<span class="token punctuation">[</span><span class="token string">"code"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"2"</span><span class="token punctuation">;</span> <span class="token comment">// 设置状态码为 2，表示获取序列号失败</span></pre></td></tr><tr><td data-num="46"></td><td><pre>            root<span class="token punctuation">[</span><span class="token string">"content"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"get SN failure"</span><span class="token punctuation">;</span> <span class="token comment">// 设置内容为获取序列号失败</span></pre></td></tr><tr><td data-num="47"></td><td><pre>            root<span class="token punctuation">.</span><span class="token function">toStyledString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>            rtnOut <span class="token operator">=</span> root<span class="token punctuation">.</span><span class="token function">toStyledString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>            <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> rtnOut<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 返回错误信息的字符串指针</span></pre></td></tr><tr><td data-num="50"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="51"></td><td><pre>            <span class="token comment">// 如果成功获取序列号数据，则检查序列号是否匹配</span></pre></td></tr><tr><td data-num="52"></td><td><pre>            <span class="token function">memcpy</span><span class="token punctuation">(</span>code_data<span class="token punctuation">,</span> Data<span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="53"></td><td><pre>            <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">strncmp</span><span class="token punctuation">(</span>inSN<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> code_data <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="54"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="55"></td><td><pre>                <span class="token comment">// 如果序列号不匹配，则返回错误信息</span></pre></td></tr><tr><td data-num="56"></td><td><pre>                root<span class="token punctuation">[</span><span class="token string">"code"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"3"</span><span class="token punctuation">;</span> <span class="token comment">// 设置状态码为 3，表示序列号不匹配</span></pre></td></tr><tr><td data-num="57"></td><td><pre>                root<span class="token punctuation">[</span><span class="token string">"content"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"SN not match"</span><span class="token punctuation">;</span> <span class="token comment">// 设置内容为序列号不匹配</span></pre></td></tr><tr><td data-num="58"></td><td><pre>                root<span class="token punctuation">.</span><span class="token function">toStyledString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="59"></td><td><pre>                rtnOut <span class="token operator">=</span> root<span class="token punctuation">.</span><span class="token function">toStyledString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="60"></td><td><pre>                <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> rtnOut<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 返回错误信息的字符串指针</span></pre></td></tr><tr><td data-num="61"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="62"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="63"></td><td><pre></pre></td></tr><tr><td data-num="64"></td><td><pre>        <span class="token comment">// 如果指纹索引不为 - 1，则删除指定索引的指纹数据</span></pre></td></tr><tr><td data-num="65"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="66"></td><td><pre>            <span class="token function">write_log_file</span><span class="token punctuation">(</span><span class="token string">"collFingerPrint 3 del"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 写入日志，表示删除指纹数据</span></pre></td></tr><tr><td data-num="67"></td><td><pre>            Data <span class="token operator">=</span> <span class="token function">FP_DEL</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> index<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="68"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="69"></td><td><pre>            index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="70"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="71"></td><td><pre></pre></td></tr><tr><td data-num="72"></td><td><pre>        <span class="token comment">// 注册新的指纹数据</span></pre></td></tr><tr><td data-num="73"></td><td><pre>        Data <span class="token operator">=</span> <span class="token function">FP_REG</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="74"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>Data <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="75"></td><td><pre>            <span class="token comment">// 如果注册指纹失败，则返回错误信息</span></pre></td></tr><tr><td data-num="76"></td><td><pre>            root<span class="token punctuation">[</span><span class="token string">"code"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"0"</span><span class="token punctuation">;</span> <span class="token comment">// 设置状态码为 0，表示注册失败</span></pre></td></tr><tr><td data-num="77"></td><td><pre>            root<span class="token punctuation">[</span><span class="token string">"content"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"collect fingerprint failure"</span><span class="token punctuation">;</span> <span class="token comment">// 设置内容为注册指纹失败</span></pre></td></tr><tr><td data-num="78"></td><td><pre>            root<span class="token punctuation">.</span><span class="token function">toStyledString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="79"></td><td><pre>            rtnOut <span class="token operator">=</span> root<span class="token punctuation">.</span><span class="token function">toStyledString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="80"></td><td><pre>            <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> rtnOut<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 返回错误信息的字符串指针</span></pre></td></tr><tr><td data-num="81"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="82"></td><td><pre>            <span class="token comment">// 如果注册指纹成功，则返回成功信息及指纹索引</span></pre></td></tr><tr><td data-num="83"></td><td><pre>            <span class="token function">memcpy</span><span class="token punctuation">(</span>code_data<span class="token punctuation">,</span> Data<span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="84"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span>code_data<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0x00</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="85"></td><td><pre>                root<span class="token punctuation">[</span><span class="token string">"code"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"0"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="86"></td><td><pre>                root<span class="token punctuation">[</span><span class="token string">"content"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"collect fingerprint failure!"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="87"></td><td><pre>                root<span class="token punctuation">.</span><span class="token function">toStyledString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="88"></td><td><pre>                rtnOut <span class="token operator">=</span> root<span class="token punctuation">.</span><span class="token function">toStyledString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="89"></td><td><pre>                <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> rtnOut<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="90"></td><td><pre>            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="91"></td><td><pre>                root<span class="token punctuation">[</span><span class="token string">"code"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"1"</span><span class="token punctuation">;</span> <span class="token comment">// 设置状态码为 1，表示注册成功</span></pre></td></tr><tr><td data-num="92"></td><td><pre>                index <span class="token operator">=</span> code_data<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token number">256</span> <span class="token operator">+</span> code_data<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 获取指纹索引</span></pre></td></tr><tr><td data-num="93"></td><td><pre>                <span class="token keyword">char</span> idx<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="94"></td><td><pre>                <span class="token function">itoa</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> idx<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="95"></td><td><pre>                inSN<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"|"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="96"></td><td><pre>                inSN<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 将指纹索引拼接到设备序列号后面</span></pre></td></tr><tr><td data-num="97"></td><td><pre>                root<span class="token punctuation">[</span><span class="token string">"content"</span><span class="token punctuation">]</span> <span class="token operator">=</span> inSN<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="98"></td><td><pre></pre></td></tr><tr><td data-num="99"></td><td><pre>                root<span class="token punctuation">.</span><span class="token function">toStyledString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="100"></td><td><pre>                rtnOut <span class="token operator">=</span> root<span class="token punctuation">.</span><span class="token function">toStyledString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="101"></td><td><pre>                <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> rtnOut<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 返回成功信息的字符串指针</span></pre></td></tr><tr><td data-num="102"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="103"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="104"></td><td><pre>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="105"></td><td><pre>        <span class="token comment">// 如果未找到读取设备信息的线程，则返回连接设备失败的错误信息</span></pre></td></tr><tr><td data-num="106"></td><td><pre>        root<span class="token punctuation">[</span><span class="token string">"code"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="107"></td><td><pre>        root<span class="token punctuation">[</span><span class="token string">"content"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"connect device failure"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="108"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="109"></td><td><pre>    root<span class="token punctuation">.</span><span class="token function">toStyledString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="110"></td><td><pre>    rtnOut <span class="token operator">=</span> root<span class="token punctuation">.</span><span class="token function">toStyledString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="111"></td><td><pre>    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> rtnOut<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 返回错误信息的字符串指针</span></pre></td></tr><tr><td data-num="112"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h4 id="deletefingerprints"><a class="anchor" href="#deletefingerprints">#</a> deleteFingerprints</h4><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="2"></td><td><pre> * 这段代码是一个用于删除设备中指纹数据的函数</pre></td></tr><tr><td data-num="3"></td><td><pre> * 这个函数的作用是接收一个包含设备序列号的 JSON 数据，并尝试从设备中获取序列号数据。</pre></td></tr><tr><td data-num="4"></td><td><pre> * 如果成功获取序列号数据并且与输入的序列号匹配，则尝试删除设备中的指纹数据。</pre></td></tr><tr><td data-num="5"></td><td><pre> * 如果删除成功，则返回成功信息；</pre></td></tr><tr><td data-num="6"></td><td><pre> * 如果删除失败，则返回失败信息。</pre></td></tr><tr><td data-num="7"></td><td><pre> * 如果无法找到读取设备信息的线程，则返回连接设备失败的错误信息。</pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre>代码中使用了 MFC 模块来管理状态，并且依赖了 JSON 库来解析 JSON 数据。</pre></td></tr><tr><td data-num="10"></td><td><pre> 在函数中，还使用了一些未定义的函数 ReadThreadFindHID ()、GET_SN () 和 FP_DEL ()，</pre></td></tr><tr><td data-num="11"></td><td><pre> 这些函数可能是外部定义的，用于设备操作和数据处理。</pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre>总的来说，这个函数的作用是在设备中删除指定范围内的指纹数据，并根据操作结果返回相应的状态信息</pre></td></tr><tr><td data-num="14"></td><td><pre> * @param inData</pre></td></tr><tr><td data-num="15"></td><td><pre> * @return</pre></td></tr><tr><td data-num="16"></td><td><pre> */</pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token keyword">char</span> <span class="token operator">*</span>__stdcall <span class="token function">deleteFingerprints</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>inData<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token function">AFX_MANAGE_STATE</span><span class="token punctuation">(</span><span class="token function">AfxGetStaticModuleState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 管理 MFC 模块状态</span></pre></td></tr><tr><td data-num="20"></td><td><pre></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token comment">// 解析输入的 JSON 数据</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    Json<span class="token double-colon punctuation">::</span>Value jData<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    Json<span class="token double-colon punctuation">::</span>Reader reader<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    string sinData <span class="token operator">=</span> inData<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    reader<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>sinData<span class="token punctuation">,</span> jData<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> code_data<span class="token punctuation">[</span><span class="token number">60</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 存储设备数据的缓冲区</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token function">memset</span><span class="token punctuation">(</span>code_data<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 将缓冲区清零</span></pre></td></tr><tr><td data-num="29"></td><td><pre></pre></td></tr><tr><td data-num="30"></td><td><pre>    string inSN <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> jData<span class="token punctuation">[</span><span class="token string">"s"</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">asString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取设备序列号</span></pre></td></tr><tr><td data-num="31"></td><td><pre></pre></td></tr><tr><td data-num="32"></td><td><pre>    <span class="token comment">// 如果成功找到读取设备信息的线程</span></pre></td></tr><tr><td data-num="33"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ReadThreadFindHID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>        <span class="token comment">// 尝试从设备中获取序列号数据</span></pre></td></tr><tr><td data-num="35"></td><td><pre>        <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>Data <span class="token operator">=</span> <span class="token function">GET_SN</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>Data <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>            <span class="token comment">// 如果未成功获取序列号数据，则返回错误信息</span></pre></td></tr><tr><td data-num="38"></td><td><pre>            root<span class="token punctuation">[</span><span class="token string">"code"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"2"</span><span class="token punctuation">;</span> <span class="token comment">// 设置状态码为 2，表示获取序列号失败</span></pre></td></tr><tr><td data-num="39"></td><td><pre>            root<span class="token punctuation">[</span><span class="token string">"content"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"get SN failure"</span><span class="token punctuation">;</span> <span class="token comment">// 设置内容为获取序列号失败</span></pre></td></tr><tr><td data-num="40"></td><td><pre>            root<span class="token punctuation">.</span><span class="token function">toStyledString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>            rtnOut <span class="token operator">=</span> root<span class="token punctuation">.</span><span class="token function">toStyledString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>            <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> rtnOut<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 返回错误信息的字符串指针</span></pre></td></tr><tr><td data-num="43"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>            <span class="token comment">// 如果成功获取序列号数据，则检查序列号是否匹配</span></pre></td></tr><tr><td data-num="45"></td><td><pre>            <span class="token function">memcpy</span><span class="token punctuation">(</span>code_data<span class="token punctuation">,</span> Data<span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>            <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">strncmp</span><span class="token punctuation">(</span>inSN<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> code_data <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>                <span class="token comment">// 如果序列号不匹配，则返回错误信息</span></pre></td></tr><tr><td data-num="49"></td><td><pre>                root<span class="token punctuation">[</span><span class="token string">"code"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"3"</span><span class="token punctuation">;</span> <span class="token comment">// 设置状态码为 3，表示序列号不匹配</span></pre></td></tr><tr><td data-num="50"></td><td><pre>                root<span class="token punctuation">[</span><span class="token string">"content"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"SN not match"</span><span class="token punctuation">;</span> <span class="token comment">// 设置内容为序列号不匹配</span></pre></td></tr><tr><td data-num="51"></td><td><pre>                root<span class="token punctuation">.</span><span class="token function">toStyledString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="52"></td><td><pre>                rtnOut <span class="token operator">=</span> root<span class="token punctuation">.</span><span class="token function">toStyledString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="53"></td><td><pre>                <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> rtnOut<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 返回错误信息的字符串指针</span></pre></td></tr><tr><td data-num="54"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="55"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="56"></td><td><pre></pre></td></tr><tr><td data-num="57"></td><td><pre>        <span class="token comment">// 删除设备中的指纹数据</span></pre></td></tr><tr><td data-num="58"></td><td><pre>        Data <span class="token operator">=</span> <span class="token function">FP_DEL</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 删除指定范围内的指纹数据</span></pre></td></tr><tr><td data-num="59"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>Data <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="60"></td><td><pre>            <span class="token comment">// 如果删除指纹数据失败，则返回错误信息</span></pre></td></tr><tr><td data-num="61"></td><td><pre>            root<span class="token punctuation">[</span><span class="token string">"code"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"0"</span><span class="token punctuation">;</span> <span class="token comment">// 设置状态码为 0，表示删除失败</span></pre></td></tr><tr><td data-num="62"></td><td><pre>            root<span class="token punctuation">[</span><span class="token string">"content"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"delete fingerprint failure"</span><span class="token punctuation">;</span> <span class="token comment">// 设置内容为删除指纹失败</span></pre></td></tr><tr><td data-num="63"></td><td><pre>            root<span class="token punctuation">.</span><span class="token function">toStyledString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="64"></td><td><pre>            rtnOut <span class="token operator">=</span> root<span class="token punctuation">.</span><span class="token function">toStyledString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="65"></td><td><pre>            <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> rtnOut<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 返回错误信息的字符串指针</span></pre></td></tr><tr><td data-num="66"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="67"></td><td><pre>            <span class="token comment">// 如果成功删除指纹数据，则返回成功信息</span></pre></td></tr><tr><td data-num="68"></td><td><pre>            root<span class="token punctuation">[</span><span class="token string">"code"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"1"</span><span class="token punctuation">;</span> <span class="token comment">// 设置状态码为 1，表示删除成功</span></pre></td></tr><tr><td data-num="69"></td><td><pre>            root<span class="token punctuation">.</span><span class="token function">toStyledString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="70"></td><td><pre>            rtnOut <span class="token operator">=</span> root<span class="token punctuation">.</span><span class="token function">toStyledString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="71"></td><td><pre>            <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> rtnOut<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 返回成功信息的字符串指针</span></pre></td></tr><tr><td data-num="72"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="73"></td><td><pre>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="74"></td><td><pre>        <span class="token comment">// 如果未找到读取设备信息的线程，则返回连接设备失败的错误信息</span></pre></td></tr><tr><td data-num="75"></td><td><pre>        root<span class="token punctuation">[</span><span class="token string">"code"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="76"></td><td><pre>        root<span class="token punctuation">[</span><span class="token string">"content"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"connect device failure"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="77"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="78"></td><td><pre>    root<span class="token punctuation">.</span><span class="token function">toStyledString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="79"></td><td><pre>    rtnOut <span class="token operator">=</span> root<span class="token punctuation">.</span><span class="token function">toStyledString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="80"></td><td><pre>    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> rtnOut<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 返回错误信息的字符串指针</span></pre></td></tr><tr><td data-num="81"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h4 id="verify"><a class="anchor" href="#verify">#</a> verify</h4><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="2"></td><td><pre> * 这段代码是一个用于验证身份信息的函数</pre></td></tr><tr><td data-num="3"></td><td><pre> * 这个函数的作用是验证设备中的指纹或身份证信息，并返回验证结果。</pre></td></tr><tr><td data-num="4"></td><td><pre> * 函数首先从输入的 JSON 数据中获取设备序列号，并与设备中的序列号进行比对。</pre></td></tr><tr><td data-num="5"></td><td><pre> * 然后尝试验证指纹或身份证信息，并根据验证结果返回相应的状态码和内容。</pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre>需要注意的是，函数中使用了一些未定义的函数 ReadThreadFindHID ()、GET_SN () 和 FP_CHECH ()，</pre></td></tr><tr><td data-num="8"></td><td><pre> 这些函数可能是外部定义的，用于设备操作和数据处理。</pre></td></tr><tr><td data-num="9"></td><td><pre> * @param inData</pre></td></tr><tr><td data-num="10"></td><td><pre> * @return</pre></td></tr><tr><td data-num="11"></td><td><pre> */</pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token keyword">char</span> <span class="token operator">*</span>__stdcall <span class="token function">verify</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>inData<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token function">AFX_MANAGE_STATE</span><span class="token punctuation">(</span><span class="token function">AfxGetStaticModuleState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 管理 MFC 模块状态</span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre>    Json<span class="token double-colon punctuation">::</span>Value jData<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    Json<span class="token double-colon punctuation">::</span>Reader reader<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    string sinData <span class="token operator">=</span> inData<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    reader<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>sinData<span class="token punctuation">,</span> jData<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> code_data<span class="token punctuation">[</span><span class="token number">60</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 存储设备数据的缓冲区</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token function">memset</span><span class="token punctuation">(</span>code_data<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 将缓冲区清零</span></pre></td></tr><tr><td data-num="22"></td><td><pre></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token keyword">int</span> index<span class="token punctuation">;</span> <span class="token comment">// 用于存储索引值</span></pre></td></tr><tr><td data-num="24"></td><td><pre></pre></td></tr><tr><td data-num="25"></td><td><pre>    string inSN <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> jData<span class="token punctuation">[</span><span class="token string">"s"</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">asString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取设备序列号</span></pre></td></tr><tr><td data-num="26"></td><td><pre></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token comment">// 如果成功找到读取设备信息的线程</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ReadThreadFindHID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>        <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>Data <span class="token operator">=</span> <span class="token function">GET_SN</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 尝试从设备中获取序列号数据</span></pre></td></tr><tr><td data-num="30"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>Data <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>            <span class="token comment">// 如果未成功获取序列号数据，则返回错误信息</span></pre></td></tr><tr><td data-num="32"></td><td><pre>            root<span class="token punctuation">[</span><span class="token string">"code"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"2"</span><span class="token punctuation">;</span> <span class="token comment">// 设置状态码为 2，表示获取序列号失败</span></pre></td></tr><tr><td data-num="33"></td><td><pre>            root<span class="token punctuation">[</span><span class="token string">"content"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"get SN failure"</span><span class="token punctuation">;</span> <span class="token comment">// 设置内容为获取序列号失败</span></pre></td></tr><tr><td data-num="34"></td><td><pre>            root<span class="token punctuation">.</span><span class="token function">toStyledString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>            rtnOut <span class="token operator">=</span> root<span class="token punctuation">.</span><span class="token function">toStyledString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>            <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> rtnOut<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 返回错误信息的字符串指针</span></pre></td></tr><tr><td data-num="37"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>            <span class="token function">memcpy</span><span class="token punctuation">(</span>code_data<span class="token punctuation">,</span> Data<span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 复制设备数据到缓冲区中</span></pre></td></tr><tr><td data-num="39"></td><td><pre>            <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">strncmp</span><span class="token punctuation">(</span>inSN<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> code_data <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 检查序列号是否匹配</span></pre></td></tr><tr><td data-num="40"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>                <span class="token comment">// 如果序列号不匹配，则返回错误信息</span></pre></td></tr><tr><td data-num="42"></td><td><pre>                root<span class="token punctuation">[</span><span class="token string">"code"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"3"</span><span class="token punctuation">;</span> <span class="token comment">// 设置状态码为 3，表示序列号不匹配</span></pre></td></tr><tr><td data-num="43"></td><td><pre>                root<span class="token punctuation">[</span><span class="token string">"content"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"SN not match"</span><span class="token punctuation">;</span> <span class="token comment">// 设置内容为序列号不匹配</span></pre></td></tr><tr><td data-num="44"></td><td><pre>                root<span class="token punctuation">.</span><span class="token function">toStyledString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>                rtnOut <span class="token operator">=</span> root<span class="token punctuation">.</span><span class="token function">toStyledString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>                <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> rtnOut<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 返回错误信息的字符串指针</span></pre></td></tr><tr><td data-num="47"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="49"></td><td><pre></pre></td></tr><tr><td data-num="50"></td><td><pre>        <span class="token comment">// 尝试验证指纹或身份证信息</span></pre></td></tr><tr><td data-num="51"></td><td><pre>        Data <span class="token operator">=</span> <span class="token function">FP_CHECH</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取设备验证结果数据</span></pre></td></tr><tr><td data-num="52"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>Data <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="53"></td><td><pre>            <span class="token comment">// 如果验证失败，则返回错误信息</span></pre></td></tr><tr><td data-num="54"></td><td><pre>            root<span class="token punctuation">[</span><span class="token string">"code"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"0"</span><span class="token punctuation">;</span> <span class="token comment">// 设置状态码为 0，表示验证失败</span></pre></td></tr><tr><td data-num="55"></td><td><pre>            root<span class="token punctuation">[</span><span class="token string">"content"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"verify failure"</span><span class="token punctuation">;</span> <span class="token comment">// 设置内容为验证失败</span></pre></td></tr><tr><td data-num="56"></td><td><pre>            root<span class="token punctuation">.</span><span class="token function">toStyledString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="57"></td><td><pre>            rtnOut <span class="token operator">=</span> root<span class="token punctuation">.</span><span class="token function">toStyledString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="58"></td><td><pre>            <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> rtnOut<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 返回错误信息的字符串指针</span></pre></td></tr><tr><td data-num="59"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="60"></td><td><pre>            <span class="token function">memcpy</span><span class="token punctuation">(</span>code_data<span class="token punctuation">,</span> Data<span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 复制设备数据到缓冲区中</span></pre></td></tr><tr><td data-num="61"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>code_data<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0x50</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>code_data<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0x11</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>code_data<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0x01</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="62"></td><td><pre>                <span class="token comment">// 如果指纹验证成功</span></pre></td></tr><tr><td data-num="63"></td><td><pre>                root<span class="token punctuation">[</span><span class="token string">"code"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"6"</span><span class="token punctuation">;</span> <span class="token comment">// 设置状态码为 6，表示指纹验证成功</span></pre></td></tr><tr><td data-num="64"></td><td><pre></pre></td></tr><tr><td data-num="65"></td><td><pre>                <span class="token comment">// 获取指纹索引和数据</span></pre></td></tr><tr><td data-num="66"></td><td><pre>                <span class="token keyword">char</span> <span class="token operator">*</span>tmpdata <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> code_data <span class="token operator">+</span> <span class="token number">6</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="67"></td><td><pre>                <span class="token keyword">char</span> tmp_code_data<span class="token punctuation">[</span><span class="token number">19</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="68"></td><td><pre>                <span class="token function">memset</span><span class="token punctuation">(</span>tmp_code_data<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">19</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="69"></td><td><pre>                <span class="token function">memcpy</span><span class="token punctuation">(</span>tmp_code_data<span class="token punctuation">,</span> tmpdata<span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="70"></td><td><pre></pre></td></tr><tr><td data-num="71"></td><td><pre>                index <span class="token operator">=</span> code_data<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token number">256</span> <span class="token operator">+</span> code_data<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 计算索引值</span></pre></td></tr><tr><td data-num="72"></td><td><pre>                <span class="token keyword">char</span> idx<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="73"></td><td><pre>                <span class="token function">itoa</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> idx<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 将索引值转换为字符串</span></pre></td></tr><tr><td data-num="74"></td><td><pre></pre></td></tr><tr><td data-num="75"></td><td><pre>                inSN<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"|"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="76"></td><td><pre>                inSN<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 将索引值添加到设备序列号后面</span></pre></td></tr><tr><td data-num="77"></td><td><pre></pre></td></tr><tr><td data-num="78"></td><td><pre>                root<span class="token punctuation">[</span><span class="token string">"content"</span><span class="token punctuation">]</span> <span class="token operator">=</span> inSN<span class="token punctuation">;</span> <span class="token comment">// 设置内容为设备序列号和指纹索引</span></pre></td></tr><tr><td data-num="79"></td><td><pre>                root<span class="token punctuation">.</span><span class="token function">toStyledString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="80"></td><td><pre>                rtnOut <span class="token operator">=</span> root<span class="token punctuation">.</span><span class="token function">toStyledString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="81"></td><td><pre>                <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> rtnOut<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 返回成功信息的字符串指针</span></pre></td></tr><tr><td data-num="82"></td><td><pre>            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>code_data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0x16</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>code_data<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0x02</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>code_data<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0x01</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="83"></td><td><pre>                <span class="token comment">// 如果身份证验证成功</span></pre></td></tr><tr><td data-num="84"></td><td><pre>                root<span class="token punctuation">[</span><span class="token string">"code"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"5"</span><span class="token punctuation">;</span> <span class="token comment">// 设置状态码为 5，表示身份证验证成功</span></pre></td></tr><tr><td data-num="85"></td><td><pre></pre></td></tr><tr><td data-num="86"></td><td><pre>                <span class="token comment">// 获取身份证数据</span></pre></td></tr><tr><td data-num="87"></td><td><pre>                <span class="token keyword">char</span> <span class="token operator">*</span>tmpdata <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> code_data <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="88"></td><td><pre>                <span class="token keyword">char</span> tmp_code_data<span class="token punctuation">[</span><span class="token number">19</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="89"></td><td><pre>                <span class="token function">memset</span><span class="token punctuation">(</span>tmp_code_data<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">19</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="90"></td><td><pre>                <span class="token function">memcpy</span><span class="token punctuation">(</span>tmp_code_data<span class="token punctuation">,</span> tmpdata<span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="91"></td><td><pre></pre></td></tr><tr><td data-num="92"></td><td><pre>                inSN<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"|"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="93"></td><td><pre>                inSN<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>tmp_code_data<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 将身份证数据添加到设备序列号后面</span></pre></td></tr><tr><td data-num="94"></td><td><pre></pre></td></tr><tr><td data-num="95"></td><td><pre>                root<span class="token punctuation">[</span><span class="token string">"content"</span><span class="token punctuation">]</span> <span class="token operator">=</span> inSN<span class="token punctuation">;</span> <span class="token comment">// 设置内容为设备序列号和身份证数据</span></pre></td></tr><tr><td data-num="96"></td><td><pre>                root<span class="token punctuation">.</span><span class="token function">toStyledString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="97"></td><td><pre>                rtnOut <span class="token operator">=</span> root<span class="token punctuation">.</span><span class="token function">toStyledString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="98"></td><td><pre>                <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> rtnOut<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 返回成功信息的字符串指针</span></pre></td></tr><tr><td data-num="99"></td><td><pre>            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="100"></td><td><pre>                <span class="token comment">// 如果验证失败，则返回错误信息</span></pre></td></tr><tr><td data-num="101"></td><td><pre>                root<span class="token punctuation">[</span><span class="token string">"code"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"0"</span><span class="token punctuation">;</span> <span class="token comment">// 设置状态码为 0，表示验证失败</span></pre></td></tr><tr><td data-num="102"></td><td><pre>                root<span class="token punctuation">[</span><span class="token string">"content"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"verify failure!"</span><span class="token punctuation">;</span> <span class="token comment">// 设置内容为验证失败</span></pre></td></tr><tr><td data-num="103"></td><td><pre>                root<span class="token punctuation">.</span><span class="token function">toStyledString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="104"></td><td><pre>                rtnOut <span class="token operator">=</span> root<span class="token punctuation">.</span><span class="token function">toStyledString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="105"></td><td><pre>                <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> rtnOut<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 返回错误信息的字符串指针</span></pre></td></tr><tr><td data-num="106"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="107"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="108"></td><td><pre>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="109"></td><td><pre>        <span class="token comment">// 如果未找到读取设备信息的线程，则返回连接设备失败的错误信息</span></pre></td></tr><tr><td data-num="110"></td><td><pre>        root<span class="token punctuation">[</span><span class="token string">"code"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="111"></td><td><pre>        root<span class="token punctuation">[</span><span class="token string">"content"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"connect device failure"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="112"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="113"></td><td><pre>    root<span class="token punctuation">.</span><span class="token function">toStyledString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="114"></td><td><pre>    rtnOut <span class="token operator">=</span> root<span class="token punctuation">.</span><span class="token function">toStyledString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="115"></td><td><pre>    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> rtnOut<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 返回错误信息的字符串指针</span></pre></td></tr><tr><td data-num="116"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h4 id="initinstance"><a class="anchor" href="#initinstance">#</a> InitInstance</h4><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="2"></td><td><pre> *  MFC 应用程序的初始化函数 InitInstance ()</pre></td></tr><tr><td data-num="3"></td><td><pre> */</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">_DEBUG</span></span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment">/*  这是一个常见的技巧，用于在调试模式下跟踪内存泄漏。</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    在 MFC 应用程序中，DEBUG_NEW 是一个宏，用于替换默认的 new 操作符，</pre></td></tr><tr><td data-num="7"></td><td><pre>    从而跟踪动态分配的内存，并在程序退出时报告未释放的内存。通过定义 new DEBUG_NEW，可以在调试模式下使用这个特性。</pre></td></tr><tr><td data-num="8"></td><td><pre>*/</pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">new</span> <span class="token expression">DEBUG_NEW</span></span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="11"></td><td><pre> * 这是 MFC 的一种用法，用于跟踪文件名。__FILE__ 是一个预定义的宏，它展开为当前源文件的文件名。</pre></td></tr><tr><td data-num="12"></td><td><pre> * 通过定义 THIS_FILE 字符数组，并将其设置为 __FILE__ 的值，可以在调试时轻松地查看代码所在的文件。</pre></td></tr><tr><td data-num="13"></td><td><pre> */</pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">undef</span> <span class="token expression">THIS_FILE</span></span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token keyword">static</span> <span class="token keyword">char</span> THIS_FILE<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token constant">__FILE__</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span></pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token comment">// CDemo1App 应用程序类的初始化函数</span></pre></td></tr><tr><td data-num="19"></td><td><pre>BOOL <span class="token class-name">CDemo1App</span><span class="token double-colon punctuation">::</span><span class="token function">InitInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token comment">// 初始化 MFC 套接字支持</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">AfxSocketInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token comment">// 如果套接字初始化失败，弹出错误消息框</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token function">AfxMessageBox</span><span class="token punctuation">(</span>IDP_SOCKETS_INIT_FAILED<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token keyword">return</span> FALSE<span class="token punctuation">;</span> <span class="token comment">// 返回初始化失败</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="26"></td><td><pre></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token keyword">return</span> TRUE<span class="token punctuation">;</span> <span class="token comment">// 返回初始化成功</span></pre></td></tr><tr><td data-num="28"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h2 id="usb_thread"><a class="anchor" href="#usb_thread">#</a> usb_thread</h2><h3 id="原始代码-3"><a class="anchor" href="#原始代码-3">#</a> 原始代码</h3><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdafx.h></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"usb_thread.h"</span></span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"global.h"</span></span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment">//#include "GSIDClientDlg.h"</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"idcardbin.h"</span></span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre>DWORD								ActualBytesRead<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>DWORD								BytesRead<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>HIDP_CAPS							Capabilities<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>DWORD								cbBytesRead<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>PSP_DEVICE_INTERFACE_DETAIL_DATA	detailData<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>HANDLE								DeviceHandle<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>DWORD								dwError<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token keyword">char</span>								FeatureReport<span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>HANDLE								hEventObject<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>HANDLE								hDevInfo<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>GUID								HidGuid<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>OVERLAPPED							HIDOverlapped<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token keyword">unsigned</span> <span class="token keyword">char</span>						InputReport<span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>ULONG								Length<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>LPOVERLAPPED						lpOverLap<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token keyword">bool</span>								MyDeviceDetected <span class="token operator">=</span> FALSE<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>CString								MyDevicePathName<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>DWORD								NumberOfBytesRead<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token keyword">unsigned</span> <span class="token keyword">char</span>						OutputReport<span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>HANDLE								ReadHandle<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>DWORD								ReportType<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>ULONG								Required<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>CString								ValueToDisplay<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>HANDLE								WriteHandle<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre></pre></td></tr><tr><td data-num="32"></td><td><pre></pre></td></tr><tr><td data-num="33"></td><td><pre>CString my_usb_detail<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre><span class="token keyword">int</span> VendorID<span class="token operator">=</span><span class="token number">0x9573</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre><span class="token keyword">int</span> ProductID<span class="token operator">=</span> <span class="token number">0x4850</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre></pre></td></tr><tr><td data-num="37"></td><td><pre></pre></td></tr><tr><td data-num="38"></td><td><pre><span class="token keyword">static</span> DWORD start_time<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre><span class="token keyword">static</span> DWORD end_time<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="40"></td><td><pre><span class="token keyword">static</span> temp_time<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="41"></td><td><pre></pre></td></tr><tr><td data-num="42"></td><td><pre><span class="token keyword">unsigned</span> <span class="token keyword">char</span> sndbuf<span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">65</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="43"></td><td><pre><span class="token keyword">int</span> bufnumb<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="44"></td><td><pre><span class="token keyword">int</span> seq<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="45"></td><td><pre><span class="token keyword">int</span> circlenumb<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="46"></td><td><pre></pre></td></tr><tr><td data-num="47"></td><td><pre><span class="token keyword">char</span> p390f88<span class="token punctuation">[</span><span class="token number">60</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="48"></td><td><pre><span class="token keyword">char</span> p670b1<span class="token punctuation">[</span><span class="token number">60</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="49"></td><td><pre><span class="token keyword">char</span> p670b2<span class="token punctuation">[</span><span class="token number">60</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="50"></td><td><pre><span class="token keyword">char</span> p390f82<span class="token punctuation">[</span><span class="token number">60</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="51"></td><td><pre><span class="token keyword">char</span> namebuf<span class="token punctuation">[</span><span class="token number">30</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="52"></td><td><pre></pre></td></tr><tr><td data-num="53"></td><td><pre><span class="token keyword">extern</span>	UINT nEndCode<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="54"></td><td><pre></pre></td></tr><tr><td data-num="55"></td><td><pre></pre></td></tr><tr><td data-num="56"></td><td><pre><span class="token keyword">static</span> <span class="token keyword">unsigned</span> <span class="token keyword">short</span> <span class="token function">UpdateCrc</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> ch<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">short</span> <span class="token operator">*</span>lpwCrc<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="57"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="58"></td><td><pre>    ch <span class="token operator">=</span> <span class="token punctuation">(</span>ch<span class="token operator">^</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>lpwCrc<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x00FF</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="59"></td><td><pre>    ch <span class="token operator">=</span> <span class="token punctuation">(</span>ch<span class="token operator">^</span><span class="token punctuation">(</span>ch<span class="token operator">&lt;&lt;</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="60"></td><td><pre>    <span class="token operator">*</span>lpwCrc <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>lpwCrc <span class="token operator">>></span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token operator">^</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">short</span><span class="token punctuation">)</span>ch <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token operator">^</span></pre></td></tr><tr><td data-num="61"></td><td><pre>              <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">short</span><span class="token punctuation">)</span>ch<span class="token operator">&lt;&lt;</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token operator">^</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">short</span><span class="token punctuation">)</span>ch<span class="token operator">>></span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="62"></td><td><pre>    <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token operator">*</span>lpwCrc<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="63"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="64"></td><td><pre><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">ComputeCrc</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>Data<span class="token punctuation">,</span><span class="token keyword">unsigned</span> <span class="token keyword">short</span> Length<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="65"></td><td><pre>                       <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>TransmitFirst<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>TransmitSecond<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="66"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="67"></td><td><pre>    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> chBlock<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="68"></td><td><pre>    <span class="token keyword">unsigned</span> <span class="token keyword">short</span> wCrc <span class="token operator">=</span> <span class="token number">0x6363</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="69"></td><td><pre>    <span class="token keyword">do</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="70"></td><td><pre>        chBlock <span class="token operator">=</span> <span class="token operator">*</span>Data<span class="token operator">++</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="71"></td><td><pre>        <span class="token function">UpdateCrc</span><span class="token punctuation">(</span>chBlock<span class="token punctuation">,</span> <span class="token operator">&amp;</span>wCrc<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="72"></td><td><pre>    <span class="token punctuation">&#125;</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">--</span>Length<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="73"></td><td><pre>    <span class="token operator">*</span>TransmitFirst <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>wCrc <span class="token operator">>></span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="74"></td><td><pre>    <span class="token operator">*</span>TransmitSecond <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>wCrc <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="75"></td><td><pre>    <span class="token keyword">return</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="76"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="77"></td><td><pre><span class="token keyword">void</span> <span class="token function">crc_calc</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>data<span class="token punctuation">,</span><span class="token keyword">unsigned</span> <span class="token keyword">short</span> len<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="78"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="79"></td><td><pre>    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>p <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>data<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="80"></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span>len<span class="token operator">&lt;</span><span class="token number">2</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="81"></td><td><pre>        <span class="token keyword">return</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="82"></td><td><pre>    <span class="token function">ComputeCrc</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span>len<span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>p<span class="token punctuation">[</span>len<span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>p<span class="token punctuation">[</span>len<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="83"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="84"></td><td><pre></pre></td></tr><tr><td data-num="85"></td><td><pre><span class="token keyword">void</span> <span class="token function">GetDeviceCapabilities</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="86"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="87"></td><td><pre>    <span class="token comment">//Get the Capabilities structure for the device.</span></pre></td></tr><tr><td data-num="88"></td><td><pre></pre></td></tr><tr><td data-num="89"></td><td><pre>    PHIDP_PREPARSED_DATA	PreparsedData<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="90"></td><td><pre></pre></td></tr><tr><td data-num="91"></td><td><pre>    <span class="token comment">/*</span></pre></td></tr><tr><td data-num="92"></td><td><pre>    API function: HidD_GetPreparsedData</pre></td></tr><tr><td data-num="93"></td><td><pre>    Returns: a pointer to a buffer containing the information about the device's capabilities.</pre></td></tr><tr><td data-num="94"></td><td><pre>    Requires: A handle returned by CreateFile.</pre></td></tr><tr><td data-num="95"></td><td><pre>    There's no need to access the buffer directly,</pre></td></tr><tr><td data-num="96"></td><td><pre>    but HidP_GetCaps and other API functions require a pointer to the buffer.</pre></td></tr><tr><td data-num="97"></td><td><pre>    */</pre></td></tr><tr><td data-num="98"></td><td><pre></pre></td></tr><tr><td data-num="99"></td><td><pre>    <span class="token function">HidD_GetPreparsedData</span></pre></td></tr><tr><td data-num="100"></td><td><pre>            <span class="token punctuation">(</span>DeviceHandle<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="101"></td><td><pre>             <span class="token operator">&amp;</span>PreparsedData<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="102"></td><td><pre></pre></td></tr><tr><td data-num="103"></td><td><pre>    <span class="token comment">/*</span></pre></td></tr><tr><td data-num="104"></td><td><pre>    API function: HidP_GetCaps</pre></td></tr><tr><td data-num="105"></td><td><pre>    Learn the device's capabilities.</pre></td></tr><tr><td data-num="106"></td><td><pre>    For standard devices such as joysticks, you can find out the specific</pre></td></tr><tr><td data-num="107"></td><td><pre>    capabilities of the device.</pre></td></tr><tr><td data-num="108"></td><td><pre>    For a custom device, the software will probably know what the device is capable of,</pre></td></tr><tr><td data-num="109"></td><td><pre>    and the call only verifies the information.</pre></td></tr><tr><td data-num="110"></td><td><pre>    Requires: the pointer to the buffer returned by HidD_GetPreparsedData.</pre></td></tr><tr><td data-num="111"></td><td><pre>    Returns: a Capabilities structure containing the information.</pre></td></tr><tr><td data-num="112"></td><td><pre>    */</pre></td></tr><tr><td data-num="113"></td><td><pre></pre></td></tr><tr><td data-num="114"></td><td><pre>    <span class="token function">HidP_GetCaps</span></pre></td></tr><tr><td data-num="115"></td><td><pre>            <span class="token punctuation">(</span>PreparsedData<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="116"></td><td><pre>             <span class="token operator">&amp;</span>Capabilities<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="117"></td><td><pre></pre></td></tr><tr><td data-num="118"></td><td><pre>    <span class="token comment">//No need for PreparsedData any more, so free the memory it's using.</span></pre></td></tr><tr><td data-num="119"></td><td><pre>    <span class="token function">HidD_FreePreparsedData</span><span class="token punctuation">(</span>PreparsedData<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="120"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="121"></td><td><pre></pre></td></tr><tr><td data-num="122"></td><td><pre><span class="token keyword">void</span> <span class="token function">PrepareForOverlappedTransfer</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="123"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="124"></td><td><pre>    <span class="token comment">//Get a handle to the device for the overlapped ReadFiles.</span></pre></td></tr><tr><td data-num="125"></td><td><pre>    ReadHandle<span class="token operator">=</span><span class="token function">CreateFile</span></pre></td></tr><tr><td data-num="126"></td><td><pre>            <span class="token punctuation">(</span>detailData<span class="token operator">-></span>DevicePath<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="127"></td><td><pre>             GENERIC_READ<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="128"></td><td><pre>             FILE_SHARE_READ<span class="token operator">|</span>FILE_SHARE_WRITE<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="129"></td><td><pre>             <span class="token punctuation">(</span>LPSECURITY_ATTRIBUTES<span class="token punctuation">)</span><span class="token constant">NULL</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="130"></td><td><pre>             OPEN_EXISTING<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="131"></td><td><pre>             FILE_ATTRIBUTE_NORMAL<span class="token operator">|</span>FILE_FLAG_OVERLAPPED<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="132"></td><td><pre>             <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="133"></td><td><pre></pre></td></tr><tr><td data-num="134"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>hEventObject <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="135"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="136"></td><td><pre>        hEventObject <span class="token operator">=</span> <span class="token function">CreateEvent</span></pre></td></tr><tr><td data-num="137"></td><td><pre>                <span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="138"></td><td><pre>                 TRUE<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="139"></td><td><pre>                 TRUE<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="140"></td><td><pre>                 <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="141"></td><td><pre>        <span class="token comment">//Set the members of the overlapped structure.</span></pre></td></tr><tr><td data-num="142"></td><td><pre></pre></td></tr><tr><td data-num="143"></td><td><pre>        HIDOverlapped<span class="token punctuation">.</span>hEvent <span class="token operator">=</span> hEventObject<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="144"></td><td><pre>        HIDOverlapped<span class="token punctuation">.</span>Offset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="145"></td><td><pre>        HIDOverlapped<span class="token punctuation">.</span>OffsetHigh <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="146"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="147"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="148"></td><td><pre><span class="token keyword">void</span> <span class="token function">CloseHandles</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="149"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="150"></td><td><pre>    <span class="token comment">//Close open handles.</span></pre></td></tr><tr><td data-num="151"></td><td><pre></pre></td></tr><tr><td data-num="152"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>DeviceHandle <span class="token operator">!=</span> INVALID_HANDLE_VALUE<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="153"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="154"></td><td><pre>        <span class="token function">CloseHandle</span><span class="token punctuation">(</span>DeviceHandle<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="155"></td><td><pre>        DeviceHandle <span class="token operator">=</span> INVALID_HANDLE_VALUE<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="156"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="157"></td><td><pre></pre></td></tr><tr><td data-num="158"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>ReadHandle <span class="token operator">!=</span> INVALID_HANDLE_VALUE<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="159"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="160"></td><td><pre>        <span class="token function">CloseHandle</span><span class="token punctuation">(</span>ReadHandle<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="161"></td><td><pre>        ReadHandle <span class="token operator">=</span> INVALID_HANDLE_VALUE<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="162"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="163"></td><td><pre></pre></td></tr><tr><td data-num="164"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>WriteHandle <span class="token operator">!=</span> INVALID_HANDLE_VALUE<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="165"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="166"></td><td><pre>        <span class="token function">CloseHandle</span><span class="token punctuation">(</span>WriteHandle<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="167"></td><td><pre>        WriteHandle <span class="token operator">=</span> INVALID_HANDLE_VALUE<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="168"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="169"></td><td><pre>    <span class="token function">SetupDiDestroyDeviceInfoList</span><span class="token punctuation">(</span>hDevInfo<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="170"></td><td><pre></pre></td></tr><tr><td data-num="171"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="172"></td><td><pre></pre></td></tr><tr><td data-num="173"></td><td><pre><span class="token keyword">int</span> <span class="token function">WriteOutputReport</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="174"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="175"></td><td><pre>    <span class="token comment">//Send a report to the device.</span></pre></td></tr><tr><td data-num="176"></td><td><pre></pre></td></tr><tr><td data-num="177"></td><td><pre>    DWORD	BytesWritten <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="178"></td><td><pre>    INT		Index <span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="179"></td><td><pre>    ULONG	Result<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="180"></td><td><pre><span class="token comment">//	OVERLAPPED overlapped;</span></pre></td></tr><tr><td data-num="181"></td><td><pre></pre></td></tr><tr><td data-num="182"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>WriteHandle <span class="token operator">!=</span> INVALID_HANDLE_VALUE<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="183"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="184"></td><td><pre>        Result <span class="token operator">=</span> <span class="token function">WriteFile</span></pre></td></tr><tr><td data-num="185"></td><td><pre>                <span class="token punctuation">(</span>WriteHandle<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="186"></td><td><pre>                 InputReport<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="187"></td><td><pre>                 Capabilities<span class="token punctuation">.</span>OutputReportByteLength<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="188"></td><td><pre>                 <span class="token operator">&amp;</span>BytesWritten<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="189"></td><td><pre>                 <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="190"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="191"></td><td><pre></pre></td></tr><tr><td data-num="192"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>Result<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="193"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="194"></td><td><pre>        <span class="token comment">//The WriteFile failed, so close the handles, display a message,</span></pre></td></tr><tr><td data-num="195"></td><td><pre>        <span class="token comment">//and set MyDeviceDetected to FALSE so the next attempt will look for the device.</span></pre></td></tr><tr><td data-num="196"></td><td><pre>        BytesWritten <span class="token operator">=</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="197"></td><td><pre>        <span class="token comment">//CloseHandles();</span></pre></td></tr><tr><td data-num="198"></td><td><pre>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="199"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token comment">//writefile success</span></pre></td></tr><tr><td data-num="200"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="201"></td><td><pre>        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="202"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="203"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="204"></td><td><pre></pre></td></tr><tr><td data-num="205"></td><td><pre><span class="token keyword">int</span> <span class="token function">WriteOutputReport</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span> buf<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="206"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="207"></td><td><pre>    <span class="token comment">//Send a report to the device.</span></pre></td></tr><tr><td data-num="208"></td><td><pre></pre></td></tr><tr><td data-num="209"></td><td><pre>    DWORD	BytesWritten <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="210"></td><td><pre>    INT		Index <span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="211"></td><td><pre>    ULONG	Result<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="212"></td><td><pre><span class="token comment">//	OVERLAPPED overlapped;</span></pre></td></tr><tr><td data-num="213"></td><td><pre>    <span class="token function">memcpy</span><span class="token punctuation">(</span>InputReport<span class="token punctuation">,</span>buf<span class="token punctuation">,</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="214"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>WriteHandle <span class="token operator">!=</span> INVALID_HANDLE_VALUE<span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span><span class="token punctuation">(</span>WriteHandle<span class="token operator">!=</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="215"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="216"></td><td><pre>        Result <span class="token operator">=</span> <span class="token function">WriteFile</span></pre></td></tr><tr><td data-num="217"></td><td><pre>                <span class="token punctuation">(</span>WriteHandle<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="218"></td><td><pre>                 InputReport<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="219"></td><td><pre>                 Capabilities<span class="token punctuation">.</span>OutputReportByteLength<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="220"></td><td><pre>                 <span class="token operator">&amp;</span>BytesWritten<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="221"></td><td><pre>                 <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="222"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="223"></td><td><pre>    <span class="token function">WritebinErrLogFile</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>InputReport<span class="token punctuation">,</span><span class="token number">65</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="224"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>Result<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="225"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="226"></td><td><pre>        <span class="token comment">//The WriteFile failed, so close the handles, display a message,</span></pre></td></tr><tr><td data-num="227"></td><td><pre>        <span class="token comment">//and set MyDeviceDetected to FALSE so the next attempt will look for the device.</span></pre></td></tr><tr><td data-num="228"></td><td><pre>        BytesWritten <span class="token operator">=</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="229"></td><td><pre>        <span class="token comment">//CloseHandles();</span></pre></td></tr><tr><td data-num="230"></td><td><pre>        <span class="token function">WriteLogFile</span><span class="token punctuation">(</span><span class="token string">"WriteOutputReport FAIL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="231"></td><td><pre><span class="token comment">//TRACE( "WriteOutputReport fail\n");</span></pre></td></tr><tr><td data-num="232"></td><td><pre>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="233"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token comment">//writefile success</span></pre></td></tr><tr><td data-num="234"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="235"></td><td><pre>        <span class="token function">WriteLogFile</span><span class="token punctuation">(</span><span class="token string">"WriteOutputReport success"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="236"></td><td><pre><span class="token comment">//TRACE( "WriteOutputReport success\n");</span></pre></td></tr><tr><td data-num="237"></td><td><pre>        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="238"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="239"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="240"></td><td><pre><span class="token keyword">int</span> <span class="token function">WriteOutputReport2</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="241"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="242"></td><td><pre>    <span class="token comment">//Send a report to the device.</span></pre></td></tr><tr><td data-num="243"></td><td><pre></pre></td></tr><tr><td data-num="244"></td><td><pre>    DWORD	BytesWritten <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="245"></td><td><pre>    INT		Index <span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="246"></td><td><pre>    ULONG	Result<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="247"></td><td><pre><span class="token comment">//	OVERLAPPED overlapped;</span></pre></td></tr><tr><td data-num="248"></td><td><pre></pre></td></tr><tr><td data-num="249"></td><td><pre></pre></td></tr><tr><td data-num="250"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>WriteHandle <span class="token operator">!=</span> INVALID_HANDLE_VALUE<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="251"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="252"></td><td><pre>        <span class="token function">memset</span><span class="token punctuation">(</span>InputReport<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="253"></td><td><pre>        InputReport<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span> <span class="token number">0x39</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="254"></td><td><pre>        InputReport<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">=</span> <span class="token number">0x03</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="255"></td><td><pre></pre></td></tr><tr><td data-num="256"></td><td><pre>        InputReport<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token operator">=</span> <span class="token number">0x03</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="257"></td><td><pre>        InputReport<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token operator">=</span> <span class="token number">0x05</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="258"></td><td><pre></pre></td></tr><tr><td data-num="259"></td><td><pre>        Result <span class="token operator">=</span> <span class="token function">WriteFile</span></pre></td></tr><tr><td data-num="260"></td><td><pre>                <span class="token punctuation">(</span>WriteHandle<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="261"></td><td><pre>                 InputReport<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="262"></td><td><pre>                 Capabilities<span class="token punctuation">.</span>OutputReportByteLength<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="263"></td><td><pre>                 <span class="token operator">&amp;</span>BytesWritten<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="264"></td><td><pre>                 <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="265"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="266"></td><td><pre></pre></td></tr><tr><td data-num="267"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>Result<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="268"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="269"></td><td><pre>        <span class="token comment">//The WriteFile failed, so close the handles, display a message,</span></pre></td></tr><tr><td data-num="270"></td><td><pre>        <span class="token comment">//and set MyDeviceDetected to FALSE so the next attempt will look for the device.</span></pre></td></tr><tr><td data-num="271"></td><td><pre>        BytesWritten <span class="token operator">=</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="272"></td><td><pre>        <span class="token comment">//CloseHandles();</span></pre></td></tr><tr><td data-num="273"></td><td><pre>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="274"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token comment">//writefile success</span></pre></td></tr><tr><td data-num="275"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="276"></td><td><pre>        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="277"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="278"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="279"></td><td><pre></pre></td></tr><tr><td data-num="280"></td><td><pre></pre></td></tr><tr><td data-num="281"></td><td><pre><span class="token keyword">bool</span> <span class="token function">ReadThreadFindHID</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="282"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="283"></td><td><pre>    <span class="token comment">//Use a series of API calls to find a HID with a specified Vendor IF and Product ID.</span></pre></td></tr><tr><td data-num="284"></td><td><pre></pre></td></tr><tr><td data-num="285"></td><td><pre>    HIDD_ATTRIBUTES						Attributes<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="286"></td><td><pre>    DWORD								DeviceUsage<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="287"></td><td><pre>    SP_DEVICE_INTERFACE_DATA			devInfoData<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="288"></td><td><pre>    <span class="token keyword">bool</span>								LastDevice <span class="token operator">=</span> FALSE<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="289"></td><td><pre>    <span class="token keyword">int</span>									MemberIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="290"></td><td><pre>    LONG								Result<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="291"></td><td><pre>    CString								UsageDescription<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="292"></td><td><pre></pre></td></tr><tr><td data-num="293"></td><td><pre>    Length <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="294"></td><td><pre>    detailData <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="295"></td><td><pre>    DeviceHandle<span class="token operator">=</span><span class="token constant">NULL</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="296"></td><td><pre></pre></td></tr><tr><td data-num="297"></td><td><pre>    <span class="token comment">/*</span></pre></td></tr><tr><td data-num="298"></td><td><pre>    API function: HidD_GetHidGuid</pre></td></tr><tr><td data-num="299"></td><td><pre>    Get the GUID for all system HIDs.</pre></td></tr><tr><td data-num="300"></td><td><pre>    Returns: the GUID in HidGuid.</pre></td></tr><tr><td data-num="301"></td><td><pre>    */</pre></td></tr><tr><td data-num="302"></td><td><pre></pre></td></tr><tr><td data-num="303"></td><td><pre>    <span class="token function">HidD_GetHidGuid</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>HidGuid<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="304"></td><td><pre></pre></td></tr><tr><td data-num="305"></td><td><pre>    <span class="token comment">/*</span></pre></td></tr><tr><td data-num="306"></td><td><pre>    API function: SetupDiGetClassDevs</pre></td></tr><tr><td data-num="307"></td><td><pre>    Returns: a handle to a device information set for all installed devices.</pre></td></tr><tr><td data-num="308"></td><td><pre>    Requires: the GUID returned by GetHidGuid.</pre></td></tr><tr><td data-num="309"></td><td><pre>    */</pre></td></tr><tr><td data-num="310"></td><td><pre></pre></td></tr><tr><td data-num="311"></td><td><pre>    hDevInfo<span class="token operator">=</span><span class="token function">SetupDiGetClassDevs</span></pre></td></tr><tr><td data-num="312"></td><td><pre>            <span class="token punctuation">(</span><span class="token operator">&amp;</span>HidGuid<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="313"></td><td><pre>             <span class="token constant">NULL</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="314"></td><td><pre>             <span class="token constant">NULL</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="315"></td><td><pre>             DIGCF_PRESENT<span class="token operator">|</span>DIGCF_INTERFACEDEVICE<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="316"></td><td><pre></pre></td></tr><tr><td data-num="317"></td><td><pre>    devInfoData<span class="token punctuation">.</span>cbSize <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>devInfoData<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="318"></td><td><pre></pre></td></tr><tr><td data-num="319"></td><td><pre>    <span class="token comment">//Step through the available devices looking for the one we want.</span></pre></td></tr><tr><td data-num="320"></td><td><pre>    <span class="token comment">//Quit on detecting the desired device or checking all available devices without success.</span></pre></td></tr><tr><td data-num="321"></td><td><pre></pre></td></tr><tr><td data-num="322"></td><td><pre>    MemberIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="323"></td><td><pre>    LastDevice <span class="token operator">=</span> FALSE<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="324"></td><td><pre></pre></td></tr><tr><td data-num="325"></td><td><pre>    <span class="token keyword">do</span></pre></td></tr><tr><td data-num="326"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="327"></td><td><pre></pre></td></tr><tr><td data-num="328"></td><td><pre></pre></td></tr><tr><td data-num="329"></td><td><pre>        Result<span class="token operator">=</span><span class="token function">SetupDiEnumDeviceInterfaces</span></pre></td></tr><tr><td data-num="330"></td><td><pre>                <span class="token punctuation">(</span>hDevInfo<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="331"></td><td><pre>                 <span class="token number">0</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="332"></td><td><pre>                 <span class="token operator">&amp;</span>HidGuid<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="333"></td><td><pre>                 MemberIndex<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="334"></td><td><pre>                 <span class="token operator">&amp;</span>devInfoData<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="335"></td><td><pre></pre></td></tr><tr><td data-num="336"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>Result <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="337"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="338"></td><td><pre></pre></td></tr><tr><td data-num="339"></td><td><pre></pre></td></tr><tr><td data-num="340"></td><td><pre>            Result <span class="token operator">=</span> <span class="token function">SetupDiGetDeviceInterfaceDetail</span></pre></td></tr><tr><td data-num="341"></td><td><pre>                    <span class="token punctuation">(</span>hDevInfo<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="342"></td><td><pre>                     <span class="token operator">&amp;</span>devInfoData<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="343"></td><td><pre>                     <span class="token constant">NULL</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="344"></td><td><pre>                     <span class="token number">0</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="345"></td><td><pre>                     <span class="token operator">&amp;</span>Length<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="346"></td><td><pre>                     <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="347"></td><td><pre></pre></td></tr><tr><td data-num="348"></td><td><pre>            <span class="token comment">//Allocate memory for the hDevInfo structure, using the returned Length.</span></pre></td></tr><tr><td data-num="349"></td><td><pre></pre></td></tr><tr><td data-num="350"></td><td><pre>            detailData <span class="token operator">=</span> <span class="token punctuation">(</span>PSP_DEVICE_INTERFACE_DETAIL_DATA<span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span>Length<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="351"></td><td><pre></pre></td></tr><tr><td data-num="352"></td><td><pre>            <span class="token comment">//Set cbSize in the detailData structure.</span></pre></td></tr><tr><td data-num="353"></td><td><pre></pre></td></tr><tr><td data-num="354"></td><td><pre>            detailData <span class="token operator">-></span> cbSize <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>SP_DEVICE_INTERFACE_DETAIL_DATA<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="355"></td><td><pre></pre></td></tr><tr><td data-num="356"></td><td><pre>            <span class="token comment">//Call the function again, this time passing it the returned buffer size.</span></pre></td></tr><tr><td data-num="357"></td><td><pre></pre></td></tr><tr><td data-num="358"></td><td><pre>            Result <span class="token operator">=</span> <span class="token function">SetupDiGetDeviceInterfaceDetail</span></pre></td></tr><tr><td data-num="359"></td><td><pre>                    <span class="token punctuation">(</span>hDevInfo<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="360"></td><td><pre>                     <span class="token operator">&amp;</span>devInfoData<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="361"></td><td><pre>                     detailData<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="362"></td><td><pre>                     Length<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="363"></td><td><pre>                     <span class="token operator">&amp;</span>Required<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="364"></td><td><pre>                     <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="365"></td><td><pre></pre></td></tr><tr><td data-num="366"></td><td><pre></pre></td></tr><tr><td data-num="367"></td><td><pre></pre></td></tr><tr><td data-num="368"></td><td><pre>            DeviceHandle<span class="token operator">=</span><span class="token function">CreateFile</span></pre></td></tr><tr><td data-num="369"></td><td><pre>                    <span class="token punctuation">(</span>detailData<span class="token operator">-></span>DevicePath<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="370"></td><td><pre>                     <span class="token number">0</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="371"></td><td><pre>                     FILE_SHARE_READ<span class="token operator">|</span>FILE_SHARE_WRITE<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="372"></td><td><pre>                     <span class="token punctuation">(</span>LPSECURITY_ATTRIBUTES<span class="token punctuation">)</span><span class="token constant">NULL</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="373"></td><td><pre>                     OPEN_EXISTING<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="374"></td><td><pre>                     <span class="token number">0</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="375"></td><td><pre>                     <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="376"></td><td><pre></pre></td></tr><tr><td data-num="377"></td><td><pre>            <span class="token comment">//Set the Size to the number of bytes in the structure.</span></pre></td></tr><tr><td data-num="378"></td><td><pre></pre></td></tr><tr><td data-num="379"></td><td><pre>            Attributes<span class="token punctuation">.</span>Size <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>Attributes<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="380"></td><td><pre></pre></td></tr><tr><td data-num="381"></td><td><pre>            Result <span class="token operator">=</span> <span class="token function">HidD_GetAttributes</span></pre></td></tr><tr><td data-num="382"></td><td><pre>                    <span class="token punctuation">(</span>DeviceHandle<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="383"></td><td><pre>                     <span class="token operator">&amp;</span>Attributes<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="384"></td><td><pre></pre></td></tr><tr><td data-num="385"></td><td><pre>            <span class="token comment">//Is it the desired device?</span></pre></td></tr><tr><td data-num="386"></td><td><pre></pre></td></tr><tr><td data-num="387"></td><td><pre>            MyDeviceDetected <span class="token operator">=</span> FALSE<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="388"></td><td><pre></pre></td></tr><tr><td data-num="389"></td><td><pre></pre></td></tr><tr><td data-num="390"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span>Attributes<span class="token punctuation">.</span>VendorID <span class="token operator">==</span> VendorID<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="391"></td><td><pre>            <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="392"></td><td><pre>                <span class="token keyword">if</span> <span class="token punctuation">(</span>Attributes<span class="token punctuation">.</span>ProductID <span class="token operator">==</span> ProductID<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="393"></td><td><pre>                <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="394"></td><td><pre>                    <span class="token comment">//Both the Vendor ID and Product ID match.</span></pre></td></tr><tr><td data-num="395"></td><td><pre></pre></td></tr><tr><td data-num="396"></td><td><pre>                    MyDeviceDetected <span class="token operator">=</span> TRUE<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="397"></td><td><pre>                    MyDevicePathName <span class="token operator">=</span> detailData<span class="token operator">-></span>DevicePath<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="398"></td><td><pre></pre></td></tr><tr><td data-num="399"></td><td><pre>                    <span class="token comment">//Register to receive device notifications.</span></pre></td></tr><tr><td data-num="400"></td><td><pre></pre></td></tr><tr><td data-num="401"></td><td><pre>                    <span class="token comment">//RegisterForDeviceNotifications();</span></pre></td></tr><tr><td data-num="402"></td><td><pre></pre></td></tr><tr><td data-num="403"></td><td><pre>                    <span class="token comment">//Get the device's capablities.</span></pre></td></tr><tr><td data-num="404"></td><td><pre></pre></td></tr><tr><td data-num="405"></td><td><pre>                    <span class="token function">GetDeviceCapabilities</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="406"></td><td><pre></pre></td></tr><tr><td data-num="407"></td><td><pre>                    <span class="token comment">// Find out if the device is a system mouse or keyboard.</span></pre></td></tr><tr><td data-num="408"></td><td><pre></pre></td></tr><tr><td data-num="409"></td><td><pre>                    DeviceUsage <span class="token operator">=</span> <span class="token punctuation">(</span>Capabilities<span class="token punctuation">.</span>UsagePage <span class="token operator">*</span> <span class="token number">256</span><span class="token punctuation">)</span> <span class="token operator">+</span> Capabilities<span class="token punctuation">.</span>Usage<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="410"></td><td><pre></pre></td></tr><tr><td data-num="411"></td><td><pre>                    <span class="token keyword">if</span> <span class="token punctuation">(</span>DeviceUsage <span class="token operator">==</span> <span class="token number">0x102</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="412"></td><td><pre>                    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="413"></td><td><pre>                        UsageDescription <span class="token operator">=</span> <span class="token string">"mouse"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="414"></td><td><pre>                    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="415"></td><td><pre></pre></td></tr><tr><td data-num="416"></td><td><pre>                    <span class="token keyword">if</span> <span class="token punctuation">(</span>DeviceUsage <span class="token operator">==</span> <span class="token number">0x106</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="417"></td><td><pre>                    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="418"></td><td><pre>                        UsageDescription <span class="token operator">=</span> <span class="token string">"keyboard"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="419"></td><td><pre>                    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="420"></td><td><pre></pre></td></tr><tr><td data-num="421"></td><td><pre>                    ReadHandle<span class="token operator">=</span><span class="token function">CreateFile</span></pre></td></tr><tr><td data-num="422"></td><td><pre>                            <span class="token punctuation">(</span>detailData<span class="token operator">-></span>DevicePath<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="423"></td><td><pre>                             GENERIC_READ<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="424"></td><td><pre>                             FILE_SHARE_READ<span class="token operator">|</span>FILE_SHARE_WRITE<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="425"></td><td><pre>                             <span class="token punctuation">(</span>LPSECURITY_ATTRIBUTES<span class="token punctuation">)</span><span class="token constant">NULL</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="426"></td><td><pre>                             OPEN_EXISTING<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="427"></td><td><pre>                             FILE_ATTRIBUTE_NORMAL<span class="token operator">|</span>FILE_FLAG_OVERLAPPED<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="428"></td><td><pre>                             <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="429"></td><td><pre></pre></td></tr><tr><td data-num="430"></td><td><pre>                    <span class="token keyword">if</span> <span class="token punctuation">(</span>hEventObject <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="431"></td><td><pre>                    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="432"></td><td><pre>                        hEventObject <span class="token operator">=</span> <span class="token function">CreateEvent</span></pre></td></tr><tr><td data-num="433"></td><td><pre>                                <span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="434"></td><td><pre>                                 TRUE<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="435"></td><td><pre>                                 TRUE<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="436"></td><td><pre>                                 <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="437"></td><td><pre>                        <span class="token comment">//Set the members of the overlapped structure.</span></pre></td></tr><tr><td data-num="438"></td><td><pre></pre></td></tr><tr><td data-num="439"></td><td><pre>                        HIDOverlapped<span class="token punctuation">.</span>hEvent <span class="token operator">=</span> hEventObject<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="440"></td><td><pre>                        HIDOverlapped<span class="token punctuation">.</span>Offset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="441"></td><td><pre>                        HIDOverlapped<span class="token punctuation">.</span>OffsetHigh <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="442"></td><td><pre>                    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="443"></td><td><pre>                    <span class="token comment">// Get a handle for writing Output reports.</span></pre></td></tr><tr><td data-num="444"></td><td><pre></pre></td></tr><tr><td data-num="445"></td><td><pre>                    WriteHandle<span class="token operator">=</span><span class="token function">CreateFile</span></pre></td></tr><tr><td data-num="446"></td><td><pre>                            <span class="token punctuation">(</span>detailData<span class="token operator">-></span>DevicePath<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="447"></td><td><pre>                             GENERIC_WRITE<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="448"></td><td><pre>                             FILE_SHARE_READ<span class="token operator">|</span>FILE_SHARE_WRITE<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="449"></td><td><pre>                             <span class="token punctuation">(</span>LPSECURITY_ATTRIBUTES<span class="token punctuation">)</span><span class="token constant">NULL</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="450"></td><td><pre>                             OPEN_EXISTING<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="451"></td><td><pre>                             FILE_ATTRIBUTE_NORMAL<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="452"></td><td><pre>                             <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="453"></td><td><pre>                    <span class="token comment">// Prepare to read reports using Overlapped I/O.</span></pre></td></tr><tr><td data-num="454"></td><td><pre></pre></td></tr><tr><td data-num="455"></td><td><pre>                    <span class="token comment">//PrepareForOverlappedTransfer();</span></pre></td></tr><tr><td data-num="456"></td><td><pre></pre></td></tr><tr><td data-num="457"></td><td><pre>                <span class="token punctuation">&#125;</span> <span class="token comment">//if (Attributes.ProductID == ProductID)</span></pre></td></tr><tr><td data-num="458"></td><td><pre>                <span class="token keyword">else</span></pre></td></tr><tr><td data-num="459"></td><td><pre>                    <span class="token comment">//The Product ID doesn't match.</span></pre></td></tr><tr><td data-num="460"></td><td><pre></pre></td></tr><tr><td data-num="461"></td><td><pre>                    <span class="token function">CloseHandle</span><span class="token punctuation">(</span>DeviceHandle<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="462"></td><td><pre>            <span class="token punctuation">&#125;</span> <span class="token comment">//if (Attributes.VendorID == VendorID)</span></pre></td></tr><tr><td data-num="463"></td><td><pre></pre></td></tr><tr><td data-num="464"></td><td><pre>            <span class="token keyword">else</span></pre></td></tr><tr><td data-num="465"></td><td><pre>                <span class="token comment">//The Vendor ID doesn't match.</span></pre></td></tr><tr><td data-num="466"></td><td><pre>                <span class="token function">CloseHandle</span><span class="token punctuation">(</span>DeviceHandle<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="467"></td><td><pre></pre></td></tr><tr><td data-num="468"></td><td><pre>            <span class="token comment">//Free the memory used by the detailData structure (no longer needed).</span></pre></td></tr><tr><td data-num="469"></td><td><pre></pre></td></tr><tr><td data-num="470"></td><td><pre>            <span class="token function">free</span><span class="token punctuation">(</span>detailData<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="471"></td><td><pre></pre></td></tr><tr><td data-num="472"></td><td><pre>        <span class="token punctuation">&#125;</span>  <span class="token comment">//if (Result != 0)</span></pre></td></tr><tr><td data-num="473"></td><td><pre></pre></td></tr><tr><td data-num="474"></td><td><pre>        <span class="token keyword">else</span></pre></td></tr><tr><td data-num="475"></td><td><pre>            <span class="token comment">//SetupDiEnumDeviceInterfaces returned 0, so there are no more devices to check.</span></pre></td></tr><tr><td data-num="476"></td><td><pre></pre></td></tr><tr><td data-num="477"></td><td><pre>            LastDevice<span class="token operator">=</span>TRUE<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="478"></td><td><pre></pre></td></tr><tr><td data-num="479"></td><td><pre>        <span class="token comment">//If we haven't found the device yet, and haven't tried every available device,</span></pre></td></tr><tr><td data-num="480"></td><td><pre>        <span class="token comment">//try the next one.</span></pre></td></tr><tr><td data-num="481"></td><td><pre></pre></td></tr><tr><td data-num="482"></td><td><pre>        MemberIndex <span class="token operator">=</span> MemberIndex <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="483"></td><td><pre></pre></td></tr><tr><td data-num="484"></td><td><pre>    <span class="token punctuation">&#125;</span> <span class="token comment">//do</span></pre></td></tr><tr><td data-num="485"></td><td><pre></pre></td></tr><tr><td data-num="486"></td><td><pre>    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>LastDevice <span class="token operator">==</span> FALSE<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>MyDeviceDetected <span class="token operator">==</span> FALSE<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="487"></td><td><pre></pre></td></tr><tr><td data-num="488"></td><td><pre></pre></td></tr><tr><td data-num="489"></td><td><pre>    <span class="token comment">//Free the memory reserved for hDevInfo by SetupDiClassDevs.</span></pre></td></tr><tr><td data-num="490"></td><td><pre></pre></td></tr><tr><td data-num="491"></td><td><pre>    <span class="token function">SetupDiDestroyDeviceInfoList</span><span class="token punctuation">(</span>hDevInfo<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="492"></td><td><pre></pre></td></tr><tr><td data-num="493"></td><td><pre>    <span class="token keyword">return</span> MyDeviceDetected<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="494"></td><td><pre></pre></td></tr><tr><td data-num="495"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="496"></td><td><pre></pre></td></tr><tr><td data-num="497"></td><td><pre><span class="token keyword">void</span> <span class="token function">TeaEncrypt</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token operator">*</span>v<span class="token punctuation">,</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> n<span class="token punctuation">,</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token operator">*</span>k<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="498"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="499"></td><td><pre>    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> z<span class="token punctuation">,</span> y<span class="token punctuation">,</span> sum<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> e<span class="token punctuation">,</span> DELTA<span class="token operator">=</span><span class="token number">0x9e3779b9</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="500"></td><td><pre>    <span class="token keyword">long</span> p<span class="token punctuation">,</span>q<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="501"></td><td><pre></pre></td></tr><tr><td data-num="502"></td><td><pre>    z<span class="token operator">=</span>v<span class="token punctuation">[</span>n<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="503"></td><td><pre>    y<span class="token operator">=</span>v<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="504"></td><td><pre>    q <span class="token operator">=</span> <span class="token number">6</span> <span class="token operator">+</span> <span class="token number">52</span><span class="token operator">/</span>n<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="505"></td><td><pre>    <span class="token keyword">while</span><span class="token punctuation">(</span>q<span class="token operator">--</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="506"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="507"></td><td><pre>        sum <span class="token operator">+=</span> DELTA<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="508"></td><td><pre>        e <span class="token operator">=</span> <span class="token punctuation">(</span>sum <span class="token operator">>></span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token number">3</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="509"></td><td><pre>        <span class="token keyword">for</span><span class="token punctuation">(</span>p<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>p<span class="token operator">&lt;</span> n<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> p<span class="token operator">++</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="510"></td><td><pre>            y <span class="token operator">=</span> v<span class="token punctuation">[</span>p<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> z <span class="token operator">=</span> v<span class="token punctuation">[</span>p<span class="token punctuation">]</span> <span class="token operator">+=</span> MX<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="511"></td><td><pre>        y <span class="token operator">=</span> v<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="512"></td><td><pre>        z <span class="token operator">=</span> v<span class="token punctuation">[</span>n<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+=</span> MX<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="513"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="514"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="515"></td><td><pre></pre></td></tr><tr><td data-num="516"></td><td><pre></pre></td></tr><tr><td data-num="517"></td><td><pre><span class="token keyword">void</span> <span class="token function">TeaDecrypt</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token operator">*</span>v<span class="token punctuation">,</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> n<span class="token punctuation">,</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token operator">*</span>k<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="518"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="519"></td><td><pre>    <span class="token comment">//n>1</span></pre></td></tr><tr><td data-num="520"></td><td><pre>    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> z<span class="token punctuation">,</span> y<span class="token punctuation">,</span> sum<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> e<span class="token punctuation">,</span> DELTA<span class="token operator">=</span><span class="token number">0x9e3779b9</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="521"></td><td><pre>    <span class="token keyword">long</span> p<span class="token punctuation">,</span>q<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="522"></td><td><pre></pre></td></tr><tr><td data-num="523"></td><td><pre>    y<span class="token operator">=</span>v<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="524"></td><td><pre>    q <span class="token operator">=</span> <span class="token number">6</span> <span class="token operator">+</span> <span class="token number">52</span><span class="token operator">/</span>n<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="525"></td><td><pre>    sum <span class="token operator">=</span> q<span class="token operator">*</span>DELTA<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="526"></td><td><pre>    <span class="token keyword">while</span><span class="token punctuation">(</span>sum <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="527"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="528"></td><td><pre>        e <span class="token operator">=</span> <span class="token punctuation">(</span>sum <span class="token operator">>></span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token number">3</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="529"></td><td><pre>        <span class="token keyword">for</span><span class="token punctuation">(</span>p<span class="token operator">=</span>n<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>p<span class="token operator">></span><span class="token number">0</span><span class="token punctuation">;</span> p<span class="token operator">--</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="530"></td><td><pre>            z <span class="token operator">=</span> v<span class="token punctuation">[</span>p<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>y <span class="token operator">=</span> v<span class="token punctuation">[</span>p<span class="token punctuation">]</span> <span class="token operator">-=</span> MX<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="531"></td><td><pre>        z <span class="token operator">=</span> v<span class="token punctuation">[</span>n<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="532"></td><td><pre>        y <span class="token operator">=</span> v<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">-=</span> MX<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="533"></td><td><pre>        sum <span class="token operator">-=</span> DELTA<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="534"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="535"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="536"></td><td><pre></pre></td></tr><tr><td data-num="537"></td><td><pre></pre></td></tr><tr><td data-num="538"></td><td><pre><span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span> <span class="token function">FP_CHECH</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="539"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="540"></td><td><pre>    DWORD	Result<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="541"></td><td><pre></pre></td></tr><tr><td data-num="542"></td><td><pre>    <span class="token comment">//device</span></pre></td></tr><tr><td data-num="543"></td><td><pre>    <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">65</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="544"></td><td><pre>    <span class="token function">memset</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">65</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="545"></td><td><pre>    buf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x00</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="546"></td><td><pre>    buf<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x55</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="547"></td><td><pre>    buf<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x7A</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="548"></td><td><pre>    <span class="token comment">//buf[4]=0x10;</span></pre></td></tr><tr><td data-num="549"></td><td><pre>    buf<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x04</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="550"></td><td><pre>    buf<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x50</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="551"></td><td><pre>    buf<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x11</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="552"></td><td><pre>    <span class="token function">crc_calc</span><span class="token punctuation">(</span>buf<span class="token operator">+</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="553"></td><td><pre></pre></td></tr><tr><td data-num="554"></td><td><pre>    <span class="token function">WriteOutputReport</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="555"></td><td><pre></pre></td></tr><tr><td data-num="556"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>ReadHandle <span class="token operator">!=</span> INVALID_HANDLE_VALUE<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="557"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="558"></td><td><pre>        Result <span class="token operator">=</span> <span class="token function">ReadFile</span></pre></td></tr><tr><td data-num="559"></td><td><pre>                <span class="token punctuation">(</span>ReadHandle<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="560"></td><td><pre>                 InputReport<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="561"></td><td><pre>                 Capabilities<span class="token punctuation">.</span>InputReportByteLength<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="562"></td><td><pre>                 <span class="token operator">&amp;</span>NumberOfBytesRead<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="563"></td><td><pre>                 <span class="token punctuation">(</span>LPOVERLAPPED<span class="token punctuation">)</span> <span class="token operator">&amp;</span>HIDOverlapped<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="564"></td><td><pre><span class="token comment">//			if (Result) break;</span></pre></td></tr><tr><td data-num="565"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token keyword">else</span></pre></td></tr><tr><td data-num="566"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="567"></td><td><pre>        <span class="token comment">//STATE_USB_BROKEN;</span></pre></td></tr><tr><td data-num="568"></td><td><pre>        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="569"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="570"></td><td><pre><span class="token comment">//		Sleep(5);</span></pre></td></tr><tr><td data-num="571"></td><td><pre><span class="token comment">//		&#125;</span></pre></td></tr><tr><td data-num="572"></td><td><pre>    Result <span class="token operator">=</span> <span class="token function">WaitForSingleObject</span> <span class="token punctuation">(</span>hEventObject<span class="token punctuation">,</span>	<span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="573"></td><td><pre></pre></td></tr><tr><td data-num="574"></td><td><pre>    <span class="token keyword">switch</span> <span class="token punctuation">(</span>Result<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="575"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="576"></td><td><pre>        <span class="token keyword">case</span> WAIT_OBJECT_0<span class="token operator">:</span> <span class="token comment">//ok, received inputreport</span></pre></td></tr><tr><td data-num="577"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="578"></td><td><pre>            <span class="token function">ResetEvent</span><span class="token punctuation">(</span>hEventObject<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="579"></td><td><pre>            <span class="token function">CloseHandles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="580"></td><td><pre>            <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>InputReport<span class="token operator">+</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="581"></td><td><pre>            <span class="token comment">//WriteOutputReport();</span></pre></td></tr><tr><td data-num="582"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="583"></td><td><pre>            <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="584"></td><td><pre>        <span class="token keyword">case</span> WAIT_TIMEOUT<span class="token operator">:</span></pre></td></tr><tr><td data-num="585"></td><td><pre>            <span class="token function">ResetEvent</span><span class="token punctuation">(</span>hEventObject<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="586"></td><td><pre><span class="token comment">//			Sleep(5);</span></pre></td></tr><tr><td data-num="587"></td><td><pre><span class="token comment">//			TRACE("noting readed");</span></pre></td></tr><tr><td data-num="588"></td><td><pre>            <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="589"></td><td><pre>        <span class="token keyword">default</span><span class="token operator">:</span>  <span class="token comment">//Undefined error</span></pre></td></tr><tr><td data-num="590"></td><td><pre>            <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="591"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="592"></td><td><pre></pre></td></tr><tr><td data-num="593"></td><td><pre><span class="token comment">//	CloseHandles();</span></pre></td></tr><tr><td data-num="594"></td><td><pre>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="595"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="596"></td><td><pre></pre></td></tr><tr><td data-num="597"></td><td><pre></pre></td></tr><tr><td data-num="598"></td><td><pre><span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span> <span class="token function">FP_REG</span><span class="token punctuation">(</span><span class="token keyword">int</span> index <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="599"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="600"></td><td><pre>    DWORD	Result<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="601"></td><td><pre>    <span class="token keyword">char</span> off1<span class="token operator">=</span>index<span class="token operator">/</span><span class="token number">256</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="602"></td><td><pre>    <span class="token keyword">char</span> off2<span class="token operator">=</span>index<span class="token operator">%</span><span class="token number">256</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="603"></td><td><pre>    <span class="token comment">//device</span></pre></td></tr><tr><td data-num="604"></td><td><pre>    <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">65</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="605"></td><td><pre>    <span class="token function">memset</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">65</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="606"></td><td><pre>    buf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x00</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="607"></td><td><pre>    buf<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x55</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="608"></td><td><pre>    buf<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x7A</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="609"></td><td><pre>    <span class="token comment">//buf[4]=0x10;</span></pre></td></tr><tr><td data-num="610"></td><td><pre>    buf<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x06</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="611"></td><td><pre>    buf<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x50</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="612"></td><td><pre>    buf<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x12</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="613"></td><td><pre>    buf<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token operator">=</span>off1<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="614"></td><td><pre>    buf<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token operator">=</span>off2<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="615"></td><td><pre>    <span class="token function">crc_calc</span><span class="token punctuation">(</span>buf<span class="token operator">+</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//len2，crc2</span></pre></td></tr><tr><td data-num="616"></td><td><pre><span class="token comment">//	memcpy</span></pre></td></tr><tr><td data-num="617"></td><td><pre><span class="token comment">//	memcpy(buf+9,data,60);</span></pre></td></tr><tr><td data-num="618"></td><td><pre>    <span class="token function">WriteOutputReport</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="619"></td><td><pre></pre></td></tr><tr><td data-num="620"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>ReadHandle <span class="token operator">!=</span> INVALID_HANDLE_VALUE<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="621"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="622"></td><td><pre>        Result <span class="token operator">=</span> <span class="token function">ReadFile</span></pre></td></tr><tr><td data-num="623"></td><td><pre>                <span class="token punctuation">(</span>ReadHandle<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="624"></td><td><pre>                 InputReport<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="625"></td><td><pre>                 Capabilities<span class="token punctuation">.</span>InputReportByteLength<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="626"></td><td><pre>                 <span class="token operator">&amp;</span>NumberOfBytesRead<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="627"></td><td><pre>                 <span class="token punctuation">(</span>LPOVERLAPPED<span class="token punctuation">)</span> <span class="token operator">&amp;</span>HIDOverlapped<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="628"></td><td><pre><span class="token comment">//			if (Result) break;</span></pre></td></tr><tr><td data-num="629"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token keyword">else</span></pre></td></tr><tr><td data-num="630"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="631"></td><td><pre>        <span class="token comment">//STATE_USB_BROKEN;</span></pre></td></tr><tr><td data-num="632"></td><td><pre>        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="633"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="634"></td><td><pre><span class="token comment">//		Sleep(5);</span></pre></td></tr><tr><td data-num="635"></td><td><pre><span class="token comment">//		&#125;</span></pre></td></tr><tr><td data-num="636"></td><td><pre>    Result <span class="token operator">=</span> <span class="token function">WaitForSingleObject</span> <span class="token punctuation">(</span>hEventObject<span class="token punctuation">,</span>	<span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="637"></td><td><pre></pre></td></tr><tr><td data-num="638"></td><td><pre>    <span class="token keyword">switch</span> <span class="token punctuation">(</span>Result<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="639"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="640"></td><td><pre>        <span class="token keyword">case</span> WAIT_OBJECT_0<span class="token operator">:</span> <span class="token comment">//ok, received inputreport</span></pre></td></tr><tr><td data-num="641"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="642"></td><td><pre>            <span class="token function">ResetEvent</span><span class="token punctuation">(</span>hEventObject<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="643"></td><td><pre>            <span class="token function">CloseHandles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="644"></td><td><pre>            <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>InputReport<span class="token operator">+</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="645"></td><td><pre>            <span class="token comment">//WriteOutputReport();</span></pre></td></tr><tr><td data-num="646"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="647"></td><td><pre>            <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="648"></td><td><pre>        <span class="token keyword">case</span> WAIT_TIMEOUT<span class="token operator">:</span></pre></td></tr><tr><td data-num="649"></td><td><pre>            <span class="token function">ResetEvent</span><span class="token punctuation">(</span>hEventObject<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="650"></td><td><pre><span class="token comment">//			Sleep(5);</span></pre></td></tr><tr><td data-num="651"></td><td><pre><span class="token comment">//			TRACE("noting readed");</span></pre></td></tr><tr><td data-num="652"></td><td><pre>            <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="653"></td><td><pre>        <span class="token keyword">default</span><span class="token operator">:</span>  <span class="token comment">//Undefined error</span></pre></td></tr><tr><td data-num="654"></td><td><pre>            <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="655"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="656"></td><td><pre></pre></td></tr><tr><td data-num="657"></td><td><pre><span class="token comment">//	CloseHandles();</span></pre></td></tr><tr><td data-num="658"></td><td><pre>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="659"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="660"></td><td><pre></pre></td></tr><tr><td data-num="661"></td><td><pre><span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span> <span class="token function">FP_DEL</span><span class="token punctuation">(</span><span class="token keyword">int</span> index1<span class="token punctuation">,</span><span class="token keyword">int</span> index2<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="662"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="663"></td><td><pre>    DWORD	Result<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="664"></td><td><pre></pre></td></tr><tr><td data-num="665"></td><td><pre>    <span class="token comment">//device</span></pre></td></tr><tr><td data-num="666"></td><td><pre>    <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">65</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="667"></td><td><pre>    <span class="token function">memset</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">65</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="668"></td><td><pre>    buf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x00</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="669"></td><td><pre>    buf<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x55</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="670"></td><td><pre>    buf<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x7A</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="671"></td><td><pre>    <span class="token comment">//buf[4]=0x10;</span></pre></td></tr><tr><td data-num="672"></td><td><pre>    buf<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x08</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="673"></td><td><pre>    buf<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x50</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="674"></td><td><pre>    buf<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x13</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="675"></td><td><pre>    buf<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token operator">=</span>index1<span class="token operator">/</span><span class="token number">256</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="676"></td><td><pre>    buf<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token operator">=</span>index1<span class="token operator">%</span><span class="token number">256</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="677"></td><td><pre>    buf<span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span><span class="token operator">=</span>index2<span class="token operator">/</span><span class="token number">256</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="678"></td><td><pre>    buf<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token operator">=</span>index2<span class="token operator">%</span><span class="token number">256</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="679"></td><td><pre>    <span class="token function">crc_calc</span><span class="token punctuation">(</span>buf<span class="token operator">+</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//len2，crc2</span></pre></td></tr><tr><td data-num="680"></td><td><pre></pre></td></tr><tr><td data-num="681"></td><td><pre><span class="token comment">//	memcpy</span></pre></td></tr><tr><td data-num="682"></td><td><pre><span class="token comment">//	memcpy(buf+9,data,60);</span></pre></td></tr><tr><td data-num="683"></td><td><pre>    <span class="token function">WriteOutputReport</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="684"></td><td><pre></pre></td></tr><tr><td data-num="685"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>ReadHandle <span class="token operator">!=</span> INVALID_HANDLE_VALUE<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="686"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="687"></td><td><pre>        Result <span class="token operator">=</span> <span class="token function">ReadFile</span></pre></td></tr><tr><td data-num="688"></td><td><pre>                <span class="token punctuation">(</span>ReadHandle<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="689"></td><td><pre>                 InputReport<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="690"></td><td><pre>                 Capabilities<span class="token punctuation">.</span>InputReportByteLength<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="691"></td><td><pre>                 <span class="token operator">&amp;</span>NumberOfBytesRead<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="692"></td><td><pre>                 <span class="token punctuation">(</span>LPOVERLAPPED<span class="token punctuation">)</span> <span class="token operator">&amp;</span>HIDOverlapped<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="693"></td><td><pre><span class="token comment">//			if (Result) break;</span></pre></td></tr><tr><td data-num="694"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token keyword">else</span></pre></td></tr><tr><td data-num="695"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="696"></td><td><pre>        <span class="token comment">//STATE_USB_BROKEN;</span></pre></td></tr><tr><td data-num="697"></td><td><pre>        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="698"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="699"></td><td><pre><span class="token comment">//		Sleep(5);</span></pre></td></tr><tr><td data-num="700"></td><td><pre><span class="token comment">//		&#125;</span></pre></td></tr><tr><td data-num="701"></td><td><pre>    Result <span class="token operator">=</span> <span class="token function">WaitForSingleObject</span> <span class="token punctuation">(</span>hEventObject<span class="token punctuation">,</span>	<span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="702"></td><td><pre></pre></td></tr><tr><td data-num="703"></td><td><pre>    <span class="token keyword">switch</span> <span class="token punctuation">(</span>Result<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="704"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="705"></td><td><pre>        <span class="token keyword">case</span> WAIT_OBJECT_0<span class="token operator">:</span> <span class="token comment">//ok, received inputreport</span></pre></td></tr><tr><td data-num="706"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="707"></td><td><pre>            <span class="token function">ResetEvent</span><span class="token punctuation">(</span>hEventObject<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="708"></td><td><pre>            <span class="token comment">//CloseHandles();</span></pre></td></tr><tr><td data-num="709"></td><td><pre>            <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>InputReport<span class="token operator">+</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="710"></td><td><pre>            <span class="token comment">//WriteOutputReport();</span></pre></td></tr><tr><td data-num="711"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="712"></td><td><pre>            <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="713"></td><td><pre>        <span class="token keyword">case</span> WAIT_TIMEOUT<span class="token operator">:</span></pre></td></tr><tr><td data-num="714"></td><td><pre>            <span class="token function">ResetEvent</span><span class="token punctuation">(</span>hEventObject<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="715"></td><td><pre><span class="token comment">//			Sleep(5);</span></pre></td></tr><tr><td data-num="716"></td><td><pre><span class="token comment">//			TRACE("noting readed");</span></pre></td></tr><tr><td data-num="717"></td><td><pre>            <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="718"></td><td><pre>        <span class="token keyword">default</span><span class="token operator">:</span>  <span class="token comment">//Undefined error</span></pre></td></tr><tr><td data-num="719"></td><td><pre>            <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="720"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="721"></td><td><pre></pre></td></tr><tr><td data-num="722"></td><td><pre><span class="token comment">//	CloseHandles();</span></pre></td></tr><tr><td data-num="723"></td><td><pre>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="724"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="725"></td><td><pre></pre></td></tr><tr><td data-num="726"></td><td><pre></pre></td></tr><tr><td data-num="727"></td><td><pre><span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span> <span class="token function">GET_SN</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="728"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="729"></td><td><pre>    DWORD	Result<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="730"></td><td><pre></pre></td></tr><tr><td data-num="731"></td><td><pre>    <span class="token comment">//device</span></pre></td></tr><tr><td data-num="732"></td><td><pre>    <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">65</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="733"></td><td><pre>    <span class="token function">memset</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">65</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="734"></td><td><pre>    buf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x00</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="735"></td><td><pre>    buf<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x55</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="736"></td><td><pre>    buf<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x7A</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="737"></td><td><pre>    <span class="token comment">//buf[4]=0x10;</span></pre></td></tr><tr><td data-num="738"></td><td><pre>    buf<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x05</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="739"></td><td><pre>    buf<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x7c</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="740"></td><td><pre>    buf<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x00</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="741"></td><td><pre>    buf<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x08</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="742"></td><td><pre>    <span class="token function">crc_calc</span><span class="token punctuation">(</span>buf<span class="token operator">+</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//len2，crc2</span></pre></td></tr><tr><td data-num="743"></td><td><pre><span class="token comment">//	memcpy</span></pre></td></tr><tr><td data-num="744"></td><td><pre><span class="token comment">//	memcpy(buf+9,data,60);</span></pre></td></tr><tr><td data-num="745"></td><td><pre>    <span class="token function">WriteOutputReport</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="746"></td><td><pre></pre></td></tr><tr><td data-num="747"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>ReadHandle <span class="token operator">!=</span> INVALID_HANDLE_VALUE<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="748"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="749"></td><td><pre>        Result <span class="token operator">=</span> <span class="token function">ReadFile</span></pre></td></tr><tr><td data-num="750"></td><td><pre>                <span class="token punctuation">(</span>ReadHandle<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="751"></td><td><pre>                 InputReport<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="752"></td><td><pre>                 Capabilities<span class="token punctuation">.</span>InputReportByteLength<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="753"></td><td><pre>                 <span class="token operator">&amp;</span>NumberOfBytesRead<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="754"></td><td><pre>                 <span class="token punctuation">(</span>LPOVERLAPPED<span class="token punctuation">)</span> <span class="token operator">&amp;</span>HIDOverlapped<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="755"></td><td><pre><span class="token comment">//			if (Result) break;</span></pre></td></tr><tr><td data-num="756"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token keyword">else</span></pre></td></tr><tr><td data-num="757"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="758"></td><td><pre>        <span class="token comment">//STATE_USB_BROKEN;</span></pre></td></tr><tr><td data-num="759"></td><td><pre>        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="760"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="761"></td><td><pre><span class="token comment">//		Sleep(5);</span></pre></td></tr><tr><td data-num="762"></td><td><pre><span class="token comment">//		&#125;</span></pre></td></tr><tr><td data-num="763"></td><td><pre>    Result <span class="token operator">=</span> <span class="token function">WaitForSingleObject</span> <span class="token punctuation">(</span>hEventObject<span class="token punctuation">,</span>	<span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="764"></td><td><pre></pre></td></tr><tr><td data-num="765"></td><td><pre>    <span class="token keyword">switch</span> <span class="token punctuation">(</span>Result<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="766"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="767"></td><td><pre>        <span class="token keyword">case</span> WAIT_OBJECT_0<span class="token operator">:</span> <span class="token comment">//ok, received inputreport</span></pre></td></tr><tr><td data-num="768"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="769"></td><td><pre>            <span class="token function">ResetEvent</span><span class="token punctuation">(</span>hEventObject<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="770"></td><td><pre>            <span class="token comment">//	CloseHandles();</span></pre></td></tr><tr><td data-num="771"></td><td><pre>            <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>InputReport<span class="token operator">+</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="772"></td><td><pre>            <span class="token comment">//WriteOutputReport();</span></pre></td></tr><tr><td data-num="773"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="774"></td><td><pre>            <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="775"></td><td><pre>        <span class="token keyword">case</span> WAIT_TIMEOUT<span class="token operator">:</span></pre></td></tr><tr><td data-num="776"></td><td><pre>            <span class="token function">ResetEvent</span><span class="token punctuation">(</span>hEventObject<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="777"></td><td><pre><span class="token comment">//			Sleep(5);</span></pre></td></tr><tr><td data-num="778"></td><td><pre><span class="token comment">//			TRACE("noting readed");</span></pre></td></tr><tr><td data-num="779"></td><td><pre>            <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="780"></td><td><pre>        <span class="token keyword">default</span><span class="token operator">:</span>  <span class="token comment">//Undefined error</span></pre></td></tr><tr><td data-num="781"></td><td><pre>            <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="782"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="783"></td><td><pre></pre></td></tr><tr><td data-num="784"></td><td><pre><span class="token comment">//	CloseHandles();</span></pre></td></tr><tr><td data-num="785"></td><td><pre>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="786"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="787"></td><td><pre></pre></td></tr><tr><td data-num="788"></td><td><pre><span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span> <span class="token function">DEL_ID</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="789"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="790"></td><td><pre>    DWORD	Result<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="791"></td><td><pre></pre></td></tr><tr><td data-num="792"></td><td><pre>    <span class="token comment">//device</span></pre></td></tr><tr><td data-num="793"></td><td><pre>    <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">65</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="794"></td><td><pre>    <span class="token function">memset</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">65</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="795"></td><td><pre>    buf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x00</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="796"></td><td><pre>    buf<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x55</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="797"></td><td><pre>    buf<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x7A</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="798"></td><td><pre>    <span class="token comment">//buf[4]=0x10;</span></pre></td></tr><tr><td data-num="799"></td><td><pre>    buf<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x04</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="800"></td><td><pre>    buf<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x7d</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="801"></td><td><pre>    buf<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x00</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="802"></td><td><pre>    <span class="token function">crc_calc</span><span class="token punctuation">(</span>buf<span class="token operator">+</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//len2，crc2</span></pre></td></tr><tr><td data-num="803"></td><td><pre><span class="token comment">//	memcpy</span></pre></td></tr><tr><td data-num="804"></td><td><pre><span class="token comment">//	memcpy(buf+9,data,60);</span></pre></td></tr><tr><td data-num="805"></td><td><pre>    <span class="token function">WriteOutputReport</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="806"></td><td><pre></pre></td></tr><tr><td data-num="807"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>ReadHandle <span class="token operator">!=</span> INVALID_HANDLE_VALUE<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="808"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="809"></td><td><pre>        Result <span class="token operator">=</span> <span class="token function">ReadFile</span></pre></td></tr><tr><td data-num="810"></td><td><pre>                <span class="token punctuation">(</span>ReadHandle<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="811"></td><td><pre>                 InputReport<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="812"></td><td><pre>                 Capabilities<span class="token punctuation">.</span>InputReportByteLength<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="813"></td><td><pre>                 <span class="token operator">&amp;</span>NumberOfBytesRead<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="814"></td><td><pre>                 <span class="token punctuation">(</span>LPOVERLAPPED<span class="token punctuation">)</span> <span class="token operator">&amp;</span>HIDOverlapped<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="815"></td><td><pre><span class="token comment">//			if (Result) break;</span></pre></td></tr><tr><td data-num="816"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token keyword">else</span></pre></td></tr><tr><td data-num="817"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="818"></td><td><pre>        <span class="token comment">//STATE_USB_BROKEN;</span></pre></td></tr><tr><td data-num="819"></td><td><pre>        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="820"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="821"></td><td><pre><span class="token comment">//		Sleep(5);</span></pre></td></tr><tr><td data-num="822"></td><td><pre><span class="token comment">//		&#125;</span></pre></td></tr><tr><td data-num="823"></td><td><pre>    Result <span class="token operator">=</span> <span class="token function">WaitForSingleObject</span> <span class="token punctuation">(</span>hEventObject<span class="token punctuation">,</span>	<span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="824"></td><td><pre></pre></td></tr><tr><td data-num="825"></td><td><pre>    <span class="token keyword">switch</span> <span class="token punctuation">(</span>Result<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="826"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="827"></td><td><pre>        <span class="token keyword">case</span> WAIT_OBJECT_0<span class="token operator">:</span> <span class="token comment">//ok, received inputreport</span></pre></td></tr><tr><td data-num="828"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="829"></td><td><pre>            <span class="token function">ResetEvent</span><span class="token punctuation">(</span>hEventObject<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="830"></td><td><pre>            <span class="token comment">//CloseHandles();</span></pre></td></tr><tr><td data-num="831"></td><td><pre>            <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>InputReport<span class="token operator">+</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="832"></td><td><pre>            <span class="token comment">//WriteOutputReport();</span></pre></td></tr><tr><td data-num="833"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="834"></td><td><pre>            <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="835"></td><td><pre>        <span class="token keyword">case</span> WAIT_TIMEOUT<span class="token operator">:</span></pre></td></tr><tr><td data-num="836"></td><td><pre>            <span class="token function">ResetEvent</span><span class="token punctuation">(</span>hEventObject<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="837"></td><td><pre><span class="token comment">//			Sleep(5);</span></pre></td></tr><tr><td data-num="838"></td><td><pre><span class="token comment">//			TRACE("noting readed");</span></pre></td></tr><tr><td data-num="839"></td><td><pre>            <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="840"></td><td><pre>        <span class="token keyword">default</span><span class="token operator">:</span>  <span class="token comment">//Undefined error</span></pre></td></tr><tr><td data-num="841"></td><td><pre>            <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="842"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="843"></td><td><pre></pre></td></tr><tr><td data-num="844"></td><td><pre><span class="token comment">//	CloseHandles();</span></pre></td></tr><tr><td data-num="845"></td><td><pre>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="846"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="847"></td><td><pre></pre></td></tr><tr><td data-num="848"></td><td><pre></pre></td></tr><tr><td data-num="849"></td><td><pre></pre></td></tr><tr><td data-num="850"></td><td><pre><span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span> <span class="token function">ADD_ID</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span> data<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="851"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="852"></td><td><pre>    DWORD	Result<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="853"></td><td><pre></pre></td></tr><tr><td data-num="854"></td><td><pre>    <span class="token comment">//device</span></pre></td></tr><tr><td data-num="855"></td><td><pre>    <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">65</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="856"></td><td><pre>    <span class="token function">memset</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">65</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="857"></td><td><pre>    buf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x00</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="858"></td><td><pre>    buf<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x55</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="859"></td><td><pre>    buf<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x7A</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="860"></td><td><pre>    <span class="token comment">//buf[4]=0x10;</span></pre></td></tr><tr><td data-num="861"></td><td><pre>    buf<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x15</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="862"></td><td><pre>    buf<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x7e</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="863"></td><td><pre><span class="token comment">//	buf[6]=0x00;</span></pre></td></tr><tr><td data-num="864"></td><td><pre><span class="token comment">//	memcpy</span></pre></td></tr><tr><td data-num="865"></td><td><pre>    <span class="token function">memcpy</span><span class="token punctuation">(</span>buf<span class="token operator">+</span><span class="token number">6</span><span class="token punctuation">,</span>data<span class="token punctuation">,</span><span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="866"></td><td><pre>    <span class="token function">crc_calc</span><span class="token punctuation">(</span>buf<span class="token operator">+</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">0x17</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//len2，crc2</span></pre></td></tr><tr><td data-num="867"></td><td><pre>    <span class="token function">WriteOutputReport</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="868"></td><td><pre></pre></td></tr><tr><td data-num="869"></td><td><pre>    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="870"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="871"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>ReadHandle <span class="token operator">!=</span> INVALID_HANDLE_VALUE<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="872"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="873"></td><td><pre>            Result <span class="token operator">=</span> <span class="token function">ReadFile</span></pre></td></tr><tr><td data-num="874"></td><td><pre>                    <span class="token punctuation">(</span>ReadHandle<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="875"></td><td><pre>                     InputReport<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="876"></td><td><pre>                     Capabilities<span class="token punctuation">.</span>InputReportByteLength<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="877"></td><td><pre>                     <span class="token operator">&amp;</span>NumberOfBytesRead<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="878"></td><td><pre>                     <span class="token punctuation">(</span>LPOVERLAPPED<span class="token punctuation">)</span> <span class="token operator">&amp;</span>HIDOverlapped<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="879"></td><td><pre><span class="token comment">//			if (Result) break;</span></pre></td></tr><tr><td data-num="880"></td><td><pre>        <span class="token punctuation">&#125;</span><span class="token keyword">else</span></pre></td></tr><tr><td data-num="881"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="882"></td><td><pre>            <span class="token comment">//STATE_USB_BROKEN;</span></pre></td></tr><tr><td data-num="883"></td><td><pre>            <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="884"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="885"></td><td><pre><span class="token comment">//		Sleep(5);</span></pre></td></tr><tr><td data-num="886"></td><td><pre><span class="token comment">//		&#125;</span></pre></td></tr><tr><td data-num="887"></td><td><pre></pre></td></tr><tr><td data-num="888"></td><td><pre></pre></td></tr><tr><td data-num="889"></td><td><pre>        Result <span class="token operator">=</span> <span class="token function">WaitForSingleObject</span> <span class="token punctuation">(</span>hEventObject<span class="token punctuation">,</span>	<span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="890"></td><td><pre>        <span class="token comment">//write_log_file("add id  6");</span></pre></td></tr><tr><td data-num="891"></td><td><pre>        <span class="token keyword">switch</span> <span class="token punctuation">(</span>Result<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="892"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="893"></td><td><pre>            <span class="token keyword">case</span> WAIT_OBJECT_0<span class="token operator">:</span> <span class="token comment">//ok, received inputreport</span></pre></td></tr><tr><td data-num="894"></td><td><pre>            <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="895"></td><td><pre>                <span class="token comment">//write_log_file("add id  7");</span></pre></td></tr><tr><td data-num="896"></td><td><pre>                <span class="token keyword">if</span> <span class="token punctuation">(</span>InputReport<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token operator">!=</span><span class="token number">0x7E</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="897"></td><td><pre>                <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="898"></td><td><pre>                    <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="899"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="900"></td><td><pre>                <span class="token keyword">else</span></pre></td></tr><tr><td data-num="901"></td><td><pre>                <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="902"></td><td><pre>                    <span class="token function">ResetEvent</span><span class="token punctuation">(</span>hEventObject<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="903"></td><td><pre>                    <span class="token function">CloseHandles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="904"></td><td><pre>                    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>InputReport<span class="token operator">+</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="905"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="906"></td><td><pre>                <span class="token comment">//WriteOutputReport();</span></pre></td></tr><tr><td data-num="907"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="908"></td><td><pre>                <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="909"></td><td><pre>            <span class="token keyword">case</span> WAIT_TIMEOUT<span class="token operator">:</span></pre></td></tr><tr><td data-num="910"></td><td><pre>                <span class="token function">write_log_file</span><span class="token punctuation">(</span><span class="token string">"add id  8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="911"></td><td><pre>                <span class="token function">ResetEvent</span><span class="token punctuation">(</span>hEventObject<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="912"></td><td><pre>                <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="913"></td><td><pre><span class="token comment">//			break;</span></pre></td></tr><tr><td data-num="914"></td><td><pre><span class="token comment">//			Sleep(5);</span></pre></td></tr><tr><td data-num="915"></td><td><pre><span class="token comment">//			TRACE("noting readed");</span></pre></td></tr><tr><td data-num="916"></td><td><pre>                <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="917"></td><td><pre>            <span class="token keyword">default</span><span class="token operator">:</span>  <span class="token comment">//Undefined error</span></pre></td></tr><tr><td data-num="918"></td><td><pre>                <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="919"></td><td><pre>                <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="920"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="921"></td><td><pre>        <span class="token keyword">continue</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="922"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="923"></td><td><pre><span class="token comment">//	CloseHandles();</span></pre></td></tr><tr><td data-num="924"></td><td><pre>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="925"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="926"></td><td><pre></pre></td></tr><tr><td data-num="927"></td><td><pre><span class="token keyword">int</span> <span class="token function">write_log_file</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span> str<span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="928"></td><td><pre>    FILE <span class="token operator">*</span>file <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span><span class="token string">"data.txt"</span><span class="token punctuation">,</span> <span class="token string">"a+"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="929"></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span>file <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="930"></td><td><pre>        <span class="token comment">// exit(1);</span></pre></td></tr><tr><td data-num="931"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="932"></td><td><pre>    <span class="token comment">//if(file.isope</span></pre></td></tr><tr><td data-num="933"></td><td><pre>    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> len <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="934"></td><td><pre>    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> wlen <span class="token operator">=</span> <span class="token function">fwrite</span><span class="token punctuation">(</span>str<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span><span class="token punctuation">,</span> len<span class="token punctuation">,</span> file<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="935"></td><td><pre>    <span class="token function">fputc</span><span class="token punctuation">(</span><span class="token char">'\n'</span><span class="token punctuation">,</span> file<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="936"></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span>len <span class="token operator">!=</span> wlen<span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="937"></td><td><pre>        <span class="token comment">//exit(1);</span></pre></td></tr><tr><td data-num="938"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="939"></td><td><pre></pre></td></tr><tr><td data-num="940"></td><td><pre>    <span class="token function">fclose</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="941"></td><td><pre>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="942"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id="精简后代码结构"><a class="anchor" href="#精简后代码结构">#</a> 精简后代码结构</h3><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// 包含标准头文件和自定义头文件</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdafx.h></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"usb_thread.h"</span></span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"global.h"</span></span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"idcardbin.h"</span></span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment">// 定义全局变量</span></pre></td></tr><tr><td data-num="8"></td><td><pre>DWORD								ActualBytesRead<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>DWORD								BytesRead<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>HIDP_CAPS							Capabilities<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>DWORD								cbBytesRead<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>PSP_DEVICE_INTERFACE_DETAIL_DATA	detailData<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>HANDLE								DeviceHandle<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>DWORD								dwError<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token keyword">char</span>								FeatureReport<span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>HANDLE								hEventObject<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>HANDLE								hDevInfo<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>GUID								HidGuid<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>OVERLAPPED							HIDOverlapped<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token keyword">unsigned</span> <span class="token keyword">char</span>						InputReport<span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>ULONG								Length<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>LPOVERLAPPED						lpOverLap<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token keyword">bool</span>								MyDeviceDetected <span class="token operator">=</span> FALSE<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>CString								MyDevicePathName<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>DWORD								NumberOfBytesRead<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token keyword">unsigned</span> <span class="token keyword">char</span>						OutputReport<span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>HANDLE								ReadHandle<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>DWORD								ReportType<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>ULONG								Required<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>CString								ValueToDisplay<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>HANDLE								WriteHandle<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre></pre></td></tr><tr><td data-num="33"></td><td><pre><span class="token comment">// 定义其他变量</span></pre></td></tr><tr><td data-num="34"></td><td><pre>CString my_usb_detail<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre><span class="token keyword">int</span> VendorID<span class="token operator">=</span><span class="token number">0x9573</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre><span class="token keyword">int</span> ProductID<span class="token operator">=</span> <span class="token number">0x4850</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="37"></td><td><pre></pre></td></tr><tr><td data-num="38"></td><td><pre><span class="token comment">// 函数：更新 CRC 校验值</span></pre></td></tr><tr><td data-num="39"></td><td><pre><span class="token keyword">static</span> <span class="token keyword">unsigned</span> <span class="token keyword">short</span> <span class="token function">UpdateCrc</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> ch<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">short</span> <span class="token operator">*</span>lpwCrc<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="40"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>    ch <span class="token operator">=</span> <span class="token punctuation">(</span>ch<span class="token operator">^</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>lpwCrc<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x00FF</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>    ch <span class="token operator">=</span> <span class="token punctuation">(</span>ch<span class="token operator">^</span><span class="token punctuation">(</span>ch<span class="token operator">&lt;&lt;</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>    <span class="token operator">*</span>lpwCrc <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>lpwCrc <span class="token operator">>></span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token operator">^</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">short</span><span class="token punctuation">)</span>ch <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token operator">^</span></pre></td></tr><tr><td data-num="44"></td><td><pre>              <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">short</span><span class="token punctuation">)</span>ch<span class="token operator">&lt;&lt;</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token operator">^</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">short</span><span class="token punctuation">)</span>ch<span class="token operator">>></span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>    <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token operator">*</span>lpwCrc<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="46"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="47"></td><td><pre></pre></td></tr><tr><td data-num="48"></td><td><pre><span class="token comment">// 函数：计算 CRC 校验值</span></pre></td></tr><tr><td data-num="49"></td><td><pre><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">ComputeCrc</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>Data<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">short</span> Length<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="50"></td><td><pre>                       <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>TransmitFirst<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>TransmitSecond<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="51"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="52"></td><td><pre>    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> chBlock<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="53"></td><td><pre>    <span class="token keyword">unsigned</span> <span class="token keyword">short</span> wCrc <span class="token operator">=</span> <span class="token number">0x6363</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="54"></td><td><pre>    <span class="token keyword">do</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="55"></td><td><pre>        chBlock <span class="token operator">=</span> <span class="token operator">*</span>Data<span class="token operator">++</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="56"></td><td><pre>        <span class="token function">UpdateCrc</span><span class="token punctuation">(</span>chBlock<span class="token punctuation">,</span> <span class="token operator">&amp;</span>wCrc<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="57"></td><td><pre>    <span class="token punctuation">&#125;</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">--</span>Length<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="58"></td><td><pre>    <span class="token operator">*</span>TransmitFirst <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>wCrc <span class="token operator">>></span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="59"></td><td><pre>    <span class="token operator">*</span>TransmitSecond <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>wCrc <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="60"></td><td><pre>    <span class="token keyword">return</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="61"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="62"></td><td><pre></pre></td></tr><tr><td data-num="63"></td><td><pre><span class="token comment">// 函数：计算 CRC 校验值（简化版）</span></pre></td></tr><tr><td data-num="64"></td><td><pre><span class="token keyword">void</span> <span class="token function">crc_calc</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>data<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">short</span> len<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="65"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="66"></td><td><pre>    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>p <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>data<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="67"></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span>len <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="68"></td><td><pre>        <span class="token keyword">return</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="69"></td><td><pre>    <span class="token function">ComputeCrc</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> len <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>p<span class="token punctuation">[</span>len <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>p<span class="token punctuation">[</span>len <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="70"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="71"></td><td><pre></pre></td></tr><tr><td data-num="72"></td><td><pre><span class="token comment">// 函数：获取设备能力</span></pre></td></tr><tr><td data-num="73"></td><td><pre><span class="token keyword">void</span> <span class="token function">GetDeviceCapabilities</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="74"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="75"></td><td><pre>    <span class="token comment">// 获取预处理数据</span></pre></td></tr><tr><td data-num="76"></td><td><pre>    PHIDP_PREPARSED_DATA PreparsedData<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="77"></td><td><pre>    <span class="token function">HidD_GetPreparsedData</span><span class="token punctuation">(</span>DeviceHandle<span class="token punctuation">,</span> <span class="token operator">&amp;</span>PreparsedData<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="78"></td><td><pre>    </pre></td></tr><tr><td data-num="79"></td><td><pre>    <span class="token comment">// 获取设备能力信息</span></pre></td></tr><tr><td data-num="80"></td><td><pre>    <span class="token function">HidP_GetCaps</span><span class="token punctuation">(</span>PreparsedData<span class="token punctuation">,</span> <span class="token operator">&amp;</span>Capabilities<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="81"></td><td><pre></pre></td></tr><tr><td data-num="82"></td><td><pre>    <span class="token comment">// 释放预处理数据</span></pre></td></tr><tr><td data-num="83"></td><td><pre>    <span class="token function">HidD_FreePreparsedData</span><span class="token punctuation">(</span>PreparsedData<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="84"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="85"></td><td><pre></pre></td></tr><tr><td data-num="86"></td><td><pre><span class="token comment">// 函数：准备进行重叠传输</span></pre></td></tr><tr><td data-num="87"></td><td><pre><span class="token keyword">void</span> <span class="token function">PrepareForOverlappedTransfer</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="88"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="89"></td><td><pre>    <span class="token comment">// 为重叠读取操作获取设备句柄</span></pre></td></tr><tr><td data-num="90"></td><td><pre>    ReadHandle <span class="token operator">=</span> <span class="token function">CreateFile</span><span class="token punctuation">(</span>detailData<span class="token operator">-></span>DevicePath<span class="token punctuation">,</span> GENERIC_READ<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="91"></td><td><pre>                            FILE_SHARE_READ <span class="token operator">|</span> FILE_SHARE_WRITE<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="92"></td><td><pre>                            <span class="token punctuation">(</span>LPSECURITY_ATTRIBUTES<span class="token punctuation">)</span><span class="token constant">NULL</span><span class="token punctuation">,</span> OPEN_EXISTING<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="93"></td><td><pre>                            FILE_ATTRIBUTE_NORMAL <span class="token operator">|</span> FILE_FLAG_OVERLAPPED<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="94"></td><td><pre></pre></td></tr><tr><td data-num="95"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>hEventObject <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="96"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="97"></td><td><pre>        <span class="token comment">// 创建事件对象</span></pre></td></tr><tr><td data-num="98"></td><td><pre>        hEventObject <span class="token operator">=</span> <span class="token function">CreateEvent</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> TRUE<span class="token punctuation">,</span> TRUE<span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="99"></td><td><pre></pre></td></tr><tr><td data-num="100"></td><td><pre>        <span class="token comment">// 设置重叠结构的成员</span></pre></td></tr><tr><td data-num="101"></td><td><pre>        HIDOverlapped<span class="token punctuation">.</span>hEvent <span class="token operator">=</span> hEventObject<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="102"></td><td><pre>        HIDOverlapped<span class="token punctuation">.</span>Offset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="103"></td><td><pre>        HIDOverlapped<span class="token punctuation">.</span>OffsetHigh <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="104"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="105"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="106"></td><td><pre></pre></td></tr><tr><td data-num="107"></td><td><pre><span class="token comment">// 函数：关闭句柄</span></pre></td></tr><tr><td data-num="108"></td><td><pre><span class="token keyword">void</span> <span class="token function">CloseHandles</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="109"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="110"></td><td><pre>    <span class="token comment">// 关闭打开的句柄</span></pre></td></tr><tr><td data-num="111"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>DeviceHandle <span class="token operator">!=</span> INVALID_HANDLE_VALUE<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="112"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="113"></td><td><pre>        <span class="token function">CloseHandle</span><span class="token punctuation">(</span>DeviceHandle<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="114"></td><td><pre>        DeviceHandle <span class="token operator">=</span> INVALID_HANDLE_VALUE<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="115"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="116"></td><td><pre></pre></td></tr><tr><td data-num="117"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>ReadHandle <span class="token operator">!=</span> INVALID_HANDLE_VALUE<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="118"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="119"></td><td><pre>        <span class="token function">CloseHandle</span><span class="token punctuation">(</span>ReadHandle<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="120"></td><td><pre>        ReadHandle <span class="token operator">=</span> INVALID_HANDLE_VALUE<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="121"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="122"></td><td><pre></pre></td></tr><tr><td data-num="123"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>WriteHandle <span class="token operator">!=</span> INVALID_HANDLE_VALUE<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="124"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="125"></td><td><pre>        <span class="token function">CloseHandle</span><span class="token punctuation">(</span>WriteHandle<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="126"></td><td><pre>        WriteHandle <span class="token operator">=</span> INVALID_HANDLE_VALUE<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="127"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="128"></td><td><pre></pre></td></tr><tr><td data-num="129"></td><td><pre>    <span class="token comment">// 销毁设备信息列表</span></pre></td></tr><tr><td data-num="130"></td><td><pre>    <span class="token function">SetupDiDestroyDeviceInfoList</span><span class="token punctuation">(</span>hDevInfo<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="131"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h4 id="updatecrc"><a class="anchor" href="#updatecrc">#</a> UpdateCrc</h4><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// 函数：更新 CRC 校验值</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment">// 参数：</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">//   ch: 待处理的字节</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment">//   lpwCrc: CRC 校验值指针</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment">// 返回值：更新后的 CRC 校验值</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">static</span> <span class="token keyword">unsigned</span> <span class="token keyword">short</span> <span class="token function">UpdateCrc</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> ch<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">short</span> <span class="token operator">*</span>lpwCrc<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token comment">// 将待处理的字节与低位 CRC 校验值进行异或运算</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    ch <span class="token operator">=</span> <span class="token punctuation">(</span>ch <span class="token operator">^</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>lpwCrc<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x00FF</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    </pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token comment">// 左移 4 位，并再次与原字节进行异或运算</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    ch <span class="token operator">=</span> <span class="token punctuation">(</span>ch <span class="token operator">^</span> <span class="token punctuation">(</span>ch <span class="token operator">&lt;&lt;</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    </pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token comment">// 更新 CRC 校验值</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token operator">*</span>lpwCrc <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>lpwCrc <span class="token operator">>></span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">short</span><span class="token punctuation">)</span>ch <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">^</span></pre></td></tr><tr><td data-num="16"></td><td><pre>              <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">short</span><span class="token punctuation">)</span>ch <span class="token operator">&lt;&lt;</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">short</span><span class="token punctuation">)</span>ch <span class="token operator">>></span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    </pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token comment">// 返回更新后的 CRC 校验值</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token operator">*</span>lpwCrc<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h4 id="computecrc"><a class="anchor" href="#computecrc">#</a> ComputeCrc</h4><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// 函数：计算 CRC 校验值</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment">// 参数：</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">//   Data: 待计算 CRC 的数据数组指针</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment">//   Length: 数据长度</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment">//   TransmitFirst: 存储 CRC 高位字节的指针</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment">//   TransmitSecond: 存储 CRC 低位字节的指针</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment">// 返回值：无</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">ComputeCrc</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>Data<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">short</span> Length<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="9"></td><td><pre>                       <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>TransmitFirst<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>TransmitSecond<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> chBlock<span class="token punctuation">;</span> <span class="token comment">// 用于存储每次处理的字节</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token keyword">unsigned</span> <span class="token keyword">short</span> wCrc <span class="token operator">=</span> <span class="token number">0x6363</span><span class="token punctuation">;</span> <span class="token comment">// 初始 CRC 校验值</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token comment">// 遍历数据数组，更新 CRC 校验值</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token keyword">do</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        chBlock <span class="token operator">=</span> <span class="token operator">*</span>Data<span class="token operator">++</span><span class="token punctuation">;</span> <span class="token comment">// 获取当前字节</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token function">UpdateCrc</span><span class="token punctuation">(</span>chBlock<span class="token punctuation">,</span> <span class="token operator">&amp;</span>wCrc<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 更新 CRC 校验值</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token punctuation">&#125;</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">--</span>Length<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 继续直到处理完所有数据</span></pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token comment">// 将 CRC 校验值的高位字节和低位字节存储到对应的指针中</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token operator">*</span>TransmitFirst <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>wCrc <span class="token operator">>></span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 存储高位字节</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token operator">*</span>TransmitSecond <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token punctuation">)</span><span class="token punctuation">(</span>wCrc <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 存储低位字节</span></pre></td></tr><tr><td data-num="23"></td><td><pre></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token keyword">return</span><span class="token punctuation">;</span> <span class="token comment">// 结束函数</span></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h4 id="crc_calc"><a class="anchor" href="#crc_calc">#</a> crc_calc</h4><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// 函数：计算 CRC 校验值</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment">// 参数：</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">//   data: 待计算 CRC 的数据指针</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment">//   len: 数据长度</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment">// 返回值：无</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">void</span> <span class="token function">crc_calc</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>data<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">short</span> len<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>p <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>data<span class="token punctuation">;</span> <span class="token comment">// 将数据指针转换为无符号字符指针</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token comment">// 如果数据长度小于 2，则直接返回，因为 CRC 校验需要至少两个字节的数据</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>len <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token keyword">return</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token comment">// 调用 ComputeCrc 函数计算 CRC 校验值，并将结果存储在数据的倒数第二个字节和最后一个字节中</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token function">ComputeCrc</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> len <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>p<span class="token punctuation">[</span>len <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>p<span class="token punctuation">[</span>len <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h4 id="getdevicecapabilities"><a class="anchor" href="#getdevicecapabilities">#</a> GetDeviceCapabilities</h4><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// 函数：获取设备的功能信息</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment">// 参数：无</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">// 返回值：无</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">void</span> <span class="token function">GetDeviceCapabilities</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    PHIDP_PREPARSED_DATA PreparsedData<span class="token punctuation">;</span> <span class="token comment">// 预解析数据结构指针</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token comment">// 获取设备的预解析数据</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token function">HidD_GetPreparsedData</span><span class="token punctuation">(</span>DeviceHandle<span class="token punctuation">,</span> <span class="token operator">&amp;</span>PreparsedData<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token comment">/*</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    函数：HidP_GetCaps</pre></td></tr><tr><td data-num="13"></td><td><pre>    说明：获取设备的功能信息。对于标准设备（如游戏手柄），可以了解设备的具体功能。</pre></td></tr><tr><td data-num="14"></td><td><pre>         对于自定义设备，软件可能已经知道设备的功能，此调用仅用于验证信息。</pre></td></tr><tr><td data-num="15"></td><td><pre>    参数：PreparsedData - 由 HidD_GetPreparsedData 返回的缓冲区指针</pre></td></tr><tr><td data-num="16"></td><td><pre>    返回值：包含设备信息的 Capabilities 结构体</pre></td></tr><tr><td data-num="17"></td><td><pre>    */</pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token function">HidP_GetCaps</span><span class="token punctuation">(</span>PreparsedData<span class="token punctuation">,</span> <span class="token operator">&amp;</span>Capabilities<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token comment">// 不再需要 PreparsedData，释放内存</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token function">HidD_FreePreparsedData</span><span class="token punctuation">(</span>PreparsedData<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h4 id="prepareforoverlappedtransfer"><a class="anchor" href="#prepareforoverlappedtransfer">#</a> PrepareForOverlappedTransfer</h4><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// 函数：准备进行重叠传输</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment">// 参数：无</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">// 返回值：无</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">void</span> <span class="token function">PrepareForOverlappedTransfer</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token comment">// 获取用于重叠读取文件的设备句柄</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    ReadHandle <span class="token operator">=</span> <span class="token function">CreateFile</span><span class="token punctuation">(</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        detailData<span class="token operator">-></span>DevicePath<span class="token punctuation">,</span>                           <span class="token comment">// 设备路径</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        GENERIC_READ<span class="token punctuation">,</span>                                     <span class="token comment">// 读取权限</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        FILE_SHARE_READ <span class="token operator">|</span> FILE_SHARE_WRITE<span class="token punctuation">,</span>               <span class="token comment">// 共享权限</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token punctuation">(</span>LPSECURITY_ATTRIBUTES<span class="token punctuation">)</span><span class="token constant">NULL</span><span class="token punctuation">,</span>                      <span class="token comment">// 安全属性</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        OPEN_EXISTING<span class="token punctuation">,</span>                                    <span class="token comment">// 打开已存在的文件</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        FILE_ATTRIBUTE_NORMAL <span class="token operator">|</span> FILE_FLAG_OVERLAPPED<span class="token punctuation">,</span>     <span class="token comment">// 属性标志：正常文件 + 重叠标志</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token constant">NULL</span>                                              <span class="token comment">// 模板句柄</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token comment">// 如果事件对象未创建，创建一个事件对象</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>hEventObject <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>        hEventObject <span class="token operator">=</span> <span class="token function">CreateEvent</span><span class="token punctuation">(</span></pre></td></tr><tr><td data-num="21"></td><td><pre>            <span class="token constant">NULL</span><span class="token punctuation">,</span>     <span class="token comment">// 默认安全属性</span></pre></td></tr><tr><td data-num="22"></td><td><pre>            TRUE<span class="token punctuation">,</span>     <span class="token comment">// 手动重置</span></pre></td></tr><tr><td data-num="23"></td><td><pre>            TRUE<span class="token punctuation">,</span>     <span class="token comment">// 初始状态为有信号</span></pre></td></tr><tr><td data-num="24"></td><td><pre>            <span class="token string">""</span>        <span class="token comment">// 无名称</span></pre></td></tr><tr><td data-num="25"></td><td><pre>        <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre></pre></td></tr><tr><td data-num="27"></td><td><pre>        <span class="token comment">// 设置重叠结构的成员</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        HIDOverlapped<span class="token punctuation">.</span>hEvent <span class="token operator">=</span> hEventObject<span class="token punctuation">;</span>   <span class="token comment">// 事件句柄</span></pre></td></tr><tr><td data-num="29"></td><td><pre>        HIDOverlapped<span class="token punctuation">.</span>Offset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>               <span class="token comment">// 偏移量</span></pre></td></tr><tr><td data-num="30"></td><td><pre>        HIDOverlapped<span class="token punctuation">.</span>OffsetHigh <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>           <span class="token comment">// 高位偏移量</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="32"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h4 id="closehandles"><a class="anchor" href="#closehandles">#</a> CloseHandles</h4><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// 函数：关闭句柄</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment">// 参数：无</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">// 返回值：无</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">void</span> <span class="token function">CloseHandles</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token comment">// 关闭打开的句柄</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token comment">// 如果设备句柄有效，关闭设备句柄并将其置为无效</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>DeviceHandle <span class="token operator">!=</span> INVALID_HANDLE_VALUE<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token function">CloseHandle</span><span class="token punctuation">(</span>DeviceHandle<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        DeviceHandle <span class="token operator">=</span> INVALID_HANDLE_VALUE<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token comment">// 如果读取句柄有效，关闭读取句柄并将其置为无效</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>ReadHandle <span class="token operator">!=</span> INVALID_HANDLE_VALUE<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token function">CloseHandle</span><span class="token punctuation">(</span>ReadHandle<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        ReadHandle <span class="token operator">=</span> INVALID_HANDLE_VALUE<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="21"></td><td><pre></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token comment">// 如果写入句柄有效，关闭写入句柄并将其置为无效</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>WriteHandle <span class="token operator">!=</span> INVALID_HANDLE_VALUE<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>        <span class="token function">CloseHandle</span><span class="token punctuation">(</span>WriteHandle<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>        WriteHandle <span class="token operator">=</span> INVALID_HANDLE_VALUE<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="28"></td><td><pre></pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token comment">// 销毁设备信息列表</span></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token function">SetupDiDestroyDeviceInfoList</span><span class="token punctuation">(</span>hDevInfo<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h4 id="writeoutputreport"><a class="anchor" href="#writeoutputreport">#</a> WriteOutputReport</h4><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// 函数：写入输出报告</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment">// 参数：无</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">// 返回值：写入结果，成功返回 0，失败返回 - 1</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">int</span> <span class="token function">WriteOutputReport</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token comment">// 向设备发送报告</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre>    DWORD	BytesWritten <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    ULONG	Result <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token comment">// 如果写入句柄有效，则进行写入操作</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>WriteHandle <span class="token operator">!=</span> INVALID_HANDLE_VALUE<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token comment">// 调用 WriteFile 函数向设备写入数据</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        Result <span class="token operator">=</span> <span class="token function">WriteFile</span><span class="token punctuation">(</span></pre></td></tr><tr><td data-num="16"></td><td><pre>            WriteHandle<span class="token punctuation">,</span>                <span class="token comment">// 写入句柄</span></pre></td></tr><tr><td data-num="17"></td><td><pre>            InputReport<span class="token punctuation">,</span>                <span class="token comment">// 待写入的数据</span></pre></td></tr><tr><td data-num="18"></td><td><pre>            Capabilities<span class="token punctuation">.</span>OutputReportByteLength<span class="token punctuation">,</span> <span class="token comment">// 写入数据的字节长度</span></pre></td></tr><tr><td data-num="19"></td><td><pre>            <span class="token operator">&amp;</span>BytesWritten<span class="token punctuation">,</span>              <span class="token comment">// 实际写入的字节数</span></pre></td></tr><tr><td data-num="20"></td><td><pre>            <span class="token constant">NULL</span>                        <span class="token comment">// 不使用重叠操作</span></pre></td></tr><tr><td data-num="21"></td><td><pre>        <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="23"></td><td><pre></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token comment">// 如果写入失败，则处理失败情况</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>Result<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>        <span class="token comment">// 获取错误信息</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        BytesWritten <span class="token operator">=</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>        <span class="token comment">// 返回 - 1 表示写入失败</span></pre></td></tr><tr><td data-num="30"></td><td><pre>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>    <span class="token keyword">else</span></pre></td></tr><tr><td data-num="33"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>        <span class="token comment">// 写入成功，返回 0 表示成功</span></pre></td></tr><tr><td data-num="35"></td><td><pre>        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="37"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h4 id="writeoutputreport-2"><a class="anchor" href="#writeoutputreport-2">#</a> WriteOutputReport</h4><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// 函数：写入输出报告</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment">// 参数：buf - 待发送的报告数据</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">// 返回值：写入结果，成功返回 0，失败返回 - 1</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">int</span> <span class="token function">WriteOutputReport</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>buf<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token comment">// 将待发送的报告数据复制到 InputReport 缓冲区中</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token function">memcpy</span><span class="token punctuation">(</span>InputReport<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token comment">// 定义变量用于记录写入操作结果和实际写入的字节数</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    DWORD	BytesWritten <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    ULONG	Result <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token comment">// 如果写入句柄有效，则进行写入操作</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>WriteHandle <span class="token operator">!=</span> INVALID_HANDLE_VALUE <span class="token operator">&amp;&amp;</span> WriteHandle <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token comment">// 调用 WriteFile 函数向设备写入数据</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        Result <span class="token operator">=</span> <span class="token function">WriteFile</span><span class="token punctuation">(</span></pre></td></tr><tr><td data-num="18"></td><td><pre>            WriteHandle<span class="token punctuation">,</span>                        <span class="token comment">// 写入句柄</span></pre></td></tr><tr><td data-num="19"></td><td><pre>            InputReport<span class="token punctuation">,</span>                        <span class="token comment">// 待写入的数据</span></pre></td></tr><tr><td data-num="20"></td><td><pre>            Capabilities<span class="token punctuation">.</span>OutputReportByteLength<span class="token punctuation">,</span><span class="token comment">// 写入数据的字节长度</span></pre></td></tr><tr><td data-num="21"></td><td><pre>            <span class="token operator">&amp;</span>BytesWritten<span class="token punctuation">,</span>                      <span class="token comment">// 实际写入的字节数</span></pre></td></tr><tr><td data-num="22"></td><td><pre>            <span class="token constant">NULL</span>                                <span class="token comment">// 不使用重叠操作</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="25"></td><td><pre></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token comment">// 记录写入操作结果到日志文件</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token function">WritebinErrLogFile</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>InputReport<span class="token punctuation">,</span> <span class="token number">65</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre></pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token comment">// 如果写入失败，则处理失败情况</span></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>Result<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>        <span class="token comment">// 获取错误信息</span></pre></td></tr><tr><td data-num="33"></td><td><pre>        BytesWritten <span class="token operator">=</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>        <span class="token comment">// 记录失败信息到日志文件</span></pre></td></tr><tr><td data-num="35"></td><td><pre>        <span class="token function">WriteLogFile</span><span class="token punctuation">(</span><span class="token string">"WriteOutputReport FAIL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>        <span class="token comment">// 返回 - 1 表示写入失败</span></pre></td></tr><tr><td data-num="37"></td><td><pre>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>    <span class="token keyword">else</span></pre></td></tr><tr><td data-num="40"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>        <span class="token comment">// 记录成功信息到日志文件</span></pre></td></tr><tr><td data-num="42"></td><td><pre>        <span class="token function">WriteLogFile</span><span class="token punctuation">(</span><span class="token string">"WriteOutputReport success"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>        <span class="token comment">// 写入成功，返回 0 表示成功</span></pre></td></tr><tr><td data-num="44"></td><td><pre>        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="46"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h4 id="writeoutputreport2"><a class="anchor" href="#writeoutputreport2">#</a> WriteOutputReport2</h4><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// 函数：写入输出报告 2</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment">// 描述：向设备发送报告数据</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">// 返回值：写入结果，成功返回 0，失败返回 - 1</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">int</span> <span class="token function">WriteOutputReport2</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token comment">// 定义变量用于记录写入操作结果和实际写入的字节数</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    DWORD	BytesWritten <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    ULONG	Result <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token comment">// 如果写入句柄有效，则进行写入操作</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>WriteHandle <span class="token operator">!=</span> INVALID_HANDLE_VALUE<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token comment">// 清空 InputReport 缓冲区，并设置报告数据</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token function">memset</span><span class="token punctuation">(</span>InputReport<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        InputReport<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x39</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        InputReport<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x03</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        InputReport<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x03</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        InputReport<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x05</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre>        <span class="token comment">// 调用 WriteFile 函数向设备写入数据</span></pre></td></tr><tr><td data-num="21"></td><td><pre>        Result <span class="token operator">=</span> <span class="token function">WriteFile</span><span class="token punctuation">(</span></pre></td></tr><tr><td data-num="22"></td><td><pre>            WriteHandle<span class="token punctuation">,</span>                        <span class="token comment">// 写入句柄</span></pre></td></tr><tr><td data-num="23"></td><td><pre>            InputReport<span class="token punctuation">,</span>                        <span class="token comment">// 待写入的数据</span></pre></td></tr><tr><td data-num="24"></td><td><pre>            Capabilities<span class="token punctuation">.</span>OutputReportByteLength<span class="token punctuation">,</span><span class="token comment">// 写入数据的字节长度</span></pre></td></tr><tr><td data-num="25"></td><td><pre>            <span class="token operator">&amp;</span>BytesWritten<span class="token punctuation">,</span>                      <span class="token comment">// 实际写入的字节数</span></pre></td></tr><tr><td data-num="26"></td><td><pre>            <span class="token constant">NULL</span>                                <span class="token comment">// 不使用重叠操作</span></pre></td></tr><tr><td data-num="27"></td><td><pre>        <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="29"></td><td><pre></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token comment">// 如果写入失败，则处理失败情况</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>Result<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="32"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>        <span class="token comment">// 获取错误信息</span></pre></td></tr><tr><td data-num="34"></td><td><pre>        BytesWritten <span class="token operator">=</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>        <span class="token comment">// 返回 - 1 表示写入失败</span></pre></td></tr><tr><td data-num="36"></td><td><pre>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>    <span class="token keyword">else</span></pre></td></tr><tr><td data-num="39"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>        <span class="token comment">// 写入成功，返回 0 表示成功</span></pre></td></tr><tr><td data-num="41"></td><td><pre>        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="43"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h4 id="readthreadfindhid"><a class="anchor" href="#readthreadfindhid">#</a> ReadThreadFindHID</h4><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// 函数：读取线程查找 HID 设备</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment">// 描述：使用一系列的 API 调用查找具有指定供应商 ID 和产品 ID 的 HID 设备</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">// 返回值：如果找到目标设备返回 true，否则返回 false</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">bool</span> <span class="token function">ReadThreadFindHID</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token comment">// 定义变量</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    HIDD_ATTRIBUTES Attributes<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    DWORD DeviceUsage<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    SP_DEVICE_INTERFACE_DATA devInfoData<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token keyword">bool</span> LastDevice <span class="token operator">=</span> FALSE<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token keyword">int</span> MemberIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    LONG Result<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    CString UsageDescription<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token comment">// 重置长度和设备信息数据</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    Length <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    detailData <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    DeviceHandle <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token comment">// 获取系统中所有 HID 设备的 GUID</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token function">HidD_GetHidGuid</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>HidGuid<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token comment">// 获取设备信息集句柄</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    hDevInfo <span class="token operator">=</span> <span class="token function">SetupDiGetClassDevs</span><span class="token punctuation">(</span></pre></td></tr><tr><td data-num="25"></td><td><pre>        <span class="token operator">&amp;</span>HidGuid<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="26"></td><td><pre>        <span class="token constant">NULL</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="27"></td><td><pre>        <span class="token constant">NULL</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        DIGCF_PRESENT <span class="token operator">|</span> DIGCF_INTERFACEDEVICE</pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre></pre></td></tr><tr><td data-num="31"></td><td><pre>    devInfoData<span class="token punctuation">.</span>cbSize <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>devInfoData<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre></pre></td></tr><tr><td data-num="33"></td><td><pre>    <span class="token comment">// 逐个检查可用设备，直到找到目标设备或检查完所有设备</span></pre></td></tr><tr><td data-num="34"></td><td><pre>    MemberIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>    LastDevice <span class="token operator">=</span> FALSE<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre></pre></td></tr><tr><td data-num="37"></td><td><pre>    <span class="token keyword">do</span></pre></td></tr><tr><td data-num="38"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>        <span class="token comment">// 枚举设备接口</span></pre></td></tr><tr><td data-num="40"></td><td><pre>        Result <span class="token operator">=</span> <span class="token function">SetupDiEnumDeviceInterfaces</span><span class="token punctuation">(</span></pre></td></tr><tr><td data-num="41"></td><td><pre>            hDevInfo<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="42"></td><td><pre>            <span class="token number">0</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="43"></td><td><pre>            <span class="token operator">&amp;</span>HidGuid<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="44"></td><td><pre>            MemberIndex<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="45"></td><td><pre>            <span class="token operator">&amp;</span>devInfoData</pre></td></tr><tr><td data-num="46"></td><td><pre>        <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="47"></td><td><pre></pre></td></tr><tr><td data-num="48"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>Result <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="49"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="50"></td><td><pre>            Result <span class="token operator">=</span> <span class="token function">SetupDiGetDeviceInterfaceDetail</span><span class="token punctuation">(</span></pre></td></tr><tr><td data-num="51"></td><td><pre>                hDevInfo<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="52"></td><td><pre>                <span class="token operator">&amp;</span>devInfoData<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="53"></td><td><pre>                <span class="token constant">NULL</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="54"></td><td><pre>                <span class="token number">0</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="55"></td><td><pre>                <span class="token operator">&amp;</span>Length<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="56"></td><td><pre>                <span class="token constant">NULL</span></pre></td></tr><tr><td data-num="57"></td><td><pre>            <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="58"></td><td><pre></pre></td></tr><tr><td data-num="59"></td><td><pre>            <span class="token comment">// 分配内存给设备信息数据结构</span></pre></td></tr><tr><td data-num="60"></td><td><pre>            detailData <span class="token operator">=</span> <span class="token punctuation">(</span>PSP_DEVICE_INTERFACE_DETAIL_DATA<span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span>Length<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="61"></td><td><pre>            detailData<span class="token operator">-></span>cbSize <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>SP_DEVICE_INTERFACE_DETAIL_DATA<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="62"></td><td><pre></pre></td></tr><tr><td data-num="63"></td><td><pre>            <span class="token comment">// 获取设备接口详细信息</span></pre></td></tr><tr><td data-num="64"></td><td><pre>            Result <span class="token operator">=</span> <span class="token function">SetupDiGetDeviceInterfaceDetail</span><span class="token punctuation">(</span></pre></td></tr><tr><td data-num="65"></td><td><pre>                hDevInfo<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="66"></td><td><pre>                <span class="token operator">&amp;</span>devInfoData<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="67"></td><td><pre>                detailData<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="68"></td><td><pre>                Length<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="69"></td><td><pre>                <span class="token operator">&amp;</span>Required<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="70"></td><td><pre>                <span class="token constant">NULL</span></pre></td></tr><tr><td data-num="71"></td><td><pre>            <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="72"></td><td><pre></pre></td></tr><tr><td data-num="73"></td><td><pre>            <span class="token comment">// 打开设备文件句柄</span></pre></td></tr><tr><td data-num="74"></td><td><pre>            DeviceHandle <span class="token operator">=</span> <span class="token function">CreateFile</span><span class="token punctuation">(</span></pre></td></tr><tr><td data-num="75"></td><td><pre>                detailData<span class="token operator">-></span>DevicePath<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="76"></td><td><pre>                <span class="token number">0</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="77"></td><td><pre>                FILE_SHARE_READ <span class="token operator">|</span> FILE_SHARE_WRITE<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="78"></td><td><pre>                <span class="token punctuation">(</span>LPSECURITY_ATTRIBUTES<span class="token punctuation">)</span><span class="token constant">NULL</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="79"></td><td><pre>                OPEN_EXISTING<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="80"></td><td><pre>                <span class="token number">0</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="81"></td><td><pre>                <span class="token constant">NULL</span></pre></td></tr><tr><td data-num="82"></td><td><pre>            <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="83"></td><td><pre></pre></td></tr><tr><td data-num="84"></td><td><pre>            <span class="token comment">// 获取设备属性</span></pre></td></tr><tr><td data-num="85"></td><td><pre>            Attributes<span class="token punctuation">.</span>Size <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>Attributes<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="86"></td><td><pre>            Result <span class="token operator">=</span> <span class="token function">HidD_GetAttributes</span><span class="token punctuation">(</span>DeviceHandle<span class="token punctuation">,</span> <span class="token operator">&amp;</span>Attributes<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="87"></td><td><pre></pre></td></tr><tr><td data-num="88"></td><td><pre>            <span class="token comment">// 检查是否为目标设备</span></pre></td></tr><tr><td data-num="89"></td><td><pre>            MyDeviceDetected <span class="token operator">=</span> FALSE<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="90"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span>Attributes<span class="token punctuation">.</span>VendorID <span class="token operator">==</span> VendorID<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="91"></td><td><pre>            <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="92"></td><td><pre>                <span class="token keyword">if</span> <span class="token punctuation">(</span>Attributes<span class="token punctuation">.</span>ProductID <span class="token operator">==</span> ProductID<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="93"></td><td><pre>                <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="94"></td><td><pre>                    <span class="token comment">// 供应商 ID 和产品 ID 都匹配</span></pre></td></tr><tr><td data-num="95"></td><td><pre>                    MyDeviceDetected <span class="token operator">=</span> TRUE<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="96"></td><td><pre>                    MyDevicePathName <span class="token operator">=</span> detailData<span class="token operator">-></span>DevicePath<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="97"></td><td><pre></pre></td></tr><tr><td data-num="98"></td><td><pre>                    <span class="token comment">// 获取设备能力</span></pre></td></tr><tr><td data-num="99"></td><td><pre>                    <span class="token function">GetDeviceCapabilities</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="100"></td><td><pre></pre></td></tr><tr><td data-num="101"></td><td><pre>                    <span class="token comment">// 检查设备是否为系统鼠标或键盘</span></pre></td></tr><tr><td data-num="102"></td><td><pre>                    DeviceUsage <span class="token operator">=</span> <span class="token punctuation">(</span>Capabilities<span class="token punctuation">.</span>UsagePage <span class="token operator">*</span> <span class="token number">256</span><span class="token punctuation">)</span> <span class="token operator">+</span> Capabilities<span class="token punctuation">.</span>Usage<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="103"></td><td><pre>                    <span class="token keyword">if</span> <span class="token punctuation">(</span>DeviceUsage <span class="token operator">==</span> <span class="token number">0x102</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="104"></td><td><pre>                    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="105"></td><td><pre>                        UsageDescription <span class="token operator">=</span> <span class="token string">"mouse"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="106"></td><td><pre>                    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="107"></td><td><pre>                    <span class="token keyword">if</span> <span class="token punctuation">(</span>DeviceUsage <span class="token operator">==</span> <span class="token number">0x106</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="108"></td><td><pre>                    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="109"></td><td><pre>                        UsageDescription <span class="token operator">=</span> <span class="token string">"keyboard"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="110"></td><td><pre>                    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="111"></td><td><pre></pre></td></tr><tr><td data-num="112"></td><td><pre>                    <span class="token comment">// 创建读取句柄</span></pre></td></tr><tr><td data-num="113"></td><td><pre>                    ReadHandle <span class="token operator">=</span> <span class="token function">CreateFile</span><span class="token punctuation">(</span></pre></td></tr><tr><td data-num="114"></td><td><pre>                        detailData<span class="token operator">-></span>DevicePath<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="115"></td><td><pre>                        GENERIC_READ<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="116"></td><td><pre>                        FILE_SHARE_READ <span class="token operator">|</span> FILE_SHARE_WRITE<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="117"></td><td><pre>                        <span class="token punctuation">(</span>LPSECURITY_ATTRIBUTES<span class="token punctuation">)</span><span class="token constant">NULL</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="118"></td><td><pre>                        OPEN_EXISTING<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="119"></td><td><pre>                        FILE_ATTRIBUTE_NORMAL <span class="token operator">|</span> FILE_FLAG_OVERLAPPED<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="120"></td><td><pre>                        <span class="token constant">NULL</span></pre></td></tr><tr><td data-num="121"></td><td><pre>                    <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="122"></td><td><pre></pre></td></tr><tr><td data-num="123"></td><td><pre>                    <span class="token comment">// 创建事件对象</span></pre></td></tr><tr><td data-num="124"></td><td><pre>                    <span class="token keyword">if</span> <span class="token punctuation">(</span>hEventObject <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="125"></td><td><pre>                    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="126"></td><td><pre>                        hEventObject <span class="token operator">=</span> <span class="token function">CreateEvent</span><span class="token punctuation">(</span></pre></td></tr><tr><td data-num="127"></td><td><pre>                            <span class="token constant">NULL</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="128"></td><td><pre>                            TRUE<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="129"></td><td><pre>                            TRUE<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="130"></td><td><pre>                            <span class="token string">""</span></pre></td></tr><tr><td data-num="131"></td><td><pre>                        <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="132"></td><td><pre>                        <span class="token comment">// 设置 Overlapped 结构的成员</span></pre></td></tr><tr><td data-num="133"></td><td><pre>                        HIDOverlapped<span class="token punctuation">.</span>hEvent <span class="token operator">=</span> hEventObject<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="134"></td><td><pre>                        HIDOverlapped<span class="token punctuation">.</span>Offset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="135"></td><td><pre>                        HIDOverlapped<span class="token punctuation">.</span>OffsetHigh <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="136"></td><td><pre>                    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="137"></td><td><pre></pre></td></tr><tr><td data-num="138"></td><td><pre>                    <span class="token comment">// 创建写入句柄</span></pre></td></tr><tr><td data-num="139"></td><td><pre>                    WriteHandle <span class="token operator">=</span> <span class="token function">CreateFile</span><span class="token punctuation">(</span></pre></td></tr><tr><td data-num="140"></td><td><pre>                        detailData<span class="token operator">-></span>DevicePath<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="141"></td><td><pre>                        GENERIC_WRITE<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="142"></td><td><pre>                        FILE_SHARE_READ <span class="token operator">|</span> FILE_SHARE_WRITE<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="143"></td><td><pre>                        <span class="token punctuation">(</span>LPSECURITY_ATTRIBUTES<span class="token punctuation">)</span><span class="token constant">NULL</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="144"></td><td><pre>                        OPEN_EXISTING<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="145"></td><td><pre>                        FILE_ATTRIBUTE_NORMAL<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="146"></td><td><pre>                        <span class="token constant">NULL</span></pre></td></tr><tr><td data-num="147"></td><td><pre>                    <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="148"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="149"></td><td><pre>                <span class="token keyword">else</span></pre></td></tr><tr><td data-num="150"></td><td><pre>                <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="151"></td><td><pre>                    <span class="token comment">// 产品 ID 不匹配，关闭设备句柄</span></pre></td></tr><tr><td data-num="152"></td><td><pre>                    <span class="token function">CloseHandle</span><span class="token punctuation">(</span>DeviceHandle<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="153"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="154"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="155"></td><td><pre>            <span class="token keyword">else</span></pre></td></tr><tr><td data-num="156"></td><td><pre>            <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="157"></td><td><pre>                <span class="token comment">// 供应商 ID 不匹配，关闭设备句柄</span></pre></td></tr><tr><td data-num="158"></td><td><pre>                <span class="token function">CloseHandle</span><span class="token punctuation">(</span>DeviceHandle<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="159"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="160"></td><td><pre></pre></td></tr><tr><td data-num="161"></td><td><pre>            <span class="token comment">// 释放 detailData 结构占用的内存</span></pre></td></tr><tr><td data-num="162"></td><td><pre>            <span class="token function">free</span><span class="token punctuation">(</span>detailData<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="163"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="164"></td><td><pre>        <span class="token keyword">else</span></pre></td></tr><tr><td data-num="165"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="166"></td><td><pre>            <span class="token comment">// 枚举设备接口失败，没有更多设备可用</span></pre></td></tr><tr><td data-num="167"></td><td><pre>            LastDevice <span class="token operator">=</span> TRUE<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="168"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="169"></td><td><pre></pre></td></tr><tr><td data-num="170"></td><td><pre>        <span class="token comment">// 如果还未找到目标设备，并且还有可用设备，尝试下一个</span></pre></td></tr><tr><td data-num="171"></td><td><pre>        MemberIndex <span class="token operator">=</span> MemberIndex <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="172"></td><td><pre></pre></td></tr><tr><td data-num="173"></td><td><pre>    <span class="token punctuation">&#125;</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>LastDevice <span class="token operator">==</span> FALSE<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>MyDeviceDetected <span class="token operator">==</span> FALSE<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="174"></td><td><pre></pre></td></tr><tr><td data-num="175"></td><td><pre>    <span class="token comment">// 释放 SetupDiClassDevs 保留的内存</span></pre></td></tr><tr><td data-num="176"></td><td><pre>    <span class="token function">SetupDiDestroyDeviceInfoList</span><span class="token punctuation">(</span>hDevInfo<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="177"></td><td><pre></pre></td></tr><tr><td data-num="178"></td><td><pre>    <span class="token keyword">return</span> MyDeviceDetected<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="179"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h4 id="teaencrypt"><a class="anchor" href="#teaencrypt">#</a> TeaEncrypt</h4><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// 函数：TEA 加密</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment">// 描述：使用 Tiny Encryption Algorithm（TEA）对数据进行加密</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">// 参数：</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment">//- v: 待加密的数据数组</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment">//- n: 数据数组的长度</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment">//- k: 加密密钥数组（4 个无符号整数）</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">void</span> <span class="token function">TeaEncrypt</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token operator">*</span>v<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> n<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token operator">*</span>k<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> z<span class="token punctuation">,</span> y<span class="token punctuation">,</span> sum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> e<span class="token punctuation">,</span> DELTA <span class="token operator">=</span> <span class="token number">0x9e3779b9</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token keyword">long</span> p<span class="token punctuation">,</span> q<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre>    z <span class="token operator">=</span> v<span class="token punctuation">[</span>n <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    y <span class="token operator">=</span> v<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    q <span class="token operator">=</span> <span class="token number">6</span> <span class="token operator">+</span> <span class="token number">52</span> <span class="token operator">/</span> n<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token keyword">while</span> <span class="token punctuation">(</span>q<span class="token operator">--</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        sum <span class="token operator">+=</span> DELTA<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        e <span class="token operator">=</span> <span class="token punctuation">(</span>sum <span class="token operator">>></span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">3</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        <span class="token keyword">for</span> <span class="token punctuation">(</span>p <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> p <span class="token operator">&lt;</span> n <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> p<span class="token operator">++</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="20"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>            y <span class="token operator">=</span> v<span class="token punctuation">[</span>p <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>            z <span class="token operator">=</span> v<span class="token punctuation">[</span>p<span class="token punctuation">]</span> <span class="token operator">+=</span> <span class="token punctuation">(</span>z <span class="token operator">>></span> <span class="token number">5</span> <span class="token operator">^</span> y <span class="token operator">&lt;&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>y <span class="token operator">>></span> <span class="token number">3</span> <span class="token operator">^</span> z <span class="token operator">&lt;&lt;</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token punctuation">(</span>sum <span class="token operator">^</span> y<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>k<span class="token punctuation">[</span>p <span class="token operator">&amp;</span> <span class="token number">3</span> <span class="token operator">^</span> e<span class="token punctuation">]</span> <span class="token operator">^</span> z<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        y <span class="token operator">=</span> v<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>        z <span class="token operator">=</span> v<span class="token punctuation">[</span>n <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+=</span> <span class="token punctuation">(</span>z <span class="token operator">>></span> <span class="token number">5</span> <span class="token operator">^</span> y <span class="token operator">&lt;&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>y <span class="token operator">>></span> <span class="token number">3</span> <span class="token operator">^</span> z <span class="token operator">&lt;&lt;</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token punctuation">(</span>sum <span class="token operator">^</span> y<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>k<span class="token punctuation">[</span>p <span class="token operator">&amp;</span> <span class="token number">3</span> <span class="token operator">^</span> e<span class="token punctuation">]</span> <span class="token operator">^</span> z<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h4 id="teadecrypt"><a class="anchor" href="#teadecrypt">#</a> TeaDecrypt</h4><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// 函数：TEA 解密</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment">// 描述：使用 Tiny Encryption Algorithm（TEA）对数据进行解密</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">// 参数：</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment">//- v: 待解密的数据数组</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment">//- n: 数据数组的长度</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment">//- k: 解密密钥数组（4 个无符号整数）</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">void</span> <span class="token function">TeaDecrypt</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token operator">*</span>v<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> n<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token operator">*</span>k<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token comment">// n > 1</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> z<span class="token punctuation">,</span> y<span class="token punctuation">,</span> sum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> e<span class="token punctuation">,</span> DELTA <span class="token operator">=</span> <span class="token number">0x9e3779b9</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token keyword">long</span> p<span class="token punctuation">,</span> q<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre>    y <span class="token operator">=</span> v<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    q <span class="token operator">=</span> <span class="token number">6</span> <span class="token operator">+</span> <span class="token number">52</span> <span class="token operator">/</span> n<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    sum <span class="token operator">=</span> q <span class="token operator">*</span> DELTA<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token keyword">while</span> <span class="token punctuation">(</span>sum <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        e <span class="token operator">=</span> <span class="token punctuation">(</span>sum <span class="token operator">>></span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">3</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        <span class="token keyword">for</span> <span class="token punctuation">(</span>p <span class="token operator">=</span> n <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> p <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">;</span> p<span class="token operator">--</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="20"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>            z <span class="token operator">=</span> v<span class="token punctuation">[</span>p <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>            y <span class="token operator">=</span> v<span class="token punctuation">[</span>p<span class="token punctuation">]</span> <span class="token operator">-=</span> <span class="token punctuation">(</span>z <span class="token operator">>></span> <span class="token number">5</span> <span class="token operator">^</span> y <span class="token operator">&lt;&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>y <span class="token operator">>></span> <span class="token number">3</span> <span class="token operator">^</span> z <span class="token operator">&lt;&lt;</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token punctuation">(</span>sum <span class="token operator">^</span> y<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>k<span class="token punctuation">[</span>p <span class="token operator">&amp;</span> <span class="token number">3</span> <span class="token operator">^</span> e<span class="token punctuation">]</span> <span class="token operator">^</span> z<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        z <span class="token operator">=</span> v<span class="token punctuation">[</span>n <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>        y <span class="token operator">=</span> v<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">-=</span> <span class="token punctuation">(</span>z <span class="token operator">>></span> <span class="token number">5</span> <span class="token operator">^</span> y <span class="token operator">&lt;&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>y <span class="token operator">>></span> <span class="token number">3</span> <span class="token operator">^</span> z <span class="token operator">&lt;&lt;</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token punctuation">(</span>sum <span class="token operator">^</span> y<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>k<span class="token punctuation">[</span>p <span class="token operator">&amp;</span> <span class="token number">3</span> <span class="token operator">^</span> e<span class="token punctuation">]</span> <span class="token operator">^</span> z<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>        sum <span class="token operator">-=</span> DELTA<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="28"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h4 id="fp_chech"><a class="anchor" href="#fp_chech">#</a> FP_CHECH</h4><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// 函数：FP_CHECH</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment">// 描述：进行指纹检查，向设备发送指纹检查命令并读取响应</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">// 返回值：指向响应数据的指针，如果发生错误则返回空指针</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token function">FP_CHECH</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    DWORD Result<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token comment">// 准备发送给设备的数据</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">65</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token function">memset</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">65</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    buf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x00</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    buf<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x55</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    buf<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x7A</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    buf<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x04</span><span class="token punctuation">;</span> <span class="token comment">// 命令长度</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    buf<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x50</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    buf<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x11</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token function">crc_calc</span><span class="token punctuation">(</span>buf <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 计算 CRC 校验码</span></pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token comment">// 向设备发送数据</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token function">WriteOutputReport</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token comment">// 读取设备响应</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>ReadHandle <span class="token operator">!=</span> INVALID_HANDLE_VALUE<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>        Result <span class="token operator">=</span> <span class="token function">ReadFile</span><span class="token punctuation">(</span>ReadHandle<span class="token punctuation">,</span> InputReport<span class="token punctuation">,</span> Capabilities<span class="token punctuation">.</span>InputReportByteLength<span class="token punctuation">,</span> <span class="token operator">&amp;</span>NumberOfBytesRead<span class="token punctuation">,</span> <span class="token punctuation">(</span>LPOVERLAPPED<span class="token punctuation">)</span> <span class="token operator">&amp;</span>HIDOverlapped<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token keyword">else</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>        <span class="token comment">// 设备句柄无效，返回空指针</span></pre></td></tr><tr><td data-num="30"></td><td><pre>        <span class="token keyword">return</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="32"></td><td><pre></pre></td></tr><tr><td data-num="33"></td><td><pre>    <span class="token comment">// 等待读取完成或超时</span></pre></td></tr><tr><td data-num="34"></td><td><pre>    Result <span class="token operator">=</span> <span class="token function">WaitForSingleObject</span><span class="token punctuation">(</span>hEventObject<span class="token punctuation">,</span> <span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre></pre></td></tr><tr><td data-num="36"></td><td><pre>    <span class="token keyword">switch</span> <span class="token punctuation">(</span>Result<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="37"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>        <span class="token keyword">case</span> WAIT_OBJECT_0<span class="token operator">:</span> <span class="token comment">// 读取完成</span></pre></td></tr><tr><td data-num="39"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>            <span class="token function">ResetEvent</span><span class="token punctuation">(</span>hEventObject<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>            <span class="token function">CloseHandles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>            <span class="token comment">// 返回响应数据指针</span></pre></td></tr><tr><td data-num="43"></td><td><pre>            <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>InputReport <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>        <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>        <span class="token keyword">case</span> WAIT_TIMEOUT<span class="token operator">:</span> <span class="token comment">// 超时</span></pre></td></tr><tr><td data-num="47"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>            <span class="token function">ResetEvent</span><span class="token punctuation">(</span>hEventObject<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="50"></td><td><pre>        <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="51"></td><td><pre>        <span class="token keyword">default</span><span class="token operator">:</span> <span class="token comment">// 其他错误</span></pre></td></tr><tr><td data-num="52"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="53"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="54"></td><td><pre>        <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="55"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="56"></td><td><pre></pre></td></tr><tr><td data-num="57"></td><td><pre>    <span class="token comment">// 关闭句柄并返回空指针</span></pre></td></tr><tr><td data-num="58"></td><td><pre>    <span class="token keyword">return</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="59"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h4 id="fp_reg"><a class="anchor" href="#fp_reg">#</a> FP_REG</h4><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// 函数：FP_REG</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment">// 描述：进行指纹注册，向设备发送指纹注册命令并读取响应</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">// 参数：index - 指纹索引</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment">// 返回值：指向响应数据的指针，如果发生错误则返回空指针</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token function">FP_REG</span><span class="token punctuation">(</span><span class="token keyword">int</span> index<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    DWORD Result<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token comment">// 计算索引偏移量</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token keyword">char</span> off1 <span class="token operator">=</span> index <span class="token operator">/</span> <span class="token number">256</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token keyword">char</span> off2 <span class="token operator">=</span> index <span class="token operator">%</span> <span class="token number">256</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token comment">// 准备发送给设备的数据</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">65</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token function">memset</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">65</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    buf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x00</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    buf<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x55</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    buf<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x7A</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    buf<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x06</span><span class="token punctuation">;</span> <span class="token comment">// 命令长度</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    buf<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x50</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    buf<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x12</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    buf<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span> <span class="token operator">=</span> off1<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    buf<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span> <span class="token operator">=</span> off2<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token function">crc_calc</span><span class="token punctuation">(</span>buf <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 计算 CRC 校验码</span></pre></td></tr><tr><td data-num="25"></td><td><pre></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token comment">// 向设备发送数据</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token function">WriteOutputReport</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre></pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token comment">// 读取设备响应</span></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>ReadHandle <span class="token operator">!=</span> INVALID_HANDLE_VALUE<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>        Result <span class="token operator">=</span> <span class="token function">ReadFile</span><span class="token punctuation">(</span>ReadHandle<span class="token punctuation">,</span> InputReport<span class="token punctuation">,</span> Capabilities<span class="token punctuation">.</span>InputReportByteLength<span class="token punctuation">,</span> <span class="token operator">&amp;</span>NumberOfBytesRead<span class="token punctuation">,</span> <span class="token punctuation">(</span>LPOVERLAPPED<span class="token punctuation">)</span> <span class="token operator">&amp;</span>HIDOverlapped<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>    <span class="token keyword">else</span></pre></td></tr><tr><td data-num="35"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>        <span class="token comment">// 设备句柄无效，返回空指针</span></pre></td></tr><tr><td data-num="37"></td><td><pre>        <span class="token keyword">return</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="39"></td><td><pre></pre></td></tr><tr><td data-num="40"></td><td><pre>    <span class="token comment">// 等待读取完成或超时</span></pre></td></tr><tr><td data-num="41"></td><td><pre>    Result <span class="token operator">=</span> <span class="token function">WaitForSingleObject</span><span class="token punctuation">(</span>hEventObject<span class="token punctuation">,</span> <span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre></pre></td></tr><tr><td data-num="43"></td><td><pre>    <span class="token keyword">switch</span> <span class="token punctuation">(</span>Result<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="44"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>        <span class="token keyword">case</span> WAIT_OBJECT_0<span class="token operator">:</span> <span class="token comment">// 读取完成</span></pre></td></tr><tr><td data-num="46"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>            <span class="token function">ResetEvent</span><span class="token punctuation">(</span>hEventObject<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>            <span class="token function">CloseHandles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>            <span class="token comment">// 返回响应数据指针</span></pre></td></tr><tr><td data-num="50"></td><td><pre>            <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>InputReport <span class="token operator">+</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="51"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="52"></td><td><pre>        <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="53"></td><td><pre>        <span class="token keyword">case</span> WAIT_TIMEOUT<span class="token operator">:</span> <span class="token comment">// 超时</span></pre></td></tr><tr><td data-num="54"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="55"></td><td><pre>            <span class="token function">ResetEvent</span><span class="token punctuation">(</span>hEventObject<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="56"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="57"></td><td><pre>        <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="58"></td><td><pre>        <span class="token keyword">default</span><span class="token operator">:</span> <span class="token comment">// 其他错误</span></pre></td></tr><tr><td data-num="59"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="60"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="61"></td><td><pre>        <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="62"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="63"></td><td><pre></pre></td></tr><tr><td data-num="64"></td><td><pre>    <span class="token comment">// 关闭句柄并返回空指针</span></pre></td></tr><tr><td data-num="65"></td><td><pre>    <span class="token keyword">return</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="66"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h4 id="fp_del"><a class="anchor" href="#fp_del">#</a> FP_DEL</h4><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// 函数：FP_DEL</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment">// 描述：删除指定索引范围内的指纹数据，向设备发送删除命令并读取响应</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">// 参数：index1 - 起始索引，index2 - 结束索引</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment">// 返回值：指向响应数据的指针，如果发生错误则返回空指针</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token function">FP_DEL</span><span class="token punctuation">(</span><span class="token keyword">int</span> index1<span class="token punctuation">,</span> <span class="token keyword">int</span> index2<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    DWORD Result<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token comment">// 准备发送给设备的数据</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">65</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token function">memset</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">65</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    buf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x00</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    buf<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x55</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    buf<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x7A</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    buf<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x08</span><span class="token punctuation">;</span> <span class="token comment">// 命令长度</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    buf<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x50</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    buf<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x13</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    buf<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span> <span class="token operator">=</span> index1 <span class="token operator">/</span> <span class="token number">256</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    buf<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span> <span class="token operator">=</span> index1 <span class="token operator">%</span> <span class="token number">256</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    buf<span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span> <span class="token operator">=</span> index2 <span class="token operator">/</span> <span class="token number">256</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    buf<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span> <span class="token operator">=</span> index2 <span class="token operator">%</span> <span class="token number">256</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token function">crc_calc</span><span class="token punctuation">(</span>buf <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 计算 CRC 校验码</span></pre></td></tr><tr><td data-num="23"></td><td><pre></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token comment">// 向设备发送数据</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token function">WriteOutputReport</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token comment">// 读取设备响应</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>ReadHandle <span class="token operator">!=</span> INVALID_HANDLE_VALUE<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>        Result <span class="token operator">=</span> <span class="token function">ReadFile</span><span class="token punctuation">(</span>ReadHandle<span class="token punctuation">,</span> InputReport<span class="token punctuation">,</span> Capabilities<span class="token punctuation">.</span>InputReportByteLength<span class="token punctuation">,</span> <span class="token operator">&amp;</span>NumberOfBytesRead<span class="token punctuation">,</span> <span class="token punctuation">(</span>LPOVERLAPPED<span class="token punctuation">)</span> <span class="token operator">&amp;</span>HIDOverlapped<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>    <span class="token keyword">else</span></pre></td></tr><tr><td data-num="33"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>        <span class="token comment">// 设备句柄无效，返回空指针</span></pre></td></tr><tr><td data-num="35"></td><td><pre>        <span class="token keyword">return</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="37"></td><td><pre></pre></td></tr><tr><td data-num="38"></td><td><pre>    <span class="token comment">// 等待读取完成或超时</span></pre></td></tr><tr><td data-num="39"></td><td><pre>    Result <span class="token operator">=</span> <span class="token function">WaitForSingleObject</span><span class="token punctuation">(</span>hEventObject<span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="40"></td><td><pre></pre></td></tr><tr><td data-num="41"></td><td><pre>    <span class="token keyword">switch</span> <span class="token punctuation">(</span>Result<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="42"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>        <span class="token keyword">case</span> WAIT_OBJECT_0<span class="token operator">:</span> <span class="token comment">// 读取完成</span></pre></td></tr><tr><td data-num="44"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>            <span class="token function">ResetEvent</span><span class="token punctuation">(</span>hEventObject<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>            <span class="token comment">// 返回响应数据指针</span></pre></td></tr><tr><td data-num="47"></td><td><pre>            <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>InputReport <span class="token operator">+</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>        <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="50"></td><td><pre>        <span class="token keyword">case</span> WAIT_TIMEOUT<span class="token operator">:</span> <span class="token comment">// 超时</span></pre></td></tr><tr><td data-num="51"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="52"></td><td><pre>            <span class="token function">ResetEvent</span><span class="token punctuation">(</span>hEventObject<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="53"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="54"></td><td><pre>        <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="55"></td><td><pre>        <span class="token keyword">default</span><span class="token operator">:</span> <span class="token comment">// 其他错误</span></pre></td></tr><tr><td data-num="56"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="57"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="58"></td><td><pre>        <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="59"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="60"></td><td><pre></pre></td></tr><tr><td data-num="61"></td><td><pre>    <span class="token comment">// 返回空指针</span></pre></td></tr><tr><td data-num="62"></td><td><pre>    <span class="token keyword">return</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="63"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h4 id="get_sn"><a class="anchor" href="#get_sn">#</a> GET_SN</h4><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// 函数：GET_SN</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment">// 描述：获取设备的序列号，向设备发送获取序列号命令并读取响应</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">// 返回值：指向设备序列号的指针，如果发生错误则返回空指针</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token function">GET_SN</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    DWORD Result<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token comment">// 准备发送给设备的数据</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">65</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token function">memset</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">65</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    buf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x00</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    buf<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x55</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    buf<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x7A</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    buf<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x05</span><span class="token punctuation">;</span> <span class="token comment">// 命令长度</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    buf<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x7c</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    buf<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x00</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    buf<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x08</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token function">crc_calc</span><span class="token punctuation">(</span>buf <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 计算 CRC 校验码</span></pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token comment">// 向设备发送数据</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token function">WriteOutputReport</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token comment">// 读取设备响应</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>ReadHandle <span class="token operator">!=</span> INVALID_HANDLE_VALUE<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>        Result <span class="token operator">=</span> <span class="token function">ReadFile</span><span class="token punctuation">(</span>ReadHandle<span class="token punctuation">,</span> InputReport<span class="token punctuation">,</span> Capabilities<span class="token punctuation">.</span>InputReportByteLength<span class="token punctuation">,</span> <span class="token operator">&amp;</span>NumberOfBytesRead<span class="token punctuation">,</span> <span class="token punctuation">(</span>LPOVERLAPPED<span class="token punctuation">)</span> <span class="token operator">&amp;</span>HIDOverlapped<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token keyword">else</span></pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>        <span class="token comment">// 设备句柄无效，返回空指针</span></pre></td></tr><tr><td data-num="31"></td><td><pre>        <span class="token keyword">return</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="33"></td><td><pre></pre></td></tr><tr><td data-num="34"></td><td><pre>    <span class="token comment">// 等待读取完成或超时</span></pre></td></tr><tr><td data-num="35"></td><td><pre>    Result <span class="token operator">=</span> <span class="token function">WaitForSingleObject</span><span class="token punctuation">(</span>hEventObject<span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre></pre></td></tr><tr><td data-num="37"></td><td><pre>    <span class="token keyword">switch</span> <span class="token punctuation">(</span>Result<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="38"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>        <span class="token keyword">case</span> WAIT_OBJECT_0<span class="token operator">:</span> <span class="token comment">// 读取完成</span></pre></td></tr><tr><td data-num="40"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>            <span class="token function">ResetEvent</span><span class="token punctuation">(</span>hEventObject<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>            <span class="token comment">// 返回序列号数据指针</span></pre></td></tr><tr><td data-num="43"></td><td><pre>            <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>InputReport <span class="token operator">+</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>        <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>        <span class="token keyword">case</span> WAIT_TIMEOUT<span class="token operator">:</span> <span class="token comment">// 超时</span></pre></td></tr><tr><td data-num="47"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>            <span class="token function">ResetEvent</span><span class="token punctuation">(</span>hEventObject<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="50"></td><td><pre>        <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="51"></td><td><pre>        <span class="token keyword">default</span><span class="token operator">:</span> <span class="token comment">// 其他错误</span></pre></td></tr><tr><td data-num="52"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="53"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="54"></td><td><pre>        <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="55"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="56"></td><td><pre></pre></td></tr><tr><td data-num="57"></td><td><pre>    <span class="token comment">// 返回空指针</span></pre></td></tr><tr><td data-num="58"></td><td><pre>    <span class="token keyword">return</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="59"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h4 id="del_id"><a class="anchor" href="#del_id">#</a> DEL_ID</h4><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// 函数：DEL_ID</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment">// 描述：从设备中删除指纹 ID</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">// 返回值：指向删除操作结果的指针，如果发生错误则返回空指针</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token function">DEL_ID</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    DWORD Result<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token comment">// 准备发送给设备的数据</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">65</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token function">memset</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">65</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    buf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x00</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    buf<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x55</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    buf<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x7A</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    buf<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x04</span><span class="token punctuation">;</span> <span class="token comment">// 命令长度</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    buf<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x7d</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    buf<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x00</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token function">crc_calc</span><span class="token punctuation">(</span>buf <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 计算 CRC 校验码</span></pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token comment">// 向设备发送数据</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token function">WriteOutputReport</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token comment">// 读取设备响应</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>ReadHandle <span class="token operator">!=</span> INVALID_HANDLE_VALUE<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>        Result <span class="token operator">=</span> <span class="token function">ReadFile</span><span class="token punctuation">(</span>ReadHandle<span class="token punctuation">,</span> InputReport<span class="token punctuation">,</span> Capabilities<span class="token punctuation">.</span>InputReportByteLength<span class="token punctuation">,</span> <span class="token operator">&amp;</span>NumberOfBytesRead<span class="token punctuation">,</span> <span class="token punctuation">(</span>LPOVERLAPPED<span class="token punctuation">)</span> <span class="token operator">&amp;</span>HIDOverlapped<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token keyword">else</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>        <span class="token comment">// 设备句柄无效，返回空指针</span></pre></td></tr><tr><td data-num="30"></td><td><pre>        <span class="token keyword">return</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="32"></td><td><pre></pre></td></tr><tr><td data-num="33"></td><td><pre>    <span class="token comment">// 等待读取完成或超时</span></pre></td></tr><tr><td data-num="34"></td><td><pre>    Result <span class="token operator">=</span> <span class="token function">WaitForSingleObject</span><span class="token punctuation">(</span>hEventObject<span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre></pre></td></tr><tr><td data-num="36"></td><td><pre>    <span class="token keyword">switch</span> <span class="token punctuation">(</span>Result<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="37"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>        <span class="token keyword">case</span> WAIT_OBJECT_0<span class="token operator">:</span> <span class="token comment">// 读取完成</span></pre></td></tr><tr><td data-num="39"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>            <span class="token function">ResetEvent</span><span class="token punctuation">(</span>hEventObject<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>            <span class="token comment">// 返回删除操作结果指针</span></pre></td></tr><tr><td data-num="42"></td><td><pre>            <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>InputReport <span class="token operator">+</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>        <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>        <span class="token keyword">case</span> WAIT_TIMEOUT<span class="token operator">:</span> <span class="token comment">// 超时</span></pre></td></tr><tr><td data-num="46"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>            <span class="token function">ResetEvent</span><span class="token punctuation">(</span>hEventObject<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>        <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="50"></td><td><pre>        <span class="token keyword">default</span><span class="token operator">:</span> <span class="token comment">// 其他错误</span></pre></td></tr><tr><td data-num="51"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="52"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="53"></td><td><pre>        <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="54"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="55"></td><td><pre></pre></td></tr><tr><td data-num="56"></td><td><pre>    <span class="token comment">// 返回空指针</span></pre></td></tr><tr><td data-num="57"></td><td><pre>    <span class="token keyword">return</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="58"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h4 id="add_id"><a class="anchor" href="#add_id">#</a> ADD_ID</h4><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// 函数：ADD_ID</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment">// 描述：向设备中添加指纹 ID</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">// 参数：</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment">//   - data: 指向包含要添加的指纹 ID 数据的指针</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment">// 返回值：指向添加操作结果的指针，如果发生错误则返回空指针</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token function">ADD_ID</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>data<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    DWORD Result<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token comment">// 准备发送给设备的数据</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">65</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token function">memset</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">65</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    buf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x00</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    buf<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x55</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    buf<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x7A</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    buf<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x15</span><span class="token punctuation">;</span> <span class="token comment">// 命令长度</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    buf<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x7e</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token function">memcpy</span><span class="token punctuation">(</span>buf <span class="token operator">+</span> <span class="token number">6</span><span class="token punctuation">,</span> data<span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 将指纹 ID 数据复制到缓冲区中</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token function">crc_calc</span><span class="token punctuation">(</span>buf <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">0x17</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 计算 CRC 校验码</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token function">WriteOutputReport</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token comment">// 循环读取设备响应</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>        <span class="token comment">// 读取设备响应</span></pre></td></tr><tr><td data-num="26"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>ReadHandle <span class="token operator">!=</span> INVALID_HANDLE_VALUE<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="27"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>            Result <span class="token operator">=</span> <span class="token function">ReadFile</span><span class="token punctuation">(</span>ReadHandle<span class="token punctuation">,</span> InputReport<span class="token punctuation">,</span> Capabilities<span class="token punctuation">.</span>InputReportByteLength<span class="token punctuation">,</span> <span class="token operator">&amp;</span>NumberOfBytesRead<span class="token punctuation">,</span> <span class="token punctuation">(</span>LPOVERLAPPED<span class="token punctuation">)</span> <span class="token operator">&amp;</span>HIDOverlapped<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>        <span class="token keyword">else</span></pre></td></tr><tr><td data-num="31"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>            <span class="token comment">// 设备句柄无效，返回空指针</span></pre></td></tr><tr><td data-num="33"></td><td><pre>            <span class="token keyword">return</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="35"></td><td><pre></pre></td></tr><tr><td data-num="36"></td><td><pre>        Result <span class="token operator">=</span> <span class="token function">WaitForSingleObject</span><span class="token punctuation">(</span>hEventObject<span class="token punctuation">,</span> <span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 等待读取完成或超时</span></pre></td></tr><tr><td data-num="37"></td><td><pre></pre></td></tr><tr><td data-num="38"></td><td><pre>        <span class="token keyword">switch</span> <span class="token punctuation">(</span>Result<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="39"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>            <span class="token keyword">case</span> WAIT_OBJECT_0<span class="token operator">:</span> <span class="token comment">// 读取完成</span></pre></td></tr><tr><td data-num="41"></td><td><pre>            <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>                <span class="token keyword">if</span> <span class="token punctuation">(</span>InputReport<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token number">0x7E</span><span class="token punctuation">)</span> <span class="token comment">// 检查响应是否为添加成功的标志</span></pre></td></tr><tr><td data-num="43"></td><td><pre>                <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>                    <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>                <span class="token keyword">else</span></pre></td></tr><tr><td data-num="47"></td><td><pre>                <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>                    <span class="token function">ResetEvent</span><span class="token punctuation">(</span>hEventObject<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>                    <span class="token function">CloseHandles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="50"></td><td><pre>                    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>InputReport <span class="token operator">+</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 返回添加操作结果指针</span></pre></td></tr><tr><td data-num="51"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="52"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="53"></td><td><pre>            <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="54"></td><td><pre>            <span class="token keyword">case</span> WAIT_TIMEOUT<span class="token operator">:</span> <span class="token comment">// 超时</span></pre></td></tr><tr><td data-num="55"></td><td><pre>            <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="56"></td><td><pre>                <span class="token function">ResetEvent</span><span class="token punctuation">(</span>hEventObject<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="57"></td><td><pre>                <span class="token keyword">return</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="58"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="59"></td><td><pre>            <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="60"></td><td><pre>            <span class="token keyword">default</span><span class="token operator">:</span> <span class="token comment">// 其他错误</span></pre></td></tr><tr><td data-num="61"></td><td><pre>            <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="62"></td><td><pre>                <span class="token keyword">return</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="63"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="64"></td><td><pre>            <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="65"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="66"></td><td><pre>        <span class="token keyword">continue</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="67"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="68"></td><td><pre>    <span class="token keyword">return</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="69"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h4 id="write_log_file"><a class="anchor" href="#write_log_file">#</a> write_log_file</h4><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// 函数：write_log_file</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment">// 描述：向日志文件中写入字符串</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">// 参数：</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment">//   - str: 要写入的字符串</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment">// 返回值：写入操作的状态，0 表示成功，-1 表示失败</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">int</span> <span class="token function">write_log_file</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>str<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    FILE <span class="token operator">*</span>file <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span><span class="token string">"data.txt"</span><span class="token punctuation">,</span> <span class="token string">"a+"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 打开日志文件，以追加方式写入</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>file <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token comment">// 文件打开失败，可以选择退出或者其他处理方式</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> len <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> wlen <span class="token operator">=</span> <span class="token function">fwrite</span><span class="token punctuation">(</span>str<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span><span class="token punctuation">,</span> len<span class="token punctuation">,</span> file<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 将字符串写入文件</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token function">fputc</span><span class="token punctuation">(</span><span class="token char">'\n'</span><span class="token punctuation">,</span> file<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 写入换行符</span></pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>len <span class="token operator">!=</span> wlen<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>        <span class="token comment">// 写入长度不匹配，可能发生了写入错误，可以选择退出或者其他处理方式</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token function">fclose</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="25"></td><td><pre></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token function">fclose</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 关闭文件</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 返回写入成功状态</span></pre></td></tr><tr><td data-num="28"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><div class="tags"><a href="/tags/%E7%86%9F%E6%82%89%E9%A1%B9%E7%9B%AE/" rel="tag"><i class="ic i-tag"></i> 熟悉项目</a></div></div><footer><div class="meta"><span class="item"><span class="icon"><i class="ic i-calendar-check"></i> </span><span class="text">更新于</span> <time title="修改时间：2024-05-08 20:25:01" itemprop="dateModified" datetime="2024-05-08T20:25:01+08:00">2024-05-08</time> </span><span id="2024/04/10/other/u盾/" class="item leancloud_visitors" data-flag-title="U盾项目代码熟悉" title="阅读次数"><span class="icon"><i class="ic i-eye"></i> </span><span class="text">阅读次数</span> <span class="leancloud-visitors-count"></span> <span class="text">次</span></span></div><div class="reward"><button><i class="ic i-heartbeat"></i> 赞赏</button><p>请我喝[茶]~(￣▽￣)~*</p><div id="qr"><div><img data-src="/images/wechatpay.png" alt="洪宽 微信支付"><p>微信支付</p></div><div><img data-src="/images/alipay.png" alt="洪宽 支付宝"><p>支付宝</p></div><div><img data-src="/images/paypal.png" alt="洪宽 贝宝"><p>贝宝</p></div></div></div><div id="copyright"><ul><li class="author"><strong>本文博主： </strong>洪宽 <i class="ic i-at"><em>@</em></i>流年印记</li><li class="link"><strong>本文链接：</strong> <a href="https://hk2012.github.io/2024/04/10/other/u%E7%9B%BE/" title="U盾项目代码熟悉">https://hk2012.github.io/2024/04/10/other/u盾/</a></li><li class="license"><strong>版权声明： </strong>本站所有文章除特别声明外，均采用 <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> 许可协议。转载请注明出处！</li></ul></div></footer></article></div><div class="post-nav"><div class="item left"><a href="/2024/04/10/course/%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%AD%A6%E4%B9%A0%E5%92%8C%E5%BC%80%E5%8F%91/" itemprop="url" rel="prev" data-background-image="https:&#x2F;&#x2F;www.loliapi.com&#x2F;acg&#x2F;?205685" title="嵌入式学习和开发"><span class="type">上一篇</span> <span class="category"><i class="ic i-flag"></i> JAVA</span><h3>嵌入式学习和开发</h3></a></div><div class="item right"><a href="/2024/04/24/doc/%E4%BB%8B%E7%BB%8D%E7%BA%BF%E7%A8%8B%E7%9A%84%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E5%92%8C%E7%8A%B6%E6%80%81/" itemprop="url" rel="next" data-background-image="https:&#x2F;&#x2F;www.loliapi.com&#x2F;acg&#x2F;?396358" title="介绍线程的生命周期和状态"><span class="type">下一篇</span> <span class="category"><i class="ic i-flag"></i> 文档</span><h3>介绍线程的生命周期和状态</h3></a></div></div><div class="wrap" id="comments"></div></div><div id="sidebar"><div class="inner"><div class="panels"><div class="inner"><div class="contents panel pjax" data-title="文章目录"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90"><span class="toc-number">1.</span> <span class="toc-text">代码分析</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#natchost-v1"><span class="toc-number">1.1.</span> <span class="toc-text">natchost-v1</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%9F%E5%A7%8B%E4%BB%A3%E7%A0%81"><span class="toc-number">1.1.1.</span> <span class="toc-text">原始代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B4%E7%90%86%E5%90%8E%E7%9A%84%E4%BB%A3%E7%A0%81"><span class="toc-number">1.1.2.</span> <span class="toc-text">整理后的代码</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%B2%BE%E7%AE%80%E4%B9%8B%E5%90%8E%E7%9A%84%E4%BB%A3%E7%A0%81"><span class="toc-number">1.1.2.1.</span> <span class="toc-text">精简之后的代码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8F%90%E9%AB%98%E4%BB%A3%E7%A0%81%E6%B8%85%E6%99%B0%E5%BA%A6"><span class="toc-number">1.1.2.2.</span> <span class="toc-text">提高代码清晰度</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#demo1"><span class="toc-number">1.2.</span> <span class="toc-text">demo1</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%9F%E5%A7%8B%E4%BB%A3%E7%A0%81-2"><span class="toc-number">1.2.1.</span> <span class="toc-text">原始代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E7%BB%93%E6%9E%84"><span class="toc-number">1.2.2.</span> <span class="toc-text">代码结构</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#testconnect"><span class="toc-number">1.2.2.1.</span> <span class="toc-text">TestConnect</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#cleanfile"><span class="toc-number">1.2.2.2.</span> <span class="toc-text">CleanFile</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#getcheck"><span class="toc-number">1.2.2.3.</span> <span class="toc-text">GetCheck</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#writeprivateprofileint"><span class="toc-number">1.2.2.4.</span> <span class="toc-text">WritePrivateProfileInt</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#encodeimage"><span class="toc-number">1.2.2.5.</span> <span class="toc-text">EncodeImage</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#readcard"><span class="toc-number">1.2.2.6.</span> <span class="toc-text">ReadCard</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ffconnect"><span class="toc-number">1.2.2.7.</span> <span class="toc-text">ffconnect</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#collterminalsn"><span class="toc-number">1.2.2.8.</span> <span class="toc-text">collTerminalSN</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#collidnumber"><span class="toc-number">1.2.2.9.</span> <span class="toc-text">collIdNumber</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#collfingerprint"><span class="toc-number">1.2.2.10.</span> <span class="toc-text">collFingerPrint</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#deletefingerprints"><span class="toc-number">1.2.2.11.</span> <span class="toc-text">deleteFingerprints</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#verify"><span class="toc-number">1.2.2.12.</span> <span class="toc-text">verify</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#initinstance"><span class="toc-number">1.2.2.13.</span> <span class="toc-text">InitInstance</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#usb_thread"><span class="toc-number">1.3.</span> <span class="toc-text">usb_thread</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%9F%E5%A7%8B%E4%BB%A3%E7%A0%81-3"><span class="toc-number">1.3.1.</span> <span class="toc-text">原始代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%B2%BE%E7%AE%80%E5%90%8E%E4%BB%A3%E7%A0%81%E7%BB%93%E6%9E%84"><span class="toc-number">1.3.2.</span> <span class="toc-text">精简后代码结构</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#updatecrc"><span class="toc-number">1.3.2.1.</span> <span class="toc-text">UpdateCrc</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#computecrc"><span class="toc-number">1.3.2.2.</span> <span class="toc-text">ComputeCrc</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#crc_calc"><span class="toc-number">1.3.2.3.</span> <span class="toc-text">crc_calc</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#getdevicecapabilities"><span class="toc-number">1.3.2.4.</span> <span class="toc-text">GetDeviceCapabilities</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#prepareforoverlappedtransfer"><span class="toc-number">1.3.2.5.</span> <span class="toc-text">PrepareForOverlappedTransfer</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#closehandles"><span class="toc-number">1.3.2.6.</span> <span class="toc-text">CloseHandles</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#writeoutputreport"><span class="toc-number">1.3.2.7.</span> <span class="toc-text">WriteOutputReport</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#writeoutputreport-2"><span class="toc-number">1.3.2.8.</span> <span class="toc-text">WriteOutputReport</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#writeoutputreport2"><span class="toc-number">1.3.2.9.</span> <span class="toc-text">WriteOutputReport2</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#readthreadfindhid"><span class="toc-number">1.3.2.10.</span> <span class="toc-text">ReadThreadFindHID</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#teaencrypt"><span class="toc-number">1.3.2.11.</span> <span class="toc-text">TeaEncrypt</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#teadecrypt"><span class="toc-number">1.3.2.12.</span> <span class="toc-text">TeaDecrypt</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#fp_chech"><span class="toc-number">1.3.2.13.</span> <span class="toc-text">FP_CHECH</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#fp_reg"><span class="toc-number">1.3.2.14.</span> <span class="toc-text">FP_REG</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#fp_del"><span class="toc-number">1.3.2.15.</span> <span class="toc-text">FP_DEL</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#get_sn"><span class="toc-number">1.3.2.16.</span> <span class="toc-text">GET_SN</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#del_id"><span class="toc-number">1.3.2.17.</span> <span class="toc-text">DEL_ID</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#add_id"><span class="toc-number">1.3.2.18.</span> <span class="toc-text">ADD_ID</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#write_log_file"><span class="toc-number">1.3.2.19.</span> <span class="toc-text">write_log_file</span></a></li></ol></li></ol></li></ol></li></ol></div><div class="related panel pjax" data-title="系列文章"><ul><li class="active"><a href="/2024/04/10/other/u%E7%9B%BE/" rel="bookmark" title="U盾项目代码熟悉">U盾项目代码熟悉</a></li><li><a href="/2024/04/25/note/u%E7%9B%BE%E6%B5%8B%E8%AF%95/" rel="bookmark" title="U盾测试">U盾测试</a></li></ul></div><div class="overview panel" data-title="站点概览"><div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="image" itemprop="image" alt="洪宽" data-src="/images/avatar.jpg"><p class="name" itemprop="name">洪宽</p><div class="description" itemprop="description">数学 & 软件工程</div></div><nav class="state"><div class="item posts"><a href="/archives/"><span class="count">56</span> <span class="name">文章</span></a></div><div class="item categories"><a href="/categories/"><span class="count">6</span> <span class="name">分类</span></a></div><div class="item tags"><a href="/tags/"><span class="count">5</span> <span class="name">标签</span></a></div></nav><div class="social"></div><ul class="menu"><li class="item"><a href="/" rel="section"><i class="ic i-home"></i>首页</a></li><li class="item dropdown"><a href="/about/" rel="section"><i class="ic i-user"></i>关于</a><ul class="submenu"><li class="item"><a href="/about/own" rel="section"><i class="ic i-cloud"></i>关于博主</a></li></ul></li><li class="item dropdown"><a href="javascript:void(0);"><i class="ic i-feather"></i>文章</a><ul class="submenu"><li class="item"><a href="/archives/" rel="section"><i class="ic i-list-alt"></i>归档</a></li><li class="item"><a href="/categories/" rel="section"><i class="ic i-th"></i>分类</a></li><li class="item"><a href="/tags/" rel="section"><i class="ic i-tags"></i>标签</a></li></ul></li><li class="item"><a href="/friends/" rel="section"><i class="ic i-heart"></i>friends</a></li><li class="item"><a href="/links/" rel="section"><i class="ic i-magic"></i>links</a></li></ul></div></div></div><ul id="quick"><li class="prev pjax"><a href="/2024/04/10/course/%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%AD%A6%E4%B9%A0%E5%92%8C%E5%BC%80%E5%8F%91/" rel="prev" title="上一篇"><i class="ic i-chevron-left"></i></a></li><li class="up"><i class="ic i-arrow-up"></i></li><li class="down"><i class="ic i-arrow-down"></i></li><li class="next pjax"><a href="/2024/04/24/doc/%E4%BB%8B%E7%BB%8D%E7%BA%BF%E7%A8%8B%E7%9A%84%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E5%92%8C%E7%8A%B6%E6%80%81/" rel="next" title="下一篇"><i class="ic i-chevron-right"></i></a></li><li class="percent"></li></ul></div></div><div class="dimmer"></div></div></main><footer id="footer"><div class="inner"><div class="widgets"><div class="rpost pjax"><h2>随机文章</h2><ul><li class="item"><div class="breadcrumb"><a href="/categories/java/" title="分类于 JAVA">JAVA</a></div><span><a href="/2023/01/24/java/jvm%E9%9D%A2%E8%AF%95%E9%A2%98/" title="jvm面试题整理">jvm面试题整理</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/doc/" title="分类于 文档">文档</a></div><span><a href="/2024/04/24/doc/%E4%BB%8B%E7%BB%8D%E7%BA%BF%E7%A8%8B%E7%9A%84%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E5%92%8C%E7%8A%B6%E6%80%81/" title="介绍线程的生命周期和状态">介绍线程的生命周期和状态</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/doc/" title="分类于 文档">文档</a></div><span><a href="/2023/09/09/doc/PubmedPolictics3/" title="2024考研政治 (中国近代史纲要)">2024考研政治 (中国近代史纲要)</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/doc/" title="分类于 文档">文档</a></div><span><a href="/2024/01/04/doc/Happens-Before%E8%A7%84%E5%88%99%E6%98%AF%E4%BB%80%E4%B9%88/" title="Happens-Before规则是什么">Happens-Before规则是什么</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/doc/" title="分类于 文档">文档</a></div><span><a href="/2024/01/02/doc/%E7%A8%8B%E5%BA%8F%E5%BC%80%E5%A4%9A%E5%B0%91%E7%BA%BF%E7%A8%8B%E5%90%88%E9%80%82/" title="创建线程有哪些方式">创建线程有哪些方式</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/doc/" title="分类于 文档">文档</a></div><span><a href="/2024/02/13/doc/JVM8%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E5%A2%9E%E5%8A%A0%E5%85%83%E7%A9%BA%E9%97%B4%20/" title="JVM 8为什么要增加元空间">JVM 8为什么要增加元空间</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/C/" title="分类于 C">C</a></div><span><a href="/2024/04/10/other/u%E7%9B%BE/" title="U盾项目代码熟悉">U盾项目代码熟悉</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/doc/" title="分类于 文档">文档</a></div><span><a href="/2024/02/12/doc/JVM%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98%E5%AE%9E%E6%88%98/" title="JVM性能调优实战">JVM性能调优实战</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/math/" title="分类于 数学">数学</a></div><span><a href="/2023/08/27/math/MathImages/" title="高等数学数学图像作图">高等数学数学图像作图</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/doc/" title="分类于 文档">文档</a></div><span><a href="/2024/02/17/doc/%E4%BB%80%E4%B9%88%E6%98%AF%E5%AD%97%E8%8A%82%E7%A0%81%E4%BB%A5%E5%8F%8A%E5%AE%83%E7%9A%84%E7%BB%84%E6%88%90/" title="什么是字节码以及它的组成">什么是字节码以及它的组成</a></span></li></ul></div><div><h2>最新评论</h2><ul class="leancloud-recent-comment"></ul></div></div><div class="status"><div class="copyright">&copy; 2010 – <span itemprop="copyrightYear">2024</span> <span class="with-love"><i class="ic i-sakura rotate"></i> </span><span class="author" itemprop="copyrightHolder">洪宽 @ HongKuan</span></div><div class="count"><span class="post-meta-item-icon"><i class="ic i-chart-area"></i> </span><span title="站点总字数">282k 字</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="ic i-coffee"></i> </span><span title="站点阅读时长">4:17</span></div><div class="powered-by">基于 <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==">Shoka</span></div></div></div></footer></div><script data-config type="text/javascript">var LOCAL={path:"2024/04/10/other/u盾/",favicon:{show:"（●´3｀●）やれやれだぜ",hide:"(´Д｀)大変だ！"},search:{placeholder:"文章搜索",empty:"关于 「 ${query} 」，什么也没搜到",stats:"${time} ms 内找到 ${hits} 条结果"},valine:!0,fancybox:!0,copyright:'复制成功，转载请遵守 <i class="ic i-creative-commons"></i>BY-NC-SA 协议。',ignores:[function(e){return e.includes("#")},function(e){return new RegExp(LOCAL.path+"$").test(e)}]}</script><script src="https://cdn.polyfill.io/v2/polyfill.js"></script><script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script><script src="/js/app.js?v=0.2.5"></script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({pluginRootPath:"live2dw/",pluginJsPath:"lib/",pluginModelPath:"assets/",tagMode:!1,debug:!1,model:{scale:1,jsonPath:"/live2dw/assets/koharu.model.json"},display:{width:150,height:300,position:"right",hOffset:0,vOffset:-20},mobile:{show:!0,scale:.5},react:{opacity:.7},dialog:{enable:!0,text:["汉室衰微，朝纲霍乱","你在狗叫什么"]},log:!1})</script></body></html><!-- rebuild by hrmmi -->